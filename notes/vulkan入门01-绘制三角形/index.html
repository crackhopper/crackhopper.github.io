<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="参考： https://vulkan-tutorial.com/\n本笔记仅为概要总结，方便自己梳理和回忆。\n"><title>Vulkan入门01-绘制三角形</title><link rel=canonical href=https://crackhopper.github.io/notes/vulkan%E5%85%A5%E9%97%A801-%E7%BB%98%E5%88%B6%E4%B8%89%E8%A7%92%E5%BD%A2/><link rel=stylesheet href=/scss/style.min.4d36f8dc1fd48129e1635deb4b8eb2870fa09474f7280c4cb606d40b2526994b.css><meta property='og:title' content="Vulkan入门01-绘制三角形"><meta property='og:description' content="参考： https://vulkan-tutorial.com/\n本笔记仅为概要总结，方便自己梳理和回忆。\n"><meta property='og:url' content='https://crackhopper.github.io/notes/vulkan%E5%85%A5%E9%97%A801-%E7%BB%98%E5%88%B6%E4%B8%89%E8%A7%92%E5%BD%A2/'><meta property='og:site_name' content='crackhopper的技术博客'><meta property='og:type' content='article'><meta property='article:section' content='Notes'><meta property='article:tag' content='vulkan'><meta property='article:tag' content='cmake'><meta property='article:tag' content='glfw'><meta property='article:published_time' content='2025-11-25T21:29:13+08:00'><meta property='article:modified_time' content='2025-11-25T21:29:13+08:00'><meta name=twitter:title content="Vulkan入门01-绘制三角形"><meta name=twitter:description content="参考： https://vulkan-tutorial.com/\n本笔记仅为概要总结，方便自己梳理和回忆。\n"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_337fe2b325ec916d.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>crackhopper的技术博客</a></h1><h2 class=site-description>C++, Graphics, Game, AI/ML</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>文章</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于我</span></a></li><li class=current><a href=/notes/><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>笔记</span></a></li><li><a href=/projects/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>项目</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/notes/vulkan%E5%85%A5%E9%97%A801-%E7%BB%98%E5%88%B6%E4%B8%89%E8%A7%92%E5%BD%A2/>Vulkan入门01-绘制三角形</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2025-11-25T21:29:13+08:00>Nov 25, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>13 minute read</time></div></footer></div></header><section class=article-content><p>参考： <a class=link href=https://vulkan-tutorial.com/ target=_blank rel=noopener>https://vulkan-tutorial.com/</a></p><p>本笔记仅为概要总结，方便自己梳理和回忆。</p><h1 id=构建配置>构建配置</h1><p>我们选择用cmake配置。依赖库有两个</p><h2 id=背景知识-cmake的-find_package>背景知识-CMake的 <code>find_package</code></h2><p>cmake提供了 <code>find_package</code> 功能。可以方便自动查找一些外部依赖库。</p><p>用法：</p><pre tabindex=0><code>find_package(&lt;PackageName&gt; [version] [REQUIRED] [QUIET] [COMPONENTS &lt;component1&gt; &lt;component2&gt;...] [NO_MODULE])
</code></pre><p>分为两种模式：module模式和config模式</p><h3 id=module-模式-老模式cmake负责>Module 模式 （老模式，cmake负责）</h3><p>通过 <code>Find&lt;PackageName>.cmake</code> 文件</p><ul><li><strong>查找文件：</strong> CMake 会尝试在特定的目录（包括 CMake 自己的安装目录和用户指定的目录）中寻找一个名为 <code>Find&lt;PackageName>.cmake</code> 的文件。</li><li><strong>执行逻辑：</strong> 如果找到，CMake 会执行这个文件中的脚本逻辑。这个脚本通常包含了一系列平台特定的命令（如 <code>find_path</code>、<code>find_library</code>、<code>find_program</code>）来定位库的头文件、库文件和可执行程序。</li><li><strong>设置变量：</strong> 成功定位后，<code>Find&lt;PackageName>.cmake</code> 脚本会设置一组标准的 CMake 变量供项目使用。</li></ul><div class=table-wrapper><table><thead><tr><th><strong>变量名称</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td><code>&lt;PackageName>_FOUND</code></td><td>布尔值，表示是否成功找到库。</td></tr><tr><td><code>&lt;PackageName>_INCLUDE_DIRS</code></td><td>包含头文件的目录列表。</td></tr><tr><td><code>&lt;PackageName>_LIBRARIES</code></td><td>要链接的库文件路径或名称列表。</td></tr><tr><td><code>&lt;PackageName>_DEFINITIONS</code></td><td>编译所需的预处理器定义。</td></tr><tr><td><strong>需要分别用 <code>target_link_library</code> ， <code>target_include_directories</code> ， <code>target_compile_definitions</code> 来引入库文件、头文件和编译选项</strong></td><td></td></tr></tbody></table></div><h3 id=config-模式-新模式库提供者负责>Config 模式 (新模式，库提供者负责)</h3><p>通过 <code>&lt;PackageName>Config.cmake</code> 或 <code>&lt;PackageName>-config.cmake</code> 文件</p><ul><li><strong>查找文件：</strong> CMake 会尝试在系统路径（如 <code>/usr/local/lib/cmake/</code> 或自定义路径）中寻找一个名为 <code>&lt;PackageName>Config.cmake</code> 或 <code>&lt;PackageName>-config.cmake</code> 的配置文件。</li><li><strong>执行逻辑：</strong> 这种配置文件是由<strong>库的开发者</strong>在库的安装过程中生成的。它包含了库的绝对路径信息。</li><li><strong>设置目标：</strong> Config 模式的配置文件通常会使用 <code>IMPORTED</code> 目标（如 <code>add_library(&lt;PackageName>::&lt;component> IMPORTED)</code>）来封装库的信息。这是 CMake 推荐的现代用法，允许用户直接使用库名称作为链接目标，例如： <code>target_link_libraries(MyExecutable PRIVATE &lt;PackageName>::&lt;component>)</code></li></ul><p><strong>一体化导入，将：库文件、头文件、编译选项，都包装到 <code>Package::Component</code> 中了</strong></p><h2 id=背景知识-windows下的动态库链接>背景知识-Windows下的动态库链接</h2><p>windows下，如果程序要链接一个动态库，需要两个文件：</p><ul><li><code>.lib</code> : 通常是一个导出库（如果文件很大，那么它本身则很有可能是包含函数定义的静态库，而不是导出库）。导出库里，包含： <code>符号名称</code> 和 <code>DLL文件名</code> 。编译过程中，windows使用这个就可以完成程序的编译。</li><li><code>.dll</code> ：运行程序时，如果程序编译中link了导出库，那么会按照路径来搜索对应的dll库（包含函数的实际实现）<ul><li>程序所在目录</li><li>系统目录（通常是system32）</li><li>环境变量PATH的目录。</li></ul></li></ul><h2 id=配置选择cxx-20>配置：选择CXX 20</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#6639ba>set</span><span style=color:#1f2328>(</span><span style=color:#0a3069>CMAKE_CXX_STANDARD</span> <span style=color:#0a3069>20</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#6639ba>set</span><span style=color:#1f2328>(</span><span style=color:#0a3069>CMAKE_CXX_STANDARD_REQUIRED</span> <span style=color:#0a3069>ON</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=配置关闭msvc特殊警告>配置：关闭MSVC特殊警告</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#57606a># -------------------------------
</span></span></span><span style=display:flex><span><span style=color:#57606a># Windows 特殊：定义宏
</span></span></span><span style=display:flex><span><span style=color:#57606a># 关闭MSVC的安全警告，例如，用 strcpy_s 替代 strcpy，用 scanf_s 替代 scanf
</span></span></span><span style=display:flex><span><span style=color:#57606a># 提高可移植性
</span></span></span><span style=display:flex><span><span style=color:#57606a># -------------------------------
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#6639ba>if</span> <span style=color:#1f2328>(</span><span style=color:#0a3069>WIN32</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>    <span style=color:#6639ba>target_compile_definitions</span><span style=color:#1f2328>(</span><span style=color:#0550ae>${</span><span style=color:#953800>PROJECT_NAME</span><span style=color:#0550ae>}</span> <span style=color:#0a3069>PRIVATE</span> <span style=color:#0a3069>&#34;_CRT_SECURE_NO_WARNINGS&#34;</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#6639ba>endif</span><span style=color:#1f2328>()</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=配置编译器编码字符集问题>配置：编译器编码(字符集)问题</h2><h3 id=msvc编译器-源代码编码识别>MSVC编译器-源代码编码识别</h3><p>当 MSVC 编译器读取源代码文件时：</p><ul><li><strong>有 BOM 的 UTF-8 (UTF-8-BOM)</strong>：编译器会检测到 <strong>BOM（字节顺序标记）</strong>，并正确地将文件识别为 UTF-8 编码。</li><li><strong>无 BOM 的 UTF-8 (UTF-8)</strong>：如果文件中<strong>没有 BOM</strong>，编译器默认会假设文件是使用<strong>当前用户的系统代码页</strong>进行编码的（例如，在中国区就是 GBK/GB2312）。这会导致 UTF-8 编码的非 ASCII 字符被错误解读，从而出现乱码或编译警告/错误。</li></ul><p>实际上对UTF8来说，并不需要BOM。我们只需要告诉编译器，输入的源代码是UTF8格式即可。</p><h3 id=源代码字符集-和-执行字符集>源代码字符集 和 执行字符集</h3><ul><li>源代码字符集 (Source Character Set)<ul><li>这是指你的 C++ 源代码文件（<code>.cpp</code>, <code>.h</code> 文件）本身是以哪种编码格式保存的（例如 UTF-8、GBK、或 ISO-8859-1）。</li></ul></li><li>执行字符集 (Execution Character Set)<ul><li>这是指程序编译完成后，存储在可执行文件内部的字符串字面量（String Literals，如 <code>"Hello"</code> 或 <code>"你好"</code>）所使用的编码格式。</li></ul></li></ul><h3 id=cmake编译器选项设置>cmake编译器选项设置</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#6639ba>if</span><span style=color:#1f2328>(</span><span style=color:#0a3069>MSVC</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>    <span style=color:#57606a># MSVC: 明确指定使用 UTF-8
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#6639ba>add_compile_options</span><span style=color:#1f2328>(</span><span style=color:#0a3069>/utf-8</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#6639ba>else</span><span style=color:#1f2328>()</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>    <span style=color:#57606a># GCC/Clang: 设置源码字符集
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#6639ba>add_compile_options</span><span style=color:#1f2328>(</span><span style=color:#0a3069>-finput-charset=UTF-8</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>    <span style=color:#6639ba>add_compile_options</span><span style=color:#1f2328>(</span><span style=color:#0a3069>-fexec-charset=UTF-8</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#6639ba>endif</span><span style=color:#1f2328>()</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#57606a># 定义一个预编译宏，方便我们自己使用
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#6639ba>add_definitions</span><span style=color:#1f2328>(</span><span style=color:#0a3069>-D_UTF8_SOURCE</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=配置vulkan依赖>配置：Vulkan依赖</h2><p>开发vulkan程序，需要需要程序连接到 vulkan loader动态库 (vulkan-1.dll) 上。</p><h3 id=vulkan-loader>Vulkan loader</h3><p>Khronos Group 通过其 <strong>Vulkan Loader and Validation Layer (Loader)</strong> 仓库开发的。它的作用是实现 Khronos 定义的<strong>加载器接口规范</strong>。</p><p>硬件厂商会根据这个仓库（有可能有一些定制化改动），编译成 <code>vulkan-1.dll</code> 。在安装驱动程序的时候，将这个动态库安装到系统目录中。</p><p><code>vulkan-1.dll</code> <strong>本身不是</strong> Vulkan 的图形实现。它是一个薄薄的层（Layer）。真正的、有巨大差异的实现代码位于厂商的 <strong>私有驱动 DLL</strong> 中（如 <code>nvoglv64.dll</code>），这些驱动 DLL 会被 <code>vulkan-1.dll</code> 加载和调用。</p><h3 id=链接方式>链接方式</h3><p>在安装好的Vulkan的SDK中，可以找到对应的导出库，<code>vulkan-1.lib</code> ：
<img src=/images/Vulkan%e5%85%a5%e9%97%a8-%e7%bb%98%e5%88%b6%e4%b8%89%e8%a7%92%e5%bd%a2-1764083080360.png loading=lazy alt=Vulkan入门-绘制三角形-1764083080360></p><p>因此严格来说，程序只要link这个库，并且system32中存在 <code>vulkan-1.dll</code> 那么就完成了vulkan的集成。</p><h3 id=cmake中导入vulkan>cmake中导入Vulkan</h3><p>代码如下：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#6639ba>find_package</span><span style=color:#1f2328>(</span><span style=color:#0a3069>Vulkan</span> <span style=color:#0a3069>REQUIRED</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#57606a># 检查查找是否成功。 (REQUIRED 关键字已经保证了这一点，但保留这个变量以备用)
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#6639ba>if</span><span style=color:#1f2328>(</span><span style=color:#0a3069>NOT</span> <span style=color:#0a3069>Vulkan_FOUND</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>    <span style=color:#57606a># 实际上由于 REQUIRED，程序不会运行到这里，但保留是良好的编程习惯。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#6639ba>message</span><span style=color:#1f2328>(</span><span style=color:#0a3069>FATAL_ERROR</span> <span style=color:#0a3069>&#34;Vulkan SDK not found.&#34;</span><span style=color:#1f2328>)</span> <span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#6639ba>endif</span><span style=color:#1f2328>()</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span></code></pre></td></tr></table></div></div><p>实际上Vulkan的SDK（windows下）并没有提供 <code>VulkunConfig.cmake</code> 。因此是按照cmake的 Module 方式，调用cmake提供的 <code>FindVulkan.cmake</code> 文件来查找的（各种尝试，包括使用环境变量）。但目前的cmake提供的 <code>FindVulkan.cmake</code> 也会导出 Config风格的目标。因此，在使用的时候：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#6639ba>if</span><span style=color:#1f2328>(</span><span style=color:#0a3069>NOT</span> <span style=color:#0a3069>TARGET</span> <span style=color:#0a3069>Vulkan::Vulkan</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>    <span style=color:#6639ba>message</span><span style=color:#1f2328>(</span><span style=color:#0a3069>FATAL_ERROR</span> <span style=color:#0a3069>&#34;Vulkan SDK found, but does not provide the required modern target Vulkan::Vulkan. Please update your SDK or FindVulkan.cmake.&#34;</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#6639ba>endif</span><span style=color:#1f2328>()</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#6639ba>target_link_libraries</span><span style=color:#1f2328>(</span><span style=color:#0550ae>${</span><span style=color:#953800>PROJECT_NAME</span><span style=color:#0550ae>}</span> <span style=color:#0a3069>PRIVATE</span> <span style=color:#0a3069>Vulkan::Vulkan</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span></code></pre></td></tr></table></div></div><p>这样即可。</p><p>当然，更稳妥的方式，还是当Config模式找不到的时候，使用Module模式：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#6639ba>if</span><span style=color:#1f2328>(</span><span style=color:#0a3069>NOT</span> <span style=color:#0a3069>TARGET</span> <span style=color:#0a3069>Vulkan::Vulkan</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>    <span style=color:#57606a># 如果找到了 SDK，但没找到目标，说明是老旧的 Module 模式。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#57606a># 此时，我们必须回退到使用传统变量。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#6639ba>message</span><span style=color:#1f2328>(</span><span style=color:#0a3069>WARNING</span> <span style=color:#0a3069>&#34;Vulkan SDK found, but target Vulkan::Vulkan is missing. Falling back to using legacy variables.&#34;</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>    <span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>    <span style=color:#57606a># 回退到 Module 模式的链接方式
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#6639ba>target_include_directories</span><span style=color:#1f2328>(</span><span style=color:#0550ae>${</span><span style=color:#953800>PROJECT_NAME</span><span style=color:#0550ae>}</span> <span style=color:#0a3069>PRIVATE</span> <span style=color:#0550ae>${</span><span style=color:#953800>Vulkan_INCLUDE_DIRS</span><span style=color:#0550ae>}</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>    <span style=color:#6639ba>target_link_libraries</span><span style=color:#1f2328>(</span><span style=color:#0550ae>${</span><span style=color:#953800>PROJECT_NAME</span><span style=color:#0550ae>}</span> <span style=color:#0a3069>PRIVATE</span> <span style=color:#0550ae>${</span><span style=color:#953800>Vulkan_LIBRARIES</span><span style=color:#0550ae>}</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#6639ba>else</span><span style=color:#1f2328>()</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>    <span style=color:#57606a># 3. 使用推荐的 Config 链接方式。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#6639ba>target_link_libraries</span><span style=color:#1f2328>(</span><span style=color:#0550ae>${</span><span style=color:#953800>PROJECT_NAME</span><span style=color:#0550ae>}</span> <span style=color:#0a3069>PRIVATE</span> <span style=color:#0a3069>Vulkan::Vulkan</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#6639ba>endif</span><span style=color:#1f2328>()</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=配置glfw依赖>配置：GLFW依赖</h2><p>直接将源码引入到依赖中。这样有更好的跨平台兼容性。也方便调试。</p><p>源码方式（Source Code）的优势</p><div class=table-wrapper><table><thead><tr><th><strong>优势</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td><strong>1. 调试友好性 (Debuggability)</strong></td><td>如果在应用程序中遇到与窗口、输入或渲染上下文相关的罕见错误，您可以直接进入 GLFW 源码进行调试和单步跟踪。这对于底层的 Vulkan 开发非常有价值。</td></tr><tr><td><strong>2. 一致性与控制 (Consistency & Control)</strong></td><td>您可以确保 GLFW 是使用与您的 Vulkan 项目<strong>相同的编译器、相同的编译标志、相同的 C++ 标准</strong>（例如 C++20）和相同的运行时库（如 MSVC 的 <code>/MT</code> 或 <code>/MD</code>）编译的。这可以避免许多由于ABI不匹配或库冲突导致的链接错误。</td></tr><tr><td><strong>3. 易于集成到构建系统 (Easy CMake Integration)</strong></td><td>如果您的项目使用 CMake，您可以使用 <code>FetchContent</code> 或 <code>add_subdirectory()</code> 将 GLFW 源码直接拉取并集成到您的主构建脚本中。这样，<strong>所有依赖都会在您配置项目时自动构建</strong>，无需手动管理二进制文件。</td></tr><tr><td><strong>4. 跨平台支持 (Cross-Platform)</strong></td><td>预编译的二进制文件通常只针对特定的操作系统、编译器和架构（例如 Windows x64 MSVC）。使用源码，您可以轻松地在 Windows、Linux 和 macOS 等平台<strong>用本地编译器进行构建</strong>。</td></tr><tr><td><strong>5. 针对性优化 (Targeted Optimization)</strong></td><td>您可以自由修改 GLFW 的 CMake 选项，根据您的特定需求（例如，禁用不必要的特性或开启特定的优化）来编译库。</td></tr></tbody></table></div><h3 id=cmake导入方式>cmake导入方式</h3><p>很简单，引入对应的源码文件夹即可。因为源码也是用cmake组织的：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#6639ba>add_subdirectory</span><span style=color:#1f2328>(</span><span style=color:#0a3069>external/glfw-3.4</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span></code></pre></td></tr></table></div></div><p>这样会加载对应目录的 <code>CMakeLists.txt</code> 文件，从而其内部定义的target都可以直接使用。</p><p>我们使用的方式只需要：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#6639ba>target_link_libraries</span><span style=color:#1f2328>(</span><span style=color:#0550ae>${</span><span style=color:#953800>PROJECT_NAME</span><span style=color:#0550ae>}</span> <span style=color:#0a3069>PRIVATE</span> <span style=color:#0a3069>glfw</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span></code></pre></td></tr></table></div></div><p>这其实是由于glfw的cmakelist编写的时候，正确使用的各种cmake的target属性设定的方式，所以我直接一个link_libraries就可以把头文件、库文件和编译选项都引入进来？</p><h2 id=配置shader编译>配置：shader编译</h2><h3 id=找到编译工具-glslcexe>找到编译工具 <code>glslc.exe</code></h3><p>根据 <code>Vulkan_SDK</code> 环境变量来查找。（一般安装SDK后会自动配置）</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#6639ba>find_program</span><span style=color:#1f2328>(</span><span style=color:#0a3069>GLSLC_EXECUTABLE</span>
</span></span><span style=display:flex><span>    <span style=color:#0a3069>NAMES</span> <span style=color:#0a3069>glslc</span>
</span></span><span style=display:flex><span>    <span style=color:#0a3069>HINTS</span> <span style=color:#0550ae>$ENV{</span><span style=color:#953800>VULKAN_SDK</span><span style=color:#0550ae>}</span><span style=color:#0a3069>/Bin</span> <span style=color:#0550ae>$ENV{</span><span style=color:#953800>VULKAN_SDK</span><span style=color:#0550ae>}</span><span style=color:#0a3069>/x86_64/bin</span>
</span></span><span style=display:flex><span>    <span style=color:#0a3069>REQUIRED</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span></code></pre></td></tr></table></div></div><p>CMake 会按照以下顺序进行查找：</p><ol><li><strong>系统默认路径 (PATH 环境变量):</strong> 首先，它会在系统 <code>PATH</code> 环境变量中定义的标准可执行文件路径中查找名为 <code>glslc</code>（在 Windows 上通常是 <code>glslc.exe</code>）的文件。</li><li><strong><code>HINTS</code> 指定的路径:</strong> 接下来，它会检查您在 <code>HINTS</code> 中提供的自定义目录：<ul><li><code>${VULKAN_SDK}/Bin</code></li><li><code>${VULKAN_SDK}/x86_64/bin</code></li></ul></li><li><strong>CMake 缓存和标准查找路径:</strong> 它还会检查 CMake 自己的缓存和其他标准查找位置（例如用户定义的前缀路径等）。</li></ol><p>找不到则直接报错。</p><h3 id=定义输入输出目录>定义输入输出目录</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#57606a># 定义 shader 目录和输出目录
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#6639ba>set</span><span style=color:#1f2328>(</span><span style=color:#0a3069>SHADER_DIR</span> <span style=color:#0550ae>${</span><span style=color:#953800>CMAKE_CURRENT_SOURCE_DIR</span><span style=color:#0550ae>}</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#6639ba>set</span><span style=color:#1f2328>(</span><span style=color:#0a3069>SHADER_OUTPUT_DIR</span> <span style=color:#0550ae>${</span><span style=color:#953800>CMAKE_CURRENT_BINARY_DIR</span><span style=color:#0550ae>}</span><span style=color:#0a3069>/shaders</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#6639ba>file</span><span style=color:#1f2328>(</span><span style=color:#0a3069>MAKE_DIRECTORY</span> <span style=color:#0550ae>${</span><span style=color:#953800>SHADER_OUTPUT_DIR</span><span style=color:#0550ae>}</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=查找和自动编译shader>查找和自动编译shader</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#57606a># 自动查找所有着色器文件
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#6639ba>file</span><span style=color:#1f2328>(</span><span style=color:#0a3069>GLOB</span> <span style=color:#0a3069>SHADER_FILES</span>
</span></span><span style=display:flex><span>    <span style=color:#0a3069>&#34;${SHADER_DIR}/*.vert&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#0a3069>&#34;${SHADER_DIR}/*.frag&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a># ...可以添加更多类型，如.comp, .geom等
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#6639ba>set</span><span style=color:#1f2328>(</span><span style=color:#0a3069>SPV_FILES</span> <span style=color:#0a3069>&#34;&#34;</span><span style=color:#1f2328>)</span> <span style=color:#57606a># 用于存储所有生成的.spv文件路径
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#6639ba>foreach</span><span style=color:#1f2328>(</span><span style=color:#0a3069>SHADER_FILE</span> <span style=color:#0550ae>${</span><span style=color:#953800>SHADER_FILES</span><span style=color:#0550ae>}</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>    <span style=color:#57606a># 获取着色器文件的完整文件名（例如: shader.vert）
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#6639ba>get_filename_component</span><span style=color:#1f2328>(</span><span style=color:#0a3069>BASE_NAME</span> <span style=color:#0550ae>${</span><span style=color:#953800>SHADER_FILE</span><span style=color:#0550ae>}</span> <span style=color:#0a3069>NAME</span><span style=color:#1f2328>)</span> <span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>    <span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>    <span style=color:#57606a># 构造输出 .spv 文件的完整路径
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#57606a># 示例: .../shaders/shader.vert.spv
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#6639ba>set</span><span style=color:#1f2328>(</span><span style=color:#0a3069>OUTPUT_SPV</span> <span style=color:#0a3069>&#34;${SHADER_OUTPUT_DIR}/${BASE_NAME}.spv&#34;</span><span style=color:#1f2328>)</span> <span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>    <span style=color:#57606a># 将生成的 .spv 文件添加到列表中
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#6639ba>list</span><span style=color:#1f2328>(</span><span style=color:#0a3069>APPEND</span> <span style=color:#0a3069>SPV_FILES</span> <span style=color:#0a3069>&#34;${OUTPUT_SPV}&#34;</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>    <span style=color:#57606a># 定义自定义编译命令
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#6639ba>add_custom_command</span><span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>        <span style=color:#0a3069>OUTPUT</span> <span style=color:#0a3069>&#34;${OUTPUT_SPV}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#0a3069>COMMAND</span> <span style=color:#0a3069>&#34;${GLSLC_EXECUTABLE}&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#0a3069>-o</span> <span style=color:#0a3069>&#34;${OUTPUT_SPV}&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#0a3069>&#34;${SHADER_FILE}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#0a3069>DEPENDS</span> <span style=color:#0a3069>&#34;${SHADER_FILE}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#0a3069>COMMENT</span> <span style=color:#0a3069>&#34;Compiling shader: ${BASE_NAME}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#0a3069>VERBATIM</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#6639ba>endforeach</span><span style=color:#1f2328>()</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#57606a># 创建目标依赖所有生成的 .spv 文件
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#6639ba>add_custom_target</span><span style=color:#1f2328>(</span><span style=color:#0a3069>CompileShaders</span>
</span></span><span style=display:flex><span>    <span style=color:#0a3069>DEPENDS</span> <span style=color:#0550ae>${</span><span style=color:#953800>SPV_FILES</span><span style=color:#0550ae>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span></code></pre></td></tr></table></div></div><h1 id=glfw窗口初始化>GLFW窗口初始化</h1><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>// 它初始化了 GLFW 内部的所有必需组件，包括系统计时器、线程、以及输入系统（键盘、鼠标等）。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>glfwInit<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 禁用 OpenGL API 。 默认情况下，GLFW 旨在创建与 **OpenGL** 上下文兼容的窗口。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>glfwWindowHint<span style=color:#1f2328>(</span>GLFW_CLIENT_API<span style=color:#1f2328>,</span> GLFW_NO_API<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 创建主应用程序窗口
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>window <span style=color:#0550ae>=</span> glfwCreateWindow<span style=color:#1f2328>(</span>WIDTH<span style=color:#1f2328>,</span> HEIGHT<span style=color:#1f2328>,</span> <span style=color:#0a3069>&#34;Vulkan&#34;</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 设置用户自定义数据： 将一个**用户指针**与 GLFW 窗口关联起来。
</span></span></span><span style=display:flex><span><span style=color:#57606a>//     主要目的就是为了在回调函数中访问到设定的这个指针。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>glfwSetWindowUserPointer<span style=color:#1f2328>(</span>window<span style=color:#1f2328>,</span> <span style=color:#cf222e>this</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 注册帧缓冲大小变化回调：处理窗口变化，通常这里用到上面设定的指针
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>glfwSetFramebufferSizeCallback<span style=color:#1f2328>(</span>window<span style=color:#1f2328>,</span> framebufferResizeCallback<span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><p>因为使用了GLFW库。窗口创建相对来说比较简单。</p><h1 id=vulkan初始化-基础初始化>Vulkan初始化-基础初始化</h1><h2 id=创建-vulkan-实例>创建 Vulkan 实例</h2><p>设定：</p><ul><li>App信息： <code>VkApplicationInfo</code></li><li>开启的扩展（字符串数组）：通常是 <code>VK_xxxx</code> 。比如， <code>VK_KHR_surface</code> ，<code>VK_EXT_debug_utils</code> (变量: <code>VK_EXT_DEBUG_UTILS_EXTENSION_NAME</code>)</li><li>开启的验证层（validation layers）（字符串数组)：通常类似 <code>VK_LAYER_xxx</code> 。比如，<code>VK_LAYER_KHRONOS_validation</code></li><li>对创建Instance的过程调试（optional）：利用 <code>pNext</code> 这个指针和 <code>VkDebugUtilsMessengerCreateInfoEXT</code> 结构。</li></ul><h3 id=extensions>Extensions</h3><p>Vulkan 的设计是模块化的，核心 API 提供了一些基本的功能，而 <strong>extensions</strong>（扩展）则允许添加额外的功能。扩展是由硬件厂商（如 NVIDIA、AMD）或 Vulkan 的开发团队提供的，可以是官方支持的，也可以是实验性的。</p><ul><li><strong>功能扩展</strong>：扩展允许 Vulkan 添加一些不在核心 API 中的功能。例如，增加对新的硬件特性、图形效果、或计算功能的支持。</li><li><strong>平台扩展</strong>：某些扩展是针对特定平台的。例如，支持 Windows、Linux 或 Android 上 Vulkan 的特性扩展。</li></ul><p>举个例子，一些常见的 Vulkan 扩展包括：</p><ul><li><strong>VK_EXT_debug_utils</strong> : 为 Vulkan 提供统一、可扩展的调试信息输出和对象标注机制</li><li><strong>VK_KHR_surface</strong>：提供了一组 <strong>API 来创建和管理“表面（Surface）</strong></li></ul><p><strong>加载原理</strong></p><ul><li>不拦截原 API</li><li>只是“是否有这组新功能”</li><li>功能直接由 Driver 或 Loader 实现</li></ul><h3 id=validation-layers>Validation layers</h3><p><strong>Validation layers</strong>（验证层）是 Vulkan 的一个重要特性，它主要用于在开发过程中帮助你调试和验证 Vulkan 程序的正确性。它们并不直接影响程序的性能，而是用来捕捉潜在的错误和不符合规范的使用。</p><p>从某种角度来看，<strong>验证层（Validation Layers）</strong> 可以被视为 <strong>一种特殊的扩展</strong>，因为它们本质上是在 Vulkan 上层提供额外的功能，但它们并不直接扩展 Vulkan 的核心图形渲染功能，而是为开发者提供错误检查、调试和运行时验证的能力。</p><ul><li><strong>功能</strong>：验证层会在运行时检查你的 Vulkan 调用是否符合规范，并报告潜在的错误和警告。例如，检查你是否正确地管理了资源，是否按照 Vulkan 的要求调用了正确的函数，或者是否发生了未定义的行为。</li><li><strong>开发过程中的帮助</strong>：验证层是 Vulkan 开发的一个非常重要的工具，可以帮助开发者快速发现问题，尤其是在学习和调试阶段。</li></ul><p>Vulkan 提供了几个验证层：</p><ul><li><strong>VK_LAYER_KHRONOS_validation</strong>：这是最常用的验证层，它会检查你是否正确地使用 Vulkan API，并提供详细的错误信息和警告。</li><li><strong>VK_LAYER_LUNARG_standard_validation</strong>：这是一个由第三方（LunarG）提供的标准验证层，也是最常见的一个。</li></ul><p>在 Vulkan 中，<strong>验证层（Validation Layers）</strong> 的功能是通过特定的调试工具来呈现的（但并不是必必要的；不过为了更好的使用，通常要配合调试信使相关的扩展来一起使用）。</p><p><strong>加载原理</strong></p><ul><li>拦截 Vulkan API 调用</li><li>可观察、修改、拒绝调用</li><li>不实现 GPU 功能，只做检查</li></ul><h2 id=配置调试工具ext>配置调试工具(EXT)</h2><h3 id=创建扩展对象>创建扩展对象</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>auto</span> func <span style=color:#0550ae>=</span> <span style=color:#1f2328>(</span>PFN_vkCreateDebugUtilsMessengerEXT<span style=color:#1f2328>)</span>vkGetInstanceProcAddr<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>	instance<span style=color:#1f2328>,</span> <span style=color:#0a3069>&#34;vkCreateDebugUtilsMessengerEXT&#34;</span><span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><p>这是调用一个扩展函数，之所以这么做: <strong>Vulkan 的扩展函数根本就不是普通意义上的 API 符号，它们是运行时由 Loader 返回的函数指针</strong>。</p><h3 id=关于扩展-vk_ext_debug_utils>关于扩展 <code>VK_EXT_debug_utils</code></h3><ul><li>允许你注册一个回调函数</li><li>接收来自：<ul><li>Validation Layers</li><li>Loader</li><li>Driver（少量）</li></ul></li><li>的调试消息</li></ul><p>使用方式就是使用这个扩展提供的函数指针： <code>vkCreateDebugUtilsMessengerEXT</code></p><p>更多功能：</p><ul><li>提供给对象的命名</li><li>给 Command Buffer / Queue 插入“标签”</li><li>被 RenderDoc / Nsight 等 GPU 工具识别</li></ul><p><strong>因此这个扩展的行为更像是一个钩子，可以钩在各个位置上。而调用则是由具体的 validation layers， loader 和 driver来调用。但主要是配合validation layers一起使用</strong></p><h2 id=创建-surface>创建 Surface</h2><p>由GLFW和底层交互，完成创建。</p><p><code>surface</code> 是：<strong>Vulkan 用来“往某个窗口显示内容”的平台抽象接口</strong></p><p>作用（surface主要符合和vulkan交互）：</p><ol><li>查询设备是否支持展示到这个窗口</li><li>查询窗口相关参数（尺寸 / 格式 / 刷新）</li><li>创建 Swapchain（<strong>最重要</strong>）</li></ol><p>总结：</p><ul><li><code>window</code>：OS 窗口（GLFW 管）</li><li><code>surface</code>：Vulkan 的显示目标抽象</li><li>GLFW 只是帮你把 <strong>OS window → Vulkan surface</strong> 连起来</li><li>surface 为 <strong>swapchain</strong> 服务</li><li>Vulkan <strong>永远不直接操作 window</strong></li></ul><h2 id=选择物理设备>选择物理设备</h2><p>主要通过 <code>vkEnumeratePhysicalDevices</code> 查询，然后选择一个物理设备对象。留待后续使用。</p><h2 id=创建逻辑设备>创建逻辑设备</h2><h3 id=配置队列族创建队列>配置队列族+创建队列</h3><p>在 Vulkan 中，<strong>queue（队列）是提交命令到 GPU 的执行通道</strong>。你把已经记录好的 command buffer 提交（<code>vkQueueSubmit</code>）到某个 queue，GPU 就按顺序在那个队列上执行这些命令。每个 queue 属于某个 <strong>队列族（queue family）</strong>，同一队列族里的队列通常能执行相同类别的工作（比如支持图形、计算或拷贝）。</p><p>更直观的队列族例子：</p><ul><li>比如：一个 GPU 可能有：<ul><li>Family 0: Graphics + Compute + Transfer，队列数 16</li><li>Family 1: Compute-only，队列数 8</li><li>Family 2: Transfer-only，队列数 4</li></ul></li></ul><p><strong>需要使用的队列组，保存到 <code>VkDeviceQueueCreateInfo</code> 的数组，逻辑设备创建的时候提供</strong></p><p><strong>注意：名字叫 QueueCreateInfo，描述从已有队列族申请队列实例的方式。队列族本身不会被创建或改变，创建逻辑设备时才生成队列实例句柄。</strong></p><p><strong>这个步骤的做法</strong></p><ol><li>寻找需要的队列族特性：<ol><li>利用 <code>queueFamily.queueFlags & VK_QUEUE_GRAPHICS_BIT</code> 来查找</li><li>利用 <code>vkGetPhysicalDeviceSurfaceSupportKHR</code> 来寻找（这种需要结合外部对象来判断队列能力）</li></ol></li><li>填充 <code>VkDeviceQueueCreateInfo</code></li><li>创建逻辑设备的时候，队列就被创建好了。</li><li>后续获取方法： <code>vkGetDeviceQueue</code></li></ol><h3 id=启用的设备特征-features>启用的设备特征 (features)</h3><p>主要填充 <code>VkPhysicalDeviceFeatures</code></p><h3 id=启用的设备扩展-extensions>启用的设备扩展 (extensions)</h3><p>主要填充字符串数组。类似： <code>VK_KHR_swapchain</code> 这种</p><p>对比VkInstance的扩展：
<img src=/images/Vulkan%e5%85%a5%e9%97%a8-%e7%bb%98%e5%88%b6%e4%b8%89%e8%a7%92%e5%bd%a2-1764135429992.png loading=lazy alt=Vulkan入门-绘制三角形-1764135429992></p><h3 id=实例扩展vs设备扩展>实例扩展v.s.设备扩展</h3><p>相似点</p><ul><li><strong>枚举扩展</strong><ul><li>实例扩展：<code>vkEnumerateInstanceExtensionProperties</code></li><li>设备扩展：<code>vkEnumerateDeviceExtensionProperties</code></li></ul></li><li><strong>启用扩展</strong><ul><li>实例扩展：在 <code>VkInstanceCreateInfo</code> 中通过 <code>enabledExtensionCount</code> 和 <code>ppEnabledExtensionNames</code> 指定</li><li>设备扩展：在 <code>VkDeviceCreateInfo</code> 中通过 <code>enabledExtensionCount</code> 和 <code>ppEnabledExtensionNames</code> 指定</li></ul></li><li><strong>获取扩展函数指针</strong>（如果扩展定义了新函数）<ul><li>实例扩展函数：使用 <code>vkGetInstanceProcAddr(instance, "函数名")</code></li><li>设备扩展函数：使用 <code>vkGetDeviceProcAddr(device, "函数名")</code></li></ul></li><li><strong>依赖检查</strong><ul><li>在启用之前必须先 <strong>枚举支持的扩展</strong>，否则创建实例/设备会失败。</li></ul></li></ul><p>差异点：</p><ul><li>实例扩展是全局的，设备扩展仅为单个逻辑设备。后者依赖前者。</li></ul><h2 id=物理设备vs逻辑设备>物理设备v.s.逻辑设备</h2><h3 id=物理设备vkphysicaldevice>物理设备（<code>VkPhysicalDevice</code>）</h3><blockquote><p><strong>“有什么硬件能力”</strong></p></blockquote><ul><li>一块 GPU（或虚拟 GPU）</li><li>包含：<ul><li>支持的特性（geometry shader、ray tracing…）</li><li>队列家族（graphics / compute / transfer）</li><li>内存类型</li><li>支持的格式</li></ul></li><li><strong>只读、不能创建资源</strong>
你只能“查”。</li></ul><h3 id=逻辑设备vkdevice>逻辑设备（<code>VkDevice</code>）</h3><blockquote><p><strong>“我决定怎么用这块硬件”</strong></p></blockquote><ul><li>基于某个 <code>VkPhysicalDevice</code> 创建</li><li>指定：<ul><li>用哪些 queue family</li><li>需要几个 queue</li><li>打开哪些 feature</li><li>启用哪些扩展</li></ul></li><li>之后<strong>所有 Vulkan 操作都用它</strong></li></ul><p>你真正“干活”都靠它。</p><h3 id=区分两者的好处>区分两者的好处</h3><ol><li><strong>性能确定性</strong>: Vulkan driver不用动态判断，不用兼容你没开却想用的东西。更低CPU开销，驱动路径更短。</li><li><strong>多逻辑设备（理论上）</strong> : 更好配合多进程，多上下文，GPU虚拟化。</li><li><strong>线程友好设计</strong> ： 逻辑设备提供：明确的 queue ownership、明确的同步边界。</li></ol><p>直接用 PhysicalDevice 的问题：
<img src=/images/Vulkan%e5%85%a5%e9%97%a8-%e7%bb%98%e5%88%b6%e4%b8%89%e8%a7%92%e5%bd%a2-1764134227084.png loading=lazy alt=Vulkan入门-绘制三角形-1764134227084></p><p>对比OpenGL：
<img src=/images/Vulkan%e5%85%a5%e9%97%a8-%e7%bb%98%e5%88%b6%e4%b8%89%e8%a7%92%e5%bd%a2-1764134269682.png loading=lazy alt=Vulkan入门-绘制三角形-1764134269682></p><h2 id=vulkan窗口渲染核心模型>Vulkan窗口渲染核心模型</h2><p>关键的元素：</p><ul><li>Surface： Vulkan 用来表示“操作系统窗口表面”的对象。</li><li>SwapChain：Vulkan 中专门用于 <strong>窗口渲染的图像队列</strong>。它维护一组 <strong>可以显示到 surface 的图像（images）</strong>。</li><li>ImageView：<code>VkImageView</code> 是对 <code>VkImage</code> 的一种“视图”或“接口”。Swapchain 中的每一张图像都是 <code>VkImage</code>，但是 Vulkan 的渲染操作（Framebuffer、Pipeline）不能直接操作 <code>VkImage</code>，需要通过 <code>VkImageView</code>。</li></ul><p><img src=/images/Vulkan%e5%85%a5%e9%97%a8-%e7%bb%98%e5%88%b6%e4%b8%89%e8%a7%92%e5%bd%a2-1764135952685.png loading=lazy alt=Vulkan入门-绘制三角形-1764135952685></p><h2 id=创建-swapchain建立渲染的条件>创建 SwapChain(建立渲染的条件)</h2><p>从<strong>原理</strong>角度来看，交换链 (Swap Chain) 是连接你的 Vulkan 渲染世界和操作系统的显示窗口的关键。它本质上是一个<strong>生产-消费</strong>缓冲区队列，因此，创建它需要定义生产者（Vulkan 渲染）和消费者（显示器/操作系统）之间的所有关键契约。</p><p>创建 $\text{Swap Chain}$ 必须回答的基本问题：</p><ul><li><strong>在哪里显示？</strong></li><li><strong>显示什么？如何显示？</strong></li><li><strong>其他显示配置</strong></li></ul><h3 id=在哪里显示目标>在哪里显示？(目标)</h3><div class=table-wrapper><table><thead><tr><th><strong>核心设定</strong></th><th><strong>对应的代码字段</strong></th><th><strong>设定的原理/为什么需要？</strong></th></tr></thead><tbody><tr><td><strong>目标表面 (Surface)</strong></td><td>$\text{surface}$</td><td>明确指出交换链创建的图像将要<strong>呈现</strong>到的抽象窗口表面。<strong>这是连接 Vulkan 驱动和操作系统窗口管理器的句柄。</strong></td></tr></tbody></table></div><ul><li><strong>目标表面</strong> ：<code>createInfo.surface = surface</code></li></ul><h3 id=显示什么如何显示数据>显示什么？如何显示？(数据)</h3><h4 id=图像方面-framebuffer相关>图像方面 （FrameBuffer相关）</h4><p>这是关于交换链中每个图像（帧）的<strong>物理属性</strong>和<strong>数据格式</strong>。</p><div class=table-wrapper><table><thead><tr><th><strong>核心设定</strong></th><th><strong>对应的代码字段</strong></th><th><strong>设定的原理/为什么需要？</strong></th></tr></thead><tbody><tr><td><strong>图像数量 (Minimum Image Count)</strong></td><td>$\text{minImageCount}$</td><td>决定了缓冲区队列的<strong>深度</strong>。$\text{minImageCount}=2$ 是双缓冲。数量越多，可以容忍更大的渲染延迟（例如三缓冲可以提高吞吐量），但会占用更多显存。<strong>这是调度渲染和显示的契约。</strong></td></tr><tr><td><strong>图像分辨率 (Extent)</strong></td><td>$\text{imageExtent}$</td><td>图像的像素宽度和高度。它必须与渲染管线中的<strong>视口</strong>和<strong>帧缓冲</strong>配置相匹配。<strong>这是显存分配的基础。</strong></td></tr><tr><td><strong>图像格式和颜色空间 (Format & Colorspace)</strong></td><td>$\text{imageFormat}$ / $\text{imageColorSpace}$</td><td>决定了每个像素占用多少<strong>字节</strong>（如 $\text{B8G8R8A8}$），以及像素值应如何<strong>解码</strong>成最终的颜色（如 $\text{SRGB}$）。<strong>这是渲染结果的解释规范。</strong></td></tr><tr><td><strong>图像用途 (Usage)</strong></td><td>$\text{imageUsage}$</td><td>告诉 Vulkan 驱动程序，这些图像在管线中将扮演什么角色，例如：作为<strong>颜色附件</strong> ( $\text{COLOR_ATTACHMENT_BIT}$)，还是作为<strong>纹理</strong>来读取。<strong>这是驱动程序内部优化图像资源布局的依据。</strong></td></tr></tbody></table></div><p>对应的代码：</p><ul><li><strong>图像数量</strong>：<code>createInfo.minImageCount = imageCount;</code> （通过 <code>vkGetPhysicalDeviceSurfaceCapabilitiesKHR</code> 来查询得到这个数据）</li><li><strong>图像分辨率 (Extent)</strong>：<code>createInfo.imageExtent = extent; </code>（同样通过上面的capability，但结合glfw的窗口大小设定）</li><li><strong>图像格式 (Format)</strong>：<code>createInfo.imageFormat = surfaceFormat.format; createInfo.imageColorSpace = surfaceFormat.colorSpace; </code>（通过 <code>vkGetPhysicalDeviceSurfaceFormatsKHR</code> 来查询）</li><li><strong>图像用途 (Usage)</strong>：<code>createInfo.imageUsage = VK_IMAGE_USAGE_COLOR_ATTACHMENT_BIT; </code>（常规渲染的用户设定就是颜色附件）</li></ul><h4 id=指令方面-commandbuffer相关>指令方面 （CommandBuffer相关）</h4><div class=table-wrapper><table><thead><tr><th><strong>核心设定</strong></th><th><strong>对应的代码字段</strong></th><th><strong>设定的原理/为什么需要？</strong></th></tr></thead><tbody><tr><td><strong>图像共享模式 (Sharing Mode)</strong></td><td>$\text{imageSharingMode}$ / $\text{pQueueFamilyIndices}$</td><td>决定了图形队列（生产者）和呈现队列（消费者）对图像的<strong>访问权限</strong>。如果两个队列不同，选择<strong>并发</strong>模式可以消除显式的<strong>所有权转移</strong>步骤，简化同步，提高效率。<strong>这是多队列同步机制的基础。</strong></td></tr><tr><td></td><td></td><td></td></tr><tr><td>swapchain逻辑上有两个队列：图形队列（生产者）、呈现队列（消费者）</td><td></td><td></td></tr></tbody></table></div><p>如果物理上也是两个队列，可以并发：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>createInfo<span style=color:#1f2328>.</span>imageSharingMode <span style=color:#0550ae>=</span> VK_SHARING_MODE_CONCURRENT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>createInfo<span style=color:#1f2328>.</span>queueFamilyIndexCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>2</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>createInfo<span style=color:#1f2328>.</span>pQueueFamilyIndices <span style=color:#0550ae>=</span> queueFamilyIndices<span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><p>如果物理上是一个队列，需要共享，因此要有锁机制：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>createInfo<span style=color:#1f2328>.</span>imageSharingMode <span style=color:#0550ae>=</span> VK_SHARING_MODE_EXCLUSIVE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 队列可以忽略不用配置，实际上使用的时候需要自己加锁，硬件不保证。
</span></span></span></code></pre></td></tr></table></div></div><p>注意：队列实际上是用来上传 <code>commandBuffer</code> 的队列。swapchain则配置了不同种类 <code>commandBuffer</code> 队列如何协同。</p><h3 id=其他显示配置呈现模式alpha合成动态变化设置>其他显示配置（呈现模式、Alpha合成、动态变化设置）</h3><p>这是关于渲染完成的帧如何以及何时被显示器接收和呈现给用户的策略。</p><div class=table-wrapper><table><thead><tr><th><strong>核心设定</strong></th><th><strong>对应的代码字段</strong></th><th><strong>设定的原理/为什么需要？</strong></th></tr></thead><tbody><tr><td><strong>呈现模式 (Present Mode)</strong></td><td>$\text{presentMode}$</td><td>决定了渲染完成的图像如何被提交给显示器。例如：是等待<strong>垂直消隐</strong>（$\text{V-Sync}$ 模式，消除画面撕裂），还是<strong>立即呈现</strong>（$\text{Immediate}$ 模式，可能撕裂但延迟最低）。<strong>这是控制应用程序帧率和视觉流畅性的关键。</strong></td></tr><tr><td><strong>Alpha 合成模式 (Composite Alpha)</strong></td><td>$\text{compositeAlpha}$</td><td>决定了 $\text{Swap Chain}$ 图像的 $\text{alpha}$ 通道如何与底层的<strong>桌面背景</strong>进行混合。$\text{OPAQUE_BIT}$（不透明）是常见选择，因为它更简单高效。<strong>这是与窗口管理器（$\text{Window Manager}$）合成最终画面的契约。</strong></td></tr><tr><td><strong>旧交换链引用 (Old Swapchain)</strong></td><td>$\text{oldSwapchain}$</td><td>在窗口大小改变时，用于引用旧的、即将被销毁的 $\text{Swap Chain}$。这允许驱动程序在重建过程中<strong>重用资源或图像数据</strong>（如果可能），实现<strong>平滑无缝</strong>的 $\text{Swap Chain}$ 替换。<strong>这是处理窗口动态变化的健壮性要求。</strong></td></tr><tr><td><strong>预变换 (Pre-Transform)</strong></td><td>$\text{preTransform}$</td><td>告知驱动程序在呈现图像之前，是否需要进行<strong>旋转</strong>、<strong>镜像</strong>等操作，以适应窗口的当前状态（例如手机横屏）。<strong>这允许 GPU 在硬件层面进行高效的最终图像调整。</strong></td></tr><tr><td><strong>裁剪 ($\text{clipped}$)</strong></td><td>clipped</td><td>指示驱动程序是否可以放弃渲染被其他窗口遮挡的像素。</td></tr></tbody></table></div><ul><li><strong>呈现模式 (Present Mode)</strong> ：<code>createInfo.presentMode = presentMode;</code> （默认查询并选择了 <code>VK_PRESENT_MODE_MAILBOX_KHR</code> ，取最新渲染好的帧）</li><li><strong>alpha合成</strong>： 暂时没有设定</li><li><strong>旧交换链</strong>： 暂时没有设定</li><li><strong>Pre-Transform</strong> : <code>createInfo.preTransform = swapChainSupport.capabilities.currentTransform;</code></li><li><strong>裁剪</strong>: <code>createInfo.clipped = VK_TRUE;</code></li></ul><h2 id=创建-imageview创建framebuffer接口>创建 ImageView(创建FrameBuffer接口)</h2><p>主要代码：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>vkCreateImageView<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>createInfo<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                            <span style=color:#0550ae>&amp;</span>swapChainImageViews<span style=color:#1f2328>[</span>i<span style=color:#1f2328>])</span> 
</span></span></code></pre></td></tr></table></div></div><p>最后得到的是 <code>VkImageView</code> 数组。即函数最后一个参数。这步也是为了渲染准备。</p><h1 id=vulkan初始化-渲染相关>Vulkan初始化-渲染相关</h1><h2 id=创建-renderpass>创建 RenderPass</h2><p>可以理解为生产1帧图像的，多个工厂的集合（产业集）。每个图像、Attachment，都可以理解为一个原材料仓库。这个层级定义的仓库主要是图像/模板的产出。（此外，还有各种VertexBuffer其实也是原材料，但没有在这个层级定义。）</p><div class=table-wrapper><table><thead><tr><th><strong>Render Pass 概念</strong></th><th><strong>工厂比喻</strong></th><th><strong>对应作用</strong></th></tr></thead><tbody><tr><td><strong>Render Pass (整体)</strong></td><td><strong>产业集 / 工厂群</strong></td><td>定义整个帧的生产计划，包含多个工厂（Subpass），规划各工厂如何使用仓库（Attachment）和产出最终产品（Framebuffer）。</td></tr><tr><td><strong>Attachment (附件)</strong></td><td><strong>原材料仓库 / 半成品仓库</strong></td><td>存储渲染所需的原料或半成品（颜色、深度、模板数据）。定义物料的格式和生产前后的状态。</td></tr><tr><td><strong>Subpass (子通道)</strong></td><td><strong>单个工厂 / 车间</strong></td><td>产业集中的具体工厂，每个工厂负责一条或多条生产线（Pipeline）来完成特定生产任务（例如先渲染不透明物体，再渲染透明物体）。</td></tr><tr><td><strong>Attachment Reference</strong></td><td><strong>工厂与仓库的连接</strong></td><td>指示工厂从哪些仓库获取原料，以及将生产结果输出到哪个仓库（颜色输出、深度输入等）。</td></tr><tr><td><strong>Subpass Dependency</strong></td><td><strong>工厂间的物流/依赖关系</strong></td><td>确保工厂之间严格按顺序作业，例如工厂 A 必须完成某些半成品，工厂 B 才能开始生产。</td></tr><tr><td><strong>Load Op / Store Op</strong></td><td><strong>工厂的物料装卸规则</strong></td><td>决定工厂开始生产前是否清空仓库（LOAD_OP_CLEAR），以及生产结束后是否将新产品存回仓库（STORE_OP_STORE）。这是工厂层面的操作，而不是生产线（Pipeline）的操作。</td></tr></tbody></table></div><p>创建 Render Pass 需要围绕 <strong>“什么数据”、“如何处理”</strong> 和 <strong>“何时处理”</strong> 这三个问题进行定义：</p><ol><li><strong>定义附件 (Attachments)：</strong> 描述 Render Pass 将使用的所有图像资源（格式、采样、Load/Store 操作和初始/最终布局）。</li><li><strong>定义子通道 (Subpasses)：</strong> 描述渲染管线的实际阶段，并指定每个子通道使用哪些附件作为输入、输出、深度/模板。</li><li><strong>定义依赖 (Dependencies)：</strong> 描述子通道之间或子通道与外部操作之间的执行和内存同步。</li></ol><h3 id=附件attachments>附件(Attachments)</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>VkAttachmentDescription colorAttachment<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>colorAttachment<span style=color:#1f2328>.</span>format <span style=color:#0550ae>=</span> swapChainImageFormat<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>colorAttachment<span style=color:#1f2328>.</span>samples <span style=color:#0550ae>=</span> VK_SAMPLE_COUNT_1_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>colorAttachment<span style=color:#1f2328>.</span>loadOp <span style=color:#0550ae>=</span> VK_ATTACHMENT_LOAD_OP_CLEAR<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>colorAttachment<span style=color:#1f2328>.</span>storeOp <span style=color:#0550ae>=</span> VK_ATTACHMENT_STORE_OP_STORE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>colorAttachment<span style=color:#1f2328>.</span>stencilLoadOp <span style=color:#0550ae>=</span> VK_ATTACHMENT_LOAD_OP_DONT_CARE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>colorAttachment<span style=color:#1f2328>.</span>stencilStoreOp <span style=color:#0550ae>=</span> VK_ATTACHMENT_STORE_OP_DONT_CARE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>colorAttachment<span style=color:#1f2328>.</span>initialLayout <span style=color:#0550ae>=</span> VK_IMAGE_LAYOUT_UNDEFINED<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>colorAttachment<span style=color:#1f2328>.</span>finalLayout <span style=color:#0550ae>=</span> VK_IMAGE_LAYOUT_PRESENT_SRC_KHR<span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=loadop-和-storeop>LoadOp 和 StoreOp</h4><p>注意到有普通的，还有带模板前缀（stencil）的。这是因为，颜色附件的设计是通用的，可以描述：<strong>颜色附件</strong> (Color Attachment)、<strong>深度附件</strong> (Depth Attachment)、<strong>深度/模板附件</strong> (Depth-Stencil Attachment)</p><p>这里进一步深入说一下：</p><div class=table-wrapper><table><thead><tr><th><strong>概念</strong></th><th><strong>形象化比喻</strong></th><th><strong>实际作用的精确解释</strong></th></tr></thead><tbody><tr><td><strong><code>loadOp</code>/<code>storeOp</code></strong> (用于颜色)</td><td><strong>直接写入/读出颜料</strong></td><td>控制渲染管线中 <strong>颜色输出阶段</strong> 对 <strong>颜色附件（Color Attachment）</strong> 的操作。渲染结束后，结果直接覆盖或写入到颜色数据区域。</td></tr><tr><td><strong><code>loadOp</code>/<code>storeOp</code></strong> (用于深度)</td><td><strong>写入/读出 Z 坐标卡</strong></td><td>控制渲染管线中 <strong>深度测试阶段</strong> 对 <strong>深度附件</strong> 的操作。它存储每个像素的 $Z$ 深度值，用于比较遮挡关系。</td></tr><tr><td><strong><code>stencilLoadOp</code>/<code>stencilStoreOp</code></strong> (用于模板)</td><td><strong>写入/读出“遮罩板”的编号/标记</strong></td><td>控制渲染管线中 <strong>模板测试阶段</strong> 对 <strong>模板附件</strong> 的操作。模板值是一个整数标记，用于 <strong>控制</strong> 哪些像素可以进行颜色写入或深度写入，但 <strong>它本身不是颜色</strong>。</td></tr><tr><td>模板v.s.普通操作：</td><td></td><td></td></tr></tbody></table></div><ul><li>相同点：都写入FrameBuffer。</li><li>不同点：<strong>模板的作用是控制：</strong> 模板的独特之处在于，它的 <strong>主要功能</strong> 不是存储最终画面数据（像颜色），也不是存储几何深度数据（像深度），而是作为一个 <strong>可编程的掩码或控制机制</strong>。它决定了当前的 Fragment 是否应该通过测试并继续影响颜色或深度缓冲区。</li></ul><h4 id=finallayout>finalLayout</h4><p>当前代码：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>colorAttachment<span style=color:#1f2328>.</span>finalLayout <span style=color:#0550ae>=</span> VK_IMAGE_LAYOUT_PRESENT_SRC_KHR<span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>finalLayout</code> 决定了图像在 Render Pass 结束后应处于的 <strong>布局状态</strong>，以便 GPU 知道如何处理后续的操作。不同的配置决定了图像的“下一站”是什么。可能的下一站：<ul><li>显示到屏幕 (Present)</li><li><strong>作为纹理输入</strong></li><li><strong>作为传输源</strong></li><li>**作为传输目标</li><li>作为下一帧/Render Pass 的颜色附件 : <code>VK_IMAGE_LAYOUT_COLOR_ATTACHMENT_OPTIMAL</code></li></ul></li></ul><h3 id=子通道subpasses>子通道(Subpasses)</h3><p>这个是更加具体的生产线。因此我们在创建具体 Pipeline 的时候要绑定到subpass。</p><pre tabindex=0><code class=language-cppp data-lang=cppp>VkAttachmentReference colorAttachmentRef{};
colorAttachmentRef.attachment = 0; // 这个代表索引0，和renderPassInfo.pAttachments[0]对应
colorAttachmentRef.layout = VK_IMAGE_LAYOUT_COLOR_ATTACHMENT_OPTIMAL;

VkSubpassDescription subpass{};
subpass.pipelineBindPoint = VK_PIPELINE_BIND_POINT_GRAPHICS;
subpass.colorAttachmentCount = 1;
subpass.pColorAttachments = &amp;colorAttachmentRef;
</code></pre><ul><li><code>colorAttachmentRef.layout = VK_IMAGE_LAYOUT_COLOR_ATTACHMENT_OPTIMAL;</code> : 这个布局告诉 <strong>GPU 驱动程序</strong> 和 <strong>管线</strong>：在 <strong>当前这个 Subpass (子通道) 执行期间</strong>，这个图像将作为 <strong>颜色附件</strong> 被写入。（工作状态）<ul><li>而颜色附件描述的 <code>finalLayout</code> 则是颜色附件最终的走向。（Render Pass结束时，最终状态）</li></ul></li><li><code>VK_PIPELINE_BIND_POINT_GRAPHICS</code> : 代表这个subpass是用来被 GraphicsPipeline绑定的。即这是个图形生产线。<ul><li>另一种选择是： <code>VK_PIPELINE_BIND_POINT_COMPUTE</code> 。意味着绑定的是计算生产线。</li></ul></li></ul><h3 id=依赖dependencies>依赖(Dependencies)</h3><p>这里主要设定subpass生产线工作的依赖条件。可以是其他subpass，也可以是颜色附件的状态（<code>VK_SUBPASS_EXTERNAL</code>）。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>VkSubpassDependency dependency<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>dependency<span style=color:#1f2328>.</span>srcSubpass <span style=color:#0550ae>=</span> VK_SUBPASS_EXTERNAL<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>dependency<span style=color:#1f2328>.</span>dstSubpass <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span> <span style=color:#57606a>// 索引为0的subpass
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>dependency<span style=color:#1f2328>.</span>srcStageMask <span style=color:#0550ae>=</span> VK_PIPELINE_STAGE_COLOR_ATTACHMENT_OUTPUT_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>dependency<span style=color:#1f2328>.</span>srcAccessMask <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>dependency<span style=color:#1f2328>.</span>dstStageMask <span style=color:#0550ae>=</span> VK_PIPELINE_STAGE_COLOR_ATTACHMENT_OUTPUT_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>dependency<span style=color:#1f2328>.</span>dstAccessMask <span style=color:#0550ae>=</span> VK_ACCESS_COLOR_ATTACHMENT_WRITE_BIT<span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><p>类比：</p><ul><li>subpass:<ul><li>src: 上一个人。</li><li>dst: 下一个人。</li></ul></li><li>stage:（关心的步骤）<ul><li>src: 上一个人执行到步骤 srcStage （等待触发的条件，如果src正处于这个阶段）</li><li>dst: 下一个人开始执行步骤 dstStage（等待触发的时刻，dst要进入这个阶段）</li></ul></li><li>access:（关心的具体做了什么）<ul><li>src: 上一个人需完成的动作 srcAccess（等待触发的条件，如果src正在完成某个访问）</li><li>dst: 下一个人将要完成的动作 dstAccess（等待触发的时刻，dst要执行某个访问）</li></ul></li></ul><p>用一句话简单描述：
<strong>当下一个人（将要进入 dstStage&&amp;dstAccess 所定义的状态时），需要看一下上一个人（src是否在 srcStage && srcAccess 所定义的状态；如果在，则等待其离开）</strong>。</p><p>代码里的，效果来说：</p><ol><li>当subpass执行到要对颜色附件写入阶段，并且要获取AccessMask的动作时：</li><li>如果由外部过程正处于对颜色附件写入的状态时（不管它Access是什么样的），此时等待其完成。</li></ol><p>注意：这个描述当空条件的时候，dst也会执行的。即，并不是dst依赖src的完成，而仅仅关注是否有src处于描述中的状态，仅等待这个状态而已。</p><h2 id=创建-graphicspipeline>创建 GraphicsPipeline</h2><p>考虑subpass类比为一个工厂/车间，那么Pipeline则是一个具体的生产线。而生产线的各个部分的定义可以类比：</p><div class=table-wrapper><table><thead><tr><th><strong>Pipeline 配置项</strong></th><th><strong>生产线比喻</strong></th><th><strong>对应作用</strong></th></tr></thead><tbody><tr><td><strong>Shader Stage（顶点/片段着色器）</strong></td><td><strong>工人技能</strong></td><td>决定生产线上工人如何加工原料（顶点/片段数据）。</td></tr><tr><td><strong>Vertex Input</strong></td><td><strong>原料装配台</strong></td><td>定义原料规格和布局（顶点属性、缓冲区绑定）。</td></tr><tr><td><strong>Input Assembly</strong></td><td><strong>工序顺序</strong></td><td>定义如何把原料组合成半成品（三角形列表、带、扇等）。</td></tr><tr><td><strong>Viewport / Scissor</strong></td><td><strong>操作区域 / 工作台范围</strong></td><td>决定工人在哪个区域操作，哪些区域允许加工。</td></tr><tr><td><strong>Dynamic State</strong></td><td><strong>可调节工作台</strong></td><td>可在生产过程中灵活调整参数（视口、剪裁等）。</td></tr><tr><td><strong>Rasterizer</strong></td><td><strong>模具 / 加工方式</strong></td><td>决定半成品如何变成最终产品（填充模式、剔除模式、线宽）。</td></tr><tr><td><strong>Multisampling</strong></td><td><strong>品质控制工序</strong></td><td>决定产品的平滑度和抗锯齿质量。</td></tr><tr><td><strong>Depth / Stencil</strong></td><td><strong>质量检测工序</strong></td><td>判断半成品覆盖情况或是否允许加工。</td></tr><tr><td><strong>Color Blend</strong></td><td><strong>上色 / 涂装工序</strong></td><td>决定最终产品颜色如何叠加。</td></tr><tr><td><strong>Pipeline Layout</strong></td><td><strong>工人手册 / 工具</strong></td><td>定义工人可以使用的工具（uniform buffer、push constants）。</td></tr><tr><td>通过这个表可以看出，我们如果需要具体渲染，主要就是和 GraphicsPipeline 打交道。这里每个生产线最终产出的都是一个framebuffer。</td><td></td><td></td></tr></tbody></table></div><h3 id=shader-stage>Shader Stage</h3><p>这个很容易理解，就是原本图形接口的各个shader，我们需要编译好。把它装配到流水线上。因为它比较灵活，所以理解为流水线上的工人也没有问题。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>auto</span> vertShaderCode <span style=color:#0550ae>=</span> readFile<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;./build/shaders/shader.vert.spv&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>auto</span> fragShaderCode <span style=color:#0550ae>=</span> readFile<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;./build/shaders/shader.frag.spv&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>auto</span> vertShaderModule <span style=color:#0550ae>=</span> createShaderModule<span style=color:#1f2328>(</span>vertShaderCode<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>auto</span> fragShaderModule <span style=color:#0550ae>=</span> createShaderModule<span style=color:#1f2328>(</span>fragShaderCode<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>VkPipelineShaderStageCreateInfo vertShaderStageInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>vertShaderStageInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span>
</span></span><span style=display:flex><span>	VK_STRUCTURE_TYPE_PIPELINE_SHADER_STAGE_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>vertShaderStageInfo<span style=color:#1f2328>.</span>stage <span style=color:#0550ae>=</span> VK_SHADER_STAGE_VERTEX_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>vertShaderStageInfo<span style=color:#1f2328>.</span>module <span style=color:#0550ae>=</span> vertShaderModule<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>vertShaderStageInfo<span style=color:#1f2328>.</span>pName <span style=color:#0550ae>=</span> <span style=color:#0a3069>&#34;main&#34;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>VkPipelineShaderStageCreateInfo fragShaderStageInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>fragShaderStageInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span>
</span></span><span style=display:flex><span>	VK_STRUCTURE_TYPE_PIPELINE_SHADER_STAGE_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>fragShaderStageInfo<span style=color:#1f2328>.</span>stage <span style=color:#0550ae>=</span> VK_SHADER_STAGE_FRAGMENT_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>fragShaderStageInfo<span style=color:#1f2328>.</span>module <span style=color:#0550ae>=</span> fragShaderModule<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>fragShaderStageInfo<span style=color:#1f2328>.</span>pName <span style=color:#0550ae>=</span> <span style=color:#0a3069>&#34;main&#34;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>VkPipelineShaderStageCreateInfo shaderStages<span style=color:#1f2328>[]</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span>vertShaderStageInfo<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>												  fragShaderStageInfo<span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>												  
</span></span><span style=display:flex><span><span style=color:#57606a>// ...忽略中间
</span></span></span><span style=display:flex><span><span style=color:#57606a>// 最后需要释放掉创建的shaderModule
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>vkDestroyShaderModule<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> fragShaderModule<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>vkDestroyShaderModule<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> vertShaderModule<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=vertex-inputvertexbuffer格式><strong>Vertex Input</strong>（VertexBuffer格式）</h3><p>定义原料规格和布局（顶点属性、缓冲区绑定）。</p><p>我们这里没有用外部的顶点数据。所以没设置。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>VkPipelineVertexInputStateCreateInfo vertexInputInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>vertexInputInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span>
</span></span><span style=display:flex><span>	VK_STRUCTURE_TYPE_PIPELINE_VERTEX_INPUT_STATE_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>vertexInputInfo<span style=color:#1f2328>.</span>vertexBindingDescriptionCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>vertexInputInfo<span style=color:#1f2328>.</span>pVertexBindingDescriptions <span style=color:#0550ae>=</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>;</span> <span style=color:#57606a>// Optional
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>vertexInputInfo<span style=color:#1f2328>.</span>vertexAttributeDescriptionCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>vertexInputInfo<span style=color:#1f2328>.</span>pVertexAttributeDescriptions <span style=color:#0550ae>=</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>;</span> <span style=color:#57606a>// Optional
</span></span></span></code></pre></td></tr></table></div></div><p>如果使用顶点数据，考虑顶点数据结构：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Vertex</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    glm<span style=color:#0550ae>::</span>vec2 pos<span style=color:#1f2328>;</span>    <span style=color:#57606a>// 位置
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    glm<span style=color:#0550ae>::</span>vec3 color<span style=color:#1f2328>;</span>  <span style=color:#57606a>// 颜色
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>pos</code> 对应 <code>location = 0</code></li><li><code>color</code> 对应 <code>location = 1</code></li><li>(location是在shader中绑定这些变量的描述)</li></ul><p>那么：顶点缓冲区绑定描述（Vertex Binding）</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>VkVertexInputBindingDescription bindingDescription<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>bindingDescription<span style=color:#1f2328>.</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>                        <span style=color:#57606a>// 绑定点 0
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>bindingDescription<span style=color:#1f2328>.</span>stride <span style=color:#0550ae>=</span> <span style=color:#cf222e>sizeof</span><span style=color:#1f2328>(</span>Vertex<span style=color:#1f2328>);</span>             <span style=color:#57606a>// 每个顶点占用字节
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>bindingDescription<span style=color:#1f2328>.</span>inputRate <span style=color:#0550ae>=</span> VK_VERTEX_INPUT_RATE_VERTEX<span style=color:#1f2328>;</span> <span style=color:#57606a>// 每个顶点变化一次
</span></span></span></code></pre></td></tr></table></div></div><ul><li>这里是每顶点模式（用顶点渲染的指令），还有每实例模式（需要用实例渲染的一些指令）。<ul><li>差别在于，vertex shader在每顶点模式处理所有顶点，比较基础的处理方式；在每实例模式，顶点数据虽然只有一份但是按照实例数目来处理多次（不同的实例，顶点数据可以复用；此外，通过额外传入实例的特有信息来辅助处理，比如索引、矩阵等等）</li></ul></li></ul><p>顶点属性描述（Vertex Attributes）</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#0550ae>::</span>array<span style=color:#0550ae>&lt;</span>VkVertexInputAttributeDescription<span style=color:#1f2328>,</span> <span style=color:#0550ae>2</span><span style=color:#0550ae>&gt;</span> attributeDescriptions<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 位置属性
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>                <span style=color:#57606a>// 对应绑定点 0
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>               <span style=color:#57606a>// shader 中 location 0
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>format <span style=color:#0550ae>=</span> VK_FORMAT_R32G32_SFLOAT<span style=color:#1f2328>;</span> <span style=color:#57606a>// vec2
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>offset <span style=color:#0550ae>=</span> offsetof<span style=color:#1f2328>(</span>Vertex<span style=color:#1f2328>,</span> pos<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 颜色属性
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>                <span style=color:#57606a>// 同绑定点 0
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>               <span style=color:#57606a>// shader 中 location 1
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>format <span style=color:#0550ae>=</span> VK_FORMAT_R32G32B32_SFLOAT<span style=color:#1f2328>;</span> <span style=color:#57606a>// vec3
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>offset <span style=color:#0550ae>=</span> offsetof<span style=color:#1f2328>(</span>Vertex<span style=color:#1f2328>,</span> color<span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><p>最后就是 更新 <code>VkPipelineVertexInputStateCreateInfo</code> 。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>VkPipelineVertexInputStateCreateInfo vertexInputInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>vertexInputInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_PIPELINE_VERTEX_INPUT_STATE_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>vertexInputInfo<span style=color:#1f2328>.</span>vertexBindingDescriptionCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>vertexInputInfo<span style=color:#1f2328>.</span>pVertexBindingDescriptions <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>bindingDescription<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>vertexInputInfo<span style=color:#1f2328>.</span>vertexAttributeDescriptionCount <span style=color:#0550ae>=</span> <span style=color:#cf222e>static_cast</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>uint32_t</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>attributeDescriptions<span style=color:#1f2328>.</span>size<span style=color:#1f2328>());</span>
</span></span><span style=display:flex><span>vertexInputInfo<span style=color:#1f2328>.</span>pVertexAttributeDescriptions <span style=color:#0550ae>=</span> attributeDescriptions<span style=color:#1f2328>.</span>data<span style=color:#1f2328>();</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=input-assemblyindexbuffer格式><strong>Input Assembly</strong>（IndexBuffer格式）</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>VkPipelineInputAssemblyStateCreateInfo inputAssembly<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>inputAssembly<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span>
</span></span><span style=display:flex><span>	VK_STRUCTURE_TYPE_PIPELINE_INPUT_ASSEMBLY_STATE_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>inputAssembly<span style=color:#1f2328>.</span>topology <span style=color:#0550ae>=</span> VK_PRIMITIVE_TOPOLOGY_TRIANGLE_LIST<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>inputAssembly<span style=color:#1f2328>.</span>primitiveRestartEnable <span style=color:#0550ae>=</span> VK_FALSE<span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><p>主要描述顶点所组成的图元。但是没有描述顶点的连接关系。但图元关系的确认，会影响到 IndexBuffer的解析。不同的定义方式，会按照不同方法来解析IndexBuffer。</p><h3 id=viewport--scissor><strong>Viewport / Scissor</strong></h3><p>视口和裁剪的设定。这个相对比较容易。不解释。</p><h3 id=dynamic-state><strong>Dynamic State</strong></h3><p>这里把 视口和裁剪的设定。 也设置为了 <strong>Dynamic State</strong> 。所谓 <strong>Dynamic State</strong> ，是Pipeline创建好了之后，每次渲染的时候，可以动态变更的参数。</p><h3 id=rasterizer>Rasterizer</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>// rasterizer配置
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>VkPipelineRasterizationStateCreateInfo rasterizer<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>rasterizer<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span>
</span></span><span style=display:flex><span>	VK_STRUCTURE_TYPE_PIPELINE_RASTERIZATION_STATE_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>rasterizer<span style=color:#1f2328>.</span>depthClampEnable <span style=color:#0550ae>=</span> VK_FALSE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>rasterizer<span style=color:#1f2328>.</span>rasterizerDiscardEnable <span style=color:#0550ae>=</span> VK_FALSE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>rasterizer<span style=color:#1f2328>.</span>polygonMode <span style=color:#0550ae>=</span> VK_POLYGON_MODE_FILL<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#57606a>// Using any mode other than fill requires enabling a GPU feature.
</span></span></span><span style=display:flex><span><span style=color:#57606a>// 如果用不是1.0f的值，需要开启 wide lines 功能
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>rasterizer<span style=color:#1f2328>.</span>lineWidth <span style=color:#0550ae>=</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>rasterizer<span style=color:#1f2328>.</span>cullMode <span style=color:#0550ae>=</span> VK_CULL_MODE_BACK_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>rasterizer<span style=color:#1f2328>.</span>frontFace <span style=color:#0550ae>=</span> VK_FRONT_FACE_CLOCKWISE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rasterizer<span style=color:#1f2328>.</span>depthBiasEnable <span style=color:#0550ae>=</span> VK_FALSE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>rasterizer<span style=color:#1f2328>.</span>depthBiasConstantFactor <span style=color:#0550ae>=</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>;</span> <span style=color:#57606a>// Optional
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>rasterizer<span style=color:#1f2328>.</span>depthBiasClamp <span style=color:#0550ae>=</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>;</span>          <span style=color:#57606a>// Optional
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>rasterizer<span style=color:#1f2328>.</span>depthBiasSlopeFactor <span style=color:#0550ae>=</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>;</span>    <span style=color:#57606a>// Optional
</span></span></span></code></pre></td></tr></table></div></div><p>光栅化流程的参数设置。定义顶点（或者说图元）到片元的转化规则。</p><h3 id=multisampling>Multisampling</h3><p>多重采样设置。画三角形没开启。</p><h3 id=depthstencil>Depth/Stencil</h3><p>深度和模板测试。画三角形没开启。</p><h3 id=color-blend><strong>Color Blend</strong></h3><p>颜色融合。画三角形没开启。</p><h3 id=pipeline-layout>Pipeline Layout</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>// Pipeline Layout 定义 shader 资源布局
</span></span></span><span style=display:flex><span><span style=color:#57606a>// 说明 shader 能访问哪些资源（Uniform Buffer, Texture, Storage Buffer 等）
</span></span></span><span style=display:flex><span><span style=color:#57606a>// 以及绑定点和 Push Constants 的范围
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span>VkPipelineLayoutCreateInfo pipelineLayoutInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>pipelineLayoutInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_PIPELINE_LAYOUT_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>pipelineLayoutInfo<span style=color:#1f2328>.</span>setLayoutCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>            <span style=color:#57606a>// Optional
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>pipelineLayoutInfo<span style=color:#1f2328>.</span>pSetLayouts <span style=color:#0550ae>=</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>;</span>         <span style=color:#57606a>// Optional
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>pipelineLayoutInfo<span style=color:#1f2328>.</span>pushConstantRangeCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>    <span style=color:#57606a>// Optional
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>pipelineLayoutInfo<span style=color:#1f2328>.</span>pPushConstantRanges <span style=color:#0550ae>=</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>;</span> <span style=color:#57606a>// Optional
</span></span></span></code></pre></td></tr></table></div></div><p>uniform buffer可以理解为把对shader预留一些dynamic state出来，在渲染的时候可以动态改变。这里layout定义，主要定义这些变量如何映射到shader的环境中。</p><p>更准确的描述：</p><ul><li><strong>Pipeline Layout</strong> 并不是具体存储 uniform buffer 的内容，它只是 <strong>定义 shader 的资源接口</strong>：<ul><li><strong>Descriptor Set Layouts</strong>（<code>pSetLayouts</code>）：定义哪些资源（Uniform Buffer, Storage Buffer, Texture 等）会被绑定到 shader，以及它们在 shader 里对应的 binding。</li><li><strong>Push Constants</strong>（<code>pPushConstantRanges</code>）：定义一小块快速更新的数据范围，也会映射到 shader 里。</li></ul></li></ul><blockquote><p>换句话说，它是 <strong>shader 资源布局的“描述表”</strong>，告诉 Vulkan 管线在渲染时 shader 会访问哪些资源以及如何访问。</p></blockquote><h2 id=创建-framebuffers>创建 FrameBuffers</h2><p>做法很显然，根据swapchain中的imageview来创建即可。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>VkImageView attachments<span style=color:#1f2328>[]</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span>swapChainImageViews<span style=color:#1f2328>[</span>i<span style=color:#1f2328>]};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>VkFramebufferCreateInfo framebufferInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>framebufferInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_FRAMEBUFFER_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>framebufferInfo<span style=color:#1f2328>.</span>renderPass <span style=color:#0550ae>=</span> renderPass<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>framebufferInfo<span style=color:#1f2328>.</span>attachmentCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>framebufferInfo<span style=color:#1f2328>.</span>pAttachments <span style=color:#0550ae>=</span> attachments<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>framebufferInfo<span style=color:#1f2328>.</span>width <span style=color:#0550ae>=</span> swapChainExtent<span style=color:#1f2328>.</span>width<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>framebufferInfo<span style=color:#1f2328>.</span>height <span style=color:#0550ae>=</span> swapChainExtent<span style=color:#1f2328>.</span>height<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>framebufferInfo<span style=color:#1f2328>.</span>layers <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><p>值得注意的是：framebuffer可以绑定多个 attachment。所以严格来说一个framebuffer可以关联大量图片资源。当然这些如果先渲染中想要用到，必须在renderpass和subpass中绑定。</p><p>因此真正渲染工作的时候，可以猜测是需要 framebuffer和renderpass绑定。同时它们的attachments定义要能够配对上。</p><p><strong>Framebuffer 与 RenderPass 的关系</strong></p><ul><li><code>VkFramebuffer</code> 是对一组 <code>VkImageView</code> 的封装，表示某次渲染将会使用的具体图像资源。</li><li>每个 <code>Framebuffer</code> 必须绑定一个 <code>RenderPass</code>。</li><li>绑定的 <code>RenderPass</code> 决定了这个 <code>Framebuffer</code> 中的 attachments 的 <strong>数量、格式、样式（load/store ops）</strong>。</li><li><strong>关键</strong>：<code>Framebuffer</code> 的 attachments 数量和顺序 <strong>必须和 RenderPass 的 attachment 描述完全匹配</strong>。</li></ul><h2 id=创建-commandpool>创建 CommandPool</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>QueueFamilyIndices queueFamilyIndices <span style=color:#0550ae>=</span> findQueueFamilies<span style=color:#1f2328>(</span>physicalDevice<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 创建图形指令的命令池
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>VkCommandPoolCreateInfo poolInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>poolInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_COMMAND_POOL_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>poolInfo<span style=color:#1f2328>.</span>flags <span style=color:#0550ae>=</span> VK_COMMAND_POOL_CREATE_RESET_COMMAND_BUFFER_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>poolInfo<span style=color:#1f2328>.</span>queueFamilyIndex <span style=color:#0550ae>=</span> queueFamilyIndices<span style=color:#1f2328>.</span>graphicsFamily<span style=color:#1f2328>.</span>value<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>vkCreateCommandPool<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>poolInfo<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>commandPool<span style=color:#1f2328>)</span> <span style=color:#0550ae>!=</span>
</span></span><span style=display:flex><span>	VK_SUCCESS<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to create command pool!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>队列（Queue）和 <code>vkGetQueue</code></strong></p><ul><li>队列是 GPU 执行命令的“通道”，每个队列属于某个队列族（Queue Family）。</li><li><code>vkGetQueue(device, queueFamilyIndex, 0, &amp;queue)</code> 得到的只是一个 <strong>句柄</strong>，可以用它提交命令执行。</li><li>队列本身<strong>不存储命令</strong>，它只是执行命令的管道。</li></ul><p><strong>CommandPool 的作用</strong></p><ul><li><code>VkCommandPool</code> 是 <strong>分配命令缓冲区 (CommandBuffer) 的内存池</strong>。</li><li>它是 GPU 内存管理的一层封装，用来高效管理命令缓冲区的创建、重置和回收。</li><li>创建命令缓冲区（CommandBuffer）<strong>必须依附于某个 CommandPool</strong>。</li><li>CommandPool 与 <strong>队列族绑定</strong>，也就是这个 pool 创建出来的命令缓冲区只能提交给这个队列族的队列。</li></ul><p><strong>CommandBuffer 的作用</strong></p><ul><li><code>CommandBuffer</code> 是实际记录 GPU 命令的容器（画图、复制、计算、内存屏障等）。</li><li>你 <strong>不能直接往队列里提交绘制操作</strong>，必须先把操作记录到 CommandBuffer。</li><li>CommandBuffer 的生命周期由 CommandPool 管理。</li></ul><p>总结：</p><ul><li>队列（Queue） = 执行命令的管道。</li><li>CommandPool = 管理命令缓冲区的“内存池”，绑定到特定队列族。</li><li>CommandBuffer = 真正记录 GPU 命令的对象，需要从 CommandPool 分配。</li></ul><h2 id=创建-commandbuffers>创建 CommandBuffers</h2><p>很显然，根据swapchain中image数量创建即可。创建需要使用到 commandPool</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>commandBuffers<span style=color:#1f2328>.</span>resize<span style=color:#1f2328>(</span>swapChainImageViews<span style=color:#1f2328>.</span>size<span style=color:#1f2328>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>VkCommandBufferAllocateInfo allocInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>allocInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_COMMAND_BUFFER_ALLOCATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>allocInfo<span style=color:#1f2328>.</span>commandPool <span style=color:#0550ae>=</span> commandPool<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>allocInfo<span style=color:#1f2328>.</span>level <span style=color:#0550ae>=</span> VK_COMMAND_BUFFER_LEVEL_PRIMARY<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>allocInfo<span style=color:#1f2328>.</span>commandBufferCount <span style=color:#0550ae>=</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>uint32_t</span><span style=color:#1f2328>)</span>commandBuffers<span style=color:#1f2328>.</span>size<span style=color:#1f2328>();</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=总结>总结</h2><p>根据渲染相关的描述。我们大概可以猜到，真正渲染的时候：</p><ul><li>renderpass 和 framebuffer绑定，设定为当前上下文。</li><li>commandbuffer记录指令，提交给GPU</li><li>呈现相关指令，也许要提交到呈现队列。</li></ul><h1 id=vulkan初始化-同步工具>Vulkan初始化-同步工具</h1><h2 id=创建-syncobjects>创建 SyncObjects</h2><p>由于大部分工作都是通过队列提交到GPU的。并且有可能还会使用不同的队列。因此，明显涉及到同步问题。所以我们需要用到GPU上的同步对象。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#0550ae>::</span>vector<span style=color:#0550ae>&lt;</span>VkSemaphore<span style=color:#0550ae>&gt;</span> imageAvailableSemaphores<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>std<span style=color:#0550ae>::</span>vector<span style=color:#0550ae>&lt;</span>VkSemaphore<span style=color:#0550ae>&gt;</span> renderFinishedSemaphores<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>std<span style=color:#0550ae>::</span>vector<span style=color:#0550ae>&lt;</span>VkFence<span style=color:#0550ae>&gt;</span> inFlightFences<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>imageAvailableSemaphores<span style=color:#1f2328>.</span>resize<span style=color:#1f2328>(</span>MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>renderFinishedSemaphores<span style=color:#1f2328>.</span>resize<span style=color:#1f2328>(</span>MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>inFlightFences<span style=color:#1f2328>.</span>resize<span style=color:#1f2328>(</span>MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><p>对每个framebuffer使用1套同步工具：</p><ul><li>信号量：<ul><li>imageAvailableSemaphores： 可以渲染了</li><li>renderFinishedSemaphores： 渲染结束了</li></ul></li><li>Fence：<ul><li>inFlightFences：当前framebuffer的上一帧还没有画完，此时等待fence。等待成功了，reset让其再次被启动。</li><li><code>vkQueueSubmit</code> 这个动作完成后，会释放fence。</li></ul></li></ul><h1 id=vulkan主循环>Vulkan主循环</h1><h2 id=每帧渲染函数>每帧渲染函数</h2><h3 id=等上一帧结束>等上一帧结束</h3><p>保证 GPU 里用到同一条 CommandBuffer 的上一帧已经跑完，CPU 才继续。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>vkWaitForFences<span style=color:#1f2328>(</span>inFlightFences<span style=color:#1f2328>[</span>currentFrame<span style=color:#1f2328>])</span>  
</span></span></code></pre></td></tr></table></div></div><h3 id=拿一张交换链图像>拿一张交换链图像</h3><p>返回 OUT_OF_DATE / SUBOPTIMAL 就重建 swapChain 并提前 return。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>vkAcquireNextImageKHR <span style=color:#f6f8fa;background-color:#82071e>→</span> imageIndex
</span></span></code></pre></td></tr></table></div></div><h3 id=重置帧内同步对象>重置“帧内”同步对象</h3><p>把 fence 重新置为“未触发”，把 CB 清零准备重新记录。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>vkResetFences<span style=color:#1f2328>(</span>inFlightFences<span style=color:#1f2328>[</span>currentFrame<span style=color:#1f2328>])</span>
</span></span><span style=display:flex><span>vkResetCommandBuffer<span style=color:#1f2328>(</span>commandBuffers<span style=color:#1f2328>[</span>currentFrame<span style=color:#1f2328>])</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=记录绘制命令>记录绘制命令</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>recordCommandBuffer<span style=color:#1f2328>(</span>commandBuffers<span style=color:#1f2328>[</span>currentFrame<span style=color:#1f2328>],</span> imageIndex<span style=color:#1f2328>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=提交给图形队列>提交给图形队列</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>vkQueueSubmit<span style=color:#1f2328>(</span>graphicsQueue<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>submitInfo<span style=color:#1f2328>,</span> inFlightFences<span style=color:#1f2328>[</span>currentFrame<span style=color:#1f2328>])</span>
</span></span></code></pre></td></tr></table></div></div><p>submitInfo 里：</p><ul><li>等 <code>imageAvailableSemaphores[currentFrame] @ COLOR_ATTACHMENT_OUTPUT</code></li><li>执行完 signal <code>renderFinishedSemaphores[currentFrame]</code></li></ul><h3 id=呈现>呈现</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>vkQueuePresentKHR<span style=color:#1f2328>(</span>presentQueue<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>presentInfo<span style=color:#1f2328>)</span>
</span></span></code></pre></td></tr></table></div></div><p>presentInfo 里：
‑ 等 <code>renderFinishedSemaphores[currentFrame]</code></p><h3 id=轮转飞行帧索引>轮转“飞行帧”索引</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>currentFrame <span style=color:#0550ae>=</span> <span style=color:#1f2328>(</span>currentFrame <span style=color:#0550ae>+</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>)</span> <span style=color:#0550ae>%</span> MAX_FRAMES_IN_FLIGHT
</span></span></code></pre></td></tr></table></div></div><h2 id=recordcommandbuffer>RecordCommandBuffer</h2><h3 id=指令录制开始>指令录制开始</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>    VkCommandBufferBeginInfo beginInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>    beginInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_COMMAND_BUFFER_BEGIN_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    beginInfo<span style=color:#1f2328>.</span>flags <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>                  <span style=color:#57606a>// Optional
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    beginInfo<span style=color:#1f2328>.</span>pInheritanceInfo <span style=color:#0550ae>=</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>;</span> <span style=color:#57606a>// Optional
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>vkBeginCommandBuffer<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>beginInfo<span style=color:#1f2328>)</span> <span style=color:#0550ae>!=</span> VK_SUCCESS<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>      <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to begin recording command buffer!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=renderpass开始绑定framebuffer>RenderPass开始(绑定FrameBuffer)</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>    VkRenderPassBeginInfo renderPassInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>    renderPassInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_RENDER_PASS_BEGIN_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    renderPassInfo<span style=color:#1f2328>.</span>renderPass <span style=color:#0550ae>=</span> renderPass<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 绑定帧
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    renderPassInfo<span style=color:#1f2328>.</span>framebuffer <span style=color:#0550ae>=</span> swapChainFramebuffers<span style=color:#1f2328>[</span>imageIndex<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 设定渲染区域
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    renderPassInfo<span style=color:#1f2328>.</span>renderArea<span style=color:#1f2328>.</span>offset <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>    renderPassInfo<span style=color:#1f2328>.</span>renderArea<span style=color:#1f2328>.</span>extent <span style=color:#0550ae>=</span> swapChainExtent<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 设定clear value
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    VkClearValue clearColor <span style=color:#0550ae>=</span> <span style=color:#1f2328>{{</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>}};</span>
</span></span><span style=display:flex><span>    renderPassInfo<span style=color:#1f2328>.</span>clearValueCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    renderPassInfo<span style=color:#1f2328>.</span>pClearValues <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>clearColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 启动render pass
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    vkCmdBeginRenderPass<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>renderPassInfo<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                         VK_SUBPASS_CONTENTS_INLINE<span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=开始绘制绑定cb-绑定pipeline>开始绘制(绑定CB, 绑定Pipeline)</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>    <span style=color:#57606a>// 绑定管线
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    vkCmdBindPipeline<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>,</span> VK_PIPELINE_BIND_POINT_GRAPHICS<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                      graphicsPipeline<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 设定动态变量
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    VkViewport viewport<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>    viewport<span style=color:#1f2328>.</span>x <span style=color:#0550ae>=</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    viewport<span style=color:#1f2328>.</span>y <span style=color:#0550ae>=</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    viewport<span style=color:#1f2328>.</span>width <span style=color:#0550ae>=</span> <span style=color:#cf222e>static_cast</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>float</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>swapChainExtent<span style=color:#1f2328>.</span>width<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    viewport<span style=color:#1f2328>.</span>height <span style=color:#0550ae>=</span> <span style=color:#cf222e>static_cast</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>float</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>swapChainExtent<span style=color:#1f2328>.</span>height<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    viewport<span style=color:#1f2328>.</span>minDepth <span style=color:#0550ae>=</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    viewport<span style=color:#1f2328>.</span>maxDepth <span style=color:#0550ae>=</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    vkCmdSetViewport<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>viewport<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    VkRect2D scissor<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>    scissor<span style=color:#1f2328>.</span>offset <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>    scissor<span style=color:#1f2328>.</span>extent <span style=color:#0550ae>=</span> swapChainExtent<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    vkCmdSetScissor<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>scissor<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// !!绘制三角形啦 （包饺子啦；其他代码都是为了这盘饺子准备的工具和馅料 ）
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    vkCmdDraw<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>,</span> <span style=color:#0550ae>3</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><p>如果要上传VertexBuffer或者IndexBuffer。更应该在初始化中做。</p><p>而在渲染命令前，如果用VB和IB，那么需要在Draw绑定它们。最后用 <code>vkCmdDrawIndexed</code> 。</p><h3 id=renderpass结束>RenderPass结束</h3><p>略</p><h3 id=指令录制结束>指令录制结束</h3><p>略</p><h1 id=三角形数据呢>三角形数据呢？</h1><p>为了简化这个例子。数据直接写到了 vertex shader中。</p><h2 id=vertex-shader>Vertex Shader</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vert data-lang=vert><span style=display:flex><span><span style=color:#57606a>#version 450</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>out</span> <span style=color:#cf222e>vec3</span> fragColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>vec2</span> positions<span style=color:#1f2328>[</span><span style=color:#0550ae>3</span><span style=color:#1f2328>]</span> <span style=color:#0550ae>=</span> <span style=color:#cf222e>vec2</span><span style=color:#1f2328>[](</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>vec2</span><span style=color:#1f2328>(</span><span style=color:#0550ae>0.0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>-</span><span style=color:#0550ae>0.5</span><span style=color:#1f2328>),</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>vec2</span><span style=color:#1f2328>(</span><span style=color:#0550ae>0.5</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.5</span><span style=color:#1f2328>),</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>vec2</span><span style=color:#1f2328>(</span><span style=color:#0550ae>-</span><span style=color:#0550ae>0.5</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.5</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>vec3</span> colors<span style=color:#1f2328>[</span><span style=color:#0550ae>3</span><span style=color:#1f2328>]</span> <span style=color:#0550ae>=</span> <span style=color:#cf222e>vec3</span><span style=color:#1f2328>[](</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>vec3</span><span style=color:#1f2328>(</span><span style=color:#0550ae>1.0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0</span><span style=color:#1f2328>),</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>vec3</span><span style=color:#1f2328>(</span><span style=color:#0550ae>0.0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0</span><span style=color:#1f2328>),</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>vec3</span><span style=color:#1f2328>(</span><span style=color:#0550ae>0.0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> main<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    gl_Position <span style=color:#0550ae>=</span> <span style=color:#cf222e>vec4</span><span style=color:#1f2328>(</span>positions<span style=color:#1f2328>[</span>gl_VertexIndex<span style=color:#1f2328>],</span> <span style=color:#0550ae>0.0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    fragColor <span style=color:#0550ae>=</span> colors<span style=color:#1f2328>[</span>gl_VertexIndex<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里。 <code>gl_VertexIndex</code> 是渲染指令触发，传递给每个shader调用的。</p><h2 id=fragment-shader>Fragment Shader</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-frag data-lang=frag><span style=display:flex><span><span style=color:#57606a>#version 450</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>in</span> <span style=color:#cf222e>vec3</span> fragColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>out</span> <span style=color:#cf222e>vec4</span> outColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> main<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    outColor <span style=color:#0550ae>=</span> <span style=color:#cf222e>vec4</span><span style=color:#1f2328>(</span>fragColor<span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>没做任何操作。直接输出颜色。（注意颜色插值是管线的固定流程自动计算的）</p></section><footer class=article-footer><section class=article-tags><a href=/tags/vulkan/>Vulkan</a>
<a href=/tags/cmake/>Cmake</a>
<a href=/tags/glfw/>Glfw</a></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=[".main-article",".widget--toc"];e.forEach(e=>{const t=document.querySelector(e);t&&renderMathInElement(t,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})})</script></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/2025/11/21/vulkan%E7%A8%8B%E5%BA%8F%E4%B8%ADintel%E9%A9%B1%E5%8A%A8%E6%80%BB%E6%98%AF%E8%A2%AB%E8%B0%83%E7%94%A8%E6%9C%AA%E8%A7%A3%E5%86%B3/><div class=article-details><h2 class=article-title>Vulkan程序中Intel驱动总是被调用（未解决）</h2></div></a></article><article><a href=/notes/vulkan%E7%9A%84layer%E5%8F%91%E7%8E%B0%E6%9C%BA%E5%88%B6/><div class=article-details><h2 class=article-title>Vulkan的Layer发现机制</h2></div></a></article><article><a href=/notes/vulkan%E7%9A%84icd%E6%9C%BA%E5%88%B6/><div class=article-details><h2 class=article-title>Vulkan的ICD机制</h2></div></a></article><article><a href=/2025/11/17/%E8%AE%B0%E5%BD%95%E8%B0%83%E8%AF%95vulkan%E7%A8%8B%E5%BA%8F%E6%89%93%E5%8D%B0%E5%A5%87%E6%80%AA%E6%97%A5%E5%BF%97%E7%9A%84%E9%97%AE%E9%A2%98/><div class=article-details><h2 class=article-title>记录调试Vulkan程序打印奇怪日志的问题</h2></div></a></article><article><a href=/notes/cmake%E5%85%A5%E9%97%A8/><div class=article-details><h2 class=article-title>cmake入门</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2025 crackhopper的技术博客</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.32.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.c922af694cc257bf1ecc41c0dd7b0430f9114ec280ccf67cd2c6ad55f5316c4e.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>
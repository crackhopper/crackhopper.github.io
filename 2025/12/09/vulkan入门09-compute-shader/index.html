<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="\r整体来说，执行compute pipeline，类似图形管线，但是更加简单：\nvkCmdBindPipeline (COMPUTE)\rvkCmdBindDescriptorSets\rvkCmdDispatch 注意本章节：仅从概念和一部分细节上介绍粒子，但并不会提供对应可以运行的代码。\n我计划构建好基于vulkan的渲染器后，整体基于这个章节的内容再来实现 GPU 粒子系统。\n"><title>Vulkan入门09-Compute Shader</title><link rel=canonical href=https://crackhopper.github.io/2025/12/09/vulkan%E5%85%A5%E9%97%A809-compute-shader/><link rel=stylesheet href=/scss/style.min.4d36f8dc1fd48129e1635deb4b8eb2870fa09474f7280c4cb606d40b2526994b.css><meta property='og:title' content="Vulkan入门09-Compute Shader"><meta property='og:description' content="\r整体来说，执行compute pipeline，类似图形管线，但是更加简单：\nvkCmdBindPipeline (COMPUTE)\rvkCmdBindDescriptorSets\rvkCmdDispatch 注意本章节：仅从概念和一部分细节上介绍粒子，但并不会提供对应可以运行的代码。\n我计划构建好基于vulkan的渲染器后，整体基于这个章节的内容再来实现 GPU 粒子系统。\n"><meta property='og:url' content='https://crackhopper.github.io/2025/12/09/vulkan%E5%85%A5%E9%97%A809-compute-shader/'><meta property='og:site_name' content='crackhopper的技术博客'><meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:tag' content='vulkan'><meta property='article:tag' content='compute-shader'><meta property='article:tag' content='particle-system'><meta property='article:published_time' content='2025-12-09T22:46:41+08:00'><meta property='article:modified_time' content='2025-12-09T22:46:41+08:00'><meta name=twitter:title content="Vulkan入门09-Compute Shader"><meta name=twitter:description content="\r整体来说，执行compute pipeline，类似图形管线，但是更加简单：\nvkCmdBindPipeline (COMPUTE)\rvkCmdBindDescriptorSets\rvkCmdDispatch 注意本章节：仅从概念和一部分细节上介绍粒子，但并不会提供对应可以运行的代码。\n我计划构建好基于vulkan的渲染器后，整体基于这个章节的内容再来实现 GPU 粒子系统。\n"><link rel=stylesheet href=/css/custom.css></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_337fe2b325ec916d.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>crackhopper的技术博客</a></h1><h2 class=site-description>C++, Graphics, Game, AI/ML</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>文章</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于我</span></a></li><li><a href=/projects/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>项目</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky" id=right-sidebar><section class="widget archives toc-widget"><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc id=toc-content><nav id=TableOfContents><ul><li><a href=#vulkan-pipeline>Vulkan Pipeline</a><ul><li><a href=#看图简介compute-shader>看图简介Compute Shader</a></li></ul></li><li><a href=#目标案例>目标案例</a></li><li><a href=#数据操作data-manipulation>数据操作(Data manipulation)</a><ul><li><a href=#shader-storage-buffer-objects-ssbo>Shader storage buffer objects (SSBO)</a></li><li><a href=#storage-images>Storage images</a></li></ul></li><li><a href=#计算队列族compute-queue-family>计算队列族(Compute queue family)</a></li><li><a href=#计算着色器阶段-compute-shader-stage>计算着色器阶段 (Compute Shader Stage)</a><ul><li><a href=#加载-compute-shader>加载 Compute Shader</a></li><li><a href=#准备-ssbo-shader-storage-buffer>准备 SSBO (Shader Storage Buffer)</a></li><li><a href=#descriptor>Descriptor</a></li><li><a href=#计算管线compute-pipelines>计算管线(Compute pipelines)</a></li><li><a href=#compute-space>Compute space</a></li><li><a href=#compute-shader>Compute shader</a></li></ul></li><li><a href=#执行计算指令>执行计算指令</a><ul><li><a href=#分发dispatch>分发(Dispatch)</a></li><li><a href=#提交worksubmitting-work>提交work(Submitting work)</a></li><li><a href=#同步图形和计算synchronizing-graphics-and-compute>同步图形和计算(Synchronizing graphics and compute)</a></li></ul></li><li><a href=#绘制粒子系统>绘制粒子系统</a></li><li><a href=#我们未来绘制的思路>我们未来绘制的思路</a><ul><li><a href=#方法-a---基于-instance-draw>方法 A - 基于 instance draw</a></li><li><a href=#方法-b--gpu-generated-vertex-data>方法 B — GPU-generated vertex data</a></li></ul></li></ul></nav></div></section></aside><button class=toc-float-btn id=toc-float-btn aria-label=展开目录 title=展开目录>
<span class=toc-float-btn-icon></span></button><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/2025/12/09/vulkan%E5%85%A5%E9%97%A809-compute-shader/>Vulkan入门09-Compute Shader</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2025-12-09T22:46:41+08:00>Dec 09, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>10 minute read</time></div></footer></div></header><section class=article-content><img src=/images/Vulkan%E5%85%A5%E9%97%A809-Compute%20Shader-1765269854030.png alt="Vulkan入门09-Compute Shader-1765269854030" width=342x270 loading=lazy><p>整体来说，执行compute pipeline，类似图形管线，但是更加简单：</p><pre tabindex=0><code>vkCmdBindPipeline (COMPUTE)
vkCmdBindDescriptorSets
vkCmdDispatch
</code></pre><p>注意本章节：仅从概念和一部分细节上介绍粒子，但并不会提供对应可以运行的代码。</p><p>我计划构建好基于vulkan的渲染器后，整体基于这个章节的内容再来实现 GPU 粒子系统。</p><h1 id=vulkan-pipeline>Vulkan Pipeline</h1><p><img src=/images/Vulkan%E5%85%A5%E9%97%A809-Compute%20Shader-1765269103129.png loading=lazy alt="Vulkan入门09-Compute Shader-1765269103129"></p><p>上面的图，左侧是传统的图形管线。右侧是一些特殊的管线（比如基于mesh shader的rendering，以及用GPU来实现计算的Compute Shader）。</p><h2 id=看图简介compute-shader>看图简介Compute Shader</h2><p>Compute Shader的使用流程：</p><pre tabindex=0><code>Dispatch
   ↓
Compute Shader
   ↓
（写回资源）
   ↓
后续 Graphics / Compute / Mesh 再继续使用
</code></pre><p>执行触发方式：Dispatch 而不是 Draw</p><div class=table-wrapper><table><thead><tr><th>图形管线</th><th>Compute</th></tr></thead><tbody><tr><td>draw / drawIndexed</td><td>dispatch(x, y, z)</td></tr><tr><td>以“顶点/图元”为驱动</td><td>以“线程组”为驱动</td></tr><tr><td>与 framebuffer 强耦合</td><td><strong>完全无 framebuffer 概念</strong></td></tr></tbody></table></div><p>从资源访问来看：Compute Shader <strong>可以读 + 写</strong> 几乎所有“非 attachment”资源。</p><h1 id=目标案例>目标案例</h1><p>我们将用 Compute Shader来实现一个粒子系统 (Particle System)效果如下</p><img src=/images/Vulkan%E5%85%A5%E9%97%A809-Compute%20Shader-1765269854030.png alt="Vulkan入门09-Compute Shader-1765269854030" width=342x270 loading=lazy><h1 id=数据操作data-manipulation>数据操作(Data manipulation)</h1><h2 id=shader-storage-buffer-objects-ssbo>Shader storage buffer objects (SSBO)</h2><p>SSBO（Shader Storage Buffer Object）相比其他缓冲类型（尤其是 Uniform Buffer Object, UBO），最大的两个不同点是：</p><ol><li><strong>SSBO 可以与其他缓冲类型“别名（alias）使用”</strong></li><li><strong>SSBO 的大小几乎不受限制（可以非常大）</strong></li></ol><p><strong>什么是alias（别名）？</strong></p><ul><li><strong>同一块 GPU 内存（同一个 VkBuffer）可以被当作多种缓冲类型来使用</strong></li></ul><p>例如：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>VkBufferCreateInfo bufferInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>bufferInfo<span style=color:#1f2328>.</span>usage <span style=color:#0550ae>=</span> VK_BUFFER_USAGE_VERTEX_BUFFER_BIT <span style=color:#0550ae>|</span> VK_BUFFER_USAGE_STORAGE_BUFFER_BIT <span style=color:#0550ae>|</span> VK_BUFFER_USAGE_TRANSFER_DST_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>vkCreateBuffer<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>bufferInfo<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>shaderStorageBuffers<span style=color:#1f2328>[</span>i<span style=color:#1f2328>])</span> <span style=color:#0550ae>!=</span> VK_SUCCESS<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to create vertex buffer!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><strong>在 compute shader 中</strong>： 通过 descriptor，把这个 buffer 当作 SSBO 来读 / 写</li><li><strong>在 graphics pipeline 中</strong>： 把同一个 buffer 绑定为 vertex buffer 来绘制</li><li>此外 <code>VK_BUFFER_USAGE_TRANSFER_DST_BIT</code> 支持我们从host上复制数据到GPU</li></ul><p>我们用下面代码创建 storageBuffer</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>createBuffer<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>	bufferSize<span style=color:#1f2328>,</span> 
</span></span><span style=display:flex><span>	VK_BUFFER_USAGE_STORAGE_BUFFER_BIT <span style=color:#0550ae>|</span> VK_BUFFER_USAGE_VERTEX_BUFFER_BIT <span style=color:#0550ae>|</span> VK_BUFFER_USAGE_TRANSFER_DST_BIT<span style=color:#1f2328>,</span> 
</span></span><span style=display:flex><span>	VK_MEMORY_PROPERTY_DEVICE_LOCAL_BIT<span style=color:#1f2328>,</span> 
</span></span><span style=display:flex><span>	shaderStorageBuffers<span style=color:#1f2328>[</span>i<span style=color:#1f2328>],</span> shaderStorageBuffersMemory<span style=color:#1f2328>[</span>i<span style=color:#1f2328>]);</span>
</span></span></code></pre></td></tr></table></div></div><p>访问这个buffer的shader代码：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span><span style=color:#cf222e>struct</span> Particle <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>vec2</span> position<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>vec2</span> velocity<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>vec4</span> color<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// std140 是 memory layout 参数，表明 shader storage memory 中元素如何对齐</span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>std140<span style=color:#1f2328>,</span> binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>)</span> readonly buffer ParticleSSBOIn <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>   Particle particlesIn<span style=color:#1f2328>[</span> <span style=color:#1f2328>];</span> <span style=color:#57606a>// 代表数量未知</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>std140<span style=color:#1f2328>,</span> binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>2</span><span style=color:#1f2328>)</span> buffer ParticleSSBOOut <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>   Particle particlesOut<span style=color:#1f2328>[</span> <span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><p>向这个 SSBO 写入很容易：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span>particlesOut<span style=color:#1f2328>[</span>index<span style=color:#1f2328>].</span>position <span style=color:#0550ae>=</span> particlesIn<span style=color:#1f2328>[</span>index<span style=color:#1f2328>].</span>position <span style=color:#0550ae>+</span> particlesIn<span style=color:#1f2328>[</span>index<span style=color:#1f2328>].</span>velocity<span style=color:#1f2328>.</span>xy <span style=color:#0550ae>*</span> ubo<span style=color:#1f2328>.</span>deltaTime<span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=storage-images>Storage images</h2><p>这里我们只是解说，Compute Shader也可以对图像操作。本章节我们不使用这个技术。</p><p>类似buffer，创建的时候，指定usage</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>VkImageCreateInfo imageInfo <span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>imageInfo<span style=color:#1f2328>.</span>usage <span style=color:#0550ae>=</span> VK_IMAGE_USAGE_SAMPLED_BIT <span style=color:#0550ae>|</span> VK_IMAGE_USAGE_STORAGE_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>vkCreateImage<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>imageInfo<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>textureImage<span style=color:#1f2328>)</span> <span style=color:#0550ae>!=</span> VK_SUCCESS<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to create image!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>VK_IMAGE_USAGE_SAMPLED_BIT</code> : 作为纹理采样</li><li><code>VK_IMAGE_USAGE_STORAGE_BIT</code> : 作为compute shader可以读写的buffer</li></ul><p>在glsl中，数据绑定：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span>layout <span style=color:#1f2328>(</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> rgba8<span style=color:#1f2328>)</span> <span style=color:#cf222e>uniform</span> readonly image2D inputImage<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layout <span style=color:#1f2328>(</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> rgba8<span style=color:#1f2328>)</span> <span style=color:#cf222e>uniform</span> writeonly image2D outputImage<span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><p>在代码中，读写image</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span><span style=color:#cf222e>vec3</span> pixel <span style=color:#0550ae>=</span> imageLoad<span style=color:#1f2328>(</span>inputImage<span style=color:#1f2328>,</span> <span style=color:#cf222e>ivec2</span><span style=color:#1f2328>(</span>gl_GlobalInvocationID<span style=color:#1f2328>.</span>xy<span style=color:#1f2328>)).</span>rgb<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>imageStore<span style=color:#1f2328>(</span>outputImage<span style=color:#1f2328>,</span> <span style=color:#cf222e>ivec2</span><span style=color:#1f2328>(</span>gl_GlobalInvocationID<span style=color:#1f2328>.</span>xy<span style=color:#1f2328>),</span> pixel<span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=计算队列族compute-queue-family>计算队列族(Compute queue family)</h1><p>Vulkan强制要求，每个驱动实现必须有1个队列，同时支持graphics和compute操作。不过，也不反对驱动实现一个专门的Compute队列，用来执行异步计算。</p><p>我们这里使用一个同时支持 graphics 和 compute 操作的队列。</p><p>创建队列的相关代码修改：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>QueueFamilyIndices</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>  std<span style=color:#0550ae>::</span>optional<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>uint32_t</span><span style=color:#0550ae>&gt;</span> graphicsAndComputeFamily<span style=color:#1f2328>;</span> <span style=color:#57606a>// 图形和计算队列族索引
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>  std<span style=color:#0550ae>::</span>optional<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>uint32_t</span><span style=color:#0550ae>&gt;</span> graphicsFamily<span style=color:#1f2328>;</span> <span style=color:#57606a>// 图形队列族索引
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>  std<span style=color:#0550ae>::</span>optional<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>uint32_t</span><span style=color:#0550ae>&gt;</span> presentFamily<span style=color:#1f2328>;</span>  <span style=color:#57606a>// 呈现队列族索引
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>bool</span> <span style=color:#6639ba>isComplete</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> graphicsFamily<span style=color:#1f2328>.</span>has_value<span style=color:#1f2328>()</span> <span style=color:#0550ae>&amp;&amp;</span> presentFamily<span style=color:#1f2328>.</span>has_value<span style=color:#1f2328>()</span> <span style=color:#0550ae>&amp;&amp;</span> graphicsAndComputeFamily<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>  <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>QueueFamilyIndices findQueueFamilies<span style=color:#1f2328>(</span>VkPhysicalDevice physicalDevice<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>uint32_t</span> queueFamilyCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	vkGetPhysicalDeviceQueueFamilyProperties<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>queueFamilyCount<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	std<span style=color:#0550ae>::</span>vector<span style=color:#0550ae>&lt;</span>VkQueueFamilyProperties<span style=color:#0550ae>&gt;</span> queueFamilies<span style=color:#1f2328>(</span>queueFamilyCount<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	vkGetPhysicalDeviceQueueFamilyProperties<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>		device<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>queueFamilyCount<span style=color:#1f2328>,</span> queueFamilies<span style=color:#1f2328>.</span>data<span style=color:#1f2328>());</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#cf222e>int</span> i <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>for</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>const</span> <span style=color:#cf222e>auto</span><span style=color:#0550ae>&amp;</span> <span style=color:#900;font-weight:700>queueFamily</span> <span style=color:#1f2328>:</span> queueFamilies<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>		<span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>	    <span style=color:#cf222e>if</span> <span style=color:#1f2328>((</span>queueFamily<span style=color:#1f2328>.</span>queueFlags <span style=color:#0550ae>&amp;</span> VK_QUEUE_GRAPHICS_BIT<span style=color:#1f2328>)</span> <span style=color:#0550ae>&amp;&amp;</span> 
</span></span><span style=display:flex><span>		    <span style=color:#1f2328>(</span>queueFamily<span style=color:#1f2328>.</span>queueFlags <span style=color:#0550ae>&amp;</span> VK_QUEUE_COMPUTE_BIT<span style=color:#1f2328>))</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	        indices<span style=color:#1f2328>.</span>graphicsAndComputeFamily <span style=color:#0550ae>=</span> i<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>		<span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>	    i<span style=color:#0550ae>++</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span>	
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 创建逻辑设备的时候，创建并获取这个队列
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>VkQueue computeQueue<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> createLogicalDevice<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>    vkGetDeviceQueue<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> indices<span style=color:#1f2328>.</span>graphicsAndComputeFamily<span style=color:#1f2328>.</span>value<span style=color:#1f2328>(),</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                     <span style=color:#0550ae>&amp;</span>computeQueue<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=计算着色器阶段-compute-shader-stage>计算着色器阶段 (Compute Shader Stage)</h1><h2 id=加载-compute-shader>加载 Compute Shader</h2><p>在我们的应用程序中加载计算着色器与加载任何其他着色器相同。唯一真正的区别是我们需要使用上面提到的 <code>VK_SHADER_STAGE_COMPUTE_BIT</code> 。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>auto</span> computeShaderCode <span style=color:#0550ae>=</span> readFile<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;shaders/compute.spv&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>VkShaderModule computeShaderModule <span style=color:#0550ae>=</span> createShaderModule<span style=color:#1f2328>(</span>computeShaderCode<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>VkPipelineShaderStageCreateInfo computeShaderStageInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>computeShaderStageInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_PIPELINE_SHADER_STAGE_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>computeShaderStageInfo<span style=color:#1f2328>.</span>stage <span style=color:#0550ae>=</span> VK_SHADER_STAGE_COMPUTE_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>computeShaderStageInfo<span style=color:#1f2328>.</span>module <span style=color:#0550ae>=</span> computeShaderModule<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>computeShaderStageInfo<span style=color:#1f2328>.</span>pName <span style=color:#0550ae>=</span> <span style=color:#0a3069>&#34;main&#34;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=准备-ssbo-shader-storage-buffer>准备 SSBO (Shader Storage Buffer)</h2><p>我们把粒子数组，写入到SSBO中，方便CS读取和修改。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#0550ae>::</span>vector<span style=color:#0550ae>&lt;</span>VkBuffer<span style=color:#0550ae>&gt;</span> shaderStorageBuffers<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>std<span style=color:#0550ae>::</span>vector<span style=color:#0550ae>&lt;</span>VkDeviceMemory<span style=color:#0550ae>&gt;</span> shaderStorageBuffersMemory<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> createShaderStorageBuffers<span style=color:#1f2328>(){</span>
</span></span><span style=display:flex><span>	shaderStorageBuffers<span style=color:#1f2328>.</span>resize<span style=color:#1f2328>(</span>MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	shaderStorageBuffersMemory<span style=color:#1f2328>.</span>resize<span style=color:#1f2328>(</span>MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// Initialize particles
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    std<span style=color:#0550ae>::</span>default_random_engine rndEngine<span style=color:#1f2328>((</span><span style=color:#cf222e>unsigned</span><span style=color:#1f2328>)</span>time<span style=color:#1f2328>(</span><span style=color:#cf222e>nullptr</span><span style=color:#1f2328>));</span>
</span></span><span style=display:flex><span>    std<span style=color:#0550ae>::</span>uniform_real_distribution<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>float</span><span style=color:#0550ae>&gt;</span> rndDist<span style=color:#1f2328>(</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#57606a>// Initial particle positions on a circle
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    std<span style=color:#0550ae>::</span>vector<span style=color:#0550ae>&lt;</span>Particle<span style=color:#0550ae>&gt;</span> particles<span style=color:#1f2328>(</span>PARTICLE_COUNT<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>for</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>auto</span><span style=color:#0550ae>&amp;</span> <span style=color:#900;font-weight:700>particle</span> <span style=color:#1f2328>:</span> particles<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	    <span style=color:#57606a>// 用极坐标随机位置
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>        <span style=color:#cf222e>float</span> r <span style=color:#0550ae>=</span> <span style=color:#0550ae>0.25f</span> <span style=color:#0550ae>*</span> sqrt<span style=color:#1f2328>(</span>rndDist<span style=color:#1f2328>(</span>rndEngine<span style=color:#1f2328>));</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>float</span> theta <span style=color:#0550ae>=</span> rndDist<span style=color:#1f2328>(</span>rndEngine<span style=color:#1f2328>)</span> <span style=color:#0550ae>*</span> <span style=color:#0550ae>2</span> <span style=color:#0550ae>*</span> <span style=color:#0550ae>3.14159265358979323846</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>float</span> x <span style=color:#0550ae>=</span> r <span style=color:#0550ae>*</span> cos<span style=color:#1f2328>(</span>theta<span style=color:#1f2328>)</span> <span style=color:#0550ae>*</span> HEIGHT <span style=color:#0550ae>/</span> WIDTH<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>float</span> y <span style=color:#0550ae>=</span> r <span style=color:#0550ae>*</span> sin<span style=color:#1f2328>(</span>theta<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>        particle<span style=color:#1f2328>.</span>position <span style=color:#0550ae>=</span> glm<span style=color:#0550ae>::</span>vec2<span style=color:#1f2328>(</span>x<span style=color:#1f2328>,</span> y<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>        <span style=color:#57606a>// 速度根据位置来计算，向外发射
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>        particle<span style=color:#1f2328>.</span>velocity <span style=color:#0550ae>=</span> glm<span style=color:#0550ae>::</span>normalize<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>	        glm<span style=color:#0550ae>::</span>vec2<span style=color:#1f2328>(</span>x<span style=color:#1f2328>,</span>y<span style=color:#1f2328>))</span> <span style=color:#0550ae>*</span> <span style=color:#0550ae>0.00025f</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        particle<span style=color:#1f2328>.</span>color <span style=color:#0550ae>=</span> glm<span style=color:#0550ae>::</span>vec4<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>	        rndDist<span style=color:#1f2328>(</span>rndEngine<span style=color:#1f2328>),</span> rndDist<span style=color:#1f2328>(</span>rndEngine<span style=color:#1f2328>),</span> rndDist<span style=color:#1f2328>(</span>rndEngine<span style=color:#1f2328>),</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 创建 staging buffer 来保存初始的粒子属性
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    VkDeviceSize bufferSize <span style=color:#0550ae>=</span> <span style=color:#cf222e>sizeof</span><span style=color:#1f2328>(</span>Particle<span style=color:#1f2328>)</span> <span style=color:#0550ae>*</span> PARTICLE_COUNT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    VkBuffer stagingBuffer<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    VkDeviceMemory stagingBufferMemory<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    createBuffer<span style=color:#1f2328>(</span>bufferSize<span style=color:#1f2328>,</span> VK_BUFFER_USAGE_TRANSFER_SRC_BIT<span style=color:#1f2328>,</span> VK_MEMORY_PROPERTY_HOST_VISIBLE_BIT <span style=color:#0550ae>|</span> VK_MEMORY_PROPERTY_HOST_COHERENT_BIT<span style=color:#1f2328>,</span> stagingBuffer<span style=color:#1f2328>,</span> stagingBufferMemory<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>void</span><span style=color:#0550ae>*</span> data<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    vkMapMemory<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> stagingBufferMemory<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> bufferSize<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>data<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    memcpy<span style=color:#1f2328>(</span>data<span style=color:#1f2328>,</span> particles<span style=color:#1f2328>.</span>data<span style=color:#1f2328>(),</span> <span style=color:#1f2328>(</span>size_t<span style=color:#1f2328>)</span>bufferSize<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    vkUnmapMemory<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> stagingBufferMemory<span style=color:#1f2328>);</span>    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 创建SSBO，并把数据上传到SSBO
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#cf222e>for</span> <span style=color:#1f2328>(</span>size_t i <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span> i <span style=color:#0550ae>&lt;</span> MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>;</span> i<span style=color:#0550ae>++</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        createBuffer<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>	        bufferSize<span style=color:#1f2328>,</span> 
</span></span><span style=display:flex><span>	        VK_BUFFER_USAGE_STORAGE_BUFFER_BIT <span style=color:#0550ae>|</span> VK_BUFFER_USAGE_VERTEX_BUFFER_BIT <span style=color:#0550ae>|</span> VK_BUFFER_USAGE_TRANSFER_DST_BIT<span style=color:#1f2328>,</span> 
</span></span><span style=display:flex><span>	        VK_MEMORY_PROPERTY_DEVICE_LOCAL_BIT<span style=color:#1f2328>,</span> 
</span></span><span style=display:flex><span>	        shaderStorageBuffers<span style=color:#1f2328>[</span>i<span style=color:#1f2328>],</span> shaderStorageBuffersMemory<span style=color:#1f2328>[</span>i<span style=color:#1f2328>]);</span>
</span></span><span style=display:flex><span>        <span style=color:#57606a>// Copy data from the staging buffer (host) to the shader storage buffer (GPU)
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>        copyBuffer<span style=color:#1f2328>(</span>stagingBuffer<span style=color:#1f2328>,</span> shaderStorageBuffers<span style=color:#1f2328>[</span>i<span style=color:#1f2328>],</span> bufferSize<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>    
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=descriptor>Descriptor</h2><p>和图形管线一样，我们需要给buffer绑定Descriptor，并且在管线中定义Descriptor Layout，并在运行时，指定Descriptor。从而让Compute Shader可以访问数据。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#0550ae>::</span>array<span style=color:#0550ae>&lt;</span>VkDescriptorSetLayoutBinding<span style=color:#1f2328>,</span> <span style=color:#0550ae>3</span><span style=color:#0550ae>&gt;</span> layoutBindings<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>layoutBindings<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layoutBindings<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>descriptorCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layoutBindings<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>descriptorType <span style=color:#0550ae>=</span> VK_DESCRIPTOR_TYPE_UNIFORM_BUFFER<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layoutBindings<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>pImmutableSamplers <span style=color:#0550ae>=</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layoutBindings<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>stageFlags <span style=color:#0550ae>=</span> VK_SHADER_STAGE_COMPUTE_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span></code></pre></td></tr></table></div></div><p>注意，如果希望descriptor从 vertex 和 compute stage都能访问 （比如 UBO），上面可以设置both stage</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>layoutBindings<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>stageFlags <span style=color:#0550ae>=</span> VK_SHADER_STAGE_VERTEX_BIT <span style=color:#0550ae>|</span> VK_SHADER_STAGE_COMPUTE_BIT<span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><p>我们整体的布局设定为：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#0550ae>::</span>array<span style=color:#0550ae>&lt;</span>VkDescriptorSetLayoutBinding<span style=color:#1f2328>,</span> <span style=color:#0550ae>3</span><span style=color:#0550ae>&gt;</span> layoutBindings<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>layoutBindings<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layoutBindings<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>descriptorCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layoutBindings<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>descriptorType <span style=color:#0550ae>=</span> VK_DESCRIPTOR_TYPE_UNIFORM_BUFFER<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layoutBindings<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>pImmutableSamplers <span style=color:#0550ae>=</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layoutBindings<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>stageFlags <span style=color:#0550ae>=</span> VK_SHADER_STAGE_COMPUTE_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layoutBindings<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layoutBindings<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>descriptorCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layoutBindings<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>descriptorType <span style=color:#0550ae>=</span> VK_DESCRIPTOR_TYPE_STORAGE_BUFFER<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layoutBindings<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>pImmutableSamplers <span style=color:#0550ae>=</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layoutBindings<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>stageFlags <span style=color:#0550ae>=</span> VK_SHADER_STAGE_COMPUTE_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layoutBindings<span style=color:#1f2328>[</span><span style=color:#0550ae>2</span><span style=color:#1f2328>].</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>2</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layoutBindings<span style=color:#1f2328>[</span><span style=color:#0550ae>2</span><span style=color:#1f2328>].</span>descriptorCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layoutBindings<span style=color:#1f2328>[</span><span style=color:#0550ae>2</span><span style=color:#1f2328>].</span>descriptorType <span style=color:#0550ae>=</span> VK_DESCRIPTOR_TYPE_STORAGE_BUFFER<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layoutBindings<span style=color:#1f2328>[</span><span style=color:#0550ae>2</span><span style=color:#1f2328>].</span>pImmutableSamplers <span style=color:#0550ae>=</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layoutBindings<span style=color:#1f2328>[</span><span style=color:#0550ae>2</span><span style=color:#1f2328>].</span>stageFlags <span style=color:#0550ae>=</span> VK_SHADER_STAGE_COMPUTE_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>VkDescriptorSetLayoutCreateInfo layoutInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>layoutInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_DESCRIPTOR_SET_LAYOUT_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layoutInfo<span style=color:#1f2328>.</span>bindingCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>3</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layoutInfo<span style=color:#1f2328>.</span>pBindings <span style=color:#0550ae>=</span> layoutBindings<span style=color:#1f2328>.</span>data<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>vkCreateDescriptorSetLayout<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>layoutInfo<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>computeDescriptorSetLayout<span style=color:#1f2328>)</span> <span style=color:#0550ae>!=</span> VK_SUCCESS<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to create compute descriptor set layout!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里面，我们用了两个layout来绑定两个SSBO，为什么呢？</p><ul><li>粒子系统逐帧更新，基于一个增量时间。</li><li>每帧需要知道上一帧粒子的位置。以便更新它们。
具体流程如下图：</li></ul><p><img src=/images/Vulkan%E5%85%A5%E9%97%A809-Compute%20Shader-1765272672259.png loading=lazy alt="Vulkan入门09-Compute Shader-1765272672259"></p><p>而UBO显然是用来计算delta time，以及管理哪个buffer是source，哪个buffer是dst的。</p><p>具体绑定descriptor的代码： （<code>createDescriptorSet</code> 在初始化最后的阶段）</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>for</span> <span style=color:#1f2328>(</span>size_t i <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span> i <span style=color:#0550ae>&lt;</span> MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>;</span> i<span style=color:#0550ae>++</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    VkDescriptorBufferInfo uniformBufferInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>    uniformBufferInfo<span style=color:#1f2328>.</span>buffer <span style=color:#0550ae>=</span> uniformBuffers<span style=color:#1f2328>[</span>i<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>    uniformBufferInfo<span style=color:#1f2328>.</span>offset <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    uniformBufferInfo<span style=color:#1f2328>.</span>range <span style=color:#0550ae>=</span> <span style=color:#cf222e>sizeof</span><span style=color:#1f2328>(</span>UniformBufferObject<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    std<span style=color:#0550ae>::</span>array<span style=color:#0550ae>&lt;</span>VkWriteDescriptorSet<span style=color:#1f2328>,</span> <span style=color:#0550ae>3</span><span style=color:#0550ae>&gt;</span> descriptorWrites<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    VkDescriptorBufferInfo storageBufferInfoLastFrame<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>    storageBufferInfoLastFrame<span style=color:#1f2328>.</span>buffer <span style=color:#0550ae>=</span> shaderStorageBuffers<span style=color:#1f2328>[(</span>i <span style=color:#0550ae>-</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>)</span> <span style=color:#0550ae>%</span> MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>    storageBufferInfoLastFrame<span style=color:#1f2328>.</span>offset <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    storageBufferInfoLastFrame<span style=color:#1f2328>.</span>range <span style=color:#0550ae>=</span> <span style=color:#cf222e>sizeof</span><span style=color:#1f2328>(</span>Particle<span style=color:#1f2328>)</span> <span style=color:#0550ae>*</span> PARTICLE_COUNT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_WRITE_DESCRIPTOR_SET<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>dstSet <span style=color:#0550ae>=</span> computeDescriptorSets<span style=color:#1f2328>[</span>i<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>    descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>dstBinding <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>dstArrayElement <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>descriptorType <span style=color:#0550ae>=</span> VK_DESCRIPTOR_TYPE_STORAGE_BUFFER<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>descriptorCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>pBufferInfo <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>storageBufferInfoLastFrame<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    VkDescriptorBufferInfo storageBufferInfoCurrentFrame<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>    storageBufferInfoCurrentFrame<span style=color:#1f2328>.</span>buffer <span style=color:#0550ae>=</span> shaderStorageBuffers<span style=color:#1f2328>[</span>i<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>    storageBufferInfoCurrentFrame<span style=color:#1f2328>.</span>offset <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    storageBufferInfoCurrentFrame<span style=color:#1f2328>.</span>range <span style=color:#0550ae>=</span> <span style=color:#cf222e>sizeof</span><span style=color:#1f2328>(</span>Particle<span style=color:#1f2328>)</span> <span style=color:#0550ae>*</span> PARTICLE_COUNT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>2</span><span style=color:#1f2328>].</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_WRITE_DESCRIPTOR_SET<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>2</span><span style=color:#1f2328>].</span>dstSet <span style=color:#0550ae>=</span> computeDescriptorSets<span style=color:#1f2328>[</span>i<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>    descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>2</span><span style=color:#1f2328>].</span>dstBinding <span style=color:#0550ae>=</span> <span style=color:#0550ae>2</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>2</span><span style=color:#1f2328>].</span>dstArrayElement <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>2</span><span style=color:#1f2328>].</span>descriptorType <span style=color:#0550ae>=</span> VK_DESCRIPTOR_TYPE_STORAGE_BUFFER<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>2</span><span style=color:#1f2328>].</span>descriptorCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>2</span><span style=color:#1f2328>].</span>pBufferInfo <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>storageBufferInfoCurrentFrame<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    vkUpdateDescriptorSets<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> <span style=color:#0550ae>3</span><span style=color:#1f2328>,</span> descriptorWrites<span style=color:#1f2328>.</span>data<span style=color:#1f2328>(),</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>当然为了支持创建上面的set，我们还需要在对应的池里，扩大容量：（<code>createDescriptorPool</code> 在 <code>createDescriptorSet</code> 的前一步）</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#0550ae>::</span>array<span style=color:#0550ae>&lt;</span>VkDescriptorPoolSize<span style=color:#1f2328>,</span> <span style=color:#0550ae>2</span><span style=color:#0550ae>&gt;</span> poolSizes<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>poolSizes<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>type <span style=color:#0550ae>=</span> VK_DESCRIPTOR_TYPE_STORAGE_BUFFER<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>poolSizes<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>descriptorCount <span style=color:#0550ae>=</span> <span style=color:#cf222e>static_cast</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>uint32_t</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>)</span> <span style=color:#0550ae>*</span> <span style=color:#0550ae>2</span><span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=计算管线compute-pipelines>计算管线(Compute pipelines)</h2><p>由于计算不是图形管线的一部分，我们不能使用 <code>vkCreateGraphicsPipelines</code> 。相反，我们需要使用 <code>vkCreateComputePipelines</code> 创建一个专门的计算管线来运行我们的计算命令。由于计算管线不涉及任何光栅化状态，因此它的状态比图形管线少得多：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>VkPipelineLayoutCreateInfo pipelineLayoutInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>pipelineLayoutInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_PIPELINE_LAYOUT_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>pipelineLayoutInfo<span style=color:#1f2328>.</span>setLayoutCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>pipelineLayoutInfo<span style=color:#1f2328>.</span>pSetLayouts <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>computeDescriptorSetLayout<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>vkCreatePipelineLayout<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>	device<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>pipelineLayoutInfo<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>computePipelineLayout<span style=color:#1f2328>)</span> <span style=color:#0550ae>!=</span> VK_SUCCESS<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to create compute pipeline layout!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>VkComputePipelineCreateInfo pipelineInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>pipelineInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_COMPUTE_PIPELINE_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>pipelineInfo<span style=color:#1f2328>.</span>layout <span style=color:#0550ae>=</span> computePipelineLayout<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>pipelineInfo<span style=color:#1f2328>.</span>stage <span style=color:#0550ae>=</span> computeShaderStageInfo<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>vkCreateComputePipelines<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>	device<span style=color:#1f2328>,</span> VK_NULL_HANDLE<span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>pipelineInfo<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>,</span> 
</span></span><span style=display:flex><span>	<span style=color:#0550ae>&amp;</span>computePipeline<span style=color:#1f2328>)</span> <span style=color:#0550ae>!=</span> VK_SUCCESS<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to create compute pipeline!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=compute-space>Compute space</h2><p>在深入了解计算着色器的工作原理以及如何向 GPU 提交计算任务之前，我们需要讨论两个重要的计算概念：工作组（ <strong>work groups</strong> ）和调用（ <strong>invocations</strong> ）。它们定义了一个抽象的执行模型，用于描述计算任务如何在 GPU 的三维计算硬件（x、y 和 z 轴）中处理。</p><ul><li><strong>Work groups</strong> : 工作组定义了 计算工作负载 如何由 GPU 的计算硬件 组织(form) 和 处理(process)。你可以将它们视为 GPU 需要处理的任务项。work group dimension 由应用，在 command buffer录制时，使用 dispatch 指令来设置。</li><li><strong>invocations</strong> ： 每个工作组是a collections of invocations （调用集合），每个调用执行相同的 compute shader。invocation 可以并行执行，它们的dimension在compute shader中被设置。每个工作组内的调用，访问共同的内存。</li></ul><p>说明示例图：</p><p><img src=/images/Vulkan%E5%85%A5%E9%97%A809-Compute%20Shader-1765273460609.png loading=lazy alt="Vulkan入门09-Compute Shader-1765273460609"></p><p>work groups 和 invocations 的维度数 (number of dimensions) 取决于输入数据的结构 （由compute shader的 local size 定义）。</p><p>在我们的例子里，处理一个一维数组，那么你需要给这两个都指定x的维度。</p><p>举例来说：如果我们dispatch work group数量为 <code>[64,1,1]</code> ，computer shader的 local size 为 <code>[32,32,1]</code> (local size也即每个workgroup内invocation的数量) ，那么我们的compute shader整体被调用 <code>64x32x32=65536</code> 次。</p><p>注意：最大work group数量，以及 local sizes的限制，根据驱动不同而不同。最好通过  <code>VkPhysicalDeviceLimits</code> 计算相关 <code>maxComputeWorkGroupCount</code> 、 <code>maxComputeWorkGroupInvocations</code> 和 <code>maxComputeWorkGroupSize</code> 限制。</p><h2 id=compute-shader>Compute shader</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span><span style=color:#57606a>#version 450</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout <span style=color:#1f2328>(</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>uniform</span> ParameterUBO <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>float</span> deltaTime<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span> ubo<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> Particle <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>vec2</span> position<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>vec2</span> velocity<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>vec4</span> color<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>std140<span style=color:#1f2328>,</span> binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>)</span> readonly buffer ParticleSSBOIn <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>   Particle particlesIn<span style=color:#1f2328>[</span> <span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>std140<span style=color:#1f2328>,</span> binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>2</span><span style=color:#1f2328>)</span> buffer ParticleSSBOOut <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>   Particle particlesOut<span style=color:#1f2328>[</span> <span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout <span style=color:#1f2328>(</span>local_size_x <span style=color:#0550ae>=</span> <span style=color:#0550ae>256</span><span style=color:#1f2328>,</span> local_size_y <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> local_size_z <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>in</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> main<span style=color:#1f2328>()</span> 
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    uint index <span style=color:#0550ae>=</span> gl_GlobalInvocationID<span style=color:#1f2328>.</span>x<span style=color:#1f2328>;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Particle particleIn <span style=color:#0550ae>=</span> particlesIn<span style=color:#1f2328>[</span>index<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    particlesOut<span style=color:#1f2328>[</span>index<span style=color:#1f2328>].</span>position <span style=color:#0550ae>=</span> particleIn<span style=color:#1f2328>.</span>position <span style=color:#0550ae>+</span> particleIn<span style=color:#1f2328>.</span>velocity<span style=color:#1f2328>.</span>xy <span style=color:#0550ae>*</span> ubo<span style=color:#1f2328>.</span>deltaTime<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    particlesOut<span style=color:#1f2328>[</span>index<span style=color:#1f2328>].</span>velocity <span style=color:#0550ae>=</span> particleIn<span style=color:#1f2328>.</span>velocity<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>一些解释和说明：</p><ol><li><strong>为什么 <code>particlesIn[]</code> 可以不写大小</strong><ol><li>它是 <strong>运行期大小（runtime-sized array）</strong></li><li>array 的长度 <strong>在 shader 编译时未知</strong></li><li>真正长度由 CPU 端 <code>vkCmdBindDescriptorSets / glBindBufferRange</code> 决定</li><li>被所有 invocations 共享。</li></ol></li><li><strong>gl_GlobalInvocationID是什么？</strong><ol><li>WorkGroupID × LocalSize + LocalInvocationID。它是通过 <strong>workgroup 的 ID</strong> 和 <strong>workgroup 内的 invocation ID</strong> 组合出来的一个 <strong>全局唯一 invocation 索引</strong>。</li><li>在 compute shader 中同时存在 <strong>三套 ID</strong>：<ol><li>uvec3 gl_WorkGroupID： 这是第几个 workgroup</li><li>uvec3 gl_LocalInvocationID： 当前 invocation 在 workgroup 内的编号</li><li><code>gl_GlobalInvocationID</code>： 组合上面两个和 <code>local_size</code> 得到的全局id</li></ol></li></ol></li><li>shared变量，才是每个workgroup中独立的，workgroup内共享的</li><li>这里的 Particle 的每个字段按照 std140对齐：<ol><li>基础标量 <code>float</code>, <code>int</code>, <code>uint</code>： 4 bytes</li><li>向量 <code>vec2</code> : 8 bytes</li><li>向量 <code>vec3, vec4</code> : 16bytes</li><li>我们在copy数据进去的时候，一定要注意对齐。使用C++11的 <code>alignas(16)</code> 进行妥善对齐。</li></ol></li></ol><p>注意索引计算逻辑：</p><pre tabindex=0><code>gl_GlobalInvocationID.x = gl_WorkGroupID.x * local_size_x + gl_LocalInvocationID.x;
gl_GlobalInvocationID.y = gl_WorkGroupID.y * local_size_y + gl_LocalInvocationID.y;
gl_GlobalInvocationID.z = gl_WorkGroupID.z * local_size_z + gl_LocalInvocationID.z;
</code></pre><p>假设数据维度为 64 x 64 x 64 。那么在 work group 可以展开 16 x 16 x 16，这样每个 local size 可以继续展开 4 x 4 x 4 。效果类似于 每个workgroup 负责数据上一个 4x4x4的小块，一共有 16x16x16个小块。而workgroup具体执行，则会展开成 4x4x4个 invocations，分别调用 compute shader。</p><h1 id=执行计算指令>执行计算指令</h1><p>下面的指令都是需要每帧调用的</p><h2 id=分发dispatch>分发(Dispatch)</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>VkCommandBufferBeginInfo beginInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>beginInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_COMMAND_BUFFER_BEGIN_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>vkBeginCommandBuffer<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>beginInfo<span style=color:#1f2328>)</span> <span style=color:#0550ae>!=</span> VK_SUCCESS<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to begin recording command buffer!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vkCmdBindPipeline<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>,</span> VK_PIPELINE_BIND_POINT_COMPUTE<span style=color:#1f2328>,</span> computePipeline<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>vkCmdBindDescriptorSets<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>,</span> VK_PIPELINE_BIND_POINT_COMPUTE<span style=color:#1f2328>,</span> computePipelineLayout<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>computeDescriptorSets<span style=color:#1f2328>[</span>i<span style=color:#1f2328>],</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vkCmdDispatch<span style=color:#1f2328>(</span>computeCommandBuffer<span style=color:#1f2328>,</span> PARTICLE_COUNT <span style=color:#0550ae>/</span> <span style=color:#0550ae>256</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>vkEndCommandBuffer<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>)</span> <span style=color:#0550ae>!=</span> VK_SUCCESS<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to record command buffer!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里我们注意到： <code>PARTICLE_COUNT / 256</code> ，因为我们每个local size是256。</p><p>所以常见做法是：</p><ul><li>local size 是固定的（设备本身也有一定限制）</li><li>work group size 则是根据数据和local size动态计算出来的。</li></ul><h2 id=提交worksubmitting-work>提交work(Submitting work)</h2><p>很简单，一目了然</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>vkQueueSubmit<span style=color:#1f2328>(</span>computeQueue<span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>submitInfo<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>)</span> <span style=color:#0550ae>!=</span> VK_SUCCESS<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to submit compute command buffer!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>vkQueueSubmit<span style=color:#1f2328>(</span>graphicsQueue<span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>submitInfo<span style=color:#1f2328>,</span> inFlightFences<span style=color:#1f2328>[</span>currentFrame<span style=color:#1f2328>])</span> <span style=color:#0550ae>!=</span> VK_SUCCESS<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to submit draw command buffer!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=同步图形和计算synchronizing-graphics-and-compute>同步图形和计算(Synchronizing graphics and compute)</h2><p>不难，只要有大致逻辑，就知道如何用 semaphore 和 fence 进行同步</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#0550ae>::</span>vector<span style=color:#0550ae>&lt;</span>VkFence<span style=color:#0550ae>&gt;</span> computeInFlightFences<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>std<span style=color:#0550ae>::</span>vector<span style=color:#0550ae>&lt;</span>VkSemaphore<span style=color:#0550ae>&gt;</span> computeFinishedSemaphores<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>computeInFlightFences<span style=color:#1f2328>.</span>resize<span style=color:#1f2328>(</span>MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>computeFinishedSemaphores<span style=color:#1f2328>.</span>resize<span style=color:#1f2328>(</span>MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>VkSemaphoreCreateInfo semaphoreInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>semaphoreInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_SEMAPHORE_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>VkFenceCreateInfo fenceInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>fenceInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_FENCE_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>fenceInfo<span style=color:#1f2328>.</span>flags <span style=color:#0550ae>=</span> VK_FENCE_CREATE_SIGNALED_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>for</span> <span style=color:#1f2328>(</span>size_t i <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span> i <span style=color:#0550ae>&lt;</span> MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>;</span> i<span style=color:#0550ae>++</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>vkCreateSemaphore<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>		    device<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>semaphoreInfo<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>,</span> 
</span></span><span style=display:flex><span>		    <span style=color:#0550ae>&amp;</span>computeFinishedSemaphores<span style=color:#1f2328>[</span>i<span style=color:#1f2328>])</span> <span style=color:#0550ae>!=</span> VK_SUCCESS <span style=color:#0550ae>||</span>
</span></span><span style=display:flex><span>		vkCreateFence<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>			device<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>fenceInfo<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>computeInFlightFences<span style=color:#1f2328>[</span>i<span style=color:#1f2328>])</span> <span style=color:#0550ae>!=</span> VK_SUCCESS
</span></span><span style=display:flex><span>	<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to create compute synchronization objects for a frame!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>	<span style=color:#57606a>// Compute submission
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	vkWaitForFences<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>		device<span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>computeInFlightFences<span style=color:#1f2328>[</span>currentFrame<span style=color:#1f2328>],</span> VK_TRUE<span style=color:#1f2328>,</span> UINT64_MAX<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	updateUniformBuffer<span style=color:#1f2328>(</span>currentFrame<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	vkResetFences<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>computeInFlightFences<span style=color:#1f2328>[</span>currentFrame<span style=color:#1f2328>]);</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	vkResetCommandBuffer<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>		computeCommandBuffers<span style=color:#1f2328>[</span>currentFrame<span style=color:#1f2328>],</span> <span style=color:#57606a>/*VkCommandBufferResetFlagBits*/</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	recordComputeCommandBuffer<span style=color:#1f2328>(</span>computeCommandBuffers<span style=color:#1f2328>[</span>currentFrame<span style=color:#1f2328>]);</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	submitInfo<span style=color:#1f2328>.</span>commandBufferCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	submitInfo<span style=color:#1f2328>.</span>pCommandBuffers <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>computeCommandBuffers<span style=color:#1f2328>[</span>currentFrame<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>	submitInfo<span style=color:#1f2328>.</span>signalSemaphoreCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	submitInfo<span style=color:#1f2328>.</span>pSignalSemaphores <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>computeFinishedSemaphores<span style=color:#1f2328>[</span>currentFrame<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>vkQueueSubmit<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>			computeQueue<span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>submitInfo<span style=color:#1f2328>,</span> computeInFlightFences<span style=color:#1f2328>[</span>currentFrame<span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>		<span style=color:#1f2328>)</span> <span style=color:#0550ae>!=</span> VK_SUCCESS<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	    <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to submit compute command buffer!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#57606a>// Graphics submission
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	vkWaitForFences<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>inFlightFences<span style=color:#1f2328>[</span>currentFrame<span style=color:#1f2328>],</span> VK_TRUE<span style=color:#1f2328>,</span> UINT64_MAX<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	vkResetCommandBuffer<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>		commandBuffers<span style=color:#1f2328>[</span>currentFrame<span style=color:#1f2328>],</span> <span style=color:#57606a>/*VkCommandBufferResetFlagBits*/</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	recordCommandBuffer<span style=color:#1f2328>(</span>commandBuffers<span style=color:#1f2328>[</span>currentFrame<span style=color:#1f2328>],</span> imageIndex<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	VkSemaphore waitSemaphores<span style=color:#1f2328>[]</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span> computeFinishedSemaphores<span style=color:#1f2328>[</span>currentFrame<span style=color:#1f2328>],</span> imageAvailableSemaphores<span style=color:#1f2328>[</span>currentFrame<span style=color:#1f2328>]</span> <span style=color:#1f2328>};</span>	
</span></span><span style=display:flex><span>		<span style=color:#1f2328>...</span>    
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=绘制粒子系统>绘制粒子系统</h1><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Particle</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>static</span> std<span style=color:#0550ae>::</span>array<span style=color:#0550ae>&lt;</span>VkVertexInputAttributeDescription<span style=color:#1f2328>,</span> <span style=color:#0550ae>2</span><span style=color:#0550ae>&gt;</span> getAttributeDescriptions<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        std<span style=color:#0550ae>::</span>array<span style=color:#0550ae>&lt;</span>VkVertexInputAttributeDescription<span style=color:#1f2328>,</span> <span style=color:#0550ae>2</span><span style=color:#0550ae>&gt;</span> attributeDescriptions<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>format <span style=color:#0550ae>=</span> VK_FORMAT_R32G32_SFLOAT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>offset <span style=color:#0550ae>=</span> offsetof<span style=color:#1f2328>(</span>Particle<span style=color:#1f2328>,</span> position<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>format <span style=color:#0550ae>=</span> VK_FORMAT_R32G32B32A32_SFLOAT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>offset <span style=color:#0550ae>=</span> offsetof<span style=color:#1f2328>(</span>Particle<span style=color:#1f2328>,</span> color<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>return</span> attributeDescriptions<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>vkCmdBindVertexBuffers<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>shaderStorageBuffer<span style=color:#1f2328>[</span>currentFrame<span style=color:#1f2328>],</span> offsets<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vkCmdDraw<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>,</span> PARTICLE_COUNT<span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><p>这里忽略了图元的定义。最简单的方法（教程里的效果）：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>VkPipelineInputAssemblyStateCreateInfo inputAssembly<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>inputAssembly<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_PIPELINE_INPUT_ASSEMBLY_STATE_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>inputAssembly<span style=color:#1f2328>.</span>topology <span style=color:#0550ae>=</span> VK_PRIMITIVE_TOPOLOGY_POINT_LIST<span style=color:#1f2328>;</span> <span style=color:#57606a>// &lt;-- 这里决定了图元类型
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>inputAssembly<span style=color:#1f2328>.</span>primitiveRestartEnable <span style=color:#0550ae>=</span> VK_FALSE<span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><p>指定大小的方式</p><p>方法A:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>vkCmdSetLineWidth<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>,</span> pointSize<span style=color:#1f2328>);</span> <span style=color:#57606a>// 注意 Vulkan 也有 line width 但点可以用动态状态
</span></span></span></code></pre></td></tr></table></div></div><p>方法B（shader）：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span><span style=color:#57606a>#version 450</span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>in</span> <span style=color:#cf222e>vec2</span> inPosition<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>in</span> <span style=color:#cf222e>vec4</span> inColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>out</span> <span style=color:#cf222e>vec4</span> fragColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> main<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    gl_Position <span style=color:#0550ae>=</span> <span style=color:#cf222e>vec4</span><span style=color:#1f2328>(</span>inPosition<span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    gl_PointSize <span style=color:#0550ae>=</span> <span style=color:#0550ae>10.0</span><span style=color:#1f2328>;</span> <span style=color:#57606a>// 每个点的大小（像素为单位）</span>
</span></span><span style=display:flex><span>    fragColor <span style=color:#0550ae>=</span> inColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=我们未来绘制的思路>我们未来绘制的思路</h1><h2 id=方法-a---基于-instance-draw>方法 A - 基于 instance draw</h2><p><strong>一个 SSBO 存储逻辑粒子 (position/velocity)，一个 vertex-/index buffer 存储三角形几何 (模板)，然后实例化 (instancing)</strong></p><ol><li><p>用 compute shader 更新粒子状态 (position, maybe other per-particle data) 存在 SSBO。</p></li><li><p>在 graphics pass，使用一个固定的三角形 (triangle mesh)，这个 triangle 作为 <strong>实例 (instance)</strong>，然后通过 instancing + shader，把 instance 的 transform/位置设为 particle 的 position (从 SSBO 读取)。</p><ul><li><p>vertex shader 读取 SSBO (or SSBO → uniform/instance-buffer → vertex shader) 里的 position，把三角形移动到对应位置。</p></li><li><p>draw call 用 instanced draw (vkCmdDrawIndexed or vkCmdDraw) + instanceCount = number of particles。</p></li></ul></li></ol><p>优点：简单、每粒子三角形共享几何数据 (triangle 顶点)，数据量小且高效。</p><p>缺点：如果你希望每个 particle 的三角形几何不一样 (顶点数、顶点位移、随机形状等等)，就不太适用。</p><h2 id=方法-b--gpu-generated-vertex-data>方法 B — GPU-generated vertex data</h2><p><strong>compute shader 写出每个粒子的三角形顶点 (vertex) 到一个 buffer (SSBO or VBO with both storage + vertex usage)，然后用 graphics pass 渲染这些顶点</strong></p><p>也就是说：让 compute shader <em>输出</em> 顶点 (vertex) 数据，而不是仅输出粒子 position。对于每个粒子，写出 3 (或更多) 顶点 (构成三角形, quad, billboard, mesh …) 到一个大的 vertex buffer。</p><ul><li><p>在 Vulkan 中，这个 buffer 要在创建时同时具有 <code>VK_BUFFER_USAGE_STORAGE_BUFFER_BIT</code> (给 compute shader 写) 和 <code>VK_BUFFER_USAGE_VERTEX_BUFFER_BIT</code> (给 vertex shader 读) 标志。教程里已经提到这种 buffer 可行。 <a class=link href=https://tutorial.vulkan.net.cn/Compute_Shader target=_blank rel=noopener>tutorial.vulkan.net.cn</a></p></li><li><p>然后在 graphics pass 的 vertex input stage，将这个 buffer 绑定为 vertex buffer (<code>vkCmdBindVertexBuffers</code>)。</p></li><li><p>vertex shader 只需做最基本的 transform (按 position 输出 <code>gl_Position</code>)，primitive topology 设置为三角形 (triangle) — draw 时用 vkCmdDraw with vertexCount = num_particles * 3 (或总顶点数)，不使用 instancing (或 instancing + per-vertex data as needed)。</p></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/vulkan/>Vulkan</a>
<a href=/tags/compute-shader/>Compute-Shader</a>
<a href=/tags/particle-system/>Particle-System</a></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=[".main-article",".widget--toc"];e.forEach(e=>{const t=document.querySelector(e);t&&renderMathInElement(t,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})})</script></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/2025/12/09/vulkan%E5%85%A5%E9%97%A808-multisampling/><div class=article-details><h2 class=article-title>Vulkan入门08-Multisampling</h2></div></a></article><article><a href=/2025/12/09/vulkan%E5%85%A5%E9%97%A807-generating-mipmaps/><div class=article-details><h2 class=article-title>Vulkan入门07-Generating Mipmaps</h2></div></a></article><article><a href=/2025/12/08/vulkan%E5%85%A5%E9%97%A806-loading-models/><div class=article-details><h2 class=article-title>Vulkan入门06-Loading models</h2></div></a></article><article><a href=/2025/12/08/vulkan%E5%85%A5%E9%97%A805-depth-buffering/><div class=article-details><h2 class=article-title>Vulkan入门05-Depth buffering</h2></div></a></article><article><a href=/2025/12/04/vulkan%E5%85%A5%E9%97%A804-texture-mapping/><div class=article-details><h2 class=article-title>Vulkan入门04-Texture mapping</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2025 crackhopper的技术博客</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.32.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.0fcb739c1f88ce461c9640077fd21d8ce903946f1aef209dd01192827d26a90c.js defer></script><script type=text/javascript src=/ts/custom.fb6397326fc458b8ae775aee18e0a0ae80628aec9c216e7e90c79bb0486cb0e3.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>
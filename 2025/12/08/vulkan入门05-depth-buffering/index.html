<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="\n深度缓冲，对于有图形基础的人来说是很熟悉的概念。Vulkan中是如何管理的呢？\n创建 Depth Image 和 Depth Image View, Depth Image Memory 在 RenderPass 创建的时候，增加深度附件。（在渲染的时候，指定RenderPass的ClearValue） 创建FrameBuffer的时候，绑定具体的深度数据。 渲染：创建渲染Pipine的时候，开启深度测试（填充对应的结构体） 资源管理：注意和swapchain image数据的生命周期一致。 "><title>Vulkan入门05-Depth buffering</title><link rel=canonical href=https://crackhopper.github.io/2025/12/08/vulkan%E5%85%A5%E9%97%A805-depth-buffering/><link rel=stylesheet href=/scss/style.min.4d36f8dc1fd48129e1635deb4b8eb2870fa09474f7280c4cb606d40b2526994b.css><meta property='og:title' content="Vulkan入门05-Depth buffering"><meta property='og:description' content="\n深度缓冲，对于有图形基础的人来说是很熟悉的概念。Vulkan中是如何管理的呢？\n创建 Depth Image 和 Depth Image View, Depth Image Memory 在 RenderPass 创建的时候，增加深度附件。（在渲染的时候，指定RenderPass的ClearValue） 创建FrameBuffer的时候，绑定具体的深度数据。 渲染：创建渲染Pipine的时候，开启深度测试（填充对应的结构体） 资源管理：注意和swapchain image数据的生命周期一致。 "><meta property='og:url' content='https://crackhopper.github.io/2025/12/08/vulkan%E5%85%A5%E9%97%A805-depth-buffering/'><meta property='og:site_name' content='crackhopper的技术博客'><meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:tag' content='vulkan'><meta property='article:tag' content='depth-test'><meta property='article:tag' content='3d'><meta property='article:published_time' content='2025-12-08T15:37:04+08:00'><meta property='article:modified_time' content='2025-12-08T15:37:04+08:00'><meta name=twitter:title content="Vulkan入门05-Depth buffering"><meta name=twitter:description content="\n深度缓冲，对于有图形基础的人来说是很熟悉的概念。Vulkan中是如何管理的呢？\n创建 Depth Image 和 Depth Image View, Depth Image Memory 在 RenderPass 创建的时候，增加深度附件。（在渲染的时候，指定RenderPass的ClearValue） 创建FrameBuffer的时候，绑定具体的深度数据。 渲染：创建渲染Pipine的时候，开启深度测试（填充对应的结构体） 资源管理：注意和swapchain image数据的生命周期一致。 "><link rel=stylesheet href=/css/custom.css></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_337fe2b325ec916d.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>crackhopper的技术博客</a></h1><h2 class=site-description>C++, Graphics, Game, AI/ML</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>文章</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于我</span></a></li><li><a href=/projects/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>项目</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ul><li><ul><li><a href=#3d几何>3D几何</a></li><li><a href=#depth-image-and-view>Depth image and view</a></li><li><a href=#render-pass-类比-预留槽位>Render pass (类比: 预留"槽位")</a><ul><li><a href=#clear-values>Clear values</a></li></ul></li><li><a href=#framebuffer-类比-填充槽位>Framebuffer (类比: 填充"槽位")</a></li><li><a href=#pipeline中开启depth-test>Pipeline中开启Depth test</a></li><li><a href=#显示效果>显示效果</a></li><li><a href=#处理window-resize>处理window resize</a></li></ul></li></ul></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/2025/12/08/vulkan%E5%85%A5%E9%97%A805-depth-buffering/>Vulkan入门05-Depth buffering</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2025-12-08T15:37:04+08:00>Dec 08, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>7 minute read</time></div></footer></div></header><section class=article-content><p><img src=/images/Vulkan%E5%85%A5%E9%97%A805-Depth%20buffering-1765166362854.png loading=lazy alt="Vulkan入门05-Depth buffering-1765166362854"></p><p>深度缓冲，对于有图形基础的人来说是很熟悉的概念。Vulkan中是如何管理的呢？</p><ol><li>创建 Depth Image 和 Depth Image View, Depth Image Memory</li><li>在 RenderPass 创建的时候，增加深度附件。（在渲染的时候，指定RenderPass的ClearValue）</li><li>创建FrameBuffer的时候，绑定具体的深度数据。</li><li>渲染：创建渲染Pipine的时候，开启深度测试（填充对应的结构体）</li><li>资源管理：注意和swapchain image数据的生命周期一致。</li></ol><h2 id=3d几何>3D几何</h2><p>顶点修改为3D顶点：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Vertex</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    glm<span style=color:#0550ae>::</span>vec3 pos<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    glm<span style=color:#0550ae>::</span>vec3 color<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    glm<span style=color:#0550ae>::</span>vec2 texCoord<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>static</span> std<span style=color:#0550ae>::</span>array<span style=color:#0550ae>&lt;</span>VkVertexInputAttributeDescription<span style=color:#1f2328>,</span> <span style=color:#0550ae>3</span><span style=color:#0550ae>&gt;</span> getAttributeDescriptions<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        std<span style=color:#0550ae>::</span>array<span style=color:#0550ae>&lt;</span>VkVertexInputAttributeDescription<span style=color:#1f2328>,</span> <span style=color:#0550ae>3</span><span style=color:#0550ae>&gt;</span> attributeDescriptions<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>format <span style=color:#0550ae>=</span> VK_FORMAT_R32G32B32_SFLOAT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>offset <span style=color:#0550ae>=</span> offsetof<span style=color:#1f2328>(</span>Vertex<span style=color:#1f2328>,</span> pos<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><p>更新VertexShader</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>in</span> <span style=color:#cf222e>vec3</span> inPosition<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> main<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    gl_Position <span style=color:#0550ae>=</span> ubo<span style=color:#1f2328>.</span>proj <span style=color:#0550ae>*</span> ubo<span style=color:#1f2328>.</span>view <span style=color:#0550ae>*</span> ubo<span style=color:#1f2328>.</span>model <span style=color:#0550ae>*</span> <span style=color:#cf222e>vec4</span><span style=color:#1f2328>(</span>inPosition<span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    fragColor <span style=color:#0550ae>=</span> inColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    fragTexCoord <span style=color:#0550ae>=</span> inTexCoord<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>更新顶点数据，增加z坐标</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>const</span> std<span style=color:#0550ae>::</span>vector<span style=color:#0550ae>&lt;</span>Vertex<span style=color:#0550ae>&gt;</span> vertices <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{{</span><span style=color:#0550ae>-</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>-</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>}},</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{{</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>-</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>}},</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{{</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>}},</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{{</span><span style=color:#0550ae>-</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>}}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><p>随后，我们为了表明3D渲染，在之前的矩形下方再增加一个矩形。
<img src=/images/Vulkan%E5%85%A5%E9%97%A805-Depth%20buffering-1765166362854.png loading=lazy alt="Vulkan入门05-Depth buffering-1765166362854"></p><p>更新顶点和索引数据：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>const</span> std<span style=color:#0550ae>::</span>vector<span style=color:#0550ae>&lt;</span>Vertex<span style=color:#0550ae>&gt;</span> vertices <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{{</span><span style=color:#0550ae>-</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>-</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>}},</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{{</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>-</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>}},</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{{</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>}},</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{{</span><span style=color:#0550ae>-</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>}},</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{{</span><span style=color:#0550ae>-</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>-</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>-</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>}},</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{{</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>-</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>-</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>}},</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{{</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>-</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>}},</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{{</span><span style=color:#0550ae>-</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>-</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>}}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>const</span> std<span style=color:#0550ae>::</span>vector<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>uint16_t</span><span style=color:#0550ae>&gt;</span> indices <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>2</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>2</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>3</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>4</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>5</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>6</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>6</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>7</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>4</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><p>我们注意到，更高的矩形，应该在矮矩形的上方。但此时我们的显示内容为：
<img src=/images/Vulkan%E5%85%A5%E9%97%A805-Depth%20buffering-1765178797074.png loading=lazy alt="Vulkan入门05-Depth buffering-1765178797074"></p><p>解决这个问题，两个办法：</p><ol><li>根据深度，对所有的draw call排序。先绘制更深的图元，然后绘制浅的图元。 （这个方法通常处理透明物体： 因为 order-independent transparency 是很困难的问题）<ul><li>关于透明材料的思考： <strong>透明材料在物理上是通过波长相关的吸收系数来定义的，其颜色表现来自未被吸收的透射光；吸收的是背景光本身，因此不存在“材料吸收固定颜色”的直观定义。只有在图形学简化模型（如 alpha blending）中，才人为引入“材料颜色”作为独立的注入项。</strong></li><li>现实中的透明材料，本身也有散射光线（体散射）。现实中的透明材料，本身也有散射光线。因此， <strong>alpha融合本身，是透明吸收模型+材料自身体散射的这种构造意图产生的颜色；它既不是严格的物理模型，也不满足真实散射的基本约束。</strong></li><li>PBR中，会根据透明色颜色，使用 Transmisson Color 来计算颜色吸收（简化处理，考虑材料厚度，实际是对 <strong>Beer–Lambert 透射公式</strong> 的 <strong>RGB 近似</strong>）。而对于体散射，区分材质来处理。比如，对于类似塑料的材质（实时处理），在材质面上加一个体积雾近似，用alpha融合/半透明叠加代替体散射。</li></ul></li><li>使用深度缓冲 (depth buffer)<ul><li><strong>Fragment 的概念</strong>： 光栅化后对应屏幕像素采样点的候选，包含该像素位置及被其射线穿过的图元信息，是 <strong>像素空间与图元几何信息的结合体</strong>。</li><li><strong>Fragment 属性</strong>： 来自图元顶点，通过 <strong>重心插值 (barycentric interpolation)</strong> 计算深度、颜色、纹理坐标等信息。</li><li><strong>光栅化阶段流程</strong>：<ol><li><strong>计算图元覆盖像素区域</strong> → 生成对应的 fragment（或多个 MSAA 采样点）。</li><li><strong>Hierarchical-Z（Hi-Z）优化</strong><ul><li>利用 depth buffer 金字塔结构，对图元覆盖区域做快速粗粒度深度测试。</li><li>可在 Early-Z 前剔除整个图元或大区域，减少 fragment 生成和后续深度测试计算量。</li></ul></li><li><strong>Early-Z（片段着色器前深度测试）</strong><ul><li>对每个 fragment（或 MSAA 采样点）在进入片段着色器前做深度测试。</li><li>若深度大于 depth buffer 值，则该 fragment（或采样点）被丢弃，避免执行片段着色器。</li><li>GPU 可以利用 <strong>粗粒度剔除</strong>（例如图元包围盒 + 顶点深度）来减少 fragment 生成，但 Early-Z 核心仍是 <strong>fragment / sample 级别的提前深度测试</strong>。</li></ul></li></ol></li></ul></li></ol><p>使用GLM为了兼容vulkan的深度范围(0,1)，我们需要开启一些宏开关：（OGL默认是-1,1）</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>#define GLM_FORCE_RADIANS
</span></span></span><span style=display:flex><span><span style=color:#57606a>#define GLM_FORCE_DEPTH_ZERO_TO_ONE
</span></span></span><span style=display:flex><span><span style=color:#57606a>#include</span> <span style=color:#57606a>&lt;glm/glm.hpp&gt;</span><span style=color:#57606a>
</span></span></span><span style=display:flex><span><span style=color:#57606a>#include</span> <span style=color:#57606a>&lt;glm/gtc/matrix_transform.hpp&gt;</span><span style=color:#57606a>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=depth-image-and-view>Depth image and view</h2><p>我们只需要创建一个深度图像即可，因为绘制指令不会并行（即1次仅有1个绘制指令再执行，这是硬件保障的）</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>VkImage depthImage<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>VkDeviceMemory depthImageMemory<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>VkImageView depthImageView<span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><p>接着我们来创建深度缓冲相关的资源:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>initVulkan</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>    createCommandPool<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    createDepthResources<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    createTextureImage<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> createDepthResources<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关于深度缓冲：宽高选择 swap chain extend的宽高，usage选择 depth attachment，选择最优的tiling，以及 device local memory，这些选择是显而易见的。还有一个问题，depth image的格式如何选择？常见的格式有：</p><ul><li><code>VK_FORMAT_D32_SFLOAT</code>: 32-bit float for depth</li><li><code>VK_FORMAT_D32_SFLOAT_S8_UINT</code>: 32-bit signed float for depth and 8 bit stencil component （模板测试本文先不提，实际上和深度测试类似，可以组合使用）</li><li><code>VK_FORMAT_D24_UNORM_S8_UINT</code>: 24-bit float for depth and 8 bit stencil component</li></ul><p>我们可以直接使用第一个格式。 <code>VK_FORMAT_D32_SFLOAT</code> （因为被广泛支持）。但我们还是写一个函数来更加动态的检测：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>// 从 candidates 中，选择符合 tiling 和 features 设定的格式
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>VkFormat <span style=color:#6639ba>findSupportedFormat</span><span style=color:#1f2328>(</span><span style=color:#cf222e>const</span> std<span style=color:#0550ae>::</span>vector<span style=color:#0550ae>&lt;</span>VkFormat<span style=color:#0550ae>&gt;&amp;</span> candidates<span style=color:#1f2328>,</span> VkImageTiling tiling<span style=color:#1f2328>,</span> VkFormatFeatureFlags features<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>for</span> <span style=color:#1f2328>(</span>VkFormat <span style=color:#900;font-weight:700>format</span> <span style=color:#1f2328>:</span> candidates<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	    VkFormatProperties props<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>		vkGetPhysicalDeviceFormatProperties<span style=color:#1f2328>(</span>physicalDevice<span style=color:#1f2328>,</span> format<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>props<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>		<span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>tiling <span style=color:#0550ae>==</span> VK_IMAGE_TILING_LINEAR <span style=color:#0550ae>&amp;&amp;</span> 
</span></span><span style=display:flex><span>		<span style=color:#57606a>// props.linearTilingFeatures 返回了格式所支持的 linear tiling 下的 feature
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>		<span style=color:#1f2328>(</span>props<span style=color:#1f2328>.</span>linearTilingFeatures <span style=color:#0550ae>&amp;</span> features<span style=color:#1f2328>)</span> <span style=color:#0550ae>==</span> features<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>		    <span style=color:#cf222e>return</span> format<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>		<span style=color:#1f2328>}</span> <span style=color:#cf222e>else</span> <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>tiling <span style=color:#0550ae>==</span> VK_IMAGE_TILING_OPTIMAL <span style=color:#0550ae>&amp;&amp;</span>
</span></span><span style=display:flex><span>		<span style=color:#57606a>// props.optimalTilingFeatures 返回了格式所支持的 optimal tiling 下的 feature
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>		 <span style=color:#1f2328>(</span>props<span style=color:#1f2328>.</span>optimalTilingFeatures <span style=color:#0550ae>&amp;</span> features<span style=color:#1f2328>)</span> <span style=color:#0550ae>==</span> features<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>		    <span style=color:#cf222e>return</span> format<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>		<span style=color:#1f2328>}</span>		    
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 查找格式失败，扔出异常。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to find supported format!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 我们具体查找格式的用法
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>VkFormat <span style=color:#6639ba>findDepthFormat</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> findSupportedFormat<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	        VK_FORMAT_D32_SFLOAT<span style=color:#1f2328>,</span> 
</span></span><span style=display:flex><span>	        VK_FORMAT_D32_SFLOAT_S8_UINT<span style=color:#1f2328>,</span> 
</span></span><span style=display:flex><span>	        VK_FORMAT_D24_UNORM_S8_UINT
</span></span><span style=display:flex><span>	    <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>        VK_IMAGE_TILING_OPTIMAL<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>        VK_FORMAT_FEATURE_DEPTH_STENCIL_ATTACHMENT_BIT
</span></span><span style=display:flex><span>    <span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 判断选择的格式是否支持stencil(模板)
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>bool</span> <span style=color:#6639ba>hasStencilComponent</span><span style=color:#1f2328>(</span>VkFormat format<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> format <span style=color:#0550ae>==</span> VK_FORMAT_D32_SFLOAT_S8_UINT <span style=color:#0550ae>||</span> format <span style=color:#0550ae>==</span> VK_FORMAT_D24_UNORM_S8_UINT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>现在我们可以回到 <code>createDepthResources</code> 函数中：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>VkImage depthImage<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>VkDeviceMemory depthImageMemory<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>VkImageView depthImageView<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>createDepthResources</span><span style=color:#1f2328>(){</span>
</span></span><span style=display:flex><span>	VkFormat depthFormat <span style=color:#0550ae>=</span> findDepthFormat<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>	createImage<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>		swapChainExtent<span style=color:#1f2328>.</span>width<span style=color:#1f2328>,</span> swapChainExtent<span style=color:#1f2328>.</span>height<span style=color:#1f2328>,</span> 
</span></span><span style=display:flex><span>		depthFormat<span style=color:#1f2328>,</span> 
</span></span><span style=display:flex><span>		VK_IMAGE_TILING_OPTIMAL<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>		VK_IMAGE_USAGE_DEPTH_STENCIL_ATTACHMENT_BIT<span style=color:#1f2328>,</span> 
</span></span><span style=display:flex><span>		VK_MEMORY_PROPERTY_DEVICE_LOCAL_BIT<span style=color:#1f2328>,</span> 
</span></span><span style=display:flex><span>		depthImage<span style=color:#1f2328>,</span> depthImageMemory<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>	depthImageView <span style=color:#0550ae>=</span> createImageView<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>		depthImage<span style=color:#1f2328>,</span> depthFormat<span style=color:#1f2328>,</span> VK_IMAGE_ASPECT_DEPTH_BIT<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 手动显式转化layout （实际上并不需要，renderPass会自动搞定，这里只是演示）
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	transitionImageLayout<span style=color:#1f2328>(</span>depthImage<span style=color:#1f2328>,</span> depthFormat<span style=color:#1f2328>,</span> 
</span></span><span style=display:flex><span>		VK_IMAGE_LAYOUT_UNDEFINED<span style=color:#1f2328>,</span> 
</span></span><span style=display:flex><span>		VK_IMAGE_LAYOUT_DEPTH_STENCIL_ATTACHMENT_OPTIMAL<span style=color:#1f2328>);</span>	
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 更新这个函数，增加一个参数，可以指定 aspectFlags (这个可有理解为 image view 关注 image 的部分， 我们这里和用途一致)
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>VkImageView <span style=color:#6639ba>createImageView</span><span style=color:#1f2328>(</span>VkImage image<span style=color:#1f2328>,</span> VkFormat format<span style=color:#1f2328>,</span> VkImageAspectFlags aspectFlags<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>    viewInfo<span style=color:#1f2328>.</span>subresourceRange<span style=color:#1f2328>.</span>aspectMask <span style=color:#0550ae>=</span> aspectFlags<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 为了支持显示转化格式，我们需要调整一下。
</span></span></span><span style=display:flex><span><span style=color:#57606a>// 增加了新的barrier，并且使用了 barrier 的 aspectMask
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>void</span> <span style=color:#6639ba>transitionImageLayout</span><span style=color:#1f2328>(</span>VkImage image<span style=color:#1f2328>,</span> VkFormat format<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>						 VkImageLayout oldLayout<span style=color:#1f2328>,</span> VkImageLayout newLayout<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>newLayout <span style=color:#0550ae>==</span> VK_IMAGE_LAYOUT_DEPTH_STENCIL_ATTACHMENT_OPTIMAL<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	    barrier<span style=color:#1f2328>.</span>subresourceRange<span style=color:#1f2328>.</span>aspectMask <span style=color:#0550ae>=</span> VK_IMAGE_ASPECT_DEPTH_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>hasStencilComponent<span style=color:#1f2328>(</span>format<span style=color:#1f2328>))</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	        barrier<span style=color:#1f2328>.</span>subresourceRange<span style=color:#1f2328>.</span>aspectMask <span style=color:#0550ae>|=</span> VK_IMAGE_ASPECT_STENCIL_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span> <span style=color:#cf222e>else</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	    barrier<span style=color:#1f2328>.</span>subresourceRange<span style=color:#1f2328>.</span>aspectMask <span style=color:#0550ae>=</span> VK_IMAGE_ASPECT_COLOR_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>oldLayout <span style=color:#0550ae>==</span> VK_IMAGE_LAYOUT_UNDEFINED <span style=color:#0550ae>&amp;&amp;</span> newLayout <span style=color:#0550ae>==</span> VK_IMAGE_LAYOUT_TRANSFER_DST_OPTIMAL<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	    barrier<span style=color:#1f2328>.</span>srcAccessMask <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	    barrier<span style=color:#1f2328>.</span>dstAccessMask <span style=color:#0550ae>=</span> VK_ACCESS_TRANSFER_WRITE_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	    sourceStage <span style=color:#0550ae>=</span> VK_PIPELINE_STAGE_TOP_OF_PIPE_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	    destinationStage <span style=color:#0550ae>=</span> VK_PIPELINE_STAGE_TRANSFER_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span> <span style=color:#cf222e>else</span> <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>oldLayout <span style=color:#0550ae>==</span> VK_IMAGE_LAYOUT_TRANSFER_DST_OPTIMAL <span style=color:#0550ae>&amp;&amp;</span> newLayout <span style=color:#0550ae>==</span> VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	    barrier<span style=color:#1f2328>.</span>srcAccessMask <span style=color:#0550ae>=</span> VK_ACCESS_TRANSFER_WRITE_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	    barrier<span style=color:#1f2328>.</span>dstAccessMask <span style=color:#0550ae>=</span> VK_ACCESS_SHADER_READ_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	    sourceStage <span style=color:#0550ae>=</span> VK_PIPELINE_STAGE_TRANSFER_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	    destinationStage <span style=color:#0550ae>=</span> VK_PIPELINE_STAGE_FRAGMENT_SHADER_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span> <span style=color:#cf222e>else</span> <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>oldLayout <span style=color:#0550ae>==</span> VK_IMAGE_LAYOUT_UNDEFINED <span style=color:#0550ae>&amp;&amp;</span> newLayout <span style=color:#0550ae>==</span> VK_IMAGE_LAYOUT_DEPTH_STENCIL_ATTACHMENT_OPTIMAL<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	    barrier<span style=color:#1f2328>.</span>srcAccessMask <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	    barrier<span style=color:#1f2328>.</span>dstAccessMask <span style=color:#0550ae>=</span> VK_ACCESS_DEPTH_STENCIL_ATTACHMENT_READ_BIT <span style=color:#0550ae>|</span> VK_ACCESS_DEPTH_STENCIL_ATTACHMENT_WRITE_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	    sourceStage <span style=color:#0550ae>=</span> VK_PIPELINE_STAGE_TOP_OF_PIPE_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	    destinationStage <span style=color:#0550ae>=</span> VK_PIPELINE_STAGE_EARLY_FRAGMENT_TESTS_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span> <span style=color:#cf222e>else</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	    <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>invalid_argument<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;unsupported layout transition!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    vkCmdPipelineBarrier<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>,</span> sourceStage<span style=color:#1f2328>,</span> destinationStage<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>                         <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>barrier<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    endSingleTimeCommands<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里我们编写了显示的布局转换操作。</p><p>补充，AI在这里应该没有掌握具体的细节。去调研细节也比较费时间。暂时我们根据AI给出的描述，做一定补充。这里 ImageBarrier 本身包含了到达 dstStage 时，需要完成 layout转化。但并没有说明在指定这个barrier的时候就要”立即“执行转化。</p><p>这里，barrier的理解，当 dstStage 和 dstAccessMask 要开始的时候：</p><ul><li>确保 srcStage, srcAccessMask 完成</li><li>确保 layout 转化完成 （barrier内部的 newLayout 和 oldLayout字段定义了这个行为）</li></ul><p>所以，布局转化操作，实际是将 这个操作 定义在了一个 管线的 时间区间之内（当然触发条件时dst的阶段和mask能达到）。</p><h2 id=render-pass-类比-预留槽位>Render pass (类比: 预留"槽位")</h2><p>上面我们定义好了 Depth Image 和 view 。接着我们要在渲染管线中 <code>createRenderPass</code>，添加这些资源：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>// VkAttachmentDescription 结构体，用于描述深度附件。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>VkAttachmentDescription depthAttachment<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>depthAttachment<span style=color:#1f2328>.</span>format <span style=color:#0550ae>=</span> findDepthFormat<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>depthAttachment<span style=color:#1f2328>.</span>samples <span style=color:#0550ae>=</span> VK_SAMPLE_COUNT_1_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#57606a>// **加载操作 (Load Op):** 在渲染开始时，如何处理深度附件中的现有数据。
</span></span></span><span style=display:flex><span><span style=color:#57606a>// VK_ATTACHMENT_LOAD_OP_CLEAR 表示在渲染此 Render Pass 时，附件中的所有像素将被清除为预设值 (通常为 1.0f，表示最远)。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>depthAttachment<span style=color:#1f2328>.</span>loadOp <span style=color:#0550ae>=</span> VK_ATTACHMENT_LOAD_OP_CLEAR<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#57606a>// **存储操作 (Store Op):** 在渲染结束时，如何处理深度附件中的数据。
</span></span></span><span style=display:flex><span><span style=color:#57606a>// VK_ATTACHMENT_STORE_OP_DONT_CARE 表示渲染完成后，深度数据的内容不需要被保留或写回内存。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>depthAttachment<span style=color:#1f2328>.</span>storeOp <span style=color:#0550ae>=</span> VK_ATTACHMENT_STORE_OP_DONT_CARE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>depthAttachment<span style=color:#1f2328>.</span>stencilLoadOp <span style=color:#0550ae>=</span> VK_ATTACHMENT_LOAD_OP_DONT_CARE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>depthAttachment<span style=color:#1f2328>.</span>stencilStoreOp <span style=color:#0550ae>=</span> VK_ATTACHMENT_STORE_OP_DONT_CARE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>depthAttachment<span style=color:#1f2328>.</span>initialLayout <span style=color:#0550ae>=</span> VK_IMAGE_LAYOUT_UNDEFINED<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>depthAttachment<span style=color:#1f2328>.</span>finalLayout <span style=color:#0550ae>=</span> VK_IMAGE_LAYOUT_DEPTH_STENCIL_ATTACHMENT_OPTIMAL<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 方便subpass引用附件。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>VkAttachmentReference depthAttachmentRef<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>depthAttachmentRef<span style=color:#1f2328>.</span>attachment <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>depthAttachmentRef<span style=color:#1f2328>.</span>layout <span style=color:#0550ae>=</span> VK_IMAGE_LAYOUT_DEPTH_STENCIL_ATTACHMENT_OPTIMAL<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// subpass中新增depth附件
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>VkSubpassDescription subpass<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>subpass<span style=color:#1f2328>.</span>pipelineBindPoint <span style=color:#0550ae>=</span> VK_PIPELINE_BIND_POINT_GRAPHICS<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>subpass<span style=color:#1f2328>.</span>colorAttachmentCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>subpass<span style=color:#1f2328>.</span>pColorAttachments <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>colorAttachmentRef<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>subpass<span style=color:#1f2328>.</span>pDepthStencilAttachment <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>depthAttachmentRef<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 修改dependency，上一个subpass需要完成，才进入下一个subpass的阶段。
</span></span></span><span style=display:flex><span><span style=color:#57606a>// 我们的是 external 依赖，因此严格来说是上一帧的depth写入完成，下一帧才能写入。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>dependency<span style=color:#1f2328>.</span>srcStageMask <span style=color:#0550ae>=</span> VK_PIPELINE_STAGE_COLOR_ATTACHMENT_OUTPUT_BIT <span style=color:#0550ae>|</span> VK_PIPELINE_STAGE_LATE_FRAGMENT_TESTS_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>dependency<span style=color:#1f2328>.</span>srcAccessMask <span style=color:#0550ae>=</span> VK_ACCESS_DEPTH_STENCIL_ATTACHMENT_WRITE_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>dependency<span style=color:#1f2328>.</span>dstStageMask <span style=color:#0550ae>=</span> VK_PIPELINE_STAGE_COLOR_ATTACHMENT_OUTPUT_BIT <span style=color:#0550ae>|</span> VK_PIPELINE_STAGE_EARLY_FRAGMENT_TESTS_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>dependency<span style=color:#1f2328>.</span>dstAccessMask <span style=color:#0550ae>=</span> VK_ACCESS_COLOR_ATTACHMENT_WRITE_BIT <span style=color:#0550ae>|</span> VK_ACCESS_DEPTH_STENCIL_ATTACHMENT_WRITE_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// RenderPass中要包含原本附件内容。 （subpass则是用引用的方式）
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>std<span style=color:#0550ae>::</span>array<span style=color:#0550ae>&lt;</span>VkAttachmentDescription<span style=color:#1f2328>,</span> <span style=color:#0550ae>2</span><span style=color:#0550ae>&gt;</span> attachments <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span>colorAttachment<span style=color:#1f2328>,</span> depthAttachment<span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>VkRenderPassCreateInfo renderPassInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>renderPassInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_RENDER_PASS_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>renderPassInfo<span style=color:#1f2328>.</span>attachmentCount <span style=color:#0550ae>=</span> <span style=color:#cf222e>static_cast</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>uint32_t</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>attachments<span style=color:#1f2328>.</span>size<span style=color:#1f2328>());</span>
</span></span><span style=display:flex><span>renderPassInfo<span style=color:#1f2328>.</span>pAttachments <span style=color:#0550ae>=</span> attachments<span style=color:#1f2328>.</span>data<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>renderPassInfo<span style=color:#1f2328>.</span>subpassCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>renderPassInfo<span style=color:#1f2328>.</span>pSubpasses <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>subpass<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>renderPassInfo<span style=color:#1f2328>.</span>dependencyCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>renderPassInfo<span style=color:#1f2328>.</span>pDependencies <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>dependency<span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=clear-values>Clear values</h3><p>因为我们有多个 clear op的定义，因此我们需要多个clear value。这个动作在绘制的时候指定，而不是创建的时候，所以，在 <code>recorCommandBuffer</code> 中修改：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#0550ae>::</span>array<span style=color:#0550ae>&lt;</span>VkClearValue<span style=color:#1f2328>,</span> <span style=color:#0550ae>2</span><span style=color:#0550ae>&gt;</span> clearValues<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>clearValues<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>color <span style=color:#0550ae>=</span> <span style=color:#1f2328>{{</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>}};</span>
</span></span><span style=display:flex><span>clearValues<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>depthStencil <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>renderPassInfo<span style=color:#1f2328>.</span>clearValueCount <span style=color:#0550ae>=</span> <span style=color:#cf222e>static_cast</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>uint32_t</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>clearValues<span style=color:#1f2328>.</span>size<span style=color:#1f2328>());</span>
</span></span><span style=display:flex><span>renderPassInfo<span style=color:#1f2328>.</span>pClearValues <span style=color:#0550ae>=</span> clearValues<span style=color:#1f2328>.</span>data<span style=color:#1f2328>();</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=framebuffer-类比-填充槽位>Framebuffer (类比: 填充"槽位")</h2><p>那么渲染需要的framebuffer，显然要把 depth image信息作为附件添加进去。修改 <code>createFramebuffers</code> 函数</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#0550ae>::</span>array<span style=color:#0550ae>&lt;</span>VkImageView<span style=color:#1f2328>,</span> <span style=color:#0550ae>2</span><span style=color:#0550ae>&gt;</span> attachments <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    swapChainImageViews<span style=color:#1f2328>[</span>i<span style=color:#1f2328>],</span>
</span></span><span style=display:flex><span>    depthImageView
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>VkFramebufferCreateInfo framebufferInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>framebufferInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_FRAMEBUFFER_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>framebufferInfo<span style=color:#1f2328>.</span>renderPass <span style=color:#0550ae>=</span> renderPass<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>framebufferInfo<span style=color:#1f2328>.</span>attachmentCount <span style=color:#0550ae>=</span> <span style=color:#cf222e>static_cast</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>uint32_t</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>attachments<span style=color:#1f2328>.</span>size<span style=color:#1f2328>());</span>
</span></span><span style=display:flex><span>framebufferInfo<span style=color:#1f2328>.</span>pAttachments <span style=color:#0550ae>=</span> attachments<span style=color:#1f2328>.</span>data<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>framebufferInfo<span style=color:#1f2328>.</span>width <span style=color:#0550ae>=</span> swapChainExtent<span style=color:#1f2328>.</span>width<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>framebufferInfo<span style=color:#1f2328>.</span>height <span style=color:#0550ae>=</span> swapChainExtent<span style=color:#1f2328>.</span>height<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>framebufferInfo<span style=color:#1f2328>.</span>layers <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><p>确保 framebuffer的创建在 depth resource之后：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>initVulkan</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>    createDepthResources<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    createFramebuffers<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=pipeline中开启depth-test>Pipeline中开启Depth test</h2><p>修改 <code>createGraphicsPipeline</code></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>VkPipelineDepthStencilStateCreateInfo depthStencil<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>depthStencil<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_PIPELINE_DEPTH_STENCIL_STATE_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 测试fragment是否通过
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>depthStencil<span style=color:#1f2328>.</span>depthTestEnable <span style=color:#0550ae>=</span> VK_TRUE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 测试通过后，是否写入depth
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>depthStencil<span style=color:#1f2328>.</span>depthWriteEnable <span style=color:#0550ae>=</span> VK_TRUE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 更小的深度值可以写入
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>depthStencil<span style=color:#1f2328>.</span>depthCompareOp <span style=color:#0550ae>=</span> VK_COMPARE_OP_LESS<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 特殊能力，仅保留depth在某个区间的fragment 进行测试。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>depthStencil<span style=color:#1f2328>.</span>depthBoundsTestEnable <span style=color:#0550ae>=</span> VK_FALSE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>depthStencil<span style=color:#1f2328>.</span>minDepthBounds <span style=color:#0550ae>=</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>;</span> <span style=color:#57606a>// Optional
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>depthStencil<span style=color:#1f2328>.</span>maxDepthBounds <span style=color:#0550ae>=</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>;</span> <span style=color:#57606a>// Optional
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>pipelineInfo<span style=color:#1f2328>.</span>pDepthStencilState <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>depthStencil<span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><p>Depth Bounds Test 常见用途：</p><ul><li>延迟渲染中某个深度切片</li><li>特殊遮罩 / debug pass
大多数引擎根本不用（包括 Unreal 默认）</li></ul><h2 id=显示效果>显示效果</h2><p><img src=/images/Vulkan%E5%85%A5%E9%97%A805-Depth%20buffering-1765179402245.png loading=lazy alt="Vulkan入门05-Depth buffering-1765179402245"></p><h2 id=处理window-resize>处理window resize</h2><p>当resize发生的时候，我们需要重新创建 depthResouce；同时，销毁资源也应该和swapChain一起销毁。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>recreateSwapChain</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>int</span> width <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> height <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>while</span> <span style=color:#1f2328>(</span>width <span style=color:#0550ae>==</span> <span style=color:#0550ae>0</span> <span style=color:#0550ae>||</span> height <span style=color:#0550ae>==</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        glfwGetFramebufferSize<span style=color:#1f2328>(</span>window<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>width<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>height<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>        glfwWaitEvents<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    vkDeviceWaitIdle<span style=color:#1f2328>(</span>device<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cleanupSwapChain<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    createSwapChain<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    createImageViews<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    createDepthResources<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    createFramebuffers<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>cleanupSwapChain</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    vkDestroyImageView<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> depthImageView<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    vkDestroyImage<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> depthImage<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    vkFreeMemory<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> depthImageMemory<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-tags><a href=/tags/vulkan/>Vulkan</a>
<a href=/tags/depth-test/>Depth-Test</a>
<a href=/tags/3d/>3d</a></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=[".main-article",".widget--toc"];e.forEach(e=>{const t=document.querySelector(e);t&&renderMathInElement(t,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})})</script></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/2025/12/04/vulkan%E5%85%A5%E9%97%A804-texture-mapping/><div class=article-details><h2 class=article-title>Vulkan入门04-Texture mapping</h2></div></a></article><article><a href=/2025/12/03/vulkan%E5%85%A5%E9%97%A803-uniformbuffers/><div class=article-details><h2 class=article-title>Vulkan入门03-UniformBuffers</h2></div></a></article><article><a href=/2025/11/27/vulkan%E5%85%A5%E9%97%A802-vertexbuffers/><div class=article-details><h2 class=article-title>Vulkan入门02-VertexBuffers</h2></div></a></article><article><a href=/2025/11/21/vulkan%E7%A8%8B%E5%BA%8F%E4%B8%ADintel%E9%A9%B1%E5%8A%A8%E6%80%BB%E6%98%AF%E8%A2%AB%E8%B0%83%E7%94%A8%E6%9C%AA%E8%A7%A3%E5%86%B3/><div class=article-details><h2 class=article-title>Vulkan程序中Intel驱动总是被调用（未解决）</h2></div></a></article><article><a href=/2025/11/19/vulkan%E7%9A%84layer%E5%8F%91%E7%8E%B0%E6%9C%BA%E5%88%B6/><div class=article-details><h2 class=article-title>Vulkan的Layer发现机制</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2025 crackhopper的技术博客</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.32.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.0fcb739c1f88ce461c9640077fd21d8ce903946f1aef209dd01192827d26a90c.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>
<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Buf CLI 是现代、快速且高效的 Protobuf API 管理的终极工具\n从管理项目来说，基于buf管理 proto文件，要比原始的 protoc 好用很多。 更进一步的 connectrpc。提供了方便各个平台（包括web），基于proto定义来进行通信的机制。 本文从文档出发，结合AI问答，梳理这个工具链的细节和要点。一方面是学习笔记，另一方面也方便未来查阅。 考虑到 buf.build 整个工具体系非常复杂。这里我们就只讲少部分buf基础内容+connectrpc的基础内容。\n"><title>buf和connectrpc入门01</title><link rel=canonical href=https://crackhopper.github.io/2025/12/02/buf%E5%92%8Cconnectrpc%E5%85%A5%E9%97%A801/><link rel=stylesheet href=/scss/style.min.4d36f8dc1fd48129e1635deb4b8eb2870fa09474f7280c4cb606d40b2526994b.css><meta property='og:title' content="buf和connectrpc入门01"><meta property='og:description' content="Buf CLI 是现代、快速且高效的 Protobuf API 管理的终极工具\n从管理项目来说，基于buf管理 proto文件，要比原始的 protoc 好用很多。 更进一步的 connectrpc。提供了方便各个平台（包括web），基于proto定义来进行通信的机制。 本文从文档出发，结合AI问答，梳理这个工具链的细节和要点。一方面是学习笔记，另一方面也方便未来查阅。 考虑到 buf.build 整个工具体系非常复杂。这里我们就只讲少部分buf基础内容+connectrpc的基础内容。\n"><meta property='og:url' content='https://crackhopper.github.io/2025/12/02/buf%E5%92%8Cconnectrpc%E5%85%A5%E9%97%A801/'><meta property='og:site_name' content='crackhopper的技术博客'><meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:tag' content='buf'><meta property='article:tag' content='proto'><meta property='article:tag' content='connectrpc'><meta property='article:published_time' content='2025-12-02T18:47:04+08:00'><meta property='article:modified_time' content='2025-12-02T18:47:04+08:00'><meta name=twitter:title content="buf和connectrpc入门01"><meta name=twitter:description content="Buf CLI 是现代、快速且高效的 Protobuf API 管理的终极工具\n从管理项目来说，基于buf管理 proto文件，要比原始的 protoc 好用很多。 更进一步的 connectrpc。提供了方便各个平台（包括web），基于proto定义来进行通信的机制。 本文从文档出发，结合AI问答，梳理这个工具链的细节和要点。一方面是学习笔记，另一方面也方便未来查阅。 考虑到 buf.build 整个工具体系非常复杂。这里我们就只讲少部分buf基础内容+connectrpc的基础内容。\n"><link rel=stylesheet href=/css/custom.css></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_337fe2b325ec916d.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>crackhopper的技术博客</a></h1><h2 class=site-description>C++, Graphics, Game, AI/ML</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>文章</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于我</span></a></li><li><a href=/projects/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>项目</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky" id=right-sidebar><section class="widget archives toc-widget"><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc id=toc-content><nav id=TableOfContents><ul><li><a href=#buf基础>Buf基础</a><ul><li><a href=#命令>命令</a></li><li><a href=#配置文件>配置文件</a></li><li><a href=#配置工作区>配置工作区</a></li><li><a href=#基础知识>基础知识</a><ul><li><a href=#buf-image-buf镜像文件>Buf Image (Buf镜像文件)</a><ul><li><a href=#image文件原理>Image文件原理</a></li><li><a href=#plugins工作原理>Plugins工作原理</a></li></ul></li><li><a href=#buf-cli-输入>Buf CLI 输入</a><ul><li><a href=#术语>术语</a></li><li><a href=#input类别source或image>input类别：Source或Image</a></li><li><a href=#input的命令行位置>input的命令行位置</a></li><li><a href=#input参数选项>input参数选项</a></li><li><a href=#source格式>source格式</a></li><li><a href=#image格式>image格式</a></li><li><a href=#身份认证-https>身份认证-HTTPS</a></li><li><a href=#身份认证-ssh>身份认证-SSH</a></li></ul></li></ul></li><li><a href=#基础配置文件说明>基础配置文件说明</a><ul><li><a href=#bufyaml-路径和模块><code>buf.yaml</code> 路径和模块</a><ul><li><a href=#import写法注意><code>import</code>写法注意</a></li></ul></li><li><a href=#bufgenyaml-生成代码><code>buf.gen.yaml</code> 生成代码</a><ul><li><a href=#managed-托管模式>managed (托管模式)</a></li><li><a href=#plugins插件配置><code>plugins</code>（插件配置）</a></li><li><a href=#inputs-输入源>inputs (输入源)</a></li></ul></li><li><a href=#bufyaml-vs-bufgenyaml><code>buf.yaml</code> v.s. <code>buf.gen.yaml</code></a></li></ul></li><li><a href=#生成stubs-bufgenyaml>生成stubs (buf.gen.yaml)</a></li><li><a href=#lint检查-bufyaml>Lint检查 (buf.yaml)</a></li><li><a href=#breaking检查--bufyaml>Breaking检查 (buf.yaml)</a></li></ul></li><li><a href=#connectrpc基础-基于go>ConnectRPC基础 (基于Go)</a><ul><li><a href=#介绍>介绍</a></li><li><a href=#快速开始>快速开始</a><ul><li><a href=#工具包安装>工具包安装</a></li><li><a href=#快速示例>快速示例</a><ul><li><a href=#1-定义一个服务>1. 定义一个服务</a></li><li><a href=#2-配置buf工具生成代码>2. 配置buf工具生成代码</a></li><li><a href=#3-实现handler>3. 实现Handler</a></li><li><a href=#4-启动运行>4. 启动运行</a></li><li><a href=#5-curl测试>5. curl测试</a></li><li><a href=#6-client代码测试>6. Client代码测试</a></li></ul></li><li><a href=#仅使用-grpc>仅使用 gRPC</a></li></ul></li><li><a href=#routing路由>Routing(路由)</a></li><li><a href=#error错误处理>Error(错误处理)</a><ul><li><a href=#利用-errordetail-传递详细错误信息>利用 ErrorDetail 传递详细错误信息</a></li></ul></li><li><a href=#header和trailer>Header和Trailer</a></li><li><a href=#interceptors-拦截器>Interceptors (拦截器)</a></li><li><a href=#observability可观测性>Observability(可观测性)</a></li><li><a href=#streaming-流处理>Streaming (流处理)</a><ul><li><a href=#proto定义>proto定义</a></li><li><a href=#server端代码>server端代码</a></li><li><a href=#interceptor验证拦截器>Interceptor(验证拦截器)</a></li><li><a href=#client端代码>client端代码</a></li></ul></li><li><a href=#超时和连接池>超时和连接池</a></li><li><a href=#h2c>h2c</a></li><li><a href=#cors>CORS</a></li></ul></li></ul></nav></div></section></aside><button class=toc-float-btn id=toc-float-btn aria-label=展开目录 title=展开目录>
<span class=toc-float-btn-icon></span></button><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/2025/12/02/buf%E5%92%8Cconnectrpc%E5%85%A5%E9%97%A801/>buf和connectrpc入门01</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2025-12-02T18:47:04+08:00>Dec 02, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>20 minute read</time></div></footer></div></header><section class=article-content><p>Buf CLI 是现代、快速且高效的 Protobuf API 管理的终极工具</p><ul><li>从管理项目来说，基于buf管理 proto文件，要比原始的 <code>protoc</code> 好用很多。</li><li>更进一步的 <code>connectrpc</code>。提供了方便各个平台（包括web），基于proto定义来进行通信的机制。</li><li>本文从文档出发，结合AI问答，梳理这个工具链的细节和要点。一方面是学习笔记，另一方面也方便未来查阅。</li></ul><p>考虑到 <code>buf.build</code> 整个工具体系非常复杂。这里我们就只讲少部分buf基础内容+connectrpc的基础内容。</p><h1 id=buf基础>Buf基础</h1><h2 id=命令>命令</h2><ul><li><code>generate</code> : 使用 <code>protoc</code> 插件从 Protobuf 文件生成代码框架</li><li><code>breaking</code> : 验证没有引入破坏性变更，以防止兼容性问题</li><li><code>lint</code> : 根据最佳实践校验你的 Protobuf 文件</li><li><code>format</code> : 格式化你的 Protobuf 文件以保持一致性</li><li><code>curl</code> : 通过调用 RPC 端点来测试你的 API，类似于使用 <code>curl</code></li><li><code>convert</code> : 将消息从二进制转换为 JSON 或反之，在调试或测试时很有用</li><li><code>config</code> ：生成和管理 Buf 配置文件</li></ul><h2 id=配置文件>配置文件</h2><ul><li><code>buf.yaml</code> : 定义工作区及其内部每个模块的配置。它是主要的配置文件，定义每个模块的目录、名称、 <code>lint</code> 和 <code>breaking</code> 配置，以及要排除的任何文件，还包括工作区的共享依赖项。</li><li><code>buf.gen.yaml</code> : 定义代码生成插件集、它们的选项以及 <code>buf generate</code> 在从您的 Protobuf 文件生成代码时使用的输入。</li><li><code>buf.lock</code> :  记录确切的依赖项版本，以确保跨团队和 CI 的一致性构建。</li></ul><h2 id=配置工作区>配置工作区</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>buf config init
</span></span></code></pre></td></tr></table></div></div><p>运行后，目录中会出现 <code>buf.yaml</code>:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#57606a># For details on buf.yaml configuration, visit https://buf.build/docs/configuration/v2/buf-yaml</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>version</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>v2<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>lint</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0550ae>use</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>- STANDARD<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>breaking</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0550ae>use</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>- FILE<span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p><code>buf.yaml</code> 文件位于工作区根目录，它定义的工作区是所有 Buf 操作的默认输入。<a class=link href=#buf-cli-%e8%be%93%e5%85%a5>Buf CLI 输入</a></p><h2 id=基础知识>基础知识</h2><h3 id=buf-image-buf镜像文件>Buf Image (Buf镜像文件)</h3><p>Buf images 是一种强大的工具，用于在组织内分发和共享编译好的 Protocol Buffer（Protobuf）模式。它们提供了一种紧凑且高效的 Protobuf 模式表示方式，使您能够轻松管理模式的演进，并确保跨多个系统的兼容性。</p><p>Buf images 设计为向前和向后兼容，使您能够在不破坏现有系统兼容性的情况下，随着时间的推移管理模式的演进。它们还包含丰富的元数据，例如源代码位置和注释，可用于提供有关schema的额外上下文和理解。</p><p>Linting 和 Breaking 检测操作主要使用 <strong>Buf Image</strong>（由CLI动态生成，或者从外部读取）。因此，镜像 Image ，代表了一种稳定、广泛使用的 protobuf schema 。（所以可以理解 image文件作为 protobuf 的schema存在）</p><h4 id=image文件原理>Image文件原理</h4><p>使用 <code>buf build</code> 命令，会将 <code>.proto</code> 文件集 编译成一个单独的 二进制文件。这个二进制文件包含了所有信息（包括proto文件和配置选项）</p><p>构建好的Buf Image文件，本身多平台兼容。可以直接分发或者放到 vcs （比如git） 中 。</p><p>如果要使用 Buf Image ，需要在系统中安装 Buf 工具，以及把 Buf Image 作为依赖整合到构建流程中。Buf 工具提供了很多基于 Buf Image 的工具，包括不限于： 验证、代码生成。</p><pre tabindex=0><code>Buf Image = 标准 protobuf FileDescriptorSet + Buf 自己额外的字段
</code></pre><p>因此可以理解 Buf Image 本身是 一种 <code>protobuf FileDescriptorSet</code> 文件的扩展。关于这个文件，我在下面补充了一些描述。可以理解为 <code>protobuf</code> 的 schema ，但本身也用protobuf来存储。</p><pre><code>补充知识： protobuf FileDescriptorSet (简单理解为编译器中间产物，或 protobuf schema)

protoc 编译器，不会直接只生成代码，它会先把 .proto 文件解析成一套标准化结构Descriptor。

protoc --descriptor_set_out=out.pb --include_imports user.proto

这个命令生成的 out.pb 就是 FileDescriptorSet 文件 。本身也是一个.pb文件(由protobuf序列化得到)。

官方定义为：
message FileDescriptorSet {
  repeated FileDescriptorProto file = 1;
}

结构层级示例如下：
FileDescriptorSet
└── FileDescriptorProto (user.proto)
    ├── message_type
    │   └── DescriptorProto (User)
    │       └── FieldDescriptorProto (id, name)
    ├── enum_type
    ├── service
    ├── dependency (import 的 proto)
</code></pre><p>Buf工具利用了这个文件，并扩展了字段。（因此本身Buf Image实际上也是兼容 DescriptorSet 格式的，可以被protoc处理）</p><p>下面是Buf的Image文件格式定义：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#57606a>// Image is an extended FileDescriptorSet.
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>message</span> <span style=color:#1f2328>Image</span> <span style=color:#1f2328>{</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#cf222e>repeated</span> ImageFile file <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#1f2328>}</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#57606a>// ImageFile is an extended FileDescriptorProto.
</span></span></span><span style=display:flex><span><span style=color:#57606a>//
</span></span></span><span style=display:flex><span><span style=color:#57606a>// Since FileDescriptorProto doesn&#39;t have extensions, we copy the fields from
</span></span></span><span style=display:flex><span><span style=color:#57606a>// FileDescriptorProto, and then add our own extensions via the buf_extension
</span></span></span><span style=display:flex><span><span style=color:#57606a>// field. This is compatible with a FileDescriptorProto.
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>message</span> <span style=color:#1f2328>ImageFile</span> <span style=color:#1f2328>{</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#cf222e>optional</span> <span style=color:#cf222e>string</span> name <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#cf222e>optional</span> <span style=color:#cf222e>string</span> <span style=color:#cf222e>package</span> <span style=color:#0550ae>=</span> <span style=color:#0550ae>2</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#cf222e>repeated</span> <span style=color:#cf222e>string</span> dependency <span style=color:#0550ae>=</span> <span style=color:#0550ae>3</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#cf222e>repeated</span> <span style=color:#cf222e>int32</span> public_dependency <span style=color:#0550ae>=</span> <span style=color:#0550ae>10</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#cf222e>repeated</span> <span style=color:#cf222e>int32</span> weak_dependency <span style=color:#0550ae>=</span> <span style=color:#0550ae>11</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#cf222e>repeated</span> google.protobuf.DescriptorProto message_type <span style=color:#0550ae>=</span> <span style=color:#0550ae>4</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#cf222e>repeated</span> google.protobuf.EnumDescriptorProto enum_type <span style=color:#0550ae>=</span> <span style=color:#0550ae>5</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#cf222e>repeated</span> google.protobuf.ServiceDescriptorProto <span style=color:#cf222e>service</span> <span style=color:#0550ae>=</span> <span style=color:#0550ae>6</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#cf222e>repeated</span> google.protobuf.FieldDescriptorProto extension <span style=color:#0550ae>=</span> <span style=color:#0550ae>7</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#cf222e>optional</span> google.protobuf.FileOptions options <span style=color:#0550ae>=</span> <span style=color:#0550ae>8</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#cf222e>optional</span> google.protobuf.SourceCodeInfo source_code_info <span style=color:#0550ae>=</span> <span style=color:#0550ae>9</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#cf222e>optional</span> <span style=color:#cf222e>string</span> syntax <span style=color:#0550ae>=</span> <span style=color:#0550ae>12</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#57606a>// buf_extension contains buf-specific extensions to FileDescriptorProtos.
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>  <span style=color:#57606a>//
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>  <span style=color:#57606a>// The prefixed name and high tag value is used to all but guarantee there
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>  <span style=color:#57606a>// will never be any conflict with Google&#39;s FileDescriptorProto definition.
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>  <span style=color:#57606a>// The definition of a FileDescriptorProto has not changed in years, so
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>  <span style=color:#57606a>// we&#39;re not too worried about a conflict here.
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>  <span style=color:#cf222e>optional</span> ImageFileExtension buf_extension <span style=color:#0550ae>=</span> <span style=color:#0550ae>8042</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#1f2328>}</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#cf222e>message</span> <span style=color:#1f2328>ImageFileExtension</span> <span style=color:#1f2328>{</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#57606a>// is_import denotes whether this file is considered an &#34;import&#34;.
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>  <span style=color:#cf222e>optional</span> <span style=color:#cf222e>bool</span> is_import <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#57606a>// ModuleInfo contains information about the Buf module this file belongs to.
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>  <span style=color:#cf222e>optional</span> ModuleInfo module_info <span style=color:#0550ae>=</span> <span style=color:#0550ae>2</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#57606a>// is_syntax_unspecified denotes whether the file did not have a syntax explicitly specified.
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>  <span style=color:#cf222e>optional</span> <span style=color:#cf222e>bool</span> is_syntax_unspecified <span style=color:#0550ae>=</span> <span style=color:#0550ae>3</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#57606a>// unused_dependency are the indexes within the dependency field on
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>  <span style=color:#57606a>// FileDescriptorProto for those dependencies that aren&#39;t used.
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>  <span style=color:#cf222e>repeated</span> <span style=color:#cf222e>int32</span> unused_dependency <span style=color:#0550ae>=</span> <span style=color:#0550ae>4</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#1f2328>}</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=plugins工作原理>Plugins工作原理</h4><p>考虑</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>protoc -I . --go_out<span style=color:#0550ae>=</span>gen/go foo.proto
</span></span></code></pre></td></tr></table></div></div><p>这个命令的执行细节：</p><ul><li><code>protoc</code> 编译文件 <code>foo.proto</code> （以及任何导入）并在内部生成一个 <code>FileDescriptorSet</code> ，这是一个包含 <code>FileDescriptorProto</code> 消息的列表。这些消息包含有关您的 <code>.proto</code> 文件的所有信息，包括可选的源代码信息，例如每个 <code>.proto</code> 文件元素的起始/结束行/列，以及相关的注释。</li><li><code>FileDescriptorSet</code> 转换为一个 <code>CodeGeneratorRequest</code> 对象。包含： <code>FileDescriptorProto</code> 列表（当前例子就 <code>foo.proto</code> 自己）、<code>go_out</code> 参数信息， <code>go_opt</code> 参数信息。（命令行参数，即 <code>=</code> 后面的内容）</li><li><code>protoc</code> 然后查找名为 <code>protoc-gen-go</code> 的二进制文件，并调用它，将序列化的 <code>CodeGeneratorRequest</code> 作为标准输入。</li><li><code>protoc-gen-go</code> 运行，要么出错，要么生成一个 <code>CodeGeneratorResponse</code> ，该文件指定要生成的文件及其内容。序列化的 CodeGeneratorResponse 写入 <code>protoc-gen-go</code> 的标准输出。</li><li>在 <code>protoc-gen-go</code> 成功后， <code>protoc</code> 读取 stdout，然后写入这些生成的文件。</li></ul><p>内部的生成器，例如 <code>--java_out, --cpp_out</code> 工作方式大致相同。（尽管不是外部的二进制，而是在protoc内部完成的）。</p><p><strong><code>FileDescriptorSet</code> 是整个 Protobuf 生态系统中用来表示编译后的 Protobuf 模板的核心基础。它们也是 <code>protoc</code> 产生的主要产物。</strong></p><p>你使用 <code>protoc</code> 以及任何你使用的插件，都是基于 <code>FileDescriptorSet</code> 进行交流的。gRPC Reflection 在底层也使用它们。</p><p><strong>所以，更进一步理解： FileDescriptorSet 可以理解为 protobuf 编译后的schema数据文件，从它可以容易的得到.proto文件中的结构和各种生成需要的信息；它也方便我们动态做一些生成</strong></p><p>手动生成 <code>FileDescriptorSet</code> ( <strong>注意：由于是pb二进制文件，所以下面的 命令虽然会输出到 stdout ，但是会有很多无法显示的字符</strong> )</p><pre tabindex=0><code>protoc -I . --include_imports --include_source_info -o /dev/stdout foo.proto
</code></pre><ul><li><code>--include_imports</code> : 将文件中的 <code>import</code> 也包含到生成的 <code>FileDescriptorSet</code> 中。</li><li><code>--include_source_info</code> : 将对应的源代码的行号信息，也包含到 <code>FileDescriptorSet</code> 中。
这些信息方便：生成文档，lint。</li></ul><p>当然 <code>FileDescriptorSet</code> 本身也是 Buf Image（Buf做了兼容处理），因此结果可以直接送给 <code>Buf</code> 命令:</p><pre tabindex=0><code>protoc -I . -o /dev/stdout proto/fetcher/market_data.proto   --experimental_allow_proto3_optional  --include_source_info | buf lint -
</code></pre><p>由于 <code>buf</code> &ldquo;理解&rdquo; <code>FileDescriptorSet</code> ，我们还提供 <code>protoc-gen-buf-lint</code> 和 <code>protoc-gen-buf-breaking</code> 作为标准的 Protobuf 插件。</p><h3 id=buf-cli-输入>Buf CLI 输入</h3><p>通常，你的唯一目标是处理磁盘上的 <code>.proto</code> 文件。Buf CLI 默认按此方式工作。但有时你可能需要处理本地文件以外的其他文件。</p><h4 id=术语>术语</h4><ul><li><strong>Source</strong>： 未编译的 Protobuf 文件集合。</li><li><strong>Image</strong> ： A set of Protobuf files compiled into an <a class=link href=https://buf.build/bufbuild/buf/docs/main/buf.alpha.image.v1#buf.alpha.image.v1.Image target=_blank rel=noopener><code>Image</code></a> binary using the <code>buf build</code> command. （使用 <code>buf build</code> 命令将一组 Protobuf 文件编译成的 <code>Image</code> 二进制文件。）<em>image</em> represents everything inside a Protobuf project and can be used as the input to most commands. （镜像文件，可以认为是protobuf编译后的平台独立的schema字节码；包含了生成所需要的所有信息） <a class=link href=#buf-image-buf%e9%95%9c%e5%83%8f%e6%96%87%e4%bb%b6>Buf Image (Buf镜像文件)</a></li><li><strong>Input</strong> : 输入，Source 或 Image</li><li><strong>Format</strong> : 对输入类型的描述，常用类型 <code>dir</code> , <code>git</code> 。通常自动生成。</li><li><strong>Buf Schema Registry (BSR)</strong>： Buf 的 核心原语(core primitive)是模块( <strong>module</strong>)。Protobuf 本身没有模块的概念，只有文件。Buf Schema注册中心 (BSR) 是一个用于跨团队甚至跨组织管理 Buf 模块的注册中心。 （可以理解一些围绕一个业务的独立的proto文件集合，构成一个module）。BSR的URL可以指定为一个source，作为命令输入。比如 <code>buf lint buf.build/acme/petapis</code></li></ul><h4 id=input类别source或image>input类别：Source或Image</h4><p>可以作为输入的两个类别。每个类别又有若干格式。</p><h4 id=input的命令行位置>input的命令行位置</h4><p>普通命令</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>buf build &lt;input&gt;
</span></span><span style=display:flex><span>buf lint &lt;input&gt;
</span></span><span style=display:flex><span>buf generate &lt;input&gt;
</span></span></code></pre></td></tr></table></div></div><p>breaking命令(两个输入)</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>buf breaking &lt;current-input&gt; --against &lt;previous-input&gt;
</span></span></code></pre></td></tr></table></div></div><h4 id=input参数选项>input参数选项</h4><pre tabindex=0><code>path#option_key1=option_value1,option_key2=option_value2
</code></pre><ul><li>path : 可以是 <code>.</code>, <code>proto/</code> , <code>file.binpb</code> , <code>https://github.com/googleapis/googleapis</code>, <code>-</code> 等等。</li><li>选项：<ul><li><code>format</code> : 用来<strong>强制指定输入的类型</strong>，覆盖 Buf 自动推断的格式。<ul><li>默认的根据path自动推断格式，比如： 目录: <code>dir</code> ；<code>.git</code> : <code>git</code>；<code>.zip</code> : <code>zip</code>；<code>.tar.gz</code> : <code>tar</code>；<code>-</code> : <code>stdin</code> 。更多格式参考 <a class=link href=#source%e6%a0%bc%e5%bc%8f>source格式</a></li></ul></li><li><code>branch=&lt;branch-name></code> : 指定 Git 仓库的分支。</li><li><code>tag=&lt;tag-name></code> : 指定 Git tag。</li><li><code>ref=&lt;git-ref></code> : 任意 <code>git checkout</code> 支持的引用</li><li><code>depth=&lt;number></code> : <code>depth</code> 控制 <strong>git shallow clone</strong> 的“深度”（等同于 <code>git clone --depth &lt;N></code>），也就是说只从远端拉取最近 N 层提交历史，而不是整个仓库的完整历史。这样可以显著减小下载量和速度提高，但历史会被截断。</li><li><code>recurse_submodules=true</code> : 等价于 <code>git clone --recurse-submodules</code> （默认不拉取子模块）</li><li><code>strip_components=&lt;n></code> : 解压时 <strong>去掉前 n 层目录</strong></li><li><code>subdir=&lt;path></code> : 只使用仓库或压缩包中的某个子目录</li><li><code>filter=&lt;filter-expression></code> : 用于 <strong>partial clone</strong> , 减少 clone 的数据量, 高级使用场景（大型仓库）</li></ul></li></ul><h4 id=source格式>source格式</h4><p>所有源都包含一组可编译的 <code>.proto</code> 文件。</p><ul><li><strong>dir</strong> : 一个本地目录。路径可以是相对的或绝对的。默认情况， <code>buf</code> 使用当前目录作为所有命令的输入。</li><li><strong>mod</strong> : Buf Schema Registry 上的一个模块。这个模块使用其包含的内容作为源。<ul><li><code>buf.build/googleapis/googleapis</code> 告诉我们编译 buf.build/googleapis/googleapis 中的文件。</li><li><code>buf.build/bufbuild/protovalidate:v0.13.4</code> 告知在 buf.build/bufbuild/protovalidate 中编译文件，该文件位于由标签 v0.13.4 所解析的提交版本。</li><li>这使用与 buf.yaml 中的依赖项相同的格式，而不是用于其他输入选项的 <code>option_key1=option_value1</code> 格式。</li></ul></li><li><strong>tar</strong> : 一个压缩包。这个压缩包的路径可以是一个本地文件、一个远程 http/https 位置，或者 <code>-</code> 表示标准输入。</li><li><strong>zip</strong> : 一个 zip 归档文件。此归档文件的路径可以是本地文件、远程 http/https 位置，或 <code>-</code> 表示标准输入。</li><li><strong>git</strong> : 一个 Git 仓库。Git 仓库的路径可以是一个本地 <code>.git</code> 目录，或是一个远程 <code>http://</code> 、 <code>https://</code> 、 <code>ssh://</code> 或 <code>git://</code> 位置。</li><li><strong>protofile</strong> : 一个本地 Protobuf 文件。路径可以是相对的或绝对的，类似于 dir 输入。这是一个特殊输入，它使用文件及其导入作为 <code>buf</code> 命令的输入。如果找到本地配置文件，则首先使用指定的依赖项解析文件导入，然后使用本地文件系统。如果没有本地配置，则使用本地文件系统解析文件导入。(import解析方式，除了本地源代码，还可以是buf.yaml中配置的依赖项；依赖项是一个mod)</li><li><strong>Symlinks</strong> ： 请注意，只有 <code>dir</code> 和 <code>protofile</code> 输入支持符号链接，而 <code>mod</code> 、 <code>git</code> 、 <code>tar</code> 和 <code>zip</code> 输入会忽略所有符号链接。</li></ul><h4 id=image格式>image格式</h4><p>可以使用 <code>buf build</code> 创建 buf image:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>buf build -o image.binpb
</span></span><span style=display:flex><span>buf build -o image.binpb.gz
</span></span><span style=display:flex><span>buf build -o image.binpb.zst
</span></span><span style=display:flex><span>buf build -o image.json
</span></span><span style=display:flex><span>buf build -o image.json.gz
</span></span><span style=display:flex><span>buf build -o image.json.zst
</span></span><span style=display:flex><span>buf build -o image.txtpb
</span></span><span style=display:flex><span>buf build -o image.txtpb.gz
</span></span><span style=display:flex><span>buf build -o image.txtpb.zst
</span></span><span style=display:flex><span>buf build -o -
</span></span><span style=display:flex><span>buf build -o -#format<span style=color:#0550ae>=</span>json
</span></span><span style=display:flex><span>buf build -o -#format<span style=color:#0550ae>=</span>json,compression<span style=color:#0550ae>=</span>gzip
</span></span><span style=display:flex><span>buf build -o -#format<span style=color:#0550ae>=</span>json,compression<span style=color:#0550ae>=</span>zstd
</span></span><span style=display:flex><span>buf build -o -#format<span style=color:#0550ae>=</span>txtpb
</span></span></code></pre></td></tr></table></div></div><p>我自己测试：(截断部分输出)</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>buf build -o -#format<span style=color:#0550ae>=</span>txtpb proto/fetcher/market_data.proto
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a># 输出结果</span>
</span></span><span style=display:flex><span>file: <span style=color:#0550ae>{</span>
</span></span><span style=display:flex><span>  name: <span style=color:#0a3069>&#34;proto/fetcher/market_data.proto&#34;</span>
</span></span><span style=display:flex><span>  package: <span style=color:#0a3069>&#34;fetcher&#34;</span>
</span></span><span style=display:flex><span>  message_type: <span style=color:#0550ae>{</span>
</span></span><span style=display:flex><span>    name: <span style=color:#0a3069>&#34;Kline&#34;</span>
</span></span><span style=display:flex><span>    field: <span style=color:#0550ae>{</span>
</span></span><span style=display:flex><span>      name: <span style=color:#0a3069>&#34;symbol&#34;</span>
</span></span><span style=display:flex><span>      number: <span style=color:#0550ae>1</span>
</span></span><span style=display:flex><span>      label: LABEL_OPTIONAL
</span></span><span style=display:flex><span>      type: TYPE_STRING
</span></span><span style=display:flex><span>      json_name: <span style=color:#0a3069>&#34;symbol&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>}</span>
</span></span><span style=display:flex><span>    field: <span style=color:#0550ae>{</span>
</span></span><span style=display:flex><span>      name: <span style=color:#0a3069>&#34;type&#34;</span>
</span></span><span style=display:flex><span>      number: <span style=color:#0550ae>2</span>
</span></span><span style=display:flex><span>      label: LABEL_OPTIONAL
</span></span><span style=display:flex><span>      type: TYPE_ENUM
</span></span><span style=display:flex><span>      type_name: <span style=color:#0a3069>&#34;.fetcher.KlineType&#34;</span>
</span></span><span style=display:flex><span>      json_name: <span style=color:#0a3069>&#34;type&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>}</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>    location: <span style=color:#0550ae>{</span>
</span></span><span style=display:flex><span>      path: <span style=color:#0550ae>4</span>
</span></span><span style=display:flex><span>      path: <span style=color:#0550ae>4</span>
</span></span><span style=display:flex><span>      path: <span style=color:#0550ae>2</span>
</span></span><span style=display:flex><span>      path: <span style=color:#0550ae>2</span>
</span></span><span style=display:flex><span>      path: <span style=color:#0550ae>3</span>
</span></span><span style=display:flex><span>      span: <span style=color:#0550ae>56</span>
</span></span><span style=display:flex><span>      span: <span style=color:#0550ae>24</span>
</span></span><span style=display:flex><span>      span: <span style=color:#0550ae>25</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>}</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>}</span>
</span></span><span style=display:flex><span>  syntax: <span style=color:#0a3069>&#34;proto3&#34;</span>
</span></span><span style=display:flex><span>  buf_extension: <span style=color:#0550ae>{</span>
</span></span><span style=display:flex><span>    is_import: <span style=color:#6639ba>false</span>
</span></span><span style=display:flex><span>    module_info: <span style=color:#0550ae>{</span>
</span></span><span style=display:flex><span>      name: <span style=color:#0550ae>{</span>
</span></span><span style=display:flex><span>        remote: <span style=color:#0a3069>&#34;hushine-tech.com&#34;</span>
</span></span><span style=display:flex><span>        owner: <span style=color:#0a3069>&#34;quant&#34;</span>
</span></span><span style=display:flex><span>        repository: <span style=color:#0a3069>&#34;proto&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#0550ae>}</span>
</span></span><span style=display:flex><span>    <span style=color:#0550ae>}</span>
</span></span><span style=display:flex><span>    is_syntax_unspecified: <span style=color:#6639ba>false</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>}</span>
</span></span><span style=display:flex><span><span style=color:#0550ae>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Image输入格式：</p><ul><li><strong>binpb</strong> ： Buf Image的二进制格式。<a class=link href=#buf-image-buf%e9%95%9c%e5%83%8f%e6%96%87%e4%bb%b6>Buf Image (Buf镜像文件)</a></li><li><strong>json</strong> : 一个 JSON 格式的 Buf Image 。 解析速度较慢，但生成的差异比较结果会以可读的格式显示两个 Buf Image之间的实际差异。</li><li><strong>txtpb</strong> : 文本格式的 Buf Image。在现代 Protobuf 使用中，JSON 更受欢迎，但许多 Protobuf 的遗留使用仍然使用文本格式。</li></ul><h4 id=身份认证-https>身份认证-HTTPS</h4><p><code>buf</code> 首先在 <code>$NETRC</code> 查找 netrc 文件，默认为 <code>~/.netrc</code> 。</p><p>还可以使用环境变量</p><ul><li><code>BUF_INPUT_HTTPS_USERNAME</code> 是用户名。对于 GitHub，这是您的 GitHub 用户。</li><li><code>BUF_INPUT_HTTPS_PASSWORD</code> 是密码。对于 GitHub，这是您的 GitHub 用户的个人访问令牌。</li></ul><h4 id=身份认证-ssh>身份认证-SSH</h4><p>Git 仓库通过 <code>git</code> 命令克隆，因此 <code>buf</code> 默认使用您现有的 Git SSH 配置，包括添加到 <code>ssh-agent</code> 的任何身份。</p><p>还可以使用环境变量</p><ul><li><code>BUF_INPUT_SSH_KEY_FILE</code> 是私钥文件路径。</li><li><code>BUF_INPUT_SSH_KNOWN_HOSTS_FILES</code> 是以冒号分隔的已知主机文件路径列表。</li></ul><h2 id=基础配置文件说明>基础配置文件说明</h2><h3 id=bufyaml-路径和模块><code>buf.yaml</code> 路径和模块</h3><p><code>buf.yaml</code> 文件默认为一个包含一个模块的工作区，模块路径设置为当前目录。</p><p>要显式定义工作区中的模块，提供包含 <code>.proto</code> 文件的目录路径。使用 <code>modules</code> 键将 <code>proto</code> 目录添加到 <code>buf.yaml</code> 文件</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#0550ae>version</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>v2<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>+modules</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>+  - path</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>proto<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>lint</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0550ae>use</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>- STANDARD<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>breaking</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0550ae>use</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>- FILE<span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>继续之前，请验证一切是否设置正确且模块可以构建。如果没有错误，您就知道已经正确设置了 Buf 模块：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>buf build
</span></span><span style=display:flex><span><span style=color:#6639ba>echo</span> <span style=color:#953800>$?</span>
</span></span><span style=display:flex><span><span style=color:#57606a># 0</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=import写法注意><code>import</code>写法注意</h4><p>考虑我的项目组织代码为:</p><pre tabindex=0><code>.
├── proto
│   ├── fetcher
│   │   └── market_data.proto
│   └── trading
│       ├── account.proto
│       └── order.proto
└── buf.yaml
</code></pre><p>其中 ，<code>buf.yaml</code> 如下：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#0550ae>version</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>v2<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>modules</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span>- <span style=color:#0550ae>path</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>proto    <span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>lint</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0550ae>use</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>- STANDARD<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>breaking</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0550ae>use</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>- FILE<span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>假设我们在 <code>account.proto</code> 中要导入 <code>order.proto</code> 文件，怎么做？</p><p><strong>导入要从 <code>buf.yaml</code> 定义的模块根路径为起点进行导入</strong> ，即我们应该 <code>import "trading/order.proto";</code></p><h3 id=bufgenyaml-生成代码><code>buf.gen.yaml</code> 生成代码</h3><p>文件作用： 控制 <code>buf generate</code> 命令如何在给定模块上执行 <code>protoc</code> 插件。可以用它来配置每个 <code>protoc</code> 插件写入结果的位置，并为每个插件指定选项。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#0550ae>version</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>v2<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>managed</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0550ae>enabled</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#cf222e>true</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0550ae>override</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>- <span style=color:#0550ae>file_option</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>go_package_prefix<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span><span style=color:#0550ae>value</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>github.com/bufbuild/buf-examples/gen<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>plugins</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span>- <span style=color:#0550ae>remote</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>buf.build/protocolbuffers/go<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#0550ae>out</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>gen<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#0550ae>opt</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>paths=source_relative<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span>- <span style=color:#0550ae>remote</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>buf.build/connectrpc/gosimple<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#0550ae>out</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>gen<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#0550ae>opt</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span>- paths=source_relative<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span>- simple<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>inputs</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span>- <span style=color:#0550ae>directory</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>proto<span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=managed-托管模式>managed (托管模式)</h4><p><code>managed</code> 模式是 <strong>Buf 的托管选项</strong>，主要解决 Protobuf 文件中的 <strong>file options</strong> 配置混乱问题。
启用后，Buf 会根据语言和插件自动生成合适的 file options，不需要手动在 <code>.proto</code> 文件中写。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#0550ae>managed</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0550ae>enabled</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#cf222e>true</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0550ae>override</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>- <span style=color:#0550ae>file_option</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>go_package_prefix<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span><span style=color:#0550ae>value</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>github.com/bufbuild/buf-examples/gen<span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>表示 <strong>生成的 Go 文件的 package 前缀</strong>全部统一设置为 <code>github.com/bufbuild/buf-examples/gen</code>。</li></ul><p>总结：</p><ul><li><strong>托管模式 = 自动管理 file options</strong></li><li><strong>override = 对托管行为进行定制</strong></li></ul><p>这个确实好，之前都是手动在每个proto文件中写一些option。</p><h4 id=plugins插件配置><code>plugins</code>（插件配置）</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#0550ae>plugins</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span>- <span style=color:#0550ae>remote</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>buf.build/protocolbuffers/go<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#0550ae>out</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>gen<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#0550ae>opt</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>paths=source_relative<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span>- <span style=color:#0550ae>remote</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>buf.build/connectrpc/gosimple<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#0550ae>out</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>gen<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#0550ae>opt</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span>- paths=source_relative<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span>- simple<span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><strong>remote</strong> : 指向 <strong>远程插件</strong>，存储在 <strong>Buf Schema Registry</strong>。(使用 remote plugin 的好处：不需要在本地下载和维护 protoc 插件; 保证版本可控、统一)<ul><li><code>buf.build/protocolbuffers/go</code> → 官方 Go plugin</li><li><code>buf.build/connectrpc/gosimple</code> → Connect-Go plugin</li></ul></li><li><strong>out</strong> ： 输出目录，插件生成的代码会放在 <code>gen</code> 目录中，Buf CLI 会在目录不存在时自动创建</li><li><strong>opt</strong> ：插件参数。<code>paths=source_relative</code>：相对路径生成，对于每个proto文件，计算其与input根目录（例子中是 <code>proto</code> 这个目录）的相对路径。随后在当前 buf.gen.yaml 所在路径创建 <code>gen</code> 文件夹，按照相对路径创建生成的文件。</li></ul><h4 id=inputs-输入源>inputs (输入源)</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>inputs:
</span></span><span style=display:flex><span>  - directory: proto
</span></span></code></pre></td></tr></table></div></div><ul><li><code>inputs</code> 指定 <strong>Buf 处理的 Protobuf 源文件位置</strong></li></ul><p>因此，这个 <code>buf.gen.yaml</code> 不需要和 <code>buf.yaml</code> 配合就可以直接生成。</p><p>如果不指定 <code>inputs</code> 。那么 <code>buf.gen.yaml</code> 就需要指定输入源（默认是当前目录，也可以手动指定；如果指定的目录有 <code>buf.yaml</code> 文件，那么使用这个文件规定的 <code>mod</code> 作为输入源）。（针对目录的输入源会遍历，找到所有的proto文件作为输入源）。</p><h3 id=bufyaml-vs-bufgenyaml><code>buf.yaml</code> v.s. <code>buf.gen.yaml</code></h3><div class=table-wrapper><table><thead><tr><th>特性</th><th><code>buf.yaml</code></th><th><code>buf.gen.yaml</code></th></tr></thead><tbody><tr><td><strong>主要用途</strong></td><td>管理 Protobuf 模块、lint、breaking 等规则</td><td>管理代码生成（generate）插件、输出目录、file options</td></tr><tr><td><strong>核心作用</strong></td><td>模块定义、代码质量控制</td><td>插件执行、生成代码</td></tr><tr><td><strong>是否必须</strong></td><td>是 Buf module 的核心文件</td><td>可独立存在（不依赖 buf.yaml），也可配合 buf.yaml 使用</td></tr><tr><td><strong>命令关联</strong></td><td><code>buf build</code>、<code>buf lint</code>、<code>buf breaking</code></td><td><code>buf generate</code></td></tr><tr><td><strong>输入源（proto 文件）</strong></td><td>模块 root 目录或指定目录</td><td>可以通过 <code>inputs</code> 指定目录/Git/tar，也可以不指定（默认用 buf.yaml 模块）</td></tr><tr><td><strong>默认输入源</strong></td><td>模块根目录（buf.yaml 所在目录）</td><td>当前目录（buf.gen.yaml 所在目录）；若存在 buf.yaml，则使用模块作为默认 input</td></tr><tr><td><strong>递归查找 proto 文件</strong></td><td>会递归查找模块目录下所有 proto 文件</td><td>如果没有指定 inputs，则递归 buf.yaml 模块目录下的 proto；如果指定 inputs，则按输入目录递归</td></tr><tr><td><strong>插件配置</strong></td><td>不配置插件</td><td>配置远程或本地插件、输出目录、插件参数（如 paths=source_relative）</td></tr><tr><td><strong>托管模式（managed）</strong></td><td>N/A</td><td>可启用 managed 模式，自动设置 file options 并可 override</td></tr><tr><td><strong>依赖关系</strong></td><td>无法单独生成代码，需要配合 buf.gen.yaml</td><td>可以单独生成代码，也可以依赖 buf.yaml 的模块信息</td></tr><tr><td><strong>输出目录</strong></td><td>N/A</td><td>插件生成代码的目录（<code>out</code>）</td></tr></tbody></table></div><p>因此，关于生成的动作，主要看 <code>buf.gen.yaml</code> 的配置，以及参考： <a class=link href=#buf-cli-%e8%be%93%e5%85%a5>Buf CLI 输入</a> 这里面关于输入的默认定义。</p><h2 id=生成stubs-bufgenyaml>生成stubs (buf.gen.yaml)</h2><p>使用当前目录中的 <code>buf.gen.yaml</code> 可以执行生成命令（注意，严格来说不需要 <code>buf.yaml</code> ，这个文件仅仅是将proto文件组织成了模块，是项目描述文件。生成的时候，会引用 <code>buf.yaml</code> ，也可以直接手动指定或者按照规则指定inputs）</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>buf generate
</span></span></code></pre></td></tr></table></div></div><p>目录结构如下：</p><pre tabindex=0><code>.
├── gen
│   ├── google
│   │   └── type
│   │       └── datetime.pb.go
│   └── pet
│       └── v1
│           ├── pet.pb.go
│           └── petv1connect
│               └── pet.connect.go
├── proto
├   ├── google
├   │   └── type
├   │       └── datetime.proto
├   └── pet
├       └── v1
├           └── pet.proto
├── buf.gen.yaml
└── buf.yaml
</code></pre><h2 id=lint检查-bufyaml>Lint检查 (buf.yaml)</h2><p>按照最佳实践给出代码中的建议：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>buf lint
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a># proto/google/type/datetime.proto:17:1:Package name &#34;google.type&#34; should be suffixed with a correctly formed version, such as &#34;google.type.v1&#34;.</span>
</span></span><span style=display:flex><span><span style=color:#57606a># proto/pet/v1/pet.proto:56:10:Field name &#34;petID&#34; should be lower_snake_case, such as &#34;pet_id&#34;.</span>
</span></span><span style=display:flex><span><span style=color:#57606a># proto/pet/v1/pet.proto:61:9:Service name &#34;PetStore&#34; should be suffixed with &#34;Service&#34;.</span>
</span></span></code></pre></td></tr></table></div></div><p>不过我现在项目已经组织好，被多个模块依赖了，所以lint错误我也只能先忽略了。QAQ</p><p>忽略lint的配置</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#0550ae>version</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>v2<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>modules</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span>- <span style=color:#0550ae>path</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>proto<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>lint</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0550ae>use</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>- STANDARD<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>+  ignore</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span>+    - proto/google/type/datetime.proto<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>breaking</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0550ae>use</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>- FILE<span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=breaking检查--bufyaml>Breaking检查 (buf.yaml)</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>buf breaking --against HEAD
</span></span></code></pre></td></tr></table></div></div><p>作用：</p><ol><li>检查 <strong>buf.yaml 中列出的所有模块</strong>。</li><li>对比 <strong>当前版本 vs 过去版本</strong> 的 Protobuf schema。</li><li>根据 <strong>选定的 breaking rules</strong> 检测潜在破坏性更改。</li></ol><p>规则类型：默认规则是 <strong>FILE</strong>，推荐使用它以保证 <strong>最大兼容性</strong>。</p><div class=table-wrapper><table><thead><tr><th>规则类型</th><th>检测内容</th><th>说明</th></tr></thead><tbody><tr><td><strong>FILE</strong></td><td>文件级别</td><td>检测 <strong>生成代码移动到不同文件</strong> 的情况。适合确保生成的代码结构不破坏现有客户端/服务端引用。</td></tr><tr><td><strong>PACKAGE</strong></td><td>包级别</td><td>检测 <strong>包级别的破坏性更改</strong>。主要针对生成的 stubs（客户端/服务端代理代码），不关注单个文件变化。</td></tr><tr><td><strong>WIRE_JSON</strong></td><td>JSON/Wire 编码</td><td>检测 <strong>JSON 或二进制编码的不兼容更改</strong>。JSON 广泛使用，因此推荐至少启用此规则。</td></tr><tr><td><strong>WIRE</strong></td><td>二进制 Wire 编码</td><td>检测 <strong>二进制编码不兼容</strong>，是最低层面的破坏性检测。</td></tr></tbody></table></div><ul><li>举例子 <strong>FILE 级别检查</strong>： proto文件移动了位置。那么生成代码的目录结构也有变化，就会触发 breaking警报。</li></ul><h1 id=connectrpc基础-基于go>ConnectRPC基础 (基于Go)</h1><h2 id=介绍>介绍</h2><p>Connect 框架旨在提供一种灵活且兼容的机制，用于连接服务器和客户端。它支持三种核心协议：<strong>gRPC</strong>、<strong>gRPC-Web</strong> 和 <strong>Connect 自己的协议</strong>。</p><ol><li>Connect <strong>完全支持</strong> gRPC 协议，包括流式传输（streaming）、尾部元数据（trailers）和错误详情（error details）。<ul><li><strong>互操作性：</strong> 任何语言的 gRPC 客户端都可以调用 Connect 服务器，反之，Connect 客户端也可以调用任何 gRPC 服务器。</li><li><strong>兼容性验证：</strong> Connect 通过 Google 自己的互操作性测试的<strong>扩展版本</strong>来验证其 gRPC 兼容性。</li></ul></li><li>gRPC-Web 协议支持<ul><li><strong>无需代理：</strong> 它无需依赖像 Envoy 这样的翻译代理即可工作。</li></ul></li><li>Connect 自己的协议<ul><li><strong>跨 HTTP 版本：</strong> 可以在 HTTP/1.1、HTTP/2 和 HTTP/3 上运行。</li><li><strong>优势整合：</strong> 它汲取了 gRPC 和 gRPC-Web 的优点，包括流式传输，非常适合用于浏览器、单体应用（monoliths）和微服务（microservices）。</li><li><strong>编码支持：</strong> 默认支持 <strong>JSON</strong> 和二进制编码的 <strong>Protobuf</strong> 两种格式。</li></ul></li></ol><p>curl示例</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>curl <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span><span style=color:#0a3069></span>    --header <span style=color:#0a3069>&#34;Content-Type: application/json&#34;</span> <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span><span style=color:#0a3069></span>    --data <span style=color:#0a3069>&#39;{&#34;sentence&#34;: &#34;I feel happy.&#34;}&#39;</span> <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span><span style=color:#0a3069></span>    https://demo.connectrpc.com/connectrpc.eliza.v1.ElizaService/Say
</span></span></code></pre></td></tr></table></div></div><ul><li>服务器默认： Connect 服务器默认支持所有三种协议的入站请求（ingress）。</li><li>客户端默认： 客户端默认使用 Connect 协议，但可以通过配置切换到 gRPC 或 gRPC-Web，无需进一步的代码修改。</li></ul><h2 id=快速开始>快速开始</h2><h3 id=工具包安装>工具包安装</h3><p>这些会安装到全局：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>go install github.com/bufbuild/buf/cmd/buf@latest
</span></span><span style=display:flex><span>go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
</span></span><span style=display:flex><span>go install connectrpc.com/connect/cmd/protoc-gen-connect-go@latest
</span></span></code></pre></td></tr></table></div></div><h3 id=快速示例>快速示例</h3><h4 id=1-定义一个服务>1. 定义一个服务</h4><p>文件 <code>greet/v1/greet.proto</code></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span>syntax <span style=color:#0550ae>=</span> <span style=color:#0a3069>&#34;proto3&#34;</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#cf222e>package</span> <span style=color:#24292e>greet</span><span style=color:#0550ae>.</span>v1<span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#cf222e>import</span> <span style=color:#0a3069>&#34;buf/validate/validate.proto&#34;</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#cf222e>message</span> <span style=color:#1f2328>GreetRequest</span> <span style=color:#1f2328>{</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#cf222e>string</span> name <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span> <span style=color:#1f2328>[(</span>buf.validate.field<span style=color:#1f2328>)</span><span style=color:#0550ae>.</span><span style=color:#cf222e>string</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>    min_len<span style=color:#0550ae>:</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>    max_len<span style=color:#0550ae>:</span> <span style=color:#0550ae>50</span><span style=color:#1f2328>,</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#1f2328>}];</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#1f2328>}</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#cf222e>message</span> <span style=color:#1f2328>GreetResponse</span> <span style=color:#1f2328>{</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#cf222e>string</span> greeting <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#1f2328>}</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#cf222e>service</span> GreetService <span style=color:#1f2328>{</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#cf222e>rpc</span> Greet<span style=color:#1f2328>(</span>GreetRequest<span style=color:#1f2328>)</span> <span style=color:#cf222e>returns</span> <span style=color:#1f2328>(</span>GreetResponse<span style=color:#1f2328>)</span> <span style=color:#1f2328>{}</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#1f2328>}</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=2-配置buf工具生成代码>2. 配置buf工具生成代码</h4><p><code>buf.yaml</code> （定义proto项目）</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#0550ae>version</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>v2<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>deps</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span>- buf.build/bufbuild/protovalidate<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>lint</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0550ae>use</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>- STANDARD<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>breaking</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0550ae>use</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>- FILE<span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p><code>buf.gen.yaml</code> （定义生成动作）</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#0550ae>version</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>v2<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>plugins</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span>- <span style=color:#0550ae>local</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>protoc-gen-go<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#0550ae>out</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>gen<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#0550ae>opt</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>paths=source_relative<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span>- <span style=color:#0550ae>local</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>protoc-gen-connect-go<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#0550ae>out</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>gen<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#0550ae>opt</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span>- paths=source_relative<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span>- simple<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>managed</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0550ae>enabled</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#cf222e>true</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0550ae>override</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>- <span style=color:#0550ae>file_option</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>go_package_prefix<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span><span style=color:#0550ae>value</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>example/gen<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0550ae>disable</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>- <span style=color:#0550ae>file_option</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>go_package<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span><span style=color:#0550ae>module</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>buf.build/bufbuild/protovalidate<span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>执行指令，检查proto，生成：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>buf dep update
</span></span><span style=display:flex><span>buf lint
</span></span><span style=display:flex><span>buf generate
</span></span></code></pre></td></tr></table></div></div><p>生成后的目录结构：</p><pre tabindex=0><code>gen
└── greet
    └── v1
        ├── greet.pb.go
        └── greetv1connect
            └── greet.connect.go
</code></pre><h4 id=3-实现handler>3. 实现Handler</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>package</span><span style=color:#fff> </span><span style=color:#1f2328>main</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>import</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;context&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;fmt&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;net/http&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>greetv1</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;example/gen/greet/v1&#34;</span><span style=color:#fff>        </span><span style=color:#57606a>// generated by protoc-gen-go</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;example/gen/greet/v1/greetv1connect&#34;</span><span style=color:#fff> </span><span style=color:#57606a>// generated by protoc-gen-connect-go</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;connectrpc.com/connect&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;connectrpc.com/validate&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>type</span><span style=color:#fff> </span><span style=color:#1f2328>GreetServer</span><span style=color:#fff> </span><span style=color:#cf222e>struct</span><span style=color:#1f2328>{}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>s</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>GreetServer</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>Greet</span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>_</span><span style=color:#fff> </span><span style=color:#1f2328>context</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Context</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>req</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>greetv1</span><span style=color:#1f2328>.</span><span style=color:#1f2328>GreetRequest</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#0550ae>*</span><span style=color:#1f2328>greetv1</span><span style=color:#1f2328>.</span><span style=color:#1f2328>GreetResponse</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>res</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>greetv1</span><span style=color:#1f2328>.</span><span style=color:#1f2328>GreetResponse</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>Greeting</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>fmt</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Sprintf</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;Hello, %s!&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>req</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Name</span><span style=color:#1f2328>),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>res</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>main</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>greeter</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>GreetServer</span><span style=color:#1f2328>{}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>mux</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewServeMux</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>path</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>handler</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>greetv1connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewGreetServiceHandler</span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>greeter</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// Validation via Protovalidate is almost always recommended</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>WithInterceptors</span><span style=color:#1f2328>(</span><span style=color:#1f2328>validate</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewInterceptor</span><span style=color:#1f2328>()),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>mux</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Handle</span><span style=color:#1f2328>(</span><span style=color:#1f2328>path</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>handler</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>p</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#6639ba>new</span><span style=color:#1f2328>(</span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Protocols</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>p</span><span style=color:#1f2328>.</span><span style=color:#6639ba>SetHTTP1</span><span style=color:#1f2328>(</span><span style=color:#cf222e>true</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#57606a>// Use h2c so we can serve HTTP/2 without TLS.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>p</span><span style=color:#1f2328>.</span><span style=color:#6639ba>SetUnencryptedHTTP2</span><span style=color:#1f2328>(</span><span style=color:#cf222e>true</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>s</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Server</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>Addr</span><span style=color:#1f2328>:</span><span style=color:#fff>      </span><span style=color:#0a3069>&#34;localhost:8080&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>Handler</span><span style=color:#1f2328>:</span><span style=color:#fff>   </span><span style=color:#1f2328>mux</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>Protocols</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>p</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>s</span><span style=color:#1f2328>.</span><span style=color:#6639ba>ListenAndServe</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=4-启动运行>4. 启动运行</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>go get connectrpc.com/connect
</span></span><span style=display:flex><span>go get connectrpc.com/validate
</span></span><span style=display:flex><span>go get buf.build/go/protovalidate
</span></span><span style=display:flex><span>go run ./cmd/server/main.go
</span></span></code></pre></td></tr></table></div></div><h4 id=5-curl测试>5. curl测试</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>curl <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span><span style=color:#0a3069></span>    --header <span style=color:#0a3069>&#34;Content-Type: application/json&#34;</span> <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span><span style=color:#0a3069></span>    --data <span style=color:#0a3069>&#39;{&#34;name&#34;: &#34;Jane&#34;}&#39;</span> <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span><span style=color:#0a3069></span>    http://localhost:8080/greet.v1.GreetService/Greet
</span></span></code></pre></td></tr></table></div></div><p>响应内容为：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#1f2328>{</span><span style=color:#0550ae>&#34;greeting&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Hello, Jane!&#34;</span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>当然也支持grpc调用，可以用buf工具模拟grpc调用：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>buf curl <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span><span style=color:#0a3069></span>  --schema ./greet/v1/greet.proto <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span><span style=color:#0a3069></span>  --protocol grpc <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span><span style=color:#0a3069></span>  --http2-prior-knowledge <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span><span style=color:#0a3069></span>  --data <span style=color:#0a3069>&#39;{&#34;name&#34;: &#34;Jane&#34;}&#39;</span> <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span><span style=color:#0a3069></span>  http://localhost:8080/greet.v1.GreetService/Greet
</span></span></code></pre></td></tr></table></div></div><p>也可以模拟connect协议调用</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>buf curl <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span><span style=color:#0a3069></span>  --schema . <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span><span style=color:#0a3069></span>  --data <span style=color:#0a3069>&#39;{&#34;name&#34;: &#34;Jane&#34;}&#39;</span> <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span><span style=color:#0a3069></span>  http://localhost:8080/greet.v1.GreetService/Greet
</span></span></code></pre></td></tr></table></div></div><h4 id=6-client代码测试>6. Client代码测试</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>package</span><span style=color:#fff> </span><span style=color:#1f2328>main</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>import</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;context&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;log&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;net/http&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>greetv1</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;example/gen/greet/v1&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;example/gen/greet/v1/greetv1connect&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>main</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>client</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>greetv1connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewGreetServiceClient</span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>DefaultClient</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#0a3069>&#34;http://localhost:8080&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>res</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>client</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Greet</span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>context</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Background</span><span style=color:#1f2328>(),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>greetv1</span><span style=color:#1f2328>.</span><span style=color:#1f2328>GreetRequest</span><span style=color:#1f2328>{</span><span style=color:#1f2328>Name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;Jane&#34;</span><span style=color:#1f2328>},</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>log</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Println</span><span style=color:#1f2328>(</span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>return</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>log</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Println</span><span style=color:#1f2328>(</span><span style=color:#1f2328>res</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Greeting</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>运行代码:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>go run ./cmd/client/main.go
</span></span></code></pre></td></tr></table></div></div><h3 id=仅使用-grpc>仅使用 gRPC</h3><p><strong>默认支持所有协议：</strong> 默认情况下，<strong>Connect-Go 服务器</strong>支持来自所有三种协议（Connect、gRPC 和 gRPC-Web）的<strong>入站请求 (ingress)</strong>，<strong>无需任何额外配置</strong>。</p><p>使用下面的代码，可以关闭connect协议，仅用gGPC协议通信</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#1f2328>client</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>greetv1connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewGreetServiceClient</span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>DefaultClient</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;http://localhost:8080&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>WithGRPC</span><span style=color:#1f2328>(),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=routing路由>Routing(路由)</h2><p>默认connect会支持下面的路由访问:</p><pre tabindex=0><code>:method post
:path /&lt;Package&gt;.&lt;Service&gt;/&lt;Method&gt;
</code></pre><p>如果想要把路由地址修改，增加前缀，可以用下面的做法。（不过这种做法， <code>grpc-go</code> 是不能支持的， 如果要支持 gRPC 最好不要把connect的handler进行prefix）</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#1f2328>api</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewServeMux</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>api</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Handle</span><span style=color:#1f2328>(</span><span style=color:#1f2328>greetv1connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewGreetServiceHandler</span><span style=color:#1f2328>(</span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>greetServer</span><span style=color:#1f2328>{}))</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>mux</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewServeMux</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>mux</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Handle</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;/&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#6639ba>newHTMLHandler</span><span style=color:#1f2328>())</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>mux</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Handle</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;/api/&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#6639ba>StripPrefix</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;/api&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>api</span><span style=color:#1f2328>))</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#6639ba>ListenAndServe</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;:http&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>mux</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>解释：</p><ol><li><code>NewServerMux</code> : 创建一个 <strong>总路由器</strong> (<code>ServeMux</code>)，Mux(Multilexer) ，可以理解聚合了一系列url路由的handler。</li><li><code>ServeMux</code> 可以嵌套使用。因此，上面代码里，顶层 <code>mux</code> 下面有两个Handle注册，其中一个，api（也是一个 <code>ServeMux</code> 对象）</li><li><code>http.StripPrefix</code> ：包装 <code>Handler</code> 的类似middleware的组件，负责把请求中URL的前缀去除掉。</li></ol><h2 id=error错误处理>Error(错误处理)</h2><p>在 Connect 中，一个错误（<code>error</code>）不仅仅是普通的 Go 错误，它还附带了一个 <strong>错误码（error code）</strong>。</p><ul><li><strong>错误码</strong>类似于 gRPC 的 status code（例如 <code>InvalidArgument</code>, <code>DeadlineExceeded</code>, <code>Canceled</code>, <code>Unknown</code> 等），用于让客户端知道这个错误的类型，从而决定如何处理，比如重试、回退或直接报错。</li><li><strong>底层错误消息</strong>仍然是标准 Go <code>error</code> 的 <code>Error()</code> 字符串，这个消息会被传给客户端。</li></ul><p>所以 Connect 的错误是 <strong>带代码的 Go 错误</strong>，发送给客户端后，客户端可以根据错误码做不同的处理逻辑。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewError</span><span style=color:#1f2328>(</span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>CodeInvalidArgument</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>第一个参数是错误码，例如 <code>CodeInvalidArgument</code>。</li><li>第二个参数是原始错误 <code>err</code>。</li><li>返回值仍然是 <code>error</code> 类型，但它已经包含了错误码</li></ul><p>如果你的 handler 没有返回带错误码的错误，Connect 会帮你自动处理一些特殊错误：</p><div class=table-wrapper><table><thead><tr><th>原始错误</th><th>Connect 错误码</th></tr></thead><tbody><tr><td><code>context.DeadlineExceeded</code></td><td><code>deadline_exceeded</code></td></tr><tr><td><code>context.Canceled</code></td><td><code>canceled</code></td></tr><tr><td>其他错误</td><td><code>unknown</code></td></tr></tbody></table></div><p>示例代码:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>s</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>GreetServer</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>Greet</span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>ctx</span><span style=color:#fff> </span><span style=color:#1f2328>context</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Context</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>req</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>greetv1</span><span style=color:#1f2328>.</span><span style=color:#1f2328>GreetRequest</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#0550ae>*</span><span style=color:#1f2328>greetv1</span><span style=color:#1f2328>.</span><span style=color:#1f2328>GreetResponse</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>ctx</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Err</span><span style=color:#1f2328>();</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#57606a>// automatically coded correctly</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#6639ba>validateGreetRequest</span><span style=color:#1f2328>(</span><span style=color:#1f2328>req</span><span style=color:#1f2328>);</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewError</span><span style=color:#1f2328>(</span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>CodeInvalidArgument</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>greeting</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#6639ba>doGreetWork</span><span style=color:#1f2328>(</span><span style=color:#1f2328>ctx</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>req</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewError</span><span style=color:#1f2328>(</span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>CodeUnknown</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>greetv1</span><span style=color:#1f2328>.</span><span style=color:#1f2328>GreetResponse</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>Greeting</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>greeting</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>},</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>第一行 <code>if err := ctx.Err(); err != nil</code> 处的逻辑： 如果 <code>ctx</code> 被取消或超时，<code>ctx.Err()</code> 会返回 <code>context.Canceled</code> 或 <code>context.DeadlineExceeded</code>。</li><li>后面的都比较直观，容易理解。</li></ul><p>对客户端来说，会得到标准的 go 错误。解析错误用 CodeOf 函数</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>CodeOf</span><span style=color:#1f2328>(</span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>获取更多信息的做法(如果是 connect 的错误类型)：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>connectErr</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#6639ba>new</span><span style=color:#1f2328>(</span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Error</span><span style=color:#1f2328>);</span><span style=color:#fff> </span><span style=color:#1f2328>errors</span><span style=color:#1f2328>.</span><span style=color:#6639ba>As</span><span style=color:#1f2328>(</span><span style=color:#1f2328>err</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>connectErr</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>fmt</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Println</span><span style=color:#1f2328>(</span><span style=color:#1f2328>connectErr</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Message</span><span style=color:#1f2328>())</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>fmt</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Println</span><span style=color:#1f2328>(</span><span style=color:#1f2328>connectErr</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Details</span><span style=color:#1f2328>())</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>从http请求得到的错误信息，大概格式为：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>&#34;code&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;invalid_argument&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>  <span style=color:#0550ae>&#34;message&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;data cannot be empty&#34;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=利用-errordetail-传递详细错误信息>利用 ErrorDetail 传递详细错误信息</h3><p>server代码</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>package</span><span style=color:#fff> </span><span style=color:#1f2328>example</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>import</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;errors&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;connectrpc.com/connect&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;google.golang.org/genproto/googleapis/rpc/errdetails&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;google.golang.org/protobuf/types/known/durationpb&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>newTransientError</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewError</span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>CodeUnavailable</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>errors</span><span style=color:#1f2328>.</span><span style=color:#6639ba>New</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;overloaded: back off and retry&#34;</span><span style=color:#1f2328>),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>retryInfo</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>errdetails</span><span style=color:#1f2328>.</span><span style=color:#1f2328>RetryInfo</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>RetryDelay</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>durationpb</span><span style=color:#1f2328>.</span><span style=color:#6639ba>New</span><span style=color:#1f2328>(</span><span style=color:#0550ae>10</span><span style=color:#0550ae>*</span><span style=color:#1f2328>time</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Second</span><span style=color:#1f2328>),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>detail</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>detailErr</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewErrorDetail</span><span style=color:#1f2328>(</span><span style=color:#1f2328>retryInfo</span><span style=color:#1f2328>);</span><span style=color:#fff> </span><span style=color:#1f2328>detailErr</span><span style=color:#fff> </span><span style=color:#0550ae>==</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>err</span><span style=color:#1f2328>.</span><span style=color:#6639ba>AddDetail</span><span style=color:#1f2328>(</span><span style=color:#1f2328>detail</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>行 <code>retryInfo := &amp;errdetails.RetryInfo{</code> : <code>RetryInfo</code> 是 gRPC 标准错误详情之一，用于告诉客户端：<strong>多久之后可以重试请求</strong>。</li><li>根据gRPC规范，error可以添加errorDetails的列表，来详细描述error。上面就是增加了一个detail。</li></ul><p>client提取这个信息</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>package</span><span style=color:#fff> </span><span style=color:#1f2328>example</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>import</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;errors&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;connectrpc.com/connect&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;google.golang.org/genproto/googleapis/rpc/errdetails&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;google.golang.org/protobuf/types/known/durationpb&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>extractRetryInfo</span><span style=color:#1f2328>(</span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#0550ae>*</span><span style=color:#1f2328>errdetails</span><span style=color:#1f2328>.</span><span style=color:#1f2328>RetryInfo</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>bool</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>var</span><span style=color:#fff> </span><span style=color:#1f2328>connectErr</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Error</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>!</span><span style=color:#1f2328>errors</span><span style=color:#1f2328>.</span><span style=color:#6639ba>As</span><span style=color:#1f2328>(</span><span style=color:#1f2328>err</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>connectErr</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>false</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>for</span><span style=color:#fff> </span><span style=color:#1f2328>_</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>detail</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#cf222e>range</span><span style=color:#fff> </span><span style=color:#1f2328>connectErr</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Details</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>msg</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>valueErr</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>detail</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Value</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>valueErr</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span><span style=color:#57606a>// Usually, errors here mean that we don&#39;t have the schema for this</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span><span style=color:#57606a>// Protobuf message.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span><span style=color:#cf222e>continue</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>retryInfo</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>ok</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>msg</span><span style=color:#1f2328>.(</span><span style=color:#0550ae>*</span><span style=color:#1f2328>errdetails</span><span style=color:#1f2328>.</span><span style=color:#1f2328>RetryInfo</span><span style=color:#1f2328>);</span><span style=color:#fff> </span><span style=color:#1f2328>ok</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>retryInfo</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>true</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>false</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>这里需要注意的：</p><ul><li><code>msg.(T)</code> 这个用法是因为 <code>msg</code> 是一个interface。使用的是接口断言的语法。断言，接口内的数据类型为 <code>T</code></li></ul><h2 id=header和trailer>Header和Trailer</h2><pre tabindex=0><code>HTTP/1.1 200 OK
Transfer-Encoding: chunked
Trailer: X-Checksum

...response body...
0
X-Checksum: 123456
</code></pre><ul><li>普通的 header 在请求/响应 <strong>开始</strong>就发送。</li><li>trailer 在消息体 <strong>结束后</strong>发送。</li></ul><p>这个能力，connect库也提供了设置的能力。这里略不细表。</p><h2 id=interceptors-拦截器>Interceptors (拦截器)</h2><p>这个类似其他框架的middleware或者decorator。主要用来扩展connect框架的。</p><p>对于 unaray RPC来说，函数接口为：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>type</span><span style=color:#fff> </span><span style=color:#1f2328>UnaryFunc</span><span style=color:#fff> </span><span style=color:#cf222e>func</span><span style=color:#1f2328>(</span><span style=color:#1f2328>context</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Context</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>AnyRequest</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>AnyResponse</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>对应的interceptor接口为：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>type</span><span style=color:#fff> </span><span style=color:#1f2328>UnaryInterceptorFunc</span><span style=color:#fff> </span><span style=color:#cf222e>func</span><span style=color:#1f2328>(</span><span style=color:#1f2328>UnaryFunc</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>UnaryFunc</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>例子：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>package</span><span style=color:#fff> </span><span style=color:#1f2328>example</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>import</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;context&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;errors&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;connectrpc.com/connect&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>const</span><span style=color:#fff> </span><span style=color:#1f2328>tokenHeader</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;Acme-Token&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>NewAuthInterceptor</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>UnaryInterceptorFunc</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>func</span><span style=color:#1f2328>(</span><span style=color:#1f2328>next</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>UnaryFunc</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>UnaryFunc</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>func</span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span><span style=color:#1f2328>ctx</span><span style=color:#fff> </span><span style=color:#1f2328>context</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Context</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span><span style=color:#1f2328>req</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>AnyRequest</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>AnyResponse</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>req</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Spec</span><span style=color:#1f2328>().</span><span style=color:#1f2328>IsClient</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#57606a>// Send a token with client requests.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>req</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Header</span><span style=color:#1f2328>().</span><span style=color:#6639ba>Set</span><span style=color:#1f2328>(</span><span style=color:#1f2328>tokenHeader</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;sample&#34;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span><span style=color:#1f2328>}</span><span style=color:#fff> </span><span style=color:#cf222e>else</span><span style=color:#fff> </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>req</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Header</span><span style=color:#1f2328>().</span><span style=color:#6639ba>Get</span><span style=color:#1f2328>(</span><span style=color:#1f2328>tokenHeader</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#0550ae>==</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;&#34;</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#57606a>// Check token in handlers.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewError</span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>          </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>CodeUnauthenticated</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>          </span><span style=color:#1f2328>errors</span><span style=color:#1f2328>.</span><span style=color:#6639ba>New</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;no token provided&#34;</span><span style=color:#1f2328>),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#6639ba>next</span><span style=color:#1f2328>(</span><span style=color:#1f2328>ctx</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>req</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=observability可观测性>Observability(可观测性)</h2><p>OpenTelemetry（简称 <strong>OTel</strong>）本质上是一个 <strong>可观测性（Observability）工具集</strong>，它帮你 <strong>了解应用在运行时发生了什么</strong>。</p><p>在现代微服务或分布式系统里，应用通常分散在很多服务、容器和服务器上。如果系统出问题，你需要知道：</p><ul><li>哪个服务慢了？</li><li>哪个服务报错了？</li><li>请求是怎么在服务之间流动的？</li></ul><p>传统日志只能告诉你一些信息，但不够系统化，也不容易关联多个服务的请求。<br>这时候就需要 <strong>可观测性工具</strong>，比如 OpenTelemetry。</p><p><strong>OpenTelemetry 的核心概念</strong></p><ol><li><strong>Tracer / Span（追踪）</strong><ul><li>一个请求会产生一个 <strong>Trace</strong>，由多个 <strong>Span</strong> 组成</li><li>每个 Span 表示请求的一个步骤，例如：<ul><li>网关收到请求 → 创建 span</li><li>调用后端服务 → 创建 span</li></ul></li><li>这样就能可视化请求的完整路径和耗时</li></ul></li><li><strong>Meter / Metric（指标）</strong><ul><li>用于收集数值数据，例如：<ul><li>每秒请求数（QPS）</li><li>请求失败数</li><li>CPU 或内存使用率</li></ul></li></ul></li><li><strong>Propagator（传播器）</strong><ul><li>让 trace 可以跨服务传递</li><li>当请求从服务 A 到服务 B，Propagator 会把 trace 信息附带过去，保证 span 能关联起来</li></ul></li></ol><p>OpenTelemetry 就是给你的应用装上“感知能力”，它能告诉你每个请求怎么走、耗时多少、是否出错，并生成统计数据。</p><p>可以以 Interceptor (拦截器)的方式启动otel</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>import</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;connectrpc.com/otelconnect&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>otelInterceptor</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>otelconnect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewInterceptor</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>log</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Fatal</span><span style=color:#1f2328>(</span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>path</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>handler</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>greetv1connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewGreetServiceHandler</span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>greeter</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>WithInterceptors</span><span style=color:#1f2328>(</span><span style=color:#1f2328>otelInterceptor</span><span style=color:#1f2328>),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>client</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>greetv1connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewGreetServiceClient</span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>DefaultClient</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#0a3069>&#34;http://localhost:8080&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>WithInterceptors</span><span style=color:#1f2328>(</span><span style=color:#1f2328>otelInterceptor</span><span style=color:#1f2328>),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>OpenTelemetry 本身不存数据，它只负责收集和发送。发送目标由 Exporter 配置 决定，例如：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#1f2328>tp</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>sdktrace</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewTracerProvider</span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>sdktrace</span><span style=color:#1f2328>.</span><span style=color:#6639ba>WithBatcher</span><span style=color:#1f2328>(</span><span style=color:#1f2328>jaegerExporter</span><span style=color:#1f2328>),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>otel</span><span style=color:#1f2328>.</span><span style=color:#6639ba>SetTracerProvider</span><span style=color:#1f2328>(</span><span style=color:#1f2328>tp</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><p>如果要自定义 export的配置，可以用下面办法自定义拦截器</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#57606a>// newInterceptor instruments Connect clients and handlers using custom OpenTelemetry metrics, tracing, and propagation.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>newInterceptor</span><span style=color:#1f2328>(</span><span style=color:#1f2328>tp</span><span style=color:#fff> </span><span style=color:#1f2328>trace</span><span style=color:#1f2328>.</span><span style=color:#1f2328>TracerProvider</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>mp</span><span style=color:#fff> </span><span style=color:#1f2328>metric</span><span style=color:#1f2328>.</span><span style=color:#1f2328>MeterProvider</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>p</span><span style=color:#fff> </span><span style=color:#1f2328>propagation</span><span style=color:#1f2328>.</span><span style=color:#1f2328>TextMapPropagator</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Interceptor</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>otelconnect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewInterceptor</span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>otelconnect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>WithTracerProvider</span><span style=color:#1f2328>(</span><span style=color:#1f2328>tp</span><span style=color:#1f2328>),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>otelconnect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>WithMeterProvider</span><span style=color:#1f2328>(</span><span style=color:#1f2328>mp</span><span style=color:#1f2328>),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>otelconnect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>WithPropagator</span><span style=color:#1f2328>(</span><span style=color:#1f2328>p</span><span style=color:#1f2328>),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=streaming-流处理>Streaming (流处理)</h2><h3 id=proto定义>proto定义</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span>syntax <span style=color:#0550ae>=</span> <span style=color:#0a3069>&#34;proto3&#34;</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#cf222e>package</span> <span style=color:#24292e>greet</span><span style=color:#0550ae>.</span>v1<span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#cf222e>import</span> <span style=color:#0a3069>&#34;buf/validate/validate.proto&#34;</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#cf222e>message</span> <span style=color:#1f2328>GreetRequest</span> <span style=color:#1f2328>{</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#cf222e>string</span> name <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span> <span style=color:#1f2328>[(</span>buf.validate.field<span style=color:#1f2328>)</span><span style=color:#0550ae>.</span><span style=color:#cf222e>string</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>    min_len<span style=color:#0550ae>:</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>    max_len<span style=color:#0550ae>:</span> <span style=color:#0550ae>50</span><span style=color:#1f2328>,</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#1f2328>}];</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#1f2328>}</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#cf222e>message</span> <span style=color:#1f2328>GreetResponse</span> <span style=color:#1f2328>{</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#cf222e>string</span> greeting <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#1f2328>}</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#cf222e>service</span> GreetService <span style=color:#1f2328>{</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span>  <span style=color:#cf222e>rpc</span> Greet<span style=color:#1f2328>(</span>stream GreetRequest<span style=color:#1f2328>)</span> <span style=color:#cf222e>returns</span> <span style=color:#1f2328>(</span>GreetResponse<span style=color:#1f2328>)</span> <span style=color:#1f2328>{}</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#1f2328>}</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>当然参数和返回值都可以是流。这样就可以双向通信。（注意： <strong>支持 Connect 的双向流就能替代 WebSocket</strong>，实现前端和后端的实时双向通信）</li></ul><p>针对上面的定义，</p><h3 id=server端代码>server端代码</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>package</span><span style=color:#fff> </span><span style=color:#1f2328>main</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>import</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;context&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;errors&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;fmt&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;log&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;net/http&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;strings&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;connectrpc.com/connect&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;connectrpc.com/validate&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>greetv1</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;example/gen/greet/v1&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;example/gen/greet/v1/greetv1connect&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>type</span><span style=color:#fff> </span><span style=color:#1f2328>GreetServer</span><span style=color:#fff> </span><span style=color:#cf222e>struct</span><span style=color:#1f2328>{}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>s</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>GreetServer</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>Greet</span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>ctx</span><span style=color:#fff> </span><span style=color:#1f2328>context</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Context</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>stream</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>ClientStream</span><span style=color:#1f2328>[</span><span style=color:#1f2328>greetv1</span><span style=color:#1f2328>.</span><span style=color:#1f2328>GreetRequest</span><span style=color:#1f2328>],</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#0550ae>*</span><span style=color:#1f2328>greetv1</span><span style=color:#1f2328>.</span><span style=color:#1f2328>GreetResponse</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>callInfo</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>ok</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>CallInfoForHandlerContext</span><span style=color:#1f2328>(</span><span style=color:#1f2328>ctx</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>!</span><span style=color:#1f2328>ok</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>errors</span><span style=color:#1f2328>.</span><span style=color:#6639ba>New</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;can&#39;t access headers: no CallInfo for handler context&#34;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>log</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Println</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;Request headers: &#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>callInfo</span><span style=color:#1f2328>.</span><span style=color:#6639ba>RequestHeader</span><span style=color:#1f2328>())</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>var</span><span style=color:#fff> </span><span style=color:#1f2328>greeting</span><span style=color:#fff> </span><span style=color:#1f2328>strings</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Builder</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>for</span><span style=color:#fff> </span><span style=color:#1f2328>stream</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Receive</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>g</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>fmt</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Sprintf</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;Hello, %s!\n&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>stream</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Msg</span><span style=color:#1f2328>().</span><span style=color:#1f2328>Name</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>_</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>greeting</span><span style=color:#1f2328>.</span><span style=color:#6639ba>WriteString</span><span style=color:#1f2328>(</span><span style=color:#1f2328>g</span><span style=color:#1f2328>);</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewError</span><span style=color:#1f2328>(</span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>CodeInternal</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>stream</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Err</span><span style=color:#1f2328>();</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewError</span><span style=color:#1f2328>(</span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>CodeUnknown</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>callInfo</span><span style=color:#1f2328>.</span><span style=color:#6639ba>ResponseHeader</span><span style=color:#1f2328>().</span><span style=color:#6639ba>Set</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;Greet-Version&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;v1&#34;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>res</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>greetv1</span><span style=color:#1f2328>.</span><span style=color:#1f2328>GreetResponse</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>Greeting</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>greeting</span><span style=color:#1f2328>.</span><span style=color:#6639ba>String</span><span style=color:#1f2328>(),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>res</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>main</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>greeter</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>GreetServer</span><span style=color:#1f2328>{}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>mux</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewServeMux</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>path</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>handler</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>greetv1connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewGreetServiceHandler</span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>greeter</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// Validation via Protovalidate is almost always recommended</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>WithInterceptors</span><span style=color:#1f2328>(</span><span style=color:#1f2328>validate</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewInterceptor</span><span style=color:#1f2328>()),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>mux</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Handle</span><span style=color:#1f2328>(</span><span style=color:#1f2328>path</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>handler</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>p</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#6639ba>new</span><span style=color:#1f2328>(</span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Protocols</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>p</span><span style=color:#1f2328>.</span><span style=color:#6639ba>SetHTTP1</span><span style=color:#1f2328>(</span><span style=color:#cf222e>true</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#57606a>// Use h2c so we can serve HTTP/2 without TLS.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>p</span><span style=color:#1f2328>.</span><span style=color:#6639ba>SetUnencryptedHTTP2</span><span style=color:#1f2328>(</span><span style=color:#cf222e>true</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>s</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Server</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>Addr</span><span style=color:#1f2328>:</span><span style=color:#fff>      </span><span style=color:#0a3069>&#34;localhost:8080&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>Handler</span><span style=color:#1f2328>:</span><span style=color:#fff>   </span><span style=color:#1f2328>mux</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>Protocols</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>p</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>s</span><span style=color:#1f2328>.</span><span style=color:#6639ba>ListenAndServe</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>服务端接收流，拼接字符串。</li></ul><h3 id=interceptor验证拦截器>Interceptor(验证拦截器)</h3><p>统一处理 ConnectRPC 的认证逻辑，在客户端自动添加 token，在服务端校验 token，覆盖 Unary 和流式 RPC。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>const</span><span style=color:#fff> </span><span style=color:#1f2328>tokenHeader</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;Acme-Token&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>var</span><span style=color:#fff> </span><span style=color:#1f2328>errNoToken</span><span style=color:#fff> </span><span style=color:#1f2328>=</span><span style=color:#fff> </span><span style=color:#1f2328>errors</span><span style=color:#1f2328>.</span><span style=color:#6639ba>New</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;no token provided&#34;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>type</span><span style=color:#fff> </span><span style=color:#1f2328>authInterceptor</span><span style=color:#fff> </span><span style=color:#cf222e>struct</span><span style=color:#1f2328>{}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>NewAuthInterceptor</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>authInterceptor</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>authInterceptor</span><span style=color:#1f2328>{}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>i</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>authInterceptor</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>WrapUnary</span><span style=color:#1f2328>(</span><span style=color:#1f2328>next</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>UnaryFunc</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>UnaryFunc</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#57606a>// Same as previous UnaryInterceptorFunc.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>func</span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>ctx</span><span style=color:#fff> </span><span style=color:#1f2328>context</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Context</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>req</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>AnyRequest</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>AnyResponse</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>req</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Spec</span><span style=color:#1f2328>().</span><span style=color:#1f2328>IsClient</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span><span style=color:#57606a>// Send a token with client requests.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span><span style=color:#1f2328>req</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Header</span><span style=color:#1f2328>().</span><span style=color:#6639ba>Set</span><span style=color:#1f2328>(</span><span style=color:#1f2328>tokenHeader</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;sample&#34;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff> </span><span style=color:#cf222e>else</span><span style=color:#fff> </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>req</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Header</span><span style=color:#1f2328>().</span><span style=color:#6639ba>Get</span><span style=color:#1f2328>(</span><span style=color:#1f2328>tokenHeader</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#0550ae>==</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;&#34;</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span><span style=color:#57606a>// Check token in handlers.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewError</span><span style=color:#1f2328>(</span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>CodeUnauthenticated</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>errNoToken</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#6639ba>next</span><span style=color:#1f2328>(</span><span style=color:#1f2328>ctx</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>req</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#0550ae>*</span><span style=color:#1f2328>authInterceptor</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>WrapStreamingClient</span><span style=color:#1f2328>(</span><span style=color:#1f2328>next</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>StreamingClientFunc</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>StreamingClientFunc</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>func</span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>ctx</span><span style=color:#fff> </span><span style=color:#1f2328>context</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Context</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>spec</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Spec</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>StreamingClientConn</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>conn</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#6639ba>next</span><span style=color:#1f2328>(</span><span style=color:#1f2328>ctx</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>spec</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>conn</span><span style=color:#1f2328>.</span><span style=color:#6639ba>RequestHeader</span><span style=color:#1f2328>().</span><span style=color:#6639ba>Set</span><span style=color:#1f2328>(</span><span style=color:#1f2328>tokenHeader</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;sample&#34;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>conn</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#1f2328>i</span><span style=color:#fff> </span><span style=color:#0550ae>*</span><span style=color:#1f2328>authInterceptor</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#6639ba>WrapStreamingHandler</span><span style=color:#1f2328>(</span><span style=color:#1f2328>next</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>StreamingHandlerFunc</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>StreamingHandlerFunc</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#cf222e>func</span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>ctx</span><span style=color:#fff> </span><span style=color:#1f2328>context</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Context</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>conn</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>StreamingHandlerConn</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#cf222e>error</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>conn</span><span style=color:#1f2328>.</span><span style=color:#6639ba>RequestHeader</span><span style=color:#1f2328>().</span><span style=color:#6639ba>Get</span><span style=color:#1f2328>(</span><span style=color:#1f2328>tokenHeader</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#0550ae>==</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;&#34;</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>      </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewError</span><span style=color:#1f2328>(</span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#1f2328>CodeUnauthenticated</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>errNoToken</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#6639ba>next</span><span style=color:#1f2328>(</span><span style=color:#1f2328>ctx</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>conn</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><p><strong>常量与错误</strong></p><ul><li><code>tokenHeader = "Acme-Token"</code>：自定义 HTTP 头名称，用于传递 token</li><li><code>errNoToken</code>：服务端在请求缺少 token 时返回的错误</li></ul></li><li><p><strong>Unary RPC 拦截器 (<code>WrapUnary</code>)</strong></p><ul><li>客户端请求时：自动在请求头加 <code>Acme-Token: sample</code></li><li>服务端处理时：如果请求头缺少 token，则返回 <code>Unauthenticated</code> 错误</li></ul></li><li><p><strong>客户端流式拦截器 (<code>WrapStreamingClient</code>)</strong></p><ul><li>客户端发起流式 RPC 时，自动在流请求头加 token</li></ul></li><li><p><strong>服务端流式拦截器 (<code>WrapStreamingHandler</code>)</strong></p><ul><li>服务端接收流式 RPC 时，校验请求头是否有 token</li><li>缺失 token 则拒绝连接并返回 <code>Unauthenticated</code></li></ul></li></ul><h3 id=client端代码>client端代码</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>package</span><span style=color:#fff> </span><span style=color:#1f2328>main</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>import</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#0a3069>&#34;context&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#0a3069>&#34;fmt&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#0a3069>&#34;log&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#0a3069>&#34;connectrpc.com/connect&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>greetv1</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;example/gen/greet/v1&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#0a3069>&#34;example/gen/greet/v1/greetv1connect&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#57606a>// 假设 authInterceptor 已经实现</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#57606a>// tokenHeader := &#34;Acme-Token&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#57606a>// func NewAuthInterceptor() *authInterceptor { ... }</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>main</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#57606a>// 创建拦截器</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>auth</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#6639ba>NewAuthInterceptor</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#57606a>// 创建 GreetService 客户端</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>client</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>greetv1connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewGreetServiceClient</span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#0a3069>&#34;http://localhost:8080&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>connect</span><span style=color:#1f2328>.</span><span style=color:#6639ba>WithInterceptors</span><span style=color:#1f2328>(</span><span style=color:#1f2328>auth</span><span style=color:#1f2328>),</span><span style=color:#fff> </span><span style=color:#57606a>// 包含 Unary 和流式拦截器</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>ctx</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>context</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Background</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#57606a>// 打开客户端流</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>stream</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>client</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Greet</span><span style=color:#1f2328>(</span><span style=color:#1f2328>ctx</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>log</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Fatalf</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to create client stream: %v&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#57606a>// 要发送的名字列表</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>names</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>[]</span><span style=color:#cf222e>string</span><span style=color:#1f2328>{</span><span style=color:#0a3069>&#34;Alice&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;Bob&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;Charlie&#34;</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#57606a>// 循环发送消息</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>for</span><span style=color:#fff> </span><span style=color:#1f2328>_</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>name</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#cf222e>range</span><span style=color:#fff> </span><span style=color:#1f2328>names</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>req</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>greetv1</span><span style=color:#1f2328>.</span><span style=color:#1f2328>GreetRequest</span><span style=color:#1f2328>{</span><span style=color:#1f2328>Name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>name</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>stream</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Send</span><span style=color:#1f2328>(</span><span style=color:#1f2328>req</span><span style=color:#1f2328>);</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>			</span><span style=color:#1f2328>log</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Fatalf</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to send request: %v&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>fmt</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Printf</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;Sent: %s\n&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>name</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#57606a>// 关闭客户端流并接收服务端响应</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>resp</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>stream</span><span style=color:#1f2328>.</span><span style=color:#6639ba>CloseAndReceive</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#fff> </span><span style=color:#0550ae>!=</span><span style=color:#fff> </span><span style=color:#cf222e>nil</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>log</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Fatalf</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to receive response: %v&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>fmt</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Println</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;Server Response:&#34;</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>fmt</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Println</span><span style=color:#1f2328>(</span><span style=color:#1f2328>resp</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Msg</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Greeting</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>客户端通过：先调用rpc，然后得到一个stream。随后可以写入。<ul><li>所以，服务端如果返回流，也是先返回，然后得到一个流。</li></ul></li></ul><h2 id=超时和连接池>超时和连接池</h2><ul><li><p><strong>连接池</strong></p><ul><li>RPC 客户端通常会频繁请求少数服务器。</li><li>可以增加 <code>Transport.MaxIdleConnsPerHost</code> 来复用连接，提高效率。</li></ul></li><li><p><strong>禁止重定向</strong></p><ul><li>RPC 很少用 HTTP 重定向，客户端可以通过 <code>CheckRedirect</code> 禁止自动跟随。</li></ul></li><li><p><strong>压缩</strong></p><ul><li>Connect 自动设置 <code>Accept-Encoding</code>，所以 <code>Transport.DisableCompression</code> 对 RPC 无效。</li></ul></li><li><p><strong>超时</strong></p><ul><li><strong>流式 RPC</strong>：超时适用于整个消息交换。</li><li>服务器需在 unary（单次请求）和 streaming（流式请求）之间平衡超时设置。</li><li>Go 的 <code>net/http</code> 用 <code>SetDeadline</code> 实现超时，没有“空闲超时”，所以如果客户端打开流但不发送数据，可能会占用服务器资源。</li><li>对公网 API，建议：<ul><li>超时不要设置过长</li><li>尽量避免流式 RPC</li></ul></li></ul></li><li><p><strong>http.Server 超时字段</strong></p><ul><li><code>ReadTimeout</code> 和 <code>WriteTimeout</code> 会作用于整个操作，包括 streaming RPC。</li></ul></li></ul><h2 id=h2c>h2c</h2><p>也叫做 HTTP/2 without TLS 。有时候需要用这个版本的协议</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>package</span><span style=color:#fff> </span><span style=color:#1f2328>main</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>import</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#0a3069>&#34;net/http&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>main</span><span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>mux</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#6639ba>NewServeMux</span><span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#57606a>// Mount some handlers here.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>p</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#6639ba>new</span><span style=color:#1f2328>(</span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Protocols</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>p</span><span style=color:#1f2328>.</span><span style=color:#6639ba>SetHTTP1</span><span style=color:#1f2328>(</span><span style=color:#cf222e>true</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>p</span><span style=color:#1f2328>.</span><span style=color:#6639ba>SetUnencryptedHTTP2</span><span style=color:#1f2328>(</span><span style=color:#cf222e>true</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>server</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Server</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>Addr</span><span style=color:#1f2328>:</span><span style=color:#fff>      </span><span style=color:#0a3069>&#34;:http&#34;</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>Handler</span><span style=color:#1f2328>:</span><span style=color:#fff>   </span><span style=color:#1f2328>mux</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>Protocols</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>p</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>// Don&#39;t forget timeouts!</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>  </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=cors>CORS</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>import</span><span style=color:#fff> </span><span style=color:#1f2328>(</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#0a3069>&#34;net/http&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>connectcors</span><span style=color:#fff> </span><span style=color:#0a3069>&#34;connectrpc.com/cors&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#0a3069>&#34;github.com/rs/cors&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#57606a>// withCORS adds CORS support to a Connect HTTP handler.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>func</span><span style=color:#fff> </span><span style=color:#6639ba>withCORS</span><span style=color:#1f2328>(</span><span style=color:#1f2328>h</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Handler</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>http</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Handler</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>middleware</span><span style=color:#fff> </span><span style=color:#0550ae>:=</span><span style=color:#fff> </span><span style=color:#1f2328>cors</span><span style=color:#1f2328>.</span><span style=color:#6639ba>New</span><span style=color:#1f2328>(</span><span style=color:#1f2328>cors</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Options</span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>AllowedOrigins</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>[]</span><span style=color:#cf222e>string</span><span style=color:#1f2328>{</span><span style=color:#0a3069>&#34;example.com&#34;</span><span style=color:#1f2328>},</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>AllowedMethods</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>connectcors</span><span style=color:#1f2328>.</span><span style=color:#6639ba>AllowedMethods</span><span style=color:#1f2328>(),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>AllowedHeaders</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>connectcors</span><span style=color:#1f2328>.</span><span style=color:#6639ba>AllowedHeaders</span><span style=color:#1f2328>(),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>ExposedHeaders</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>connectcors</span><span style=color:#1f2328>.</span><span style=color:#6639ba>ExposedHeaders</span><span style=color:#1f2328>(),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>})</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>middleware</span><span style=color:#1f2328>.</span><span style=color:#6639ba>Handler</span><span style=color:#1f2328>(</span><span style=color:#1f2328>h</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-tags><a href=/tags/buf/>Buf</a>
<a href=/tags/proto/>Proto</a>
<a href=/tags/connectrpc/>Connectrpc</a></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=[".main-article",".widget--toc"];e.forEach(e=>{const t=document.querySelector(e);t&&renderMathInElement(t,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})})</script></article><footer class=site-footer><section class=copyright>&copy;
2025 crackhopper的技术博客</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.32.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.0fcb739c1f88ce461c9640077fd21d8ce903946f1aef209dd01192827d26a90c.js defer></script><script type=text/javascript src=/ts/custom.fb6397326fc458b8ae775aee18e0a0ae80628aec9c216e7e90c79bb0486cb0e3.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>
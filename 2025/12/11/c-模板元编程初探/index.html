<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="\r说起来我也是C++老鸟了，本科的时候就深入学习了C++，那个时候还没有C++11。微软的msvc编译器针对当前的C++0x上还有大量的不兼容（学习的时候试出来的）。自认为对C++的掌握算是精通的水平，不过，多年来一直没有对模板技术进行深入系统的学习。\n最近，确立了成为渲染大师的目标。我打算推进渲染器开发的过程中，再强化一下C++的学习。\n本文则是我学习模板元编程的初探。不过自认为掌握之后，足以应对常规的模板开发。\n注：本文不适合C++初级水平的开发人员阅读。\n"><title>C++模板元编程初探</title><link rel=canonical href=https://crackhopper.github.io/2025/12/11/c-%E6%A8%A1%E6%9D%BF%E5%85%83%E7%BC%96%E7%A8%8B%E5%88%9D%E6%8E%A2/><link rel=stylesheet href=/scss/style.min.4d36f8dc1fd48129e1635deb4b8eb2870fa09474f7280c4cb606d40b2526994b.css><meta property='og:title' content="C++模板元编程初探"><meta property='og:description' content="\r说起来我也是C++老鸟了，本科的时候就深入学习了C++，那个时候还没有C++11。微软的msvc编译器针对当前的C++0x上还有大量的不兼容（学习的时候试出来的）。自认为对C++的掌握算是精通的水平，不过，多年来一直没有对模板技术进行深入系统的学习。\n最近，确立了成为渲染大师的目标。我打算推进渲染器开发的过程中，再强化一下C++的学习。\n本文则是我学习模板元编程的初探。不过自认为掌握之后，足以应对常规的模板开发。\n注：本文不适合C++初级水平的开发人员阅读。\n"><meta property='og:url' content='https://crackhopper.github.io/2025/12/11/c-%E6%A8%A1%E6%9D%BF%E5%85%83%E7%BC%96%E7%A8%8B%E5%88%9D%E6%8E%A2/'><meta property='og:site_name' content='crackhopper的技术博客'><meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:published_time' content='2025-12-11T00:16:03+08:00'><meta property='article:modified_time' content='2025-12-11T00:16:03+08:00'><meta name=twitter:title content="C++模板元编程初探"><meta name=twitter:description content="\r说起来我也是C++老鸟了，本科的时候就深入学习了C++，那个时候还没有C++11。微软的msvc编译器针对当前的C++0x上还有大量的不兼容（学习的时候试出来的）。自认为对C++的掌握算是精通的水平，不过，多年来一直没有对模板技术进行深入系统的学习。\n最近，确立了成为渲染大师的目标。我打算推进渲染器开发的过程中，再强化一下C++的学习。\n本文则是我学习模板元编程的初探。不过自认为掌握之后，足以应对常规的模板开发。\n注：本文不适合C++初级水平的开发人员阅读。\n"><link rel=stylesheet href=/css/custom.css></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_337fe2b325ec916d.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>crackhopper的技术博客</a></h1><h2 class=site-description>C++, Graphics, Game, AI/ML</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>文章</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于我</span></a></li><li><a href=/projects/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>项目</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky" id=right-sidebar><section class="widget archives toc-widget"><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc id=toc-content><nav id=TableOfContents><ul><li><a href=#c模板基础>C++模板基础</a><ul><li><a href=#语法概述>语法概述</a></li><li><a href=#函数模板--类模板--别名模板>函数模板 / 类模板 / 别名模板</a></li><li><a href=#模板参数种类>模板参数种类</a></li><li><a href=#变长模板参数variadic-templates>变长模板参数（Variadic Templates）</a><ul><li><a href=#如何unpack>如何unpack？</a></li><li><a href=#如何提取函数的第一个参数类型>如何提取函数的第一个参数类型？</a></li><li><a href=#如何提取args中的某一个类型>如何提取args中的某一个类型？</a></li></ul></li><li><a href=#模板参数推导template-argument-deduction>模板参数推导（template argument deduction）</a><ul><li><a href=#推导时的关键原则>推导时的关键原则</a></li><li><a href=#引用推导case01>引用推导case01</a></li><li><a href=#引用推导case02>引用推导case02</a></li><li><a href=#常见调整>常见调整</a></li><li><a href=#成员指针推导>成员指针推导</a></li></ul></li><li><a href=#重载解析overload-resolution>重载解析（overload resolution）</a></li><li><a href=#sfinae>SFINAE</a><ul><li><a href=#元编程中如何使用sfinae>元编程中如何使用SFINAE</a></li></ul></li><li><a href=#名称查找与二阶段查找two-phase-lookup>名称查找与“二阶段查找”（two-phase lookup）</a></li><li><a href=#特化specialization>特化（specialization）</a></li></ul></li><li><a href=#模板编程范式>模板编程范式</a><ul><li><a href=#概述>概述</a></li><li><a href=#值类型value-types>值类型(Value Types)</a><ul><li><a href=#概念>概念</a></li><li><a href=#实现方式>实现方式</a></li><li><a href=#integral_constant-简化版><code>integral_constant</code> 简化版</a></li><li><a href=#示例用法-编译期求解表达式>示例用法-编译期求解表达式</a></li><li><a href=#更核心的用法-继承>更核心的用法-继承</a><ul><li><a href=#继承提供统一接口>继承提供统一接口</a></li><li><a href=#类型标签tag-dispatching>类型标签（Tag Dispatching）</a></li><li><a href=#组合模板逻辑>组合模板逻辑</a></li></ul></li></ul></li><li><a href=#特性模板traits>特性模板(Traits)</a><ul><li><a href=#概念-1>概念</a></li><li><a href=#实现方式-1>实现方式</a></li><li><a href=#使用示例>使用示例</a></li><li><a href=#使用traits的好处>使用Traits的好处</a></li><li><a href=#traits-全家桶示例模板库>Traits 全家桶示例模板库</a><ul><li><a href=#基础工具void_t>基础工具：<code>void_t</code></a></li><li><a href=#has_xxx检测是否有某个内置成员>has_xxx：检测是否有某个内置成员</a></li><li><a href=#fallback-适配-traits接口统一>fallback 适配 traits（接口统一）</a></li><li><a href=#类型判断-traits偏特化版>类型判断 traits（偏特化版）</a></li><li><a href=#类型计算-traits编译期元函数>类型计算 traits（编译期“元函数”）</a></li><li><a href=#组合型-traitstraits-的-traits>组合型 traits（traits 的 traits）</a></li><li><a href=#使用示例-1>使用示例</a></li></ul></li></ul></li><li><a href=#valuetypestraits小结>ValueTypes/Traits小结</a></li><li><a href=#类型求值函数type-computation--type-functions>类型求值函数（Type Computation / Type Functions）</a><ul><li><a href=#概念-2>概念</a></li><li><a href=#实现和使用>实现和使用</a></li></ul></li></ul></li><li><a href=#conceptc20>concept(C++20)</a><ul><li><a href=#基础介绍>基础介绍</a><ul><li><a href=#旧写法和新写法>旧写法和新写法</a></li><li><a href=#从-traits-过渡到-concept-的方法>从 traits 过渡到 concept 的方法</a></li></ul></li><li><a href=#基本语法>基本语法</a><ul><li><a href=#定义concept>定义concept</a></li><li><a href=#内联约束表达式>内联约束表达式</a></li><li><a href=#组合concept>组合concept</a></li><li><a href=#模板中使用-concept>模板中使用 concept</a></li></ul></li><li><a href=#concept--traits-协同设计>concept + traits 协同设计</a><ul><li><a href=#traits-提供类型信息--concept-做语义约束>traits 提供类型信息 + concept 做语义约束</a></li><li><a href=#组合-concept-替代复杂-traits-检测>组合 concept 替代复杂 traits 检测</a></li><li><a href=#过渡策略总结>过渡策略总结</a></li></ul></li></ul></li><li><a href=#高级技巧简介>高级技巧简介</a><ul><li><a href=#constexpr-与编译期计算>constexpr 与编译期计算</a><ul><li><a href=#概念-3>概念</a></li><li><a href=#用法简要举例>用法简要举例</a></li></ul></li><li><a href=#decltype技巧>decltype技巧</a><ul><li><a href=#概念-4>概念</a></li><li><a href=#用法简要举例-1>用法简要举例</a></li></ul></li><li><a href=#利用函数签名提取类型>利用函数签名提取类型</a></li><li><a href=#编译期列表>编译期列表</a><ul><li><a href=#integer-sequence整数序列>Integer Sequence（整数序列）</a></li><li><a href=#typelist类型列表>TypeList（类型列表）</a></li><li><a href=#valuelist值列表>ValueList（值列表）</a></li><li><a href=#总结>总结</a></li></ul></li></ul></li></ul></nav></div></section></aside><button class=toc-float-btn id=toc-float-btn aria-label=展开目录 title=展开目录>
<span class=toc-float-btn-icon></span></button><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/2025/12/11/c-%E6%A8%A1%E6%9D%BF%E5%85%83%E7%BC%96%E7%A8%8B%E5%88%9D%E6%8E%A2/>C++模板元编程初探</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2025-12-11T00:16:03+08:00>Dec 11, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>16 minute read</time></div></footer></div></header><section class=article-content><img src=/images/C%2B%2B%E6%A8%A1%E6%9D%BF%E5%85%83%E7%BC%96%E7%A8%8B%E5%88%9D%E6%8E%A2-1765422624800.png alt=C++模板元编程初探-1765422624800 width=697x392 loading=lazy><p>说起来我也是C++老鸟了，本科的时候就深入学习了C++，那个时候还没有C++11。微软的msvc编译器针对当前的C++0x上还有大量的不兼容（学习的时候试出来的）。自认为对C++的掌握算是精通的水平，不过，多年来一直没有对模板技术进行深入系统的学习。</p><p>最近，确立了成为渲染大师的目标。我打算推进渲染器开发的过程中，再强化一下C++的学习。</p><p>本文则是我学习模板元编程的初探。不过自认为掌握之后，足以应对常规的模板开发。</p><p><strong>注：本文不适合C++初级水平的开发人员阅读。</strong></p><h1 id=c模板基础>C++模板基础</h1><h2 id=语法概述>语法概述</h2><p>模板是 C++ 的泛型编程机制 —— 编译时生成类型与/或值的参数化代码。模板不是运行时的多态（如 virtual），而是在 <strong>编译期通过实例化（instantiation）产生具体实体（函数、类）</strong> 。</p><p>这个加黑的部分要重点理解：模板实际上是开发者和编译器沟通的手段（更精确的描述：模板是编译器可执行的代码生成规则（code generation patterns），类似一种约定描述，编译器遇到模板的时候，存储规则；遇到使用模板的时候，按照模板开发者定义好的规则来生成）</p><ul><li>从效果上看，模板让开发者像是在给编译器提供一套‘可执行的代码生成脚本’，有类似 <strong>插件</strong> 的感觉。但这仍是语言内建机制，而不是外部插件。</li><li>模板在效果上能够完成比 <strong>宏</strong> 更强的代码生成任务，因此从使用体验上像是‘更高级的泛型化代码生成工具’，但两者在技术原理上完全不同： <strong>宏做文本替换，模板操作 AST</strong> 。</li></ul><p>接下来主要简单举例子，列举常见模板语法。不深入讲。看不懂的，需要自己深入学习，或者说本文还不太适合你。</p><h2 id=函数模板--类模板--别名模板>函数模板 / 类模板 / 别名模板</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>// 函数模板
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span>T add<span style=color:#1f2328>(</span>T a<span style=color:#1f2328>,</span> T b<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span> <span style=color:#cf222e>return</span> a <span style=color:#0550ae>+</span> b<span style=color:#1f2328>;</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>int</span> x <span style=color:#0550ae>=</span> add<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>2</span><span style=color:#1f2328>);</span>   <span style=color:#57606a>// 显式指定模板实参
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>int</span> y <span style=color:#0550ae>=</span> add<span style=color:#1f2328>(</span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>2</span><span style=color:#1f2328>);</span>        <span style=color:#57606a>// 类型推导，编译器 deduce 为 int
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 类模板
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#1f2328>,</span> std<span style=color:#0550ae>::</span>size_t N<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Array</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    T data<span style=color:#1f2328>[</span>N<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>    T<span style=color:#0550ae>&amp;</span> <span style=color:#cf222e>operator</span><span style=color:#1f2328>[](</span>std<span style=color:#0550ae>::</span>size_t i<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span> <span style=color:#cf222e>return</span> data<span style=color:#1f2328>[</span>i<span style=color:#1f2328>];</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Array<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>10</span><span style=color:#0550ae>&gt;</span> a<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 别名模板
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>using</span> Vec <span style=color:#0550ae>=</span> std<span style=color:#0550ae>::</span>vector<span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>&gt;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Vec<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#0550ae>&gt;</span> v<span style=color:#1f2328>;</span> <span style=color:#57606a>// 等价于 std::vector&lt;int&gt;
</span></span></span></code></pre></td></tr></table></div></div><h2 id=模板参数种类>模板参数种类</h2><p><strong>类型模板参数（type template parameter）</strong>：<code>typename</code> 或 <code>class</code>（等价）。最常见的模板类型。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#1f2328>,</span> std<span style=color:#0550ae>::</span>size_t N<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Array</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    T data<span style=color:#1f2328>[</span>N<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>    T<span style=color:#0550ae>&amp;</span> <span style=color:#cf222e>operator</span><span style=color:#1f2328>[](</span>std<span style=color:#0550ae>::</span>size_t i<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span> <span style=color:#cf222e>return</span> data<span style=color:#1f2328>[</span>i<span style=color:#1f2328>];</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>非类型模板参数（non-type template parameter）</strong>：整型、指针、引用等常量值（必须在编译期可确定）。 <strong>很重要，实现traits的关键</strong></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span> N<span style=color:#0550ae>&gt;</span> <span style=color:#cf222e>struct</span> <span style=color:#1f2328>X</span> <span style=color:#1f2328>{</span> <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>X<span style=color:#0550ae>&lt;</span><span style=color:#0550ae>5</span><span style=color:#0550ae>&gt;</span> x<span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>模板模板参数（template template）</strong>：参数类型是一个模板。在元编程中大量使用，只是阅读起来会麻烦点，理解上并不困难（递归的概念）。(C++11要求严格匹配，C++17要求兼容匹配)</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>typename</span><span style=color:#0550ae>&gt;</span> <span style=color:#cf222e>class</span> <span style=color:#1f2328>Container</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Wrapper</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    Container<span style=color:#0550ae>&lt;</span>T<span style=color:#1f2328>,</span> std<span style=color:#0550ae>::</span>allocator<span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>&gt;&gt;</span> c<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 使用：以 std::vector 作为模板参数
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>Wrapper<span style=color:#0550ae>&lt;</span>std<span style=color:#0550ae>::</span>vector<span style=color:#1f2328>,</span> <span style=color:#cf222e>int</span><span style=color:#0550ae>&gt;</span> w<span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=变长模板参数variadic-templates>变长模板参数（Variadic Templates）</h2><p>这个话题稍微复杂一点。C++11 引入了 <strong>模板参数包（parameter pack）</strong>，可以表示<strong>任意数量的模板参数</strong>：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>// 类型 parameter pack
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span><span style=color:#1f2328>...</span> Ts<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Tuple</span> <span style=color:#1f2328>{</span> <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>Tuple<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>double</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>char</span><span style=color:#0550ae>&gt;</span> t<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 非类型 parameter pack
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>...</span> Ns<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>ArrayHolder</span> <span style=color:#1f2328>{</span> <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>ArrayHolder<span style=color:#0550ae>&lt;</span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span><span style=color:#0550ae>2</span><span style=color:#1f2328>,</span><span style=color:#0550ae>3</span><span style=color:#0550ae>&gt;</span> a<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 函数模板参数包（匹配任意函数参数列表）
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span><span style=color:#1f2328>...</span> Args<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> func<span style=color:#1f2328>(</span>Args<span style=color:#0550ae>&amp;&amp;</span><span style=color:#1f2328>...</span> args<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 可以转发参数，逐一处理
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>main</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    func<span style=color:#1f2328>(</span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>2.0</span><span style=color:#1f2328>,</span> <span style=color:#0a3069>&#34;hello&#34;</span><span style=color:#1f2328>);</span>   <span style=color:#57606a>// 任意数量和类型的参数
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>基本概念比较容易。我们看一些细节用法</p><h3 id=如何unpack>如何unpack？</h3><p><strong>1.递归展开（经典元编程）</strong></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#1f2328>,</span> <span style=color:#cf222e>typename</span><span style=color:#1f2328>...</span> Ts<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> printTypes<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    std<span style=color:#0550ae>::</span>cout <span style=color:#0550ae>&lt;&lt;</span> <span style=color:#cf222e>typeid</span><span style=color:#1f2328>(</span>T<span style=color:#1f2328>).</span>name<span style=color:#1f2328>()</span> <span style=color:#0550ae>&lt;&lt;</span> <span style=color:#0a3069>&#34;</span><span style=color:#0a3069>\n</span><span style=color:#0a3069>&#34;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>if</span> <span style=color:#6639ba>constexpr</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>sizeof</span><span style=color:#1f2328>...(</span>Ts<span style=color:#1f2328>)</span> <span style=color:#0550ae>&gt;</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        printTypes<span style=color:#0550ae>&lt;</span>Ts<span style=color:#1f2328>...</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>();</span> <span style=color:#57606a>// 递归展开剩余类型
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>2.直接展开到表达式</strong></p><ul><li><code>(expr, 0)...</code> 是 <strong>pack expansion</strong> 。把 <code>Ts...</code> 中的每个类型套用到表达式中</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span><span style=color:#1f2328>...</span> Ts<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> printSizes<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>int</span> arr<span style=color:#1f2328>[]</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span> <span style=color:#1f2328>(</span>std<span style=color:#0550ae>::</span>cout <span style=color:#0550ae>&lt;&lt;</span> <span style=color:#cf222e>sizeof</span><span style=color:#1f2328>(</span>Ts<span style=color:#1f2328>)</span> <span style=color:#0550ae>&lt;&lt;</span> <span style=color:#0a3069>&#34;</span><span style=color:#0a3069>\n</span><span style=color:#0a3069>&#34;</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)...</span> <span style=color:#1f2328>};</span> <span style=color:#57606a>// pack expansion
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#1f2328>(</span><span style=color:#cf222e>void</span><span style=color:#1f2328>)</span>arr<span style=color:#1f2328>;</span> <span style=color:#57606a>// 防止未使用警告
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>3.C++17 fold expression</strong></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span><span style=color:#1f2328>...</span> Ts<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> printSizes<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>((</span>std<span style=color:#0550ae>::</span>cout <span style=color:#0550ae>&lt;&lt;</span> <span style=color:#cf222e>sizeof</span><span style=color:#1f2328>(</span>Ts<span style=color:#1f2328>)</span> <span style=color:#0550ae>&lt;&lt;</span> <span style=color:#0a3069>&#34;</span><span style=color:#0a3069>\n</span><span style=color:#0a3069>&#34;</span><span style=color:#1f2328>),</span> <span style=color:#1f2328>...);</span> <span style=color:#57606a>// fold expression
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span><span style=color:#1f2328>...</span> Args<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> func<span style=color:#1f2328>(</span>Args<span style=color:#0550ae>&amp;&amp;</span><span style=color:#1f2328>...</span> args<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>(</span>std<span style=color:#0550ae>::</span>cout <span style=color:#0550ae>&lt;&lt;</span> <span style=color:#1f2328>...</span> <span style=color:#0550ae>&lt;&lt;</span> args<span style=color:#1f2328>)</span> <span style=color:#0550ae>&lt;&lt;</span> <span style=color:#0a3069>&#34;</span><span style=color:#0a3069>\n</span><span style=color:#0a3069>&#34;</span><span style=color:#1f2328>;</span> <span style=color:#57606a>// C++17 fold
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>形式上：</p><ul><li><code>(... op pack)</code> // 左折叠，无初值</li><li><code>(init op ... op pack)</code> // 左折叠，有初值</li><li><code>(pack op ...)</code> // 右折叠，无初值</li><li><code>(pack op ... op init)</code> // 右折叠，有初值</li><li>理解上，把整个形式打括号，随后根据pack的位置，延申一个pack出来。<ul><li><code>(... op pack)</code> -> <code>((... op pack) op pack)</code></li><li>有init的情况： <code>(init op ... op pack)</code> -> <code>((init op ... op pack) op pack)</code></li><li>全部展开完了，从左到右，填入 pack中的各个元素。</li><li>注意，这里pack代表有 args 的expression</li></ul></li></ul><h3 id=如何提取函数的第一个参数类型>如何提取函数的第一个参数类型？</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>// primary template（默认）
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> Func<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>FirstArg</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 偏特化，匹配普通函数类型
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> R<span style=color:#1f2328>,</span> <span style=color:#cf222e>typename</span> T1<span style=color:#1f2328>,</span> <span style=color:#cf222e>typename</span><span style=color:#1f2328>...</span> Ts<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>FirstArg</span><span style=color:#0550ae>&lt;</span>R<span style=color:#1f2328>(</span>T1<span style=color:#1f2328>,</span> Ts<span style=color:#1f2328>...)</span><span style=color:#0550ae>&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>using</span> type <span style=color:#0550ae>=</span> T1<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><p>有针对这个能力的 meta function</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>#include</span> <span style=color:#57606a>&lt;tuple&gt;</span><span style=color:#57606a>
</span></span></span><span style=display:flex><span><span style=color:#57606a>#include</span> <span style=color:#57606a>&lt;type_traits&gt;</span><span style=color:#57606a>
</span></span></span><span style=display:flex><span><span style=color:#57606a>#include</span> <span style=color:#57606a>&lt;iostream&gt;</span><span style=color:#57606a>
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span><span style=color:#1f2328>...</span> Args<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>FunctionTraits</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>using</span> FirstArg <span style=color:#0550ae>=</span> std<span style=color:#0550ae>::</span>tuple_element_t<span style=color:#0550ae>&lt;</span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> std<span style=color:#0550ae>::</span>tuple<span style=color:#0550ae>&lt;</span>Args<span style=color:#1f2328>...</span><span style=color:#0550ae>&gt;&gt;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=如何提取args中的某一个类型>如何提取args中的某一个类型？</h3><p>即上一节中的meta function的原理是什么。</p><p>答案是：利用偏特化 （在模板内调用另一个模板，触发偏特化）</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>// 用于提取参数包第一个类型
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#1f2328>,</span> <span style=color:#cf222e>typename</span><span style=color:#1f2328>...</span> Ts<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>FirstType</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>using</span> type <span style=color:#0550ae>=</span> T<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span><span style=color:#1f2328>...</span> Args<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> func<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>using</span> First <span style=color:#0550ae>=</span> <span style=color:#cf222e>typename</span> FirstType<span style=color:#0550ae>&lt;</span>Args<span style=color:#1f2328>...</span><span style=color:#0550ae>&gt;::</span>type<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    std<span style=color:#0550ae>::</span>cout <span style=color:#0550ae>&lt;&lt;</span> <span style=color:#cf222e>typeid</span><span style=color:#1f2328>(</span>First<span style=color:#1f2328>).</span>name<span style=color:#1f2328>()</span> <span style=color:#0550ae>&lt;&lt;</span> <span style=color:#0a3069>&#34;</span><span style=color:#0a3069>\n</span><span style=color:#0a3069>&#34;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=模板参数推导template-argument-deduction>模板参数推导（template argument deduction）</h2><p>模板参数推导在标准里的基本描述是：将 <strong>参数声明的类型模式</strong>（记为 <strong>P</strong>）与 <strong>实际实参的类型</strong>（记为 <strong>A</strong>）比较，从而推导出模板参数 <code>T</code> 等。</p><h3 id=推导时的关键原则>推导时的关键原则</h3><ul><li><strong>模板推导不进行用户定义转换</strong>（user-defined conversions）。推导只“匹配”类型结构（identity、引用调整、数组/函数退化等），不是一般的 overload-conversion 过程。</li><li>某些 <em>调整</em> 是允许且自动发生的（例如数组 → 指针、函数 → 指针、顶层 <code>const</code> 忽略）。</li><li>如果 P 是引用类型（<code>T&</code>、<code>T&&</code>），推导的规则与是否为左值/右值有关（这会产生引用折叠/通用引用行为）。</li></ul><h3 id=引用推导case01>引用推导case01</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> f<span style=color:#1f2328>(</span>T<span style=color:#0550ae>&amp;</span><span style=color:#1f2328>);</span>   <span style=color:#57606a>// lvalue 引用
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span><span style=color:#cf222e>int</span> a <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>f<span style=color:#1f2328>(</span>a<span style=color:#1f2328>);</span> <span style=color:#57606a>// T 推导为 int
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>f<span style=color:#1f2328>(</span><span style=color:#0550ae>5</span><span style=color:#1f2328>);</span> <span style=color:#57606a>// 错误：不能将临时赋给 int&amp;
</span></span></span></code></pre></td></tr></table></div></div><ul><li>对于 <code>f(a)</code>：P = <code>T&</code>，A = <code>int</code>（<code>a</code> 的实际类型是 <code>int</code>，且是 lvalue），推导出 <code>T = int</code>，参数类型变为 <code>int&</code>，匹配成功。</li><li>对于 <code>f(5)</code>：A 的类型为 <code>int</code>，但是 prvalue（临时）。<code>T&</code> 不能绑定到非 <code>const</code> prvalue，因此没有可行推导 — 推导失败（并非“以转换方式”接受）。<ul><li>lvalue : 左值，有名字、可寻址的对象或引用。 <code>int a; a</code></li><li>xvalue ：expiring value，可移动的对象，可寻址。 <code>std::move(a)</code><ul><li>可以简单记为 <strong>可以转化为左值的右值</strong> 。类别仍然是右值。但被引用接收后，可以当作左值来操作：</li><li><code>std::string&& r1 = std::move(a);</code> 随后使用r1可以访问这个对象进行修改。（注意，r1是左值，只有 <code>std::move</code> 返回的是右值xvalue，因此要触发移动语义，需要手动move）</li></ul></li><li>prvalue: pure rvalue，临时值，不可寻址。 <code>1+2</code> , <code>std::string("hi")</code><ul><li>即使绑定了 T&& 之类的，也无法修改内部的数据。</li></ul></li><li>注： xvalue, prvalue 在绑定参数的类别上一样，仅可以绑定 <code>const T&</code> 和 <code>T&&</code></li></ul></li></ul><h3 id=引用推导case02>引用推导case02</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> g<span style=color:#1f2328>(</span>T<span style=color:#0550ae>&amp;&amp;</span><span style=color:#1f2328>);</span>  <span style=color:#57606a>// 通用引用（在模板参数推导上下文中）
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>g<span style=color:#1f2328>(</span>a<span style=color:#1f2328>);</span> <span style=color:#57606a>// T -&gt; int&amp;, g 参数类型 becomes int&amp; &amp;&amp;
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>g<span style=color:#1f2328>(</span><span style=color:#0550ae>5</span><span style=color:#1f2328>);</span> <span style=color:#57606a>// T -&gt; int, g 参数类型 becomes int&amp;&amp;
</span></span></span></code></pre></td></tr></table></div></div><ul><li><code>T&&</code> 在模板参数中且 <code>T</code> 是待推导的模板参数时，被称为 <strong>通用引用</strong>（forwarding/reference-collapsing 情况）。（即推导的时候，得到的参数类型一定为引用）</li><li>若实参是 <strong>左值</strong>（如 <code>a</code>），规则会将 <code>T</code> 推导为 <code>int&</code>，于是 <code>T&&</code> 展开为 <code>int& &&</code>，根据引用折叠规则变为 <code>int&</code>（函数参数成为 <code>int&</code>）。</li><li>若实参是 <strong>右值/prvalue</strong>（如 <code>5</code>），<code>T</code> 推导为 <code>int</code>，参数类型为 <code>int&&</code>。</li></ul><p>这里有引用折叠规则：</p><ul><li><code>& &</code> 折叠为 <code>&</code></li><li><code>& &&</code> 折叠为 <code>&</code></li><li><code>&& &</code> 折叠为 <code>&</code></li><li><code>&& &&</code> 折叠为 <code>&&</code></li></ul><h3 id=常见调整>常见调整</h3><ul><li><strong>顶层 cv（const/volatile）忽略</strong>：<code>T</code> 不会保留顶层 <code>const</code>。<ul><li>例：<code>template&lt;typename T> void h(T); const int ci = 0; h(ci);</code> → <code>T</code> 推导为 <code>int</code>（不是 <code>const int</code>）。</li></ul></li><li><strong>数组/函数 退化</strong>：当参数是按值或按指针接收时，数组会退化为指针、函数会退化为函数指针（但若 P 是 <code>T (&)[N]</code> 则不会退化）。<ul><li>例：<code>template&lt;class T> void p(T*); int a[10]; p(a);</code> → <code>T</code> 为 <code>int</code>（数组退化为 <code>int*</code>）。</li></ul></li><li><strong>引用参数时</strong>：如果 P 是引用，会根据 A 的值类别调整（参见前面的两个case）。</li><li><strong>指针/引用到成员等有较复杂规则</strong>：（参见后面展开讲解）</li></ul><p>推导<strong>不</strong>允许（因此会导致 SFINAE 或失败）的情形：</p><ul><li>通过用户定义的转换来匹配模板参数（例：class -> int via operator int() 不用于推导）。</li><li>需要多步隐式转换（除非在重载解析阶段通过 conversion sequence 被考虑，但推导本身不做）。</li></ul><h3 id=成员指针推导>成员指针推导</h3><p>先看基础概念</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>// 指向 数据成员的指针
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>S</span> <span style=color:#1f2328>{</span> <span style=color:#cf222e>int</span> a<span style=color:#1f2328>;</span> <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>int</span> S<span style=color:#0550ae>::*</span> p <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>S<span style=color:#0550ae>::</span>a<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 指向 成员函数的指针
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>S</span> <span style=color:#1f2328>{</span> <span style=color:#cf222e>void</span> <span style=color:#6639ba>f</span><span style=color:#1f2328>(</span><span style=color:#cf222e>int</span><span style=color:#1f2328>);</span> <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#1f2328>(</span>S<span style=color:#0550ae>::*</span>mf<span style=color:#1f2328>)(</span><span style=color:#cf222e>int</span><span style=color:#1f2328>)</span> <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>S<span style=color:#0550ae>::</span>f<span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><p>举例子对应的模板</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#1f2328>,</span> <span style=color:#cf222e>typename</span> C<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> f<span style=color:#1f2328>(</span>T C<span style=color:#0550ae>::*</span> mem<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>S</span> <span style=color:#1f2328>{</span> <span style=color:#cf222e>int</span> x<span style=color:#1f2328>;</span> <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>f<span style=color:#1f2328>(</span><span style=color:#0550ae>&amp;</span>S<span style=color:#0550ae>::</span>x<span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>注意：模板函数定义的时候，需要两个类型。<ul><li>一个是成员的类型 T。（实例化时匹配 int）</li><li>一个是成员指针的所属类的类型 C（实例化时匹配 S）。</li></ul></li></ul><p>更多不展开。原理上差不多。需要注意的：</p><ul><li>cv匹配修饰，不能忽略。</li><li>遇到成员重载的时候，不能有二义性。</li></ul><h2 id=重载解析overload-resolution>重载解析（overload resolution）</h2><ol><li><strong>构造候选集合（candidate functions）</strong>：包括可见的普通函数与函数模板实例（模板以原型形式加入候选集）。</li><li><strong>对每个函数模板做模板参数推导</strong>（deduction）：<ul><li>如果推导失败或导致替换错误（并且是在 SFINAE 环境），该函数模板被视为不可行（removed）。</li><li>对推导成功的模板，会得到一个“可行候选”（viable candidate）及对应的实参转换序列。</li></ul></li><li><strong>对所有可行候选评估转换序列（conversion sequences）</strong>：<ul><li>计算从每个函数实参到形参所需的标准转换序列（exact match、promotion、conversion 等）；注意：在此阶段用户定义转换可被计入转换序列（区别于推导阶段）。</li></ul></li><li><strong>比较各候选的转换序列来选出“最优”</strong>（best viable function）：<ul><li>一般规则：<strong>更精确的匹配（更短、更少的转换）优先</strong>。</li><li>在转换序列相同的情况下，有一些 tie-break 规则：<ul><li><strong>非模板函数优于函数模板</strong>（如果两者转换序列同等，非模板被选择）。</li><li><strong>对于两个函数模板，采用模板部分排序（partial ordering）来选择更特化的模板</strong>（更特化者优先）。</li><li>其它规则如模板实参显式指定、模板特化程度也会影响。</li></ul></li></ul></li></ol><h2 id=sfinae>SFINAE</h2><p>这个词出现了很多次。现在详细解释。</p><p><strong>SFINAE</strong> 全称：<strong>Substitution Failure Is Not An Error</strong> 。翻译：<strong>替换失败不是错误</strong></p><p><strong>核心思想</strong>：</p><ul><li>当编译器在模板实例化（instantiation）过程中，尝试把模板参数替换到模板定义时，如果<strong>类型不匹配或语法不成立</strong>，<strong>不会报错</strong></li><li>相反，编译器会 <strong>忽略这个模板实例</strong>，继续尝试其他可行的模板重载或特化</li><li>如果所有模板都替换失败，才算真正的编译错误</li></ul><p>SFINAE 是模板推导/替换阶段的核心规则：当用某个模板参数替换模板参数导致模板的类型匹配或形成无效类型时，不视为编译错误，而是将该模板从候选集中移除，从而允许其他重载生效。SFINAE 常用于启发式重载选择（enable_if、检测 idiom）实现不同实现路径。</p><h3 id=元编程中如何使用sfinae>元编程中如何使用SFINAE</h3><ul><li>如果模板推导失败，那么对应的模板代码不会生成。这让我们有了可以 “检查” 的机会。把SFINAE作为一个检查接口和编译器通信。<ul><li>定义一个模板，增加一个默认参数，里面定义一套复杂的模板推导规则。</li><li>实例化的时候，模板推导规则被执行，<ul><li>最后规则通过，那么检查通过；</li><li>规则不通过，没有可行的模板以及重载，那么会报错。</li></ul></li></ul></li></ul><h2 id=名称查找与二阶段查找two-phase-lookup>名称查找与“二阶段查找”（two-phase lookup）</h2><p>模板编译涉及两阶段语义检查：</p><ol><li><p><strong>模板定义阶段（phase 1）</strong>：编译器解析非依赖名 —— 在模板定义处就必须能解析的名字（非依赖表达式）。</p><ol><li><code>typename</code> 告诉编译器某个依赖名是类型 （尤其是从模板类型中访问成员，成员是类型的时候）</li><li><code>template</code> 告诉编译器后面的 <code>&lt;...></code> 是对模板的引用（同上，模板类型的成员，还是模板的时候）</li></ol></li><li><p><strong>模板实例化阶段（phase 2）</strong>：编译器在具体实例化模板、并给定模板实参后，解析依赖名（dependent names）。</p></li></ol><h2 id=特化specialization>特化（specialization）</h2><ul><li><strong>完全特化（full specialization）</strong>：针对特定模板实参写专门实现（类或函数）。函数模板的完全特化语法较少用，类模板常用。</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span> <span style=color:#cf222e>struct</span> <span style=color:#1f2328>Traits</span> <span style=color:#1f2328>{</span> <span style=color:#cf222e>static</span> <span style=color:#cf222e>const</span> <span style=color:#cf222e>bool</span> is_special <span style=color:#0550ae>=</span> <span style=color:#6639ba>false</span><span style=color:#1f2328>;</span> <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;&gt;</span> <span style=color:#cf222e>struct</span> <span style=color:#1f2328>Traits</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#0550ae>&gt;</span> <span style=color:#1f2328>{</span> <span style=color:#cf222e>static</span> <span style=color:#cf222e>const</span> <span style=color:#cf222e>bool</span> is_special <span style=color:#0550ae>=</span> <span style=color:#6639ba>true</span><span style=color:#1f2328>;</span> <span style=color:#1f2328>};</span> <span style=color:#57606a>// 完全特化
</span></span></span></code></pre></td></tr></table></div></div><ul><li><strong>偏特化（partial specialization）</strong>：仅类模板支持偏特化（函数模板不支持偏特化；可用重载代替）。</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span> <span style=color:#cf222e>struct</span> <span style=color:#1f2328>Wrapper</span><span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>*&gt;</span> <span style=color:#1f2328>{</span> <span style=color:#57606a>/* 指针版本 */</span> <span style=color:#1f2328>};</span> <span style=color:#57606a>// 偏特化
</span></span></span></code></pre></td></tr></table></div></div><h1 id=模板编程范式>模板编程范式</h1><h2 id=概述>概述</h2><p>看一个简单的例子：定义一个模板函数，仅接收整数作为参数：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>typename</span> <span style=color:#0550ae>=</span> std<span style=color:#0550ae>::</span>enable_if_t<span style=color:#0550ae>&lt;</span>std<span style=color:#0550ae>::</span>is_integral_v<span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> f<span style=color:#1f2328>(</span>T<span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>typename=...</code> 默认模板参数实参。<ul><li>这个参数名都没有。说第二个参数仅仅用来做 SFINAE，只是指挥编译器做事情。</li></ul></li></ul><p>上面的模板函数中，第二个模板参数有默认值，因此会在实例化的时候，触发模板参数推导，里面用到了两个meta function。从命名上很容易理解，一个是检查是不是整数，另一个是enable是否开启。</p><p>具体怎么定义的呢？</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>bool</span> B<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>integral_constant</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>static</span> <span style=color:#cf222e>constexpr</span> <span style=color:#cf222e>bool</span> value <span style=color:#0550ae>=</span> B<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>using</span> value_type <span style=color:#0550ae>=</span> <span style=color:#cf222e>bool</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>using</span> type <span style=color:#0550ae>=</span> integral_constant<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 到 bool 类型的隐式转换；
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#57606a>// 代码中可以构造临时变量，强制转化true和false形成分支。编译器会同时生成两个分支代码
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#57606a>// 这个是C++17之前的解决手段。目前被 if constexpr 条件编译代替了
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#cf222e>constexpr</span> <span style=color:#cf222e>operator</span> <span style=color:#6639ba>value_type</span><span style=color:#1f2328>()</span> <span style=color:#cf222e>const</span> <span style=color:#cf222e>noexcept</span> <span style=color:#1f2328>{</span> <span style=color:#cf222e>return</span> value<span style=color:#1f2328>;</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>using</span> true_type  <span style=color:#0550ae>=</span> integral_constant<span style=color:#0550ae>&lt;</span><span style=color:#6639ba>true</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>using</span> false_type <span style=color:#0550ae>=</span> integral_constant<span style=color:#0550ae>&lt;</span><span style=color:#6639ba>false</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// minimal enable_if
</span></span></span><span style=display:flex><span><span style=color:#57606a>// T的类型不重要。重要的是 enable_if 是否导出了type成员。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>bool</span> B<span style=color:#1f2328>,</span> <span style=color:#cf222e>typename</span> T <span style=color:#0550ae>=</span> <span style=color:#cf222e>void</span><span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>enable_if</span> <span style=color:#1f2328>{</span> <span style=color:#1f2328>};</span>                <span style=color:#57606a>// 当 B == false：没有成员 typedef -&gt; 替换失败
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>enable_if</span><span style=color:#0550ae>&lt;</span><span style=color:#6639ba>true</span><span style=color:#1f2328>,</span> T<span style=color:#0550ae>&gt;</span> <span style=color:#1f2328>{</span> <span style=color:#cf222e>using</span> type <span style=color:#0550ae>=</span> T<span style=color:#1f2328>;</span> <span style=color:#1f2328>};</span> <span style=color:#57606a>// B == true 时提供 type
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span><span style=color:#57606a>// C++14 alias template
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>bool</span> B<span style=color:#1f2328>,</span> <span style=color:#cf222e>typename</span> T <span style=color:#0550ae>=</span> <span style=color:#cf222e>void</span><span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>using</span> enable_if_t <span style=color:#0550ae>=</span> <span style=color:#cf222e>typename</span> enable_if<span style=color:#0550ae>&lt;</span>B<span style=color:#1f2328>,</span> T<span style=color:#0550ae>&gt;::</span>type<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// minimal is_integral: 默认 false，但为整型特化为 true
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>is_integral</span> <span style=color:#0550ae>:</span> false_type <span style=color:#1f2328>{</span> <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;&gt;</span> <span style=color:#cf222e>struct</span> <span style=color:#1f2328>is_integral</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#0550ae>&gt;</span> <span style=color:#0550ae>:</span> true_type <span style=color:#1f2328>{</span> <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;&gt;</span> <span style=color:#cf222e>struct</span> <span style=color:#1f2328>is_integral</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>short</span><span style=color:#0550ae>&gt;</span> <span style=color:#0550ae>:</span> true_type <span style=color:#1f2328>{</span> <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;&gt;</span> <span style=color:#cf222e>struct</span> <span style=color:#1f2328>is_integral</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>long</span><span style=color:#0550ae>&gt;</span> <span style=color:#0550ae>:</span> true_type <span style=color:#1f2328>{</span> <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;&gt;</span> <span style=color:#cf222e>struct</span> <span style=color:#1f2328>is_integral</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>unsigned</span> <span style=color:#cf222e>int</span><span style=color:#0550ae>&gt;</span> <span style=color:#0550ae>:</span> true_type <span style=color:#1f2328>{</span> <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span><span style=color:#57606a>// ... 以及其他整型 specializations (char, bool, unsigned long long, 等)
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span><span style=color:#57606a>// C++17 variable template
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>inline</span> <span style=color:#cf222e>constexpr</span> <span style=color:#cf222e>bool</span> is_integral_v <span style=color:#0550ae>=</span> is_integral<span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>&gt;::</span>value<span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><p>我们接下来详细讲解上面的实现。这里先给出简要总结：</p><ul><li><p><strong>值模板</strong> ：</p><ul><li><code>integral_constant&lt;B></code> 是<strong>值模板</strong>，它把布尔值（或整数值）包装成一个类型。</li><li>实例化后类型里有静态成员 <code>value</code></li><li>这些类型可以作为 <strong>标签类型（tag）</strong>，用于模板特化或继承。</li></ul></li><li><p><strong>特性模板</strong> （traits）：</p><ul><li>**核心中的核心：提供了一个 类型对应的值(tag) **</li><li><strong>特性模板继承自值模版</strong> ： <code>is_integral&lt;T></code> 继承自 <code>true_type</code> 或 <code>false_type</code></li><li>这种继承关系在 <strong>类型层面</strong>表示“满足特性或不满足特性” （因此本身也是一个tag类型）</li><li><code>value</code> 成员提供 <strong>编译期常量值</strong></li></ul></li><li><p><strong>类型求值函数（enable_if）</strong> ：</p><ul><li>根据tag内包含的具体值做偏特化</li><li>输出：<ul><li>提供 type： 利用 <code>using</code> 或 <code>typedef</code> ，</li><li>不提供 type</li></ul></li></ul></li><li><p><strong>使用位置/SFINAE</strong> ：</p><ul><li>追加额外的模板参数，</li><li>提供上面的meta函数，利用返回的类型作为默认模板参数，从而触发 SFINAE 。</li></ul></li></ul><h2 id=值类型value-types>值类型(Value Types)</h2><h3 id=概念>概念</h3><p>在模板元编程中，<strong>值类型</strong>指的是将“值”作为类型的一部分进行编码。C++ 允许我们通过 <code>std::integral_constant</code> 或自定义类型将整数、布尔值等常量封装为类型，这样编译器在编译期就可以进行运算和推导。</p><h3 id=实现方式>实现方式</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span> N<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>IntValue</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>static</span> <span style=color:#cf222e>constexpr</span> <span style=color:#cf222e>int</span> value <span style=color:#0550ae>=</span> N<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>value</code> 是静态成员，在编译期就可以访问。(<strong>编译器可以访问，意味着可以作为模板参数</strong>)</li><li>可以用来在模板参数中传递整数或布尔值。</li></ul><p>C++ 标准库提供了 <code>std::integral_constant</code>，是这种模式的标准实现：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>#include</span> <span style=color:#57606a>&lt;type_traits&gt;</span><span style=color:#57606a>
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span><span style=color:#cf222e>using</span> TrueType <span style=color:#0550ae>=</span> std<span style=color:#0550ae>::</span>true_type<span style=color:#1f2328>;</span>   <span style=color:#57606a>// 相当于 std::integral_constant&lt;bool, true&gt;
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>using</span> FalseType <span style=color:#0550ae>=</span> std<span style=color:#0550ae>::</span>false_type<span style=color:#1f2328>;</span> <span style=color:#57606a>// 相当于 std::integral_constant&lt;bool, false&gt;
</span></span></span></code></pre></td></tr></table></div></div><h3 id=integral_constant-简化版><code>integral_constant</code> 简化版</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>// 简化版 integral_constant
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#1f2328>,</span> T v<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>integral_constant</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 编译期常量值
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#cf222e>static</span> <span style=color:#cf222e>constexpr</span> T value <span style=color:#0550ae>=</span> v<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 类型别名，方便 TMP 使用
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#cf222e>using</span> value_type <span style=color:#0550ae>=</span> T<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>using</span> type <span style=color:#0550ae>=</span> integral_constant<span style=color:#0550ae>&lt;</span>T<span style=color:#1f2328>,</span> v<span style=color:#0550ae>&gt;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 编译期隐式转换到 T
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#cf222e>constexpr</span> <span style=color:#cf222e>operator</span> <span style=color:#6639ba>T</span><span style=color:#1f2328>()</span> <span style=color:#cf222e>const</span> <span style=color:#cf222e>noexcept</span> <span style=color:#1f2328>{</span> <span style=color:#cf222e>return</span> value<span style=color:#1f2328>;</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 调用运算符，返回 value
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#cf222e>constexpr</span> T <span style=color:#6639ba>operator</span><span style=color:#1f2328>()()</span> <span style=color:#cf222e>const</span> <span style=color:#cf222e>noexcept</span> <span style=color:#1f2328>{</span> <span style=color:#cf222e>return</span> value<span style=color:#1f2328>;</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 类型别名，方便使用布尔值
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>using</span> true_type <span style=color:#0550ae>=</span> integral_constant<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>bool</span><span style=color:#1f2328>,</span> <span style=color:#6639ba>true</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>using</span> false_type <span style=color:#0550ae>=</span> integral_constant<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>bool</span><span style=color:#1f2328>,</span> <span style=color:#6639ba>false</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=示例用法-编译期求解表达式>示例用法-编译期求解表达式</h3><p>把非类型模板参数，理解为函数参数。把类型内定义的成员 <code>value</code> （也可以是其他成员），理解为函数输出。可以利用递归的方式，完成复杂的编译期计算</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>#include</span> <span style=color:#57606a>&lt;iostream&gt;</span><span style=color:#57606a>
</span></span></span><span style=display:flex><span><span style=color:#57606a>#include</span> <span style=color:#57606a>&lt;type_traits&gt;</span><span style=color:#57606a>
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span> N<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Factorial</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>static</span> <span style=color:#cf222e>constexpr</span> <span style=color:#cf222e>int</span> value <span style=color:#0550ae>=</span> N <span style=color:#0550ae>*</span> Factorial<span style=color:#0550ae>&lt;</span>N<span style=color:#0550ae>-</span><span style=color:#0550ae>1</span><span style=color:#0550ae>&gt;::</span>value<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Factorial</span><span style=color:#0550ae>&lt;</span><span style=color:#0550ae>0</span><span style=color:#0550ae>&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>static</span> <span style=color:#cf222e>constexpr</span> <span style=color:#cf222e>int</span> value <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>main</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    std<span style=color:#0550ae>::</span>cout <span style=color:#0550ae>&lt;&lt;</span> <span style=color:#0a3069>&#34;Factorial&lt;5&gt;::value = &#34;</span> <span style=color:#0550ae>&lt;&lt;</span> Factorial<span style=color:#0550ae>&lt;</span><span style=color:#0550ae>5</span><span style=color:#0550ae>&gt;::</span>value <span style=color:#0550ae>&lt;&lt;</span> std<span style=color:#0550ae>::</span>endl<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 输出 120
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=更核心的用法-继承>更核心的用法-继承</h3><p>在 TMP 的设计哲学中，<strong>值类型更多是作为类型的一部分被继承或组合，起到“类型标签”和编译期信息载体的作用”</strong>。</p><p>它既包含<strong>值</strong> (<code>value</code>) 又是<strong>类型</strong> (<code>integral_constant&lt;T, v></code> 本身就是一个类型)。</p><ul><li><strong>值</strong>：允许编译期运算</li><li><strong>类型</strong>：可以继承或作为模板参数传递</li></ul><h4 id=继承提供统一接口>继承提供统一接口</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>TrueType</span> <span style=color:#0550ae>:</span> integral_constant<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>bool</span><span style=color:#1f2328>,</span> <span style=color:#6639ba>true</span><span style=color:#0550ae>&gt;</span> <span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>FalseType</span> <span style=color:#0550ae>:</span> integral_constant<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>bool</span><span style=color:#1f2328>,</span> <span style=color:#6639ba>false</span><span style=color:#0550ae>&gt;</span> <span style=color:#1f2328>{};</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>TrueType</code> 和 <code>FalseType</code> 都有 <code>::value</code> 和 <code>::type</code></li><li>允许不同特性模板统一接口，方便模板元编程中做条件判断和类型选择。</li></ul><h4 id=类型标签tag-dispatching>类型标签（Tag Dispatching）</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> process<span style=color:#1f2328>(</span>T<span style=color:#1f2328>,</span> std<span style=color:#0550ae>::</span>true_type<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span> <span style=color:#57606a>/* 特化行为 */</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> process<span style=color:#1f2328>(</span>T<span style=color:#1f2328>,</span> std<span style=color:#0550ae>::</span>false_type<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span> <span style=color:#57606a>/* 默认行为 */</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>process<span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>,</span> std<span style=color:#0550ae>::</span>is_integral<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>{});</span> <span style=color:#57606a>// 编译期选择函数
</span></span></span></code></pre></td></tr></table></div></div><ul><li><code>std::is_integral&lt;int></code> 是一个 <strong>值类型</strong> 。通常这个模板类会继承自 <code>std::true_type</code> 或 <code>std::false_type</code> （通过特化/偏特化，从而会是其中一个类型）</li></ul><h4 id=组合模板逻辑>组合模板逻辑</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>my_trait</span> <span style=color:#0550ae>:</span> std<span style=color:#0550ae>::</span>integral_constant<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>bool</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>    std<span style=color:#0550ae>::</span>is_pointer<span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>&gt;::</span>value <span style=color:#0550ae>||</span> std<span style=color:#0550ae>::</span>is_reference<span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>&gt;::</span>value<span style=color:#0550ae>&gt;</span> <span style=color:#1f2328>{};</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>这个新的值类型，可以组合两种值类型的概念。</li><li>可以在编译期被其他模板继承或组合</li><li><strong>值和类型合二为一</strong>，方便 TMP 进行递归或组合逻辑</li></ul><h2 id=特性模板traits>特性模板(Traits)</h2><p><strong>特性模板（Traits）本质上就是一种值类型的“包装”</strong>，它在编译期承载类型特性信息，同时作为类型存在，可以被继承或组合。</p><h3 id=概念-1>概念</h3><p><strong>特性模板</strong>是一种模板元编程手段，用来描述类型的某种属性或特性。常见用途包括：</p><ul><li>类型是否是指针、引用、数组</li><li>类型是否是 POD（Plain Old Data）</li><li>类型之间的关系（可赋值、可拷贝等）</li></ul><p>因为它本质上继承自值类型（通常 <code>std::true_type</code> 或 <code>std::false_type</code> ），所以特征模板本身包含成员 <code>value</code> 。值为 true 或 false。</p><p>如何让不同的模板参数，得到不同的答案？ <strong>偏特化</strong></p><p>简单类比理解： <strong>偏特化</strong> 类似于正常编程里的if分支结构。而整个类型的定义，就是把 if 分支结构组合到一起了。这样，traits相当于利用模板的“if”，完成编译期的判断。</p><h3 id=实现方式-1>实现方式</h3><p>特性模板通常通过<strong>偏特化</strong>实现：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>is_pointer</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>static</span> <span style=color:#cf222e>constexpr</span> <span style=color:#cf222e>bool</span> value <span style=color:#0550ae>=</span> <span style=color:#6639ba>false</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>is_pointer</span><span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>*&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>static</span> <span style=color:#cf222e>constexpr</span> <span style=color:#cf222e>bool</span> value <span style=color:#0550ae>=</span> <span style=color:#6639ba>true</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><p>不过更常见的做法是：继承 <code>std::true_type</code> 或 <code>std::false_type</code> 。保证一个统一的形式。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>// 通用模板：默认不是指针
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>is_pointer</span> <span style=color:#0550ae>:</span> std<span style=color:#0550ae>::</span>false_type <span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 偏特化：指针类型
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>is_pointer</span><span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>*&gt;</span> <span style=color:#0550ae>:</span> std<span style=color:#0550ae>::</span>true_type <span style=color:#1f2328>{};</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=使用示例>使用示例</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>#include</span> <span style=color:#57606a>&lt;iostream&gt;</span><span style=color:#57606a>
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> check_pointer<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>if</span> <span style=color:#6639ba>constexpr</span><span style=color:#1f2328>(</span>is_pointer<span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>&gt;::</span>value<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        std<span style=color:#0550ae>::</span>cout <span style=color:#0550ae>&lt;&lt;</span> <span style=color:#0a3069>&#34;It&#39;s a pointer type.</span><span style=color:#0a3069>\n</span><span style=color:#0a3069>&#34;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span> <span style=color:#cf222e>else</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        std<span style=color:#0550ae>::</span>cout <span style=color:#0550ae>&lt;&lt;</span> <span style=color:#0a3069>&#34;It&#39;s not a pointer type.</span><span style=color:#0a3069>\n</span><span style=color:#0a3069>&#34;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>main</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    check_pointer<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>();</span>    <span style=color:#57606a>// 输出: It&#39;s not a pointer type.
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    check_pointer<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#0550ae>*&gt;</span><span style=color:#1f2328>();</span>   <span style=color:#57606a>// 输出: It&#39;s a pointer type.
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=使用traits的好处>使用Traits的好处</h3><ol><li>编译期，可以对类型的结构进行 <strong>检查</strong> 。</li><li>编译期，如果类型结构不符合预期，可以 <strong>对类型进行自动补全或适配</strong> ，让类型具备统一接口。：<ol><li>某个模板函数实现，需要使用 <code>value_type</code> ，但是某个T，比如没有 <code>value_type</code> 之类的成员。</li><li>Traits可以做一些常规的尝试，比如通过 <code>pointer_type</code> ，来自动定义对应成员，从而让traits包装的类，具备统一的接口。（相当于也有了 <code>value_type</code> ）</li></ol></li><li>把 <strong>约束相关逻辑集中到 traits 中</strong> ，减少模板类的复杂度<ol><li>可以把模板类实现过程中，对T的各种约束性要求，可能比较分散的处于实现细节的各个位置上。而有了一层traits封装，可以确保约束都集中到traits中。实现的时候，只需要考虑约束已经满足即可。</li></ol></li><li>作为 <strong>编译期信息的统一入口</strong> （type/value 提供点），每个 trait 提供：<ol><li><code>::value</code></li><li><code>::type</code></li></ol></li></ol><h3 id=traits-全家桶示例模板库>Traits 全家桶示例模板库</h3><p>这里面很多属于 类型求值函数 (type functions)</p><h4 id=基础工具void_t>基础工具：<code>void_t</code></h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span><span style=color:#1f2328>...</span><span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>using</span> void_t <span style=color:#0550ae>=</span> <span style=color:#cf222e>void</span><span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>接收任意模板参数。（但是并不使用）</li></ul><p>上面代码等价于：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span><span style=color:#1f2328>...</span> Ts<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>void_</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>using</span> type <span style=color:#0550ae>=</span> <span style=color:#cf222e>void</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span><span style=color:#1f2328>...</span> Ts<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>using</span> void_t <span style=color:#0550ae>=</span> <span style=color:#cf222e>typename</span> void_<span style=color:#0550ae>&lt;</span>Ts<span style=color:#1f2328>...</span><span style=color:#0550ae>&gt;::</span>type<span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><p>但是可以简化写，因为： <code>void 永远不依赖 Ts...</code></p><h4 id=has_xxx检测是否有某个内置成员>has_xxx：检测是否有某个内置成员</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#1f2328>,</span> <span style=color:#cf222e>typename</span> <span style=color:#0550ae>=</span> <span style=color:#cf222e>void</span><span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>has_value_type</span> <span style=color:#0550ae>:</span> std<span style=color:#0550ae>::</span>false_type <span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>has_value_type</span><span style=color:#0550ae>&lt;</span>T<span style=color:#1f2328>,</span> void_t<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>::</span>value_type<span style=color:#0550ae>&gt;&gt;</span> 
</span></span><span style=display:flex><span>    <span style=color:#0550ae>:</span> std<span style=color:#0550ae>::</span>true_type <span style=color:#1f2328>{};</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=fallback-适配-traits接口统一>fallback 适配 traits（接口统一）</h4><p>如果 <code>T</code> 有 <code>value_type</code> → 使用<br>如果没有 → 默认使用 <code>T</code> 本身</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#1f2328>,</span> <span style=color:#cf222e>typename</span> <span style=color:#0550ae>=</span> <span style=color:#cf222e>void</span><span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>value_type_trait</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>using</span> type <span style=color:#0550ae>=</span> T<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>value_type_trait</span><span style=color:#0550ae>&lt;</span>T<span style=color:#1f2328>,</span> void_t<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>::</span>value_type<span style=color:#0550ae>&gt;&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>using</span> type <span style=color:#0550ae>=</span> <span style=color:#cf222e>typename</span> T<span style=color:#0550ae>::</span>value_type<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=类型判断-traits偏特化版>类型判断 traits（偏特化版）</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>is_pointer</span> <span style=color:#0550ae>:</span> std<span style=color:#0550ae>::</span>false_type <span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>is_pointer</span><span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>*&gt;</span> <span style=color:#0550ae>:</span> std<span style=color:#0550ae>::</span>true_type <span style=color:#1f2328>{};</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=类型计算-traits编译期元函数>类型计算 traits（编译期“元函数”）</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>remove_pointer</span> <span style=color:#1f2328>{</span> <span style=color:#cf222e>using</span> type <span style=color:#0550ae>=</span> T<span style=color:#1f2328>;</span> <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>remove_pointer</span><span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>*&gt;</span> <span style=color:#1f2328>{</span> <span style=color:#cf222e>using</span> type <span style=color:#0550ae>=</span> T<span style=color:#1f2328>;</span> <span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=组合型-traitstraits-的-traits>组合型 traits（traits 的 traits）</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>normalized_type</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>using</span> raw <span style=color:#0550ae>=</span> <span style=color:#cf222e>typename</span> remove_pointer<span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>&gt;::</span>type<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>using</span> value <span style=color:#0550ae>=</span> <span style=color:#cf222e>typename</span> value_type_trait<span style=color:#0550ae>&lt;</span>raw<span style=color:#0550ae>&gt;::</span>type<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><p>说明：</p><ul><li>去掉指针，例如 <code>int* -> int</code></li><li>从最终类型中取 value_type（如果有）</li></ul><p>组合 traits 常用于构建复杂泛型库。</p><h4 id=使用示例-1>使用示例</h4><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Foo</span> <span style=color:#1f2328>{</span> <span style=color:#cf222e>using</span> value_type <span style=color:#0550ae>=</span> <span style=color:#cf222e>double</span><span style=color:#1f2328>;</span> <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>static_assert</span><span style=color:#1f2328>(</span>has_value_type<span style=color:#0550ae>&lt;</span>Foo<span style=color:#0550ae>&gt;::</span>value<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>static_assert</span><span style=color:#1f2328>(</span><span style=color:#0550ae>!</span>has_value_type<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#0550ae>&gt;::</span>value<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>using</span> A <span style=color:#0550ae>=</span> value_type_trait<span style=color:#0550ae>&lt;</span>Foo<span style=color:#0550ae>&gt;::</span>type<span style=color:#1f2328>;</span>   <span style=color:#57606a>// double
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>using</span> B <span style=color:#0550ae>=</span> value_type_trait<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#0550ae>&gt;::</span>type<span style=color:#1f2328>;</span>   <span style=color:#57606a>// int
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span><span style=color:#cf222e>static_assert</span><span style=color:#1f2328>(</span>is_pointer<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#0550ae>*&gt;::</span>value<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>static_assert</span><span style=color:#1f2328>(</span><span style=color:#0550ae>!</span>is_pointer<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#0550ae>&gt;::</span>value<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>using</span> C <span style=color:#0550ae>=</span> remove_pointer<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#0550ae>*&gt;::</span>type<span style=color:#1f2328>;</span>    <span style=color:#57606a>// int
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>using</span> D <span style=color:#0550ae>=</span> normalized_type<span style=color:#0550ae>&lt;</span>Foo<span style=color:#0550ae>*&gt;::</span>value<span style=color:#1f2328>;</span>  <span style=color:#57606a>// double
</span></span></span></code></pre></td></tr></table></div></div><h2 id=valuetypestraits小结>ValueTypes/Traits小结</h2><p>在模板编程中：</p><ul><li>模板参数：可以类比为 函数参数。<ul><li>通常使用 类型模板参数，作为待推断的内容。</li></ul></li><li>模板类的成员(比如如 <code>type</code>, <code>value</code>) ：可以类比为函数的返回值。<ul><li>为了包含对应的值，通常继承链上，存在 非类型模板参数 。从而实现类型和值的绑定。（值类型）</li></ul></li><li>如何实现if分支结构？ 偏特化。<ul><li>根据不同的参数，偏特化一个类，并提供对应的value。（如何提供？选择对应的值类型进行继承）</li></ul></li></ul><p>上面的meta function和普通函数逻辑上讲，类似的。因此，也可以递归符合调用。</p><h2 id=类型求值函数type-computation--type-functions>类型求值函数（Type Computation / Type Functions）</h2><h3 id=概念-2>概念</h3><p>在模板元编程中，<strong>类型求值函数</strong>是指通过模板机制在编译期生成新的类型。它类似于函数，但输入输出都是类型。</p><ul><li>输入：类型或值类型</li><li>输出：类型</li></ul><p>可以类比，类型求值函数，即为一个meta function。只不过不必继承值类型。而通过对参数的检查（利用traits），就可以直接在成员（type）里输出结果。</p><p>比如前面其实举例子的 <code>remove_pointer</code> ，本质就是一个类型求值函数。</p><h3 id=实现和使用>实现和使用</h3><p>类型求值通常依赖于<strong>模板偏特化</strong>和嵌套类型 <code>::type</code>：</p><p>元函数 <code>conditional</code> ，根据condition，条件选择类型。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>bool</span> Condition<span style=color:#1f2328>,</span> <span style=color:#cf222e>typename</span> TrueType<span style=color:#1f2328>,</span> <span style=color:#cf222e>typename</span> FalseType<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>conditional</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>using</span> type <span style=color:#0550ae>=</span> TrueType<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> TrueType<span style=color:#1f2328>,</span> <span style=color:#cf222e>typename</span> FalseType<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>conditional</span><span style=color:#0550ae>&lt;</span><span style=color:#6639ba>false</span><span style=color:#1f2328>,</span> TrueType<span style=color:#1f2328>,</span> FalseType<span style=color:#0550ae>&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>using</span> type <span style=color:#0550ae>=</span> FalseType<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><p>元函数 <code>enable_if</code></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>bool</span> B<span style=color:#1f2328>,</span> <span style=color:#cf222e>typename</span> T <span style=color:#0550ae>=</span> <span style=color:#cf222e>void</span><span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>enable_if</span> <span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>enable_if</span><span style=color:#0550ae>&lt;</span><span style=color:#6639ba>true</span><span style=color:#1f2328>,</span> T<span style=color:#0550ae>&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>using</span> type <span style=color:#0550ae>=</span> T<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><p>元函数 <code>void_t</code></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span><span style=color:#1f2328>...</span><span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>using</span> void_t <span style=color:#0550ae>=</span> <span style=color:#cf222e>void</span><span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><p>上面三个元函数，用法：</p><ul><li><code>enable_if_t</code>：基于布尔条件启用/禁用模板（逻辑判断）<strong>根据condition启用禁用模板</strong>（通常配合true和false的偏特化使用，参数为false时，模板参数替换失败时触发 SFINAE。）</li><li><code>conditional_t</code> : 基于布尔条件在类型之间选择，<strong>根据condition选择类型，而不是启用/禁用</strong>（类型三元运算符）(可以用于类型协变)</li><li><code>void_t</code>：基于表达式是否可展开进行类型检测（结构探测）<strong>检查成员/表达式合法性</strong>（检查表达式是否合法，从而在模板参数替换失败时触发 SFINAE。）</li></ul><p>使用的时候，应该从语义上思考去使用。而不是用不符合语义的办法来实现，比如，约束模板类型为整数：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>// 方法1: enable_if_t（语义最清晰，推荐）
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>template</span> <span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#1f2328>,</span> <span style=color:#cf222e>typename</span> <span style=color:#0550ae>=</span> std<span style=color:#0550ae>::</span>enable_if_t<span style=color:#0550ae>&lt;</span>std<span style=color:#0550ae>::</span>is_integral_v<span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>&gt;&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> func<span style=color:#1f2328>(</span>T value<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    std<span style=color:#0550ae>::</span>cout <span style=color:#0550ae>&lt;&lt;</span> <span style=color:#0a3069>&#34;Integral version: &#34;</span> <span style=color:#0550ae>&lt;&lt;</span> value <span style=color:#0550ae>&lt;&lt;</span> std<span style=color:#0550ae>::</span>endl<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 方法2: 组合 conditiional_t 和 void_t ，完成一样的功能 。（显然不清晰，也过于复杂）
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>template</span> <span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#1f2328>,</span> <span style=color:#cf222e>typename</span> <span style=color:#0550ae>=</span> std<span style=color:#0550ae>::</span>conditional_t<span style=color:#0550ae>&lt;</span>
</span></span><span style=display:flex><span>    std<span style=color:#0550ae>::</span>is_integral_v<span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>&gt;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>    T<span style=color:#1f2328>,</span> <span style=color:#57606a>// true 时，触发的路径
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    std<span style=color:#0550ae>::</span>void_t<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>decltype</span><span style=color:#1f2328>(</span>T<span style=color:#0550ae>::</span>non_exist<span style=color:#1f2328>)</span><span style=color:#0550ae>&gt;&gt;</span> <span style=color:#57606a>// false时，才会求值，导致SFINAE，匹配失败
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#0550ae>&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> func_conditional<span style=color:#1f2328>(</span>T value<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    std<span style=color:#0550ae>::</span>cout <span style=color:#0550ae>&lt;&lt;</span> <span style=color:#0a3069>&#34;Conditional  version: &#34;</span> <span style=color:#0550ae>&lt;&lt;</span> value <span style=color:#0550ae>&lt;&lt;</span> std<span style=color:#0550ae>::</span>endl<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=conceptc20>concept(C++20)</h1><p>concept 是对模板参数语义约束的“显式、可命名、可组合”的语言级机制。一句话： <strong>concept = 把“隐式模板约束”变成“显式接口契约”</strong></p><h2 id=基础介绍>基础介绍</h2><p><strong>没有 concept 之前</strong> 模板的约束是：</p><ul><li>隐式的</li><li>分散在实现中 （不过我们通常用traits，所以某种程度来说，concept替代了traits的部分能力）</li><li>依赖报错触发（SFINAE）</li></ul><p><strong>使用 concept 之后</strong></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>concept</span> Range <span style=color:#0550ae>=</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>requires</span><span style=color:#1f2328>(</span>T t<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        t<span style=color:#1f2328>.</span>begin<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>        t<span style=color:#1f2328>.</span>end<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span>Range T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> sort<span style=color:#1f2328>(</span>T<span style=color:#0550ae>&amp;</span> x<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span> <span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>约束是<strong>显式</strong></li><li>约束是<strong>可复用的</strong></li><li>错误信息是<strong>语义级别的</strong>（不满足 Range）</li></ul><p><strong>concept 和 traits 的关系</strong></p><ul><li>traits 解决的是“如何适配类型”</li><li>concept 解决的是“类型是否满足某种语义” (以前traits也能处理这块)</li></ul><h3 id=旧写法和新写法>旧写法和新写法</h3><p>检查是否符合 iterable 接口的写法：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>is_iterable</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>private</span><span style=color:#0550ae>:</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> U<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>static</span> <span style=color:#cf222e>auto</span> test<span style=color:#1f2328>(</span><span style=color:#cf222e>int</span><span style=color:#1f2328>)</span> <span style=color:#0550ae>-&gt;</span> <span style=color:#cf222e>decltype</span><span style=color:#1f2328>(</span>std<span style=color:#0550ae>::</span>declval<span style=color:#0550ae>&lt;</span>U<span style=color:#0550ae>&gt;</span><span style=color:#1f2328>().</span>begin<span style=color:#1f2328>(),</span>
</span></span><span style=display:flex><span>                                      std<span style=color:#0550ae>::</span>declval<span style=color:#0550ae>&lt;</span>U<span style=color:#0550ae>&gt;</span><span style=color:#1f2328>().</span>end<span style=color:#1f2328>(),</span>
</span></span><span style=display:flex><span>                                      std<span style=color:#0550ae>::</span>true_type<span style=color:#1f2328>{});</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span><span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>static</span> <span style=color:#cf222e>auto</span> test<span style=color:#1f2328>(...)</span> <span style=color:#0550ae>-&gt;</span> std<span style=color:#0550ae>::</span>false_type<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>public</span><span style=color:#0550ae>:</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>static</span> <span style=color:#cf222e>constexpr</span> <span style=color:#cf222e>bool</span> value <span style=color:#0550ae>=</span> <span style=color:#cf222e>decltype</span><span style=color:#1f2328>(</span>test<span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span><span style=color:#0550ae>0</span><span style=color:#1f2328>))</span><span style=color:#0550ae>::</span>value<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>隐式约束：不满足条件时报错是模板实例化错误。</li><li>可读性差：错误信息冗长，不语义化。</li><li>分散：traits 与模板实现分开，难以组合语义约束。</li></ul><p><strong>使用concept</strong></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>concept</span> Iterable <span style=color:#0550ae>=</span> <span style=color:#cf222e>requires</span><span style=color:#1f2328>(</span>T t<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    t<span style=color:#1f2328>.</span>begin<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    t<span style=color:#1f2328>.</span>end<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>显式语义：<code>Iterable</code> 直接表述类型契约。</li><li>可复用：多个模板直接使用 <code>Iterable&lt;T></code>。</li><li>错误信息清晰：不满足 <code>Iterable</code> 时，编译器提示“concept not satisfied”。</li></ul><h3 id=从-traits-过渡到-concept-的方法>从 traits 过渡到 concept 的方法</h3><ol><li><strong>直接替换型</strong>：原本 traits 检查的条件，改写为 concept 的 <code>requires</code> 表达式。</li><li><strong>组合型</strong>：多个 traits 条件可以组合成一个 concept。</li><li><strong>保留辅助型 traits</strong>：<ul><li><strong>提取类型信息</strong>：<code>std::iterator_traits&lt;T>::value_type</code>。</li><li><strong>计算型属性</strong>：<code>std::rank&lt;T>::value</code>。</li><li><strong>SFINAE 辅助</strong>：某些复杂类型适配仍需 traits。</li></ul></li></ol><p><strong>总结</strong>：概念负责 <strong>语义验证</strong>，traits 负责 <strong>类型信息提取</strong>。</p><h2 id=基本语法>基本语法</h2><h3 id=定义concept>定义concept</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>concept</span> Range <span style=color:#0550ae>=</span> <span style=color:#cf222e>requires</span><span style=color:#1f2328>(</span>T t<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    t<span style=color:#1f2328>.</span>begin<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    t<span style=color:#1f2328>.</span>end<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>concept</span> Iterable <span style=color:#0550ae>=</span> <span style=color:#cf222e>requires</span><span style=color:#1f2328>(</span>T t<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{</span> t<span style=color:#1f2328>.</span>begin<span style=color:#1f2328>()</span> <span style=color:#1f2328>}</span> <span style=color:#0550ae>-&gt;</span> std<span style=color:#0550ae>::</span>same_as<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>::</span>iterator<span style=color:#0550ae>&gt;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{</span> t<span style=color:#1f2328>.</span>end<span style=color:#1f2328>()</span> <span style=color:#1f2328>}</span> <span style=color:#0550ae>-&gt;</span> std<span style=color:#0550ae>::</span>same_as<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>::</span>iterator<span style=color:#0550ae>&gt;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>template&lt;typename T></code>：模板参数。</li><li><code>concept Range</code>：定义一个名为 <code>Range</code> 的概念。</li><li><code>requires</code> 后面可以接：<ul><li><code>{ expr }-> Trait</code><ul><li><code>{ expr }</code>：要求类型 <code>T</code> 必须能在该上下文中进行该操作（调用、访问等）。</li><li><code>-> Trait</code>：指定<strong>返回值约束</strong>，本质是一个 <strong>类型谓词（type predicate）</strong>。参数为返回值类型，返回为<code>value</code> 成员（bool值）</li></ul></li><li>还可以直接跟 Trait （只要是类型谓词即可）</li></ul></li></ul><p><strong>注意：简短说明 concept 不触发 SFINAE，而是语义级布尔约束，错误信息更清晰</strong></p><h3 id=内联约束表达式>内联约束表达式</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>requires</span> std<span style=color:#0550ae>::</span>is_integral_v<span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span>T add<span style=color:#1f2328>(</span>T a<span style=color:#1f2328>,</span> T b<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span> <span style=color:#cf222e>return</span> a <span style=color:#0550ae>+</span> b<span style=color:#1f2328>;</span> <span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=组合concept>组合concept</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>concept</span> RandomAccessRange <span style=color:#0550ae>=</span> Range<span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>&gt;</span> <span style=color:#0550ae>&amp;&amp;</span> <span style=color:#cf222e>requires</span><span style=color:#1f2328>(</span>T t<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{</span> t<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>]</span> <span style=color:#1f2328>}</span> <span style=color:#0550ae>-&gt;</span> std<span style=color:#0550ae>::</span>convertible_to<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>::</span>value_type<span style=color:#0550ae>&gt;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=模板中使用-concept>模板中使用 concept</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span>Range T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> sort<span style=color:#1f2328>(</span>T<span style=color:#0550ae>&amp;</span> x<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>requires</span> Range<span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> sort<span style=color:#1f2328>(</span>T<span style=color:#0550ae>&amp;</span> x<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span> <span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=concept--traits-协同设计>concept + traits 协同设计</h2><h3 id=traits-提供类型信息--concept-做语义约束>traits 提供类型信息 + concept 做语义约束</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>concept</span> HasValueType <span style=color:#0550ae>=</span> <span style=color:#cf222e>requires</span> <span style=color:#1f2328>{</span> <span style=color:#cf222e>typename</span> T<span style=color:#0550ae>::</span>value_type<span style=color:#1f2328>;</span> <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>concept</span> Container <span style=color:#0550ae>=</span> HasValueType<span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>&gt;</span> <span style=color:#0550ae>&amp;&amp;</span> <span style=color:#cf222e>requires</span><span style=color:#1f2328>(</span>T t<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    t<span style=color:#1f2328>.</span>begin<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    t<span style=color:#1f2328>.</span>end<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span>Container C<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> process<span style=color:#1f2328>(</span>C<span style=color:#0550ae>&amp;</span> c<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>using</span> value_t <span style=color:#0550ae>=</span> <span style=color:#cf222e>typename</span> C<span style=color:#0550ae>::</span>value_type<span style=color:#1f2328>;</span> <span style=color:#57606a>// traits 风格类型提取
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#57606a>// 进一步操作
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><strong>概念负责约束</strong>：编译期检查类型契约。</li><li><strong>traits 提供元信息</strong>：模板内部用于提取类型或计算属性。</li><li>形成明确分工：概念 + traits。</li></ul><h3 id=组合-concept-替代复杂-traits-检测>组合 concept 替代复杂 traits 检测</h3><p>原本需要多层 traits 嵌套判断：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>is_random_access_iterable</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>static</span> <span style=color:#cf222e>constexpr</span> <span style=color:#cf222e>bool</span> value <span style=color:#0550ae>=</span> is_iterable<span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>&gt;::</span>value <span style=color:#0550ae>&amp;&amp;</span> 
</span></span><span style=display:flex><span>                                  std<span style=color:#0550ae>::</span>is_same_v<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>::</span>iterator<span style=color:#0550ae>::</span>iterator_category<span style=color:#1f2328>,</span> std<span style=color:#0550ae>::</span>random_access_iterator_tag<span style=color:#0550ae>&gt;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><p>使用 concept 改写：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>concept</span> RandomAccessIterable <span style=color:#0550ae>=</span> Iterable<span style=color:#0550ae>&lt;</span>T<span style=color:#0550ae>&gt;</span> <span style=color:#0550ae>&amp;&amp;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>requires</span><span style=color:#1f2328>(</span>T t<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>typename</span> T<span style=color:#0550ae>::</span>iterator<span style=color:#0550ae>::</span>iterator_category<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span> <span style=color:#0550ae>&amp;&amp;</span> std<span style=color:#0550ae>::</span>is_same_v<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>::</span>iterator<span style=color:#0550ae>::</span>iterator_category<span style=color:#1f2328>,</span> std<span style=color:#0550ae>::</span>random_access_iterator_tag<span style=color:#0550ae>&gt;</span><span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=过渡策略总结>过渡策略总结</h3><ol><li><strong>优先用 concept 表达语义约束</strong>。</li><li><strong>traits 保留类型属性提取功能</strong>。</li><li><strong>模板内部用 traits，模板外部用 concept</strong>。</li><li><strong>逐步替换</strong>：老代码可先封装 traits 为 concept，再逐步清理原 traits 判断。</li></ol><h1 id=高级技巧简介>高级技巧简介</h1><h2 id=constexpr-与编译期计算>constexpr 与编译期计算</h2><ul><li><p><strong>用途</strong>：让函数、变量在编译期求值，提高效率，支持模板元编程。</p></li><li><p><strong>常见用法</strong>：</p><ul><li><code>constexpr</code> 函数：可以在编译期使用，配合非类型模板参数实现计算。</li><li><code>consteval</code> 函数：强制在编译期求值。</li><li>编译期状态机、递归计算（如阶乘、斐波那契）。</li></ul></li><li><p><strong>特点</strong>：</p><ul><li>与模板结合可以实现“模板元编程 → 编译期编程”。</li><li>编译期求值比运行时更高效。</li></ul></li></ul><h3 id=概念-3>概念</h3><p><code>constexpr</code> 是 C++11 引入的关键字，其核心目的是 <strong>让表达式在编译期求值</strong>，从而提升效率，同时支持模板元编程。</p><p>特点：</p><ol><li><strong>编译期求值</strong>：编译器尝试在编译期计算值，如果无法在编译期求值，也可以在运行时使用（前提是函数允许）。</li><li><strong>与 <code>const</code> 的区别</strong>：<ul><li><code>const</code> 表示“值不可修改”，但不保证编译期求值。</li><li><code>constexpr</code> 表示“可在编译期求值”，编译器会尽量在编译期求值。</li></ul></li><li><strong>支持复杂表达式</strong>：现代 C++（C++14 以后）允许 <code>constexpr</code> 函数包含条件语句、循环等，增强了表达力。</li></ol><h3 id=用法简要举例>用法简要举例</h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>/////// 旧写法
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span> N<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Factorial</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>static</span> <span style=color:#cf222e>constexpr</span> <span style=color:#cf222e>int</span> value <span style=color:#0550ae>=</span> N <span style=color:#0550ae>*</span> Factorial<span style=color:#0550ae>&lt;</span>N <span style=color:#0550ae>-</span> <span style=color:#0550ae>1</span><span style=color:#0550ae>&gt;::</span>value<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Factorial</span><span style=color:#0550ae>&lt;</span><span style=color:#0550ae>0</span><span style=color:#0550ae>&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>static</span> <span style=color:#cf222e>constexpr</span> <span style=color:#cf222e>int</span> value <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>constexpr</span> <span style=color:#cf222e>int</span> f5 <span style=color:#0550ae>=</span> Factorial<span style=color:#0550ae>&lt;</span><span style=color:#0550ae>5</span><span style=color:#0550ae>&gt;::</span>value<span style=color:#1f2328>;</span> <span style=color:#57606a>// 编译期求值 120
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>/////// 新写法
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>constexpr</span> <span style=color:#cf222e>int</span> <span style=color:#6639ba>factorial</span><span style=color:#1f2328>(</span><span style=color:#cf222e>int</span> n<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> n <span style=color:#0550ae>&lt;=</span> <span style=color:#0550ae>1</span> <span style=color:#0550ae>?</span> <span style=color:#0550ae>1</span> <span style=color:#0550ae>:</span> n <span style=color:#0550ae>*</span> factorial<span style=color:#1f2328>(</span>n <span style=color:#0550ae>-</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>constexpr</span> <span style=color:#cf222e>int</span> f6 <span style=color:#0550ae>=</span> factorial<span style=color:#1f2328>(</span><span style=color:#0550ae>6</span><span style=color:#1f2328>);</span> <span style=color:#57606a>// 720
</span></span></span></code></pre></td></tr></table></div></div><p>从 C++14 开始，<code>constexpr</code> 函数功能增强：</p><ol><li><strong>允许循环</strong>：</li><li><strong>允许局部变量和条件判断</strong>：增强逻辑复杂度。</li><li><strong>支持递归计算</strong></li></ol><p>注意事项：</p><ul><li><strong>递归深度</strong>：编译期递归过深可能导致编译器报错或性能下降。</li><li><strong>非编译期变量</strong>：<code>constexpr</code> 函数参数必须是可在编译期确定的值才能在编译期求值。</li><li><strong>限制操作</strong>：<ul><li>C++11：函数体只能包含单条 <code>return</code> 语句。</li><li>C++14 之后：允许局部变量、循环、条件分支。</li></ul></li></ul><h2 id=decltype技巧>decltype技巧</h2><ul><li><strong>用途</strong>：根据表达式推导类型，尤其在模板元编程中，方便提取函数返回值类型或变量类型。</li><li><strong>常见用法</strong>：
<code>template&lt;typename T, typename U> auto add(T t, U u) -> decltype(t + u) { return t + u; }</code></li><li><strong>特点</strong>：<ul><li>避免手动书写复杂类型。</li><li>与 <code>auto</code>、模板结合可生成灵活的类型推导函数。</li></ul></li></ul><h3 id=概念-4>概念</h3><p><code>decltype</code> 是 C++11 引入的关键字，用于<strong>在编译期推导表达式的类型</strong>。它的作用类似于 <code>auto</code>，但 <code>auto</code> 是推导变量类型，而 <code>decltype</code> 更强调<strong>获取表达式的类型，而不是变量的类型</strong>。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>int</span> a <span style=color:#0550ae>=</span> <span style=color:#0550ae>5</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>decltype</span><span style=color:#1f2328>(</span>a<span style=color:#1f2328>)</span> b<span style=color:#1f2328>;</span> <span style=color:#57606a>// b 的类型是 int
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>decltype</span><span style=color:#1f2328>(</span>a <span style=color:#0550ae>+</span> <span style=color:#0550ae>0.0</span><span style=color:#1f2328>)</span> c<span style=color:#1f2328>;</span> <span style=color:#57606a>// c 的类型是 double，因为表达式 a + 0.0 的类型是 double
</span></span></span></code></pre></td></tr></table></div></div><ul><li>不会对表达式进行求值，只用来推导类型。</li><li>可以获取左值引用、右值引用、常量属性等完整类型信息。</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>int</span> x <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>int</span><span style=color:#0550ae>&amp;</span> xr <span style=color:#0550ae>=</span> x<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>decltype</span><span style=color:#1f2328>(</span>x<span style=color:#1f2328>)</span> a<span style=color:#1f2328>;</span>   <span style=color:#57606a>// int
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>decltype</span><span style=color:#1f2328>(</span>xr<span style=color:#1f2328>)</span> b <span style=color:#0550ae>=</span> x<span style=color:#1f2328>;</span> <span style=color:#57606a>// int&amp;
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>decltype</span><span style=color:#1f2328>((</span>x<span style=color:#1f2328>))</span> c <span style=color:#0550ae>=</span> x<span style=color:#1f2328>;</span> <span style=color:#57606a>// int&amp; 注意：加括号后，表达式是左值，所以得到引用
</span></span></span></code></pre></td></tr></table></div></div><ul><li>对于变量本身，<code>decltype(var)</code> 得到的是变量类型。</li><li>对于括号包裹的表达式，<code>decltype((var))</code> 如果是左值，则得到左值引用类型。</li></ul><h3 id=用法简要举例-1>用法简要举例</h3><p>在模板编程中，经常遇到“如何自动推导返回值类型”的问题。<code>decltype</code> 可以完美解决这个问题，特别是当返回值类型依赖于模板参数时。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#1f2328>,</span> <span style=color:#cf222e>typename</span> U<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>auto</span> add<span style=color:#1f2328>(</span>T t<span style=color:#1f2328>,</span> U u<span style=color:#1f2328>)</span> <span style=color:#0550ae>-&gt;</span> <span style=color:#cf222e>decltype</span><span style=color:#1f2328>(</span>t <span style=color:#0550ae>+</span> u<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> t <span style=color:#0550ae>+</span> u<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>类似 <code>void_t</code> ，检查表达式是否合法：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>decltype</span><span style=color:#1f2328>(</span>expr<span style=color:#1f2328>,</span> <span style=color:#cf222e>void</span><span style=color:#1f2328>())</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=利用函数签名提取类型>利用函数签名提取类型</h2><ul><li><strong>用途</strong>：通过函数模板或偏特化，获取函数参数、返回值类型，便于模板逻辑处理。</li><li><strong>常见用法</strong>：<ul><li>提取函数的第一个参数类型。</li><li>提取成员函数指针、返回值类型。</li><li>与 <code>std::function_traits</code>、自定义 meta 函数结合。</li></ul></li></ul><p>这部分，我们在前面有提到过： <a class=link href=#%e5%a6%82%e4%bd%95%e6%8f%90%e5%8f%96%e5%87%bd%e6%95%b0%e7%9a%84%e7%ac%ac%e4%b8%80%e4%b8%aa%e5%8f%82%e6%95%b0%e7%b1%bb%e5%9e%8b>如何提取函数的第一个参数类型？</a></p><h2 id=编译期列表>编译期列表</h2><ul><li><p><strong>用途</strong>：管理一组类型或值，实现编译期循环、映射或组合。</p></li><li><p><strong>常见用法</strong>：</p><ul><li><code>std::index_sequence</code> / <code>std::integer_sequence</code> 生成编译期序列。</li><li>类型列表（TypeList）进行递归处理或模式匹配。</li><li>值列表（ValueList）进行 fold、累加等编译期运算。</li></ul></li><li><p><strong>特点</strong>：</p><ul><li>与变长模板参数结合，实现灵活的模板展开。</li><li>是高级模板库（如 Boost.MPL / TMP）常用手段。</li></ul></li></ul><h3 id=integer-sequence整数序列>Integer Sequence（整数序列）</h3><p><code>std::index_sequence</code> 和 <code>std::integer_sequence</code> 是 C++14 引入的模板工具，用于在编译期生成整数序列。</p><p>核心作用：配合 <strong>变长模板参数</strong>，实现对序列的遍历、展开、映射等。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>#include</span> <span style=color:#57606a>&lt;utility&gt;</span><span style=color:#57606a>
</span></span></span><span style=display:flex><span><span style=color:#57606a>#include</span> <span style=color:#57606a>&lt;iostream&gt;</span><span style=color:#57606a>
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span>std<span style=color:#0550ae>::</span>size_t<span style=color:#1f2328>...</span> Is<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> print_index_sequence<span style=color:#1f2328>(</span>std<span style=color:#0550ae>::</span>index_sequence<span style=color:#0550ae>&lt;</span>Is<span style=color:#1f2328>...</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>((</span>std<span style=color:#0550ae>::</span>cout <span style=color:#0550ae>&lt;&lt;</span> Is <span style=color:#0550ae>&lt;&lt;</span> <span style=color:#0a3069>&#34; &#34;</span><span style=color:#1f2328>),</span> <span style=color:#1f2328>...);</span>  <span style=color:#57606a>// fold expression (C++17)
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>main</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    print_index_sequence<span style=color:#1f2328>(</span>std<span style=color:#0550ae>::</span>make_index_sequence<span style=color:#0550ae>&lt;</span><span style=color:#0550ae>5</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>{});</span>  <span style=color:#57606a>// 输出: 0 1 2 3 4
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>展开元组或数组参数包</strong></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>#include</span> <span style=color:#57606a>&lt;tuple&gt;</span><span style=color:#57606a>
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> Tuple<span style=color:#1f2328>,</span> std<span style=color:#0550ae>::</span>size_t<span style=color:#1f2328>...</span> Is<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> print_tuple<span style=color:#1f2328>(</span><span style=color:#cf222e>const</span> Tuple<span style=color:#0550ae>&amp;</span> t<span style=color:#1f2328>,</span> std<span style=color:#0550ae>::</span>index_sequence<span style=color:#0550ae>&lt;</span>Is<span style=color:#1f2328>...</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>((</span>std<span style=color:#0550ae>::</span>cout <span style=color:#0550ae>&lt;&lt;</span> std<span style=color:#0550ae>::</span>get<span style=color:#0550ae>&lt;</span>Is<span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>t<span style=color:#1f2328>)</span> <span style=color:#0550ae>&lt;&lt;</span> <span style=color:#0a3069>&#34; &#34;</span><span style=color:#1f2328>),</span> <span style=color:#1f2328>...);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>main</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>auto</span> t <span style=color:#0550ae>=</span> std<span style=color:#0550ae>::</span>make_tuple<span style=color:#1f2328>(</span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>2</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>3</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    print_tuple<span style=color:#1f2328>(</span>t<span style=color:#1f2328>,</span> std<span style=color:#0550ae>::</span>make_index_sequence<span style=color:#0550ae>&lt;</span><span style=color:#0550ae>3</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>{});</span> <span style=color:#57606a>// 输出: 1 2 3
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=typelist类型列表>TypeList（类型列表）</h3><p>TypeList 是一种将一组类型封装在模板参数包中的手段：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span><span style=color:#1f2328>...</span> Ts<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>TypeList</span> <span style=color:#1f2328>{};</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><strong>递归处理类型</strong>：比如实现条件筛选、映射或连接类型。</li><li><strong>编译期映射/计算</strong>：可以对每个类型应用元函数。</li></ul><p><strong>示例：获取 TypeList 长度</strong></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span><span style=color:#1f2328>...</span> Ts<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>TypeList</span> <span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> List<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Length</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span><span style=color:#1f2328>...</span> Ts<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Length</span><span style=color:#0550ae>&lt;</span>TypeList<span style=color:#0550ae>&lt;</span>Ts<span style=color:#1f2328>...</span><span style=color:#0550ae>&gt;&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>static</span> <span style=color:#cf222e>constexpr</span> std<span style=color:#0550ae>::</span>size_t value <span style=color:#0550ae>=</span> <span style=color:#cf222e>sizeof</span><span style=color:#1f2328>...(</span>Ts<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>main</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>using</span> MyTypes <span style=color:#0550ae>=</span> TypeList<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>double</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>char</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    std<span style=color:#0550ae>::</span>cout <span style=color:#0550ae>&lt;&lt;</span> Length<span style=color:#0550ae>&lt;</span>MyTypes<span style=color:#0550ae>&gt;::</span>value<span style=color:#1f2328>;</span> <span style=color:#57606a>// 输出: 3
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>示例：类型映射</strong></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>AddPointer</span> <span style=color:#1f2328>{</span> <span style=color:#cf222e>using</span> type <span style=color:#0550ae>=</span> T<span style=color:#0550ae>*</span><span style=color:#1f2328>;</span> <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span><span style=color:#1f2328>...</span> Ts<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Transform</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span><span style=color:#1f2328>...</span> Ts<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Transform</span><span style=color:#0550ae>&lt;</span>TypeList<span style=color:#0550ae>&lt;</span>Ts<span style=color:#1f2328>...</span><span style=color:#0550ae>&gt;&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>using</span> type <span style=color:#0550ae>=</span> TypeList<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> AddPointer<span style=color:#0550ae>&lt;</span>Ts<span style=color:#0550ae>&gt;::</span>type<span style=color:#1f2328>...</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>using</span> MyTypes <span style=color:#0550ae>=</span> TypeList<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>double</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>using</span> PtrTypes <span style=color:#0550ae>=</span> Transform<span style=color:#0550ae>&lt;</span>MyTypes<span style=color:#0550ae>&gt;::</span>type<span style=color:#1f2328>;</span> <span style=color:#57606a>// TypeList&lt;int*, double*&gt;
</span></span></span></code></pre></td></tr></table></div></div><p><strong>示例：类型筛选</strong></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>#include</span> <span style=color:#57606a>&lt;type_traits&gt;</span><span style=color:#57606a>
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span><span style=color:#57606a>// Filter 元函数
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span><span style=color:#0550ae>&gt;</span> <span style=color:#cf222e>class</span> <span style=color:#1f2328>Pred</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>typename</span> List<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Filter</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span><span style=color:#0550ae>&gt;</span> <span style=color:#cf222e>class</span> <span style=color:#1f2328>Pred</span><span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Filter</span><span style=color:#0550ae>&lt;</span>Pred<span style=color:#1f2328>,</span> TypeList<span style=color:#0550ae>&lt;&gt;&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>using</span> type <span style=color:#0550ae>=</span> TypeList<span style=color:#0550ae>&lt;&gt;</span><span style=color:#1f2328>;</span> <span style=color:#57606a>// 空列表
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span><span style=color:#0550ae>&gt;</span> <span style=color:#cf222e>class</span> <span style=color:#1f2328>Pred</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>typename</span> Head<span style=color:#1f2328>,</span> <span style=color:#cf222e>typename</span><span style=color:#1f2328>...</span> Tail<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Filter</span><span style=color:#0550ae>&lt;</span>Pred<span style=color:#1f2328>,</span> TypeList<span style=color:#0550ae>&lt;</span>Head<span style=color:#1f2328>,</span> Tail<span style=color:#1f2328>...</span><span style=color:#0550ae>&gt;&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>private</span><span style=color:#0550ae>:</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>using</span> TailResult <span style=color:#0550ae>=</span> <span style=color:#cf222e>typename</span> Filter<span style=color:#0550ae>&lt;</span>Pred<span style=color:#1f2328>,</span> TypeList<span style=color:#0550ae>&lt;</span>Tail<span style=color:#1f2328>...</span><span style=color:#0550ae>&gt;&gt;::</span>type<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>public</span><span style=color:#0550ae>:</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>using</span> type <span style=color:#0550ae>=</span> std<span style=color:#0550ae>::</span>conditional_t<span style=color:#0550ae>&lt;</span>
</span></span><span style=display:flex><span>        Pred<span style=color:#0550ae>&lt;</span>Head<span style=color:#0550ae>&gt;::</span>value<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>        TypeList<span style=color:#0550ae>&lt;</span>Head<span style=color:#1f2328>,</span> TailResult<span style=color:#0550ae>&gt;</span><span style=color:#1f2328>,</span> <span style=color:#57606a>// 保留 Head
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>        TailResult                  <span style=color:#57606a>// 跳过 Head
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#0550ae>&gt;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>/// 使用示例：
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span><span style=color:#cf222e>using</span> MyTypes <span style=color:#0550ae>=</span> TypeList<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>double</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>char</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>float</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>long</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 只保留整型
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>using</span> IntegralTypes <span style=color:#0550ae>=</span> Filter<span style=color:#0550ae>&lt;</span>std<span style=color:#0550ae>::</span>is_integral<span style=color:#1f2328>,</span> MyTypes<span style=color:#0550ae>&gt;::</span>type<span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=valuelist值列表>ValueList（值列表）</h3><p><strong>integer_sequence 拓展</strong></p><ul><li><code>std::integer_sequence&lt;int, ...></code></li><li><code>std::index_sequence</code>（用于索引）</li></ul><p><strong>示例：计算编译期和</strong></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>#include</span> <span style=color:#57606a>&lt;utility&gt;</span><span style=color:#57606a>
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>...</span> Ns<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>constexpr</span> <span style=color:#cf222e>int</span> sum<span style=color:#1f2328>(</span>std<span style=color:#0550ae>::</span>integer_sequence<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>,</span> Ns<span style=color:#1f2328>...</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> <span style=color:#1f2328>(</span><span style=color:#0550ae>0</span> <span style=color:#0550ae>+</span> <span style=color:#1f2328>...</span> <span style=color:#0550ae>+</span> Ns<span style=color:#1f2328>);</span> <span style=color:#57606a>// fold expression
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>main</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>constexpr</span> <span style=color:#cf222e>int</span> s <span style=color:#0550ae>=</span> sum<span style=color:#1f2328>(</span>std<span style=color:#0550ae>::</span>integer_sequence<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>2</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>3</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>4</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>{});</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>static_assert</span><span style=color:#1f2328>(</span>s <span style=color:#0550ae>==</span> <span style=color:#0550ae>10</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>示例：与 index_sequence 配合</strong></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>#include</span> <span style=color:#57606a>&lt;array&gt;</span><span style=color:#57606a>
</span></span></span><span style=display:flex><span><span style=color:#57606a>#include</span> <span style=color:#57606a>&lt;iostream&gt;</span><span style=color:#57606a>
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> T<span style=color:#1f2328>,</span> std<span style=color:#0550ae>::</span>size_t N<span style=color:#1f2328>,</span> std<span style=color:#0550ae>::</span>size_t<span style=color:#1f2328>...</span> Is<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> print_array<span style=color:#1f2328>(</span><span style=color:#cf222e>const</span> std<span style=color:#0550ae>::</span>array<span style=color:#0550ae>&lt;</span>T<span style=color:#1f2328>,</span> N<span style=color:#0550ae>&gt;&amp;</span> arr<span style=color:#1f2328>,</span> std<span style=color:#0550ae>::</span>index_sequence<span style=color:#0550ae>&lt;</span>Is<span style=color:#1f2328>...</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>((</span>std<span style=color:#0550ae>::</span>cout <span style=color:#0550ae>&lt;&lt;</span> arr<span style=color:#1f2328>[</span>Is<span style=color:#1f2328>]</span> <span style=color:#0550ae>&lt;&lt;</span> <span style=color:#0a3069>&#34; &#34;</span><span style=color:#1f2328>),</span> <span style=color:#1f2328>...);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>main</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    std<span style=color:#0550ae>::</span>array<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>4</span><span style=color:#0550ae>&gt;</span> arr <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>10</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>20</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>30</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>40</span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>    print_array<span style=color:#1f2328>(</span>arr<span style=color:#1f2328>,</span> std<span style=color:#0550ae>::</span>make_index_sequence<span style=color:#0550ae>&lt;</span>arr<span style=color:#1f2328>.</span>size<span style=color:#1f2328>()</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>{});</span> <span style=color:#57606a>// 10 20 30 40
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=总结>总结</h3><ul><li><p><strong>TypeList 与 IndexSequence 配合</strong></p><ul><li>用索引序列访问类型列表或元组。</li></ul></li><li><p><strong>值列表 Fold/累加</strong></p><ul><li>用整数序列进行编译期求和、乘积等。</li></ul></li><li><p><strong>递归元函数</strong></p><ul><li>通过 TypeList 递归处理每个类型，实现条件筛选或类型转换。</li></ul></li></ul></section><footer class=article-footer></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=[".main-article",".widget--toc"];e.forEach(e=>{const t=document.querySelector(e);t&&renderMathInElement(t,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})})</script></article><footer class=site-footer><section class=copyright>&copy;
2025 crackhopper的技术博客</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.32.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.0fcb739c1f88ce461c9640077fd21d8ce903946f1aef209dd01192827d26a90c.js defer></script><script type=text/javascript src=/ts/custom.fb6397326fc458b8ae775aee18e0a0ae80628aec9c216e7e90c79bb0486cb0e3.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>
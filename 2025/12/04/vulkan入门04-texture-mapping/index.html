<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="\n纹理映射，熟悉OGL和DX的，对这个功能并不陌生。在传统的API中，相对来说使用方式比较简单也比较固定。在vulkan中：\n创建Image对象（类似创建Buffer，需要绑定 VkDeviceMemory） 读取图片并上传（使用图片库读取，使用 vkMapMemory/vkUnmapMemory，转化 layout :借助pipeline barrier同步），创建 TextureImage 和 TextureImageView 创建 TextureSampler (指定过滤、address mode等) 创建 Descriptor (类似UBO的步骤，但类型为 COMBINED_IMAGE_SAMPLER) 其他额外步骤：增加纹理坐标，修改InputVertex配置；修改Vertex数据；修改 Vertex Shader （读取并传递纹理坐标）；修改 FragmentShader (读取 Descriptor绑定的 sampler，进行纹理采样)\n"><title>Vulkan入门04-Texture mapping</title><link rel=canonical href=https://crackhopper.github.io/2025/12/04/vulkan%E5%85%A5%E9%97%A804-texture-mapping/><link rel=stylesheet href=/scss/style.min.4d36f8dc1fd48129e1635deb4b8eb2870fa09474f7280c4cb606d40b2526994b.css><meta property='og:title' content="Vulkan入门04-Texture mapping"><meta property='og:description' content="\n纹理映射，熟悉OGL和DX的，对这个功能并不陌生。在传统的API中，相对来说使用方式比较简单也比较固定。在vulkan中：\n创建Image对象（类似创建Buffer，需要绑定 VkDeviceMemory） 读取图片并上传（使用图片库读取，使用 vkMapMemory/vkUnmapMemory，转化 layout :借助pipeline barrier同步），创建 TextureImage 和 TextureImageView 创建 TextureSampler (指定过滤、address mode等) 创建 Descriptor (类似UBO的步骤，但类型为 COMBINED_IMAGE_SAMPLER) 其他额外步骤：增加纹理坐标，修改InputVertex配置；修改Vertex数据；修改 Vertex Shader （读取并传递纹理坐标）；修改 FragmentShader (读取 Descriptor绑定的 sampler，进行纹理采样)\n"><meta property='og:url' content='https://crackhopper.github.io/2025/12/04/vulkan%E5%85%A5%E9%97%A804-texture-mapping/'><meta property='og:site_name' content='crackhopper的技术博客'><meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:tag' content='vulkan'><meta property='article:tag' content='texture'><meta property='article:tag' content='sampler'><meta property='article:tag' content='descriptor'><meta property='article:published_time' content='2025-12-04T09:51:00+08:00'><meta property='article:modified_time' content='2025-12-04T09:51:00+08:00'><meta name=twitter:title content="Vulkan入门04-Texture mapping"><meta name=twitter:description content="\n纹理映射，熟悉OGL和DX的，对这个功能并不陌生。在传统的API中，相对来说使用方式比较简单也比较固定。在vulkan中：\n创建Image对象（类似创建Buffer，需要绑定 VkDeviceMemory） 读取图片并上传（使用图片库读取，使用 vkMapMemory/vkUnmapMemory，转化 layout :借助pipeline barrier同步），创建 TextureImage 和 TextureImageView 创建 TextureSampler (指定过滤、address mode等) 创建 Descriptor (类似UBO的步骤，但类型为 COMBINED_IMAGE_SAMPLER) 其他额外步骤：增加纹理坐标，修改InputVertex配置；修改Vertex数据；修改 Vertex Shader （读取并传递纹理坐标）；修改 FragmentShader (读取 Descriptor绑定的 sampler，进行纹理采样)\n"><link rel=stylesheet href=/css/custom.css></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_337fe2b325ec916d.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>crackhopper的技术博客</a></h1><h2 class=site-description>C++, Graphics, Game, AI/ML</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>文章</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于我</span></a></li><li><a href=/projects/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>项目</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky" id=right-sidebar><section class="widget archives toc-widget"><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc id=toc-content><nav id=TableOfContents><ul><li><a href=#图像>图像</a><ul><li><a href=#总体流程概述>总体流程概述</a></li><li><a href=#加载图像-使用-stb-库>加载图像 (使用 stb 库)</a></li><li><a href=#创建-texture-image>创建 Texture Image</a></li><li><a href=#布局转换layout-transitions>布局转换（Layout transitions）</a><ul><li><a href=#关于pipeline概念>关于pipeline概念</a></li></ul></li><li><a href=#复制-buffer-到-image>复制 Buffer 到 Image</a></li><li><a href=#准备-texture-image>准备 Texture Image</a></li></ul></li><li><a href=#texture-image-view>Texture Image View</a></li><li><a href=#采样器-samplers>采样器 (Samplers)</a><ul><li><a href=#基础概念原理>基础概念原理</a></li><li><a href=#创建采样器>创建采样器</a></li></ul></li><li><a href=#使用descriptor-combined-image-sampler>使用Descriptor (combined image sampler)</a><ul><li><a href=#descriptor-set-layout修改-add-sampler-binding>Descriptor set layout修改 (add sampler binding)</a></li><li><a href=#descriptor-pool修改增加这个类别的descriptorcount>Descriptor pool修改(增加这个类别的descriptorCount)</a></li><li><a href=#desciptor-set修改-绑定新的descriptor>Desciptor Set修改 (绑定新的Descriptor)</a></li><li><a href=#顶点数据修改增加纹理坐标>顶点数据修改(增加纹理坐标)</a></li><li><a href=#shader的修改>shader的修改</a></li></ul></li></ul></nav></div></section></aside><button class=toc-float-btn id=toc-float-btn aria-label=展开目录 title=展开目录>
<span class=toc-float-btn-icon></span></button><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/2025/12/04/vulkan%E5%85%A5%E9%97%A804-texture-mapping/>Vulkan入门04-Texture mapping</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2025-12-04T09:51:00+08:00>Dec 04, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>13 minute read</time></div></footer></div></header><section class=article-content><p><img src=/images/Vulkan%E5%85%A5%E9%97%A804-Texture%20mapping-1764816362517.png loading=lazy alt="Vulkan入门04-Texture mapping-1764816362517"></p><p>纹理映射，熟悉OGL和DX的，对这个功能并不陌生。在传统的API中，相对来说使用方式比较简单也比较固定。在vulkan中：</p><ol><li>创建Image对象（类似创建Buffer，需要绑定 VkDeviceMemory）</li><li>读取图片并上传（使用图片库读取，使用 vkMapMemory/vkUnmapMemory，转化 layout :借助pipeline barrier同步），创建 TextureImage 和 TextureImageView</li><li>创建 TextureSampler (指定过滤、address mode等)</li><li>创建 Descriptor (类似UBO的步骤，但类型为 COMBINED_IMAGE_SAMPLER)</li></ol><p>其他额外步骤：增加纹理坐标，修改InputVertex配置；修改Vertex数据；修改 Vertex Shader （读取并传递纹理坐标）；修改 FragmentShader (读取 Descriptor绑定的 sampler，进行纹理采样)</p><h1 id=图像>图像</h1><h2 id=总体流程概述>总体流程概述</h2><ol><li><strong>创建一个 image 对象（VkImage）</strong><ul><li>手动创建，不是 SwapChain 自动生成</li><li>分配 <code>DEVICE_LOCAL</code> 内存并绑定</li><li>指定格式、宽高、tiling（通常 <code>OPTIMAL</code>）这次不是 SwapChain 自动创建</li></ul></li><li><strong>从图片文件读取像素并上传</strong><ul><li>例如 PNG / JPG</li><li>写入 HOST_VISIBLE staging buffer</li><li>使用 vkCmdCopyBufferToImage 拷贝到最终 image</li><li>通过 pipeline barrier 将 image layout 切换到 VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL</li></ul></li><li><strong>创建 image sampler（VkSampler）</strong><ul><li>控制如何采样（过滤、寻址方式、mipmap等）</li></ul></li><li><strong>创建 Combined Image Sampler 描述符</strong><ul><li>描述符作用：将 image 和 sampler 绑定到 shader</li><li>着色器中就可以 <code>sampler2D</code> 读取纹理颜色</li></ul></li></ol><p><strong>为什么要用Staging Buffer？</strong></p><ul><li>CPU → staging buffer（HOST_VISIBLE）</li><li>staging buffer → GPU image（DEVICE_LOCAL）
原因：GPU 专用内存（DEVICE_LOCAL）<strong>CPU 无法直接写</strong> 。staging buffer 是 CPU 可见的，用来做中转。（所以想要将数据复制到更高性能的位置，不得不用这个中转）</li></ul><p>这里我有个核心疑问，<strong>如果某个纹理是每帧都更新的，那是不是不需要用 staging buffer 转到 DEVICE_LOCAL ？</strong> 。AI帮我做了如下回答：</p><ul><li>情况一：CPU 每帧更新（最常见）<ul><li>思路：“既然每帧都要改，那就别再拷来拷去了”。</li><li>做法：创建 <code>VkImage</code>；内存类型：<code>HOST_VISIBLE | HOST_COHERENT</code>；tiling：<code>VK_IMAGE_TILING_LINEAR</code>；直接 <code>vkMapMemory()</code> → 写像素；- layout：<code>SHADER_READ_ONLY_OPTIMAL</code> 或 GENERAL</li><li>特点：不用 staging buffer，没有copy命令。</li><li>代价：GPU访问慢；可能不能sampler；无mipmap</li><li>适合：小且频繁更新的纹理。</li></ul></li><li>情况二：CPU 每帧更新，但纹理很大 （比如高清视频、大型动态噪声）<ul><li>思路：拷贝有 DMA / 专用路径；GPU 采样效率差距巨大；多帧拷贝摊销成本</li><li>做法：还是用 staging buffer → DEVICE_LOCAL image</li></ul></li><li>情况三：GPU 每帧更新（最优路径）<ul><li>思路 ：直接在DEVICE_LOCAL的图像上操作</li><li>做法：image：<code>DEVICE_LOCAL</code>；layout：<code>GENERAL</code> / <code>STORAGE</code>；compute shader 写；fragment shader 读</li><li>特点：不需要staging buffer；不需要CPU干预；性能最好</li></ul></li></ul><p>当然，出了staging buffer，还有一个叫staging image的概念。简单来说，在 Vulkan 中你只有两种 image 可选：</p><div class=table-wrapper><table><thead><tr><th>image 类型</th><th>CPU</th><th>GPU</th></tr></thead><tbody><tr><td>LINEAR tiling</td><td>✅ 可写</td><td>❌ 访问慢 / 受限</td></tr><tr><td>OPTIMAL tiling</td><td>❌ 不可写</td><td>✅ 采样最快</td></tr></tbody></table></div><p><strong>不存在一种“CPU 可写 + GPU 高效采样”的 image</strong> 。而支持CPU可写的这种image，也叫staging image（这是一种口语化的描述，指的是<code>HOST_VISIBLE + LINEAR tiling</code> 的image）， 主要用来做CPU侧的一些操作和调试工作。</p><p>而使用staging buffer足够，很多GPU硬件层会优化从 staging buffer 到 GPU image的复制动作。</p><p>对图像来说，有一些额外需要注意的点。就是 <code>layouts</code> ，描述像素在memory中的组织方式。不同的操作对于不同的layout来说，性能是不一样的：</p><div class=table-wrapper><table><thead><tr><th>Layout</th><th>用途</th></tr></thead><tbody><tr><td><code>VK_IMAGE_LAYOUT_PRESENT_SRC_KHR</code></td><td>用来显示到屏幕（交换链）</td></tr><tr><td><code>VK_IMAGE_LAYOUT_COLOR_ATTACHMENT_OPTIMAL</code></td><td>作为颜色附件，被 fragment shader 写</td></tr><tr><td><code>VK_IMAGE_LAYOUT_TRANSFER_SRC_OPTIMAL</code></td><td>作为拷贝源</td></tr><tr><td><code>VK_IMAGE_LAYOUT_TRANSFER_DST_OPTIMAL</code></td><td>作为拷贝目标</td></tr><tr><td><code>VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL</code></td><td><strong>供 shader 采样纹理用（非常关键）</strong></td></tr></tbody></table></div><p>一个典型的纹理流程：</p><pre tabindex=0><code>UNDEFINED
→ TRANSFER_DST_OPTIMAL
→ SHADER_READ_ONLY_OPTIMAL
</code></pre><p><strong>Layout 是必须“手动切换”的</strong></p><ul><li>最常用的，来转化image layout的方式是 <code>pipeline barrier</code> 。pipeline barrier 通常主要用来同步对资源的访问操作（比如读之前确保已经写入完成），但它也可以用来做 layout 转化操作。（此外，barrier也可以用来转移 queue family 的 拥有权：比如从 graphics 队列转移到 transfer队列）</li></ul><h2 id=加载图像-使用-stb-库>加载图像 (使用 stb 库)</h2><p>这里，我们需要加载简单的 BMP或者PPM格式。选择使用 <code>stb</code> 库 (<a class=link href=https://github.com/nothings/stb target=_blank rel=noopener>https://github.com/nothings/stb</a>) 。好处是，这个库是一个单文件header库。我们仅需要在构建过程中，添加一个 include directory 就可以了。</p><p>我们的目录结构：</p><img src=/images/Vulkan%E5%85%A5%E9%97%A804-Texture%20mapping-1764816054141.png alt="Vulkan入门04-Texture mapping-1764816054141" width=205x325 loading=lazy><p>我们的cmakelist配置</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#6639ba>set</span><span style=color:#1f2328>(</span><span style=color:#0a3069>SOURCES</span>
</span></span><span style=display:flex><span>    <span style=color:#0a3069>src/main.cpp</span>
</span></span><span style=display:flex><span>    <span style=color:#0a3069>src/utils.cpp</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#6639ba>add_executable</span><span style=color:#1f2328>(</span><span style=color:#0550ae>${</span><span style=color:#953800>PROJECT_NAME</span><span style=color:#0550ae>}</span> <span style=color:#0550ae>${</span><span style=color:#953800>SOURCES</span><span style=color:#0550ae>}</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#6639ba>target_link_libraries</span><span style=color:#1f2328>(</span><span style=color:#0550ae>${</span><span style=color:#953800>PROJECT_NAME</span><span style=color:#0550ae>}</span> <span style=color:#0a3069>PRIVATE</span> <span style=color:#0a3069>Vulkan::Vulkan</span> <span style=color:#0a3069>glfw</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e></span><span style=color:#6639ba>target_include_directories</span><span style=color:#1f2328>(</span><span style=color:#0550ae>${</span><span style=color:#953800>PROJECT_NAME</span><span style=color:#0550ae>}</span> <span style=color:#0a3069>PRIVATE</span> <span style=color:#0a3069>include</span><span style=color:#1f2328>)</span><span style=color:#f6f8fa;background-color:#82071e>
</span></span></span></code></pre></td></tr></table></div></div><p>我们在代码里的使用方式</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>#define STB_IMAGE_IMPLEMENTATION
</span></span></span><span style=display:flex><span><span style=color:#57606a>#include</span> <span style=color:#57606a>&lt;stb/stb_image.h&gt;</span><span style=color:#57606a>
</span></span></span></code></pre></td></tr></table></div></div><p>开始之前，在创建 textures 文件夹，并放入一个 CC0 的image （512 x 512 ） <code>texture.jpg</code> 如下：
<img src=/images/Vulkan%E5%85%A5%E9%97%A804-Texture%20mapping-1764816362517.png alt="Vulkan入门04-Texture mapping-1764816362517" width=142x142 loading=lazy></p><p>接下来我们来创建TextureImage:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>initVulkan</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>    createCommandPool<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    createTextureImage<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    createVertexBuffer<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>VkBuffer stagingBuffer<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>VkDeviceMemory stagingBufferMemory<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>createTextureImage</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>int</span> texWidth<span style=color:#1f2328>,</span> texHeight<span style=color:#1f2328>,</span> texChannels<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 加载图像像素为一个指针
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    stbi_uc<span style=color:#0550ae>*</span> pixels <span style=color:#0550ae>=</span> stbi_load<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;textures/texture.jpg&#34;</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>texWidth<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>texHeight<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>texChannels<span style=color:#1f2328>,</span> STBI_rgb_alpha<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    VkDeviceSize imageSize <span style=color:#0550ae>=</span> texWidth <span style=color:#0550ae>*</span> texHeight <span style=color:#0550ae>*</span> <span style=color:#0550ae>4</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span><span style=color:#0550ae>!</span>pixels<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to load texture image!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 创建vkBuffer
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    createBuffer<span style=color:#1f2328>(</span>imageSize<span style=color:#1f2328>,</span> VK_BUFFER_USAGE_TRANSFER_SRC_BIT<span style=color:#1f2328>,</span> VK_MEMORY_PROPERTY_HOST_VISIBLE_BIT <span style=color:#0550ae>|</span> VK_MEMORY_PROPERTY_HOST_COHERENT_BIT<span style=color:#1f2328>,</span> stagingBuffer<span style=color:#1f2328>,</span> stagingBufferMemory<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 复制pixel到我们的buffer
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	<span style=color:#cf222e>void</span><span style=color:#0550ae>*</span> data<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	vkMapMemory<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> stagingBufferMemory<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> imageSize<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>data<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	    memcpy<span style=color:#1f2328>(</span>data<span style=color:#1f2328>,</span> pixels<span style=color:#1f2328>,</span> <span style=color:#cf222e>static_cast</span><span style=color:#0550ae>&lt;</span>size_t<span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>imageSize<span style=color:#1f2328>));</span>
</span></span><span style=display:flex><span>	vkUnmapMemory<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> stagingBufferMemory<span style=color:#1f2328>);</span>    
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 释放掉我们用stb加载的image
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	stbi_image_free<span style=color:#1f2328>(</span>pixels<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=创建-texture-image>创建 Texture Image</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>// 声明纹理图像对象
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>VkImage textureImage<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 声明纹理图像对应的显存对象
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>VkDeviceMemory textureImageMemory<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 创建图像的通用函数，方便后续多次复用 (类似我们之前用过的createBuffer函数)
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>void</span> <span style=color:#6639ba>createImage</span><span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>uint32_t</span> width<span style=color:#1f2328>,</span> 
</span></span><span style=display:flex><span>	<span style=color:#cf222e>uint32_t</span> height<span style=color:#1f2328>,</span> 
</span></span><span style=display:flex><span>	VkFormat format<span style=color:#1f2328>,</span>  <span style=color:#57606a>// 像素格式，如 R8G8B8A8_SRGB
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	VkImageTiling tiling<span style=color:#1f2328>,</span>  <span style=color:#57606a>// 内存布局 （决定硬件访问效率）
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	VkImageUsageFlags usage<span style=color:#1f2328>,</span>  <span style=color:#57606a>// 用途
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	VkMemoryPropertyFlags properties<span style=color:#1f2328>,</span> <span style=color:#57606a>// 内存属性 （如，HOST_VISIBLE之类的）
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	VkImage<span style=color:#0550ae>&amp;</span> image<span style=color:#1f2328>,</span>  <span style=color:#57606a>// 输出: 创建好的图像对象
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	VkDeviceMemory<span style=color:#0550ae>&amp;</span> imageMemory <span style=color:#57606a>// 输出: 绑定的显存对象
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    VkImageCreateInfo imageInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>    imageInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_IMAGE_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 图像类型：二维纹理
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    imageInfo<span style=color:#1f2328>.</span>imageType <span style=color:#0550ae>=</span> VK_IMAGE_TYPE_2D<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    imageInfo<span style=color:#1f2328>.</span>extent<span style=color:#1f2328>.</span>width <span style=color:#0550ae>=</span> width<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    imageInfo<span style=color:#1f2328>.</span>extent<span style=color:#1f2328>.</span>height <span style=color:#0550ae>=</span> height<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 图像深度，二维图像为1
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    imageInfo<span style=color:#1f2328>.</span>extent<span style=color:#1f2328>.</span>depth <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// mipmap层数，暂时只用1层
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    imageInfo<span style=color:#1f2328>.</span>mipLevels <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 图像数组层数，单张图片为1
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    imageInfo<span style=color:#1f2328>.</span>arrayLayers <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    imageInfo<span style=color:#1f2328>.</span>format <span style=color:#0550ae>=</span> format<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    imageInfo<span style=color:#1f2328>.</span>tiling <span style=color:#0550ae>=</span> tiling<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// GPU无法直接使用初始数据，第一次写入会覆盖现有内容。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    imageInfo<span style=color:#1f2328>.</span>initialLayout <span style=color:#0550ae>=</span> VK_IMAGE_LAYOUT_UNDEFINED<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    imageInfo<span style=color:#1f2328>.</span>usage <span style=color:#0550ae>=</span> usage<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 如果是多重采样渲染的目标图像，这个值会大于1。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    imageInfo<span style=color:#1f2328>.</span>samples <span style=color:#0550ae>=</span> VK_SAMPLE_COUNT_1_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 独占队列访问（仅图形队列）
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    imageInfo<span style=color:#1f2328>.</span>sharingMode <span style=color:#0550ae>=</span> VK_SHARING_MODE_EXCLUSIVE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>vkCreateImage<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>imageInfo<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>image<span style=color:#1f2328>)</span> <span style=color:#0550ae>!=</span> VK_SUCCESS<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to create image!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 查询图像内存需求
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    VkMemoryRequirements memRequirements<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    vkGetImageMemoryRequirements<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> image<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>memRequirements<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 配置内存分配信息
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    VkMemoryAllocateInfo allocInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>    allocInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_MEMORY_ALLOCATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    allocInfo<span style=color:#1f2328>.</span>allocationSize <span style=color:#0550ae>=</span> memRequirements<span style=color:#1f2328>.</span>size<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    allocInfo<span style=color:#1f2328>.</span>memoryTypeIndex <span style=color:#0550ae>=</span> findMemoryType<span style=color:#1f2328>(</span>memRequirements<span style=color:#1f2328>.</span>memoryTypeBits<span style=color:#1f2328>,</span> properties<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>vkAllocateMemory<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>allocInfo<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>imageMemory<span style=color:#1f2328>)</span> <span style=color:#0550ae>!=</span> VK_SUCCESS<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to allocate image memory!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 将分配好的显存绑定到图像对象上
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    vkBindImageMemory<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> image<span style=color:#1f2328>,</span> imageMemory<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>createTextureImage</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 创建Image。类似createBuffer便利函数
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	createImage<span style=color:#1f2328>(</span>texWidth<span style=color:#1f2328>,</span> texHeight<span style=color:#1f2328>,</span> VK_FORMAT_R8G8B8A8_SRGB<span style=color:#1f2328>,</span> VK_IMAGE_TILING_OPTIMAL<span style=color:#1f2328>,</span> VK_IMAGE_USAGE_TRANSFER_DST_BIT <span style=color:#0550ae>|</span> VK_IMAGE_USAGE_SAMPLED_BIT<span style=color:#1f2328>,</span> VK_MEMORY_PROPERTY_DEVICE_LOCAL_BIT<span style=color:#1f2328>,</span> textureImage<span style=color:#1f2328>,</span> textureImageMemory<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>其中一些细节的解释：
<strong>1. mipLevels（mipmap层数）</strong></p><ul><li>Vulkan不会自动生成 mipmaps，<code>mipLevels</code> 只是告诉 GPU 这个图像预期有多少层 mipmap。</li><li>如果你想使用 mipmaps，有两种方法：<ol><li>预先在 CPU 上生成，然后上传到每层；</li><li>上传原始纹理后，让 GPU 在渲染或 compute pass 中生成（需要额外命令，比如 <code>vkCmdBlitImage</code>）。</li></ol></li><li>存储上，每个 mipmap 层在内存中占用连续空间，但 Vulkan 可以自动计算偏移。</li></ul><p><strong>2. arrayLayers（图像数组层数）</strong></p><ul><li>图像数组允许你把多张图像“叠加”成一个对象。每一层就是一张图像。</li><li>用途：<ul><li><strong>2D纹理数组</strong>：shader里用<code>tex2DArray()</code>访问不同层的纹理</li><li><strong>立方体贴图</strong>：本质上是 6 层 2D 图像（每个面一层）</li></ul></li><li>对普通单张纹理，<code>arrayLayers = 1</code> 就够了。</li></ul><p><strong>3. VK_SHARING_MODE_EXCLUSIVE（独占队列访问）</strong></p><ul><li>解释你提到的两种理解：<ol><li><strong>正确理解</strong>：图像对象一次只能被一个队列家族访问。队列家族外的访问需要显式转移。</li><li><strong>错误理解</strong>：独占模式不会限制队列当前仅能使用这张图像，其他资源不能用。</li></ol></li><li>换句话说：<ul><li><strong>EXCLUSIVE</strong> → 同一时间仅一个队列家族对图像有直接访问权（效率高）</li><li><strong>CONCURRENT</strong> → 多个队列家族可以同时访问（需声明共享队列），但效率略低</li></ul></li></ul><p><strong>这里面 <code>extent.depth</code> 和 <code>arrayLayers</code> 容易混淆，详细展开解释一下：</strong></p><ol><li><strong>depth</strong><ul><li>描述单张图像在 Z 轴方向上的厚度。</li><li>对应 <code>VkImageType = VK_IMAGE_TYPE_3D</code> 时才大于 1，否则 2D 图像 depth 始终为 1。</li><li>决定 shader 中 <code>sampler3D</code> 访问的 z 方向 texel 数量。</li><li>通常和图像本身的数据文件格式有关（比如 3D 体素纹理、体积数据）。</li></ul></li><li><strong>arrayLayers</strong><ul><li>描述图像数组层数，即 GPU 上堆叠的多张二维图像数量。</li><li>对应 2D 图像数组或者立方体贴图（cubemap）。</li><li>shader 可以用 <code>sampler2DArray</code> 或 <code>samplerCube</code> 访问不同的层。</li><li>通常和数据文件个数有关，比如 4 张纹理打包成一张 image array。</li></ul></li><li><strong>depth 和 arrayLayers 是独立维度</strong><ul><li>depth 决定单张图像沿 Z 轴的厚度；</li><li>arrayLayers 决定图像数组的数量；</li><li>它们可以组合使用，比如 3D 图像数组（少见）：<ul><li>depth > 1 → 单张 3D 图像</li><li>arrayLayers > 1 → 多个 3D 图像堆叠</li></ul></li></ul></li></ol><p><strong>记忆技巧</strong>：</p><ul><li><strong>depth</strong> → 单张图像的“厚度”</li><li><strong>arrayLayers</strong> → 多张图像的“堆叠”</li></ul><h2 id=布局转换layout-transitions>布局转换（Layout transitions）</h2><p>重构部分代码：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>VkCommandBuffer <span style=color:#6639ba>beginSingleTimeCommands</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    VkCommandBufferAllocateInfo allocInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>    allocInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_COMMAND_BUFFER_ALLOCATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    allocInfo<span style=color:#1f2328>.</span>level <span style=color:#0550ae>=</span> VK_COMMAND_BUFFER_LEVEL_PRIMARY<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    allocInfo<span style=color:#1f2328>.</span>commandPool <span style=color:#0550ae>=</span> commandPool<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    allocInfo<span style=color:#1f2328>.</span>commandBufferCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    VkCommandBuffer commandBuffer<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    vkAllocateCommandBuffers<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>allocInfo<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>commandBuffer<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    VkCommandBufferBeginInfo beginInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>    beginInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_COMMAND_BUFFER_BEGIN_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    beginInfo<span style=color:#1f2328>.</span>flags <span style=color:#0550ae>=</span> VK_COMMAND_BUFFER_USAGE_ONE_TIME_SUBMIT_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    vkBeginCommandBuffer<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>beginInfo<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> commandBuffer<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>endSingleTimeCommands</span><span style=color:#1f2328>(</span>VkCommandBuffer commandBuffer<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    vkEndCommandBuffer<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    VkSubmitInfo submitInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>    submitInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_SUBMIT_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    submitInfo<span style=color:#1f2328>.</span>commandBufferCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    submitInfo<span style=color:#1f2328>.</span>pCommandBuffers <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>commandBuffer<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    vkQueueSubmit<span style=color:#1f2328>(</span>graphicsQueue<span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>submitInfo<span style=color:#1f2328>,</span> VK_NULL_HANDLE<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    vkQueueWaitIdle<span style=color:#1f2328>(</span>graphicsQueue<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    vkFreeCommandBuffers<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> commandPool<span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>commandBuffer<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 对于这种一次性执行的command（不是启动pipeline执行渲染），我们都可以重构一下
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>void</span> <span style=color:#6639ba>copyBuffer</span><span style=color:#1f2328>(</span>VkBuffer srcBuffer<span style=color:#1f2328>,</span> VkBuffer dstBuffer<span style=color:#1f2328>,</span> VkDeviceSize size<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    VkCommandBuffer commandBuffer <span style=color:#0550ae>=</span> beginSingleTimeCommands<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    VkBufferCopy copyRegion<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>    copyRegion<span style=color:#1f2328>.</span>size <span style=color:#0550ae>=</span> size<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    vkCmdCopyBuffer<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>,</span> srcBuffer<span style=color:#1f2328>,</span> dstBuffer<span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>copyRegion<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    endSingleTimeCommands<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>对于我们要进行布局转化，我们就可以写为：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>transitionImageLayout</span><span style=color:#1f2328>(</span>VkImage image<span style=color:#1f2328>,</span> VkFormat format<span style=color:#1f2328>,</span> VkImageLayout oldLayout<span style=color:#1f2328>,</span> VkImageLayout newLayout<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    VkCommandBuffer commandBuffer <span style=color:#0550ae>=</span> beginSingleTimeCommands<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 定义一个图像内存屏障结构，用于描述访问依赖和布局转换
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	VkImageMemoryBarrier barrier<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>	barrier<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_IMAGE_MEMORY_BARRIER<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 指定旧布局和新布局
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	barrier<span style=color:#1f2328>.</span>oldLayout <span style=color:#0550ae>=</span> oldLayout<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	barrier<span style=color:#1f2328>.</span>newLayout <span style=color:#0550ae>=</span> newLayout<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 如果图像需要在不同队列族之间转移所有权，用下面字段指定
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#57606a>// 这里不需要队列转移，所以使用 VK_QUEUE_FAMILY_IGNORED
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	barrier<span style=color:#1f2328>.</span>srcQueueFamilyIndex <span style=color:#0550ae>=</span> VK_QUEUE_FAMILY_IGNORED<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	barrier<span style=color:#1f2328>.</span>dstQueueFamilyIndex <span style=color:#0550ae>=</span> VK_QUEUE_FAMILY_IGNORED<span style=color:#1f2328>;</span>	
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 指定操作的图像	
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	barrier<span style=color:#1f2328>.</span>image <span style=color:#0550ae>=</span> image<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// subresourceRange 指定影响的图像子资源（mipmap层和数组层）
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	barrier<span style=color:#1f2328>.</span>subresourceRange<span style=color:#1f2328>.</span>aspectMask <span style=color:#0550ae>=</span> VK_IMAGE_ASPECT_COLOR_BIT<span style=color:#1f2328>;</span><span style=color:#57606a>// 操作颜色数据
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	barrier<span style=color:#1f2328>.</span>subresourceRange<span style=color:#1f2328>.</span>baseMipLevel <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span><span style=color:#57606a>// 从第0层mipmap开始
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	barrier<span style=color:#1f2328>.</span>subresourceRange<span style=color:#1f2328>.</span>levelCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span><span style=color:#57606a>// 只影响1层mipmap
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	barrier<span style=color:#1f2328>.</span>subresourceRange<span style=color:#1f2328>.</span>baseArrayLayer <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span><span style=color:#57606a>// 从第0层数组开始
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	barrier<span style=color:#1f2328>.</span>subresourceRange<span style=color:#1f2328>.</span>layerCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span> <span style=color:#57606a>// 只影响1层数组
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 定义源和目标的 pipeline 阶段，用于同步
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	VkPipelineStageFlags sourceStage<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	VkPipelineStageFlags destinationStage<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 判断是哪种布局转换
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	<span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>oldLayout <span style=color:#0550ae>==</span> VK_IMAGE_LAYOUT_UNDEFINED <span style=color:#0550ae>&amp;&amp;</span> newLayout <span style=color:#0550ae>==</span> VK_IMAGE_LAYOUT_TRANSFER_DST_OPTIMAL<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#57606a>// UNDEFINED -&gt; TRANSFER_DST_OPTIMAL
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>        <span style=color:#57606a>// 未定义布局，不需要等待任何操作	
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	    barrier<span style=color:#1f2328>.</span>srcAccessMask <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	    <span style=color:#57606a>// 下一步操作是写入图像
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	    barrier<span style=color:#1f2328>.</span>dstAccessMask <span style=color:#0550ae>=</span> VK_ACCESS_TRANSFER_WRITE_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>		<span style=color:#57606a>// 源阶段为 pipeline 开头 （stage不能为0，必须是有效阶段；所以才这么设置）
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	    sourceStage <span style=color:#0550ae>=</span> VK_PIPELINE_STAGE_TOP_OF_PIPE_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	    <span style=color:#57606a>// 目标阶段为 transfer 阶段
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	    destinationStage <span style=color:#0550ae>=</span> VK_PIPELINE_STAGE_TRANSFER_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	    
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span> <span style=color:#cf222e>else</span> <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>oldLayout <span style=color:#0550ae>==</span> VK_IMAGE_LAYOUT_TRANSFER_DST_OPTIMAL <span style=color:#0550ae>&amp;&amp;</span> newLayout <span style=color:#0550ae>==</span> VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#57606a>// TRANSFER_DST_OPTIMAL -&gt; SHADER_READ_ONLY_OPTIMAL
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>        <span style=color:#57606a>// 确保 transfer 写入完成后，shader 才能读取	
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	    barrier<span style=color:#1f2328>.</span>srcAccessMask <span style=color:#0550ae>=</span> VK_ACCESS_TRANSFER_WRITE_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	    barrier<span style=color:#1f2328>.</span>dstAccessMask <span style=color:#0550ae>=</span> VK_ACCESS_SHADER_READ_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>		<span style=color:#57606a>// 源阶段：写入阶段完成
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	    sourceStage <span style=color:#0550ae>=</span> VK_PIPELINE_STAGE_TRANSFER_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	    <span style=color:#57606a>// 目标阶段：在片段着色器读取之前
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	    destinationStage <span style=color:#0550ae>=</span> VK_PIPELINE_STAGE_FRAGMENT_SHADER_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span> <span style=color:#cf222e>else</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>		<span style=color:#57606a>// 其他布局转换不支持
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	    <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>invalid_argument<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;unsupported layout transition!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 当然，layout transition操作，需要都记录到一个 commandBuffer，barrier才会生效。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	vkCmdPipelineBarrier<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>	    commandBuffer<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>	    sourceStage<span style=color:#1f2328>,</span> destinationStage<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>	    <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>	    <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>	    <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>	    <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>barrier
</span></span><span style=display:flex><span>	<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	 endSingleTimeCommands<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>createTextureImage</span><span style=color:#1f2328>(){</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>    transitionImageLayout<span style=color:#1f2328>(</span>textureImage<span style=color:#1f2328>,</span> VK_FORMAT_R8G8B8A8_SRGB<span style=color:#1f2328>,</span> VK_IMAGE_LAYOUT_TRANSFER_DST_OPTIMAL<span style=color:#1f2328>,</span> VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>cleanup</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    cleanupSwapChain<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    vkDestroyImage<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> textureImage<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    vkFreeMemory<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> textureImageMemory<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>回顾之前barrier的含义理解描述：</p><p>一句话解释: <strong>在 src stage / access 完成前，dst stage / access 不能执行</strong></p><p>具体执行，举例子：</p><p>当我们执行布局转换（从 DST_OPTIMAL 到 SHARED_READ_ONLY_OPTIMAL）</p><ul><li>当pipeline（隐式的），<strong>将要</strong> 进入到 <code>VK_ACCESS_SHADER_READ_BIT</code> 阶段，执行 <code>VK_PIPELINE_STAGE_FRAGMENT_SHADER_BIT</code> 的时候。</li><li>检查barrier：<strong>是否正在</strong> <code>VK_ACCESS_TRANSFER_WRITE_BIT</code> 阶段，正在执行 <code>VK_ACCESS_TRANSFER_WRITE_BIT</code> 。</li><li>如果是，屏障生效，等待执行上一步操作执行结束。</li></ul><h3 id=关于pipeline概念>关于pipeline概念</h3><p>在 Vulkan 中，“pipeline”分为很多类型，不只是图形渲染 pipeline：</p><div class=table-wrapper><table><thead><tr><th>Pipeline 类型</th><th>用途</th></tr></thead><tbody><tr><td><strong>Graphics Pipeline</strong></td><td>渲染到 framebuffer，包括 vertex/fragment shader、光栅化等</td></tr><tr><td><strong>Compute Pipeline</strong></td><td>GPU 上执行 compute shader</td></tr><tr><td><strong>Transfer / Blit</strong></td><td>并不是必须显式创建 pipeline，但 GPU 在 transfer 阶段也有自己的执行管线，Vulkan 将它抽象为 pipeline stage，例如 <code>VK_PIPELINE_STAGE_TRANSFER_BIT</code></td></tr></tbody></table></div><p>从方便理解的角度：GPU执行指令的时候，要么是显示创建了pipeline。要么GPU相当于隐式创建pipeline，也会记录更新stage和access的flag。</p><ul><li><p><strong>显式 pipeline（Explicit Pipeline）</strong></p><ul><li>你自己创建的 Graphics Pipeline 或 Compute Pipeline。</li><li>包括 shader、光栅化状态、混合状态等。</li><li>当 GPU 执行 draw/dispatch 命令时，会启动这个 pipeline。</li></ul></li><li><p><strong>隐式 pipeline（Implicit Stage）</strong></p><ul><li>对于 copy / layout transition / buffer fill 等操作，并不需要用户创建 pipeline 对象。</li><li>GPU 内部有 <strong>Transfer 阶段</strong>、<strong>Host 写阶段</strong> 等。</li><li>Vulkan 使用 pipeline stage 标记（<code>VK_PIPELINE_STAGE_TRANSFER_BIT</code> 等）和访问掩码（<code>ACCESS_TRANSFER_WRITE_BIT</code> 等）来描述这些操作。</li><li>barrier 的作用就是告诉 GPU：“在 src stage / access 完成前，dst stage / access 不能执行”。</li></ul></li></ul><p>当然，需要注意的是：barrier 只对 <strong>同一命令缓冲区内的顺序</strong>起作用。如果命令缓冲区被反复提交（比如 drawFrame 的动作），那么整体的函数需要做 <strong>防止重入</strong> 的操作：</p><ul><li>对同一资源（如纹理图像）在不同命令缓冲区/提交中进行 layout transition，需要用 <strong>semaphore/event 或者 fence</strong> 来保证前一次操作完成。</li><li>CPU 层面也可以用锁（mutex）来保证同一张图片不会被重复 layout transition。</li><li>Vulkan 常用做法：<ul><li><code>FRAMES_IN_FLIGHT</code> 分组，每帧使用独立的命令缓冲区和资源副本。</li><li>每帧完成前，GPU 会通过 <code>vkWaitForFences</code> / <code>vkQueueSubmit</code> 的依赖保证安全。</li></ul></li></ul><h2 id=复制-buffer-到-image>复制 Buffer 到 Image</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>copyBufferToImage</span><span style=color:#1f2328>(</span>VkBuffer buffer<span style=color:#1f2328>,</span> VkImage image<span style=color:#1f2328>,</span> <span style=color:#cf222e>uint32_t</span> width<span style=color:#1f2328>,</span> <span style=color:#cf222e>uint32_t</span> height<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    VkCommandBuffer commandBuffer <span style=color:#0550ae>=</span> beginSingleTimeCommands<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	VkBufferImageCopy region<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>	region<span style=color:#1f2328>.</span>bufferOffset <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	region<span style=color:#1f2328>.</span>bufferRowLength <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	region<span style=color:#1f2328>.</span>bufferImageHeight <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	region<span style=color:#1f2328>.</span>imageSubresource<span style=color:#1f2328>.</span>aspectMask <span style=color:#0550ae>=</span> VK_IMAGE_ASPECT_COLOR_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	region<span style=color:#1f2328>.</span>imageSubresource<span style=color:#1f2328>.</span>mipLevel <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	region<span style=color:#1f2328>.</span>imageSubresource<span style=color:#1f2328>.</span>baseArrayLayer <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	region<span style=color:#1f2328>.</span>imageSubresource<span style=color:#1f2328>.</span>layerCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	region<span style=color:#1f2328>.</span>imageOffset <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>	region<span style=color:#1f2328>.</span>imageExtent <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	    width<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>	    height<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>	    <span style=color:#0550ae>1</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	vkCmdCopyBufferToImage<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>	    commandBuffer<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>	    buffer<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>	    image<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>	    VK_IMAGE_LAYOUT_TRANSFER_DST_OPTIMAL<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>	    <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>	    <span style=color:#0550ae>&amp;</span>region
</span></span><span style=display:flex><span>	<span style=color:#1f2328>);</span>	
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    endSingleTimeCommands<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p> Right now we&rsquo;re only copying one chunk of pixels to the whole image, but it&rsquo;s possible to specify an array of <a class=link href=https://www.khronos.org/registry/vulkan/specs/1.0/man/html/VkBufferImageCopy.html target=_blank rel=noopener><code>VkBufferImageCopy</code></a> to perform many different copies from this buffer to the image in one operation.</p><h2 id=准备-texture-image>准备 Texture Image</h2><p>仍然是修改 <code>createTextureImage</code> 函数，在后面增加下面代码：</p><p>buffer要复制到texture image，需要两个步骤：</p><ul><li>texture image的layout转化为  <code>VK_IMAGE_LAYOUT_TRANSFER_DST_OPTIMAL</code></li><li>执行复制： Execute the buffer to image copy operation</li><li>texture image的layout转化为 <code>VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL</code> ；方便shader使用。</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>createTextureImage</span><span style=color:#1f2328>(){</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>...</span> 
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	transitionImageLayout<span style=color:#1f2328>(</span>textureImage<span style=color:#1f2328>,</span> VK_FORMAT_R8G8B8A8_SRGB<span style=color:#1f2328>,</span> VK_IMAGE_LAYOUT_UNDEFINED<span style=color:#1f2328>,</span> VK_IMAGE_LAYOUT_TRANSFER_DST_OPTIMAL<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	copyBufferToImage<span style=color:#1f2328>(</span>stagingBuffer<span style=color:#1f2328>,</span> textureImage<span style=color:#1f2328>,</span> <span style=color:#cf222e>static_cast</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>uint32_t</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>texWidth<span style=color:#1f2328>),</span> <span style=color:#cf222e>static_cast</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>uint32_t</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>texHeight<span style=color:#1f2328>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 当然最后还要cleanup
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    transitionImageLayout<span style=color:#1f2328>(</span>textureImage<span style=color:#1f2328>,</span> VK_FORMAT_R8G8B8A8_SRGB<span style=color:#1f2328>,</span> VK_IMAGE_LAYOUT_TRANSFER_DST_OPTIMAL<span style=color:#1f2328>,</span> VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    vkDestroyBuffer<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> stagingBuffer<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    vkFreeMemory<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> stagingBufferMemory<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=texture-image-view>Texture Image View</h1><p>为了访问图像，我们需要 ImageView</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>VkImageView textureImageView<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> initVulkan<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>    createTextureImage<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    createTextureImageView<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    createVertexBuffer<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>VkImageView createImageView<span style=color:#1f2328>(</span>VkImage image<span style=color:#1f2328>,</span> VkFormat format<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    VkImageViewCreateInfo viewInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>    viewInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_IMAGE_VIEW_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    viewInfo<span style=color:#1f2328>.</span>image <span style=color:#0550ae>=</span> image<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    viewInfo<span style=color:#1f2328>.</span>viewType <span style=color:#0550ae>=</span> VK_IMAGE_VIEW_TYPE_2D<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    viewInfo<span style=color:#1f2328>.</span>format <span style=color:#0550ae>=</span> format<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    viewInfo<span style=color:#1f2328>.</span>subresourceRange<span style=color:#1f2328>.</span>aspectMask <span style=color:#0550ae>=</span> VK_IMAGE_ASPECT_COLOR_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    viewInfo<span style=color:#1f2328>.</span>subresourceRange<span style=color:#1f2328>.</span>baseMipLevel <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    viewInfo<span style=color:#1f2328>.</span>subresourceRange<span style=color:#1f2328>.</span>levelCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    viewInfo<span style=color:#1f2328>.</span>subresourceRange<span style=color:#1f2328>.</span>baseArrayLayer <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    viewInfo<span style=color:#1f2328>.</span>subresourceRange<span style=color:#1f2328>.</span>layerCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    VkImageView imageView<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>vkCreateImageView<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>viewInfo<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>imageView<span style=color:#1f2328>)</span> <span style=color:#0550ae>!=</span> VK_SUCCESS<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to create image view!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> imageView<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>createTextureImageView</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    textureImageView <span style=color:#0550ae>=</span> createImageView<span style=color:#1f2328>(</span>textureImage<span style=color:#1f2328>,</span> VK_FORMAT_R8G8B8A8_SRGB<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>createImageViews</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    swapChainImageViews<span style=color:#1f2328>.</span>resize<span style=color:#1f2328>(</span>swapChainImages<span style=color:#1f2328>.</span>size<span style=color:#1f2328>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>for</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>uint32_t</span> i <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span> i <span style=color:#0550ae>&lt;</span> swapChainImages<span style=color:#1f2328>.</span>size<span style=color:#1f2328>();</span> i<span style=color:#0550ae>++</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        swapChainImageViews<span style=color:#1f2328>[</span>i<span style=color:#1f2328>]</span> <span style=color:#0550ae>=</span> createImageView<span style=color:#1f2328>(</span>swapChainImages<span style=color:#1f2328>[</span>i<span style=color:#1f2328>],</span> swapChainImageFormat<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>cleanup</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    cleanupSwapChain<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    vkDestroyImageView<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> textureImageView<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    vkDestroyImage<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> textureImage<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    vkFreeMemory<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> textureImageMemory<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=采样器-samplers>采样器 (Samplers)</h1><h2 id=基础概念原理>基础概念原理</h2><p>在shader中，虽然可以直接访问 texels，但更多使用sampler来访问（这样sampler内部可以支持一些采样算法）。</p><p>假设，texture的一个像素，对应到多个fragments 时（oversampling）。那么使用采样器，会有平滑效果：（这里oversampling过采样指的是，fragment采样的时候，对同个texel多次采样）</p><p><img src=/images/Vulkan%E5%85%A5%E9%97%A804-Texture%20mapping-1764823642196.png loading=lazy alt="Vulkan入门04-Texture mapping-1764823642196"></p><p>另一个方面，欠采样（undersampling）也会产生问题，即，一个fragment覆盖多个texel。会产生 artifacts （走样）。欠采样的本质：<strong>欠采样</strong>发生在 <strong>fragment 的采样率不足以覆盖它所映射的 texel 区域</strong></p><ul><li>典型情况：<ol><li><strong>Nearest sampling</strong>：每个 fragment 只采样 1 个 texel<ul><li>fragment 的颜色完全依赖于采样点命中的 texel</li><li>导致 aliasing / 锯齿 / blocky artifacts</li></ul></li><li><strong>部分采样 + 融合</strong>：fragment 对多个 texel 做采样，但采样点太少<ul><li>结果是丢掉纹理细节</li><li>也会产生 aliasing 或模糊</li></ul></li></ol></li></ul><p>下面是一个结果。（解决方法是各向异性采样 anisotropic filtering：原理：针对纹理区域为长方形条的fragment， <strong>沿长轴方向增加采样点</strong> → 多个 texel 加权融合；短轴方向采样少 → 节约计算）</p><p><img src=/images/Vulkan%E5%85%A5%E9%97%A804-Texture%20mapping-1764824965915.png loading=lazy alt="Vulkan入门04-Texture mapping-1764824965915"></p><p>此外，采样器也会定义超出正常范围之外的位置如何填充颜色，（address mode）：
<img src=/images/Vulkan%E5%85%A5%E9%97%A804-Texture%20mapping-1764825031307.png loading=lazy alt="Vulkan入门04-Texture mapping-1764825031307"></p><h2 id=创建采样器>创建采样器</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>initVulkan</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>    createTextureImage<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    createTextureImageView<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    createTextureSampler<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> createTextureSampler<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	VkSamplerCreateInfo samplerInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>	samplerInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_SAMPLER_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 针对 oversampling (简记：纹理过小)
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	samplerInfo<span style=color:#1f2328>.</span>magFilter <span style=color:#0550ae>=</span> VK_FILTER_LINEAR<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 针对 undersampling (简记：纹理过大)
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	samplerInfo<span style=color:#1f2328>.</span>minFilter <span style=color:#0550ae>=</span> VK_FILTER_LINEAR<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 超出区域的采样方式
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	samplerInfo<span style=color:#1f2328>.</span>addressModeU <span style=color:#0550ae>=</span> VK_SAMPLER_ADDRESS_MODE_REPEAT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	samplerInfo<span style=color:#1f2328>.</span>addressModeV <span style=color:#0550ae>=</span> VK_SAMPLER_ADDRESS_MODE_REPEAT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	samplerInfo<span style=color:#1f2328>.</span>addressModeW <span style=color:#0550ae>=</span> VK_SAMPLER_ADDRESS_MODE_REPEAT<span style=color:#1f2328>;</span>	
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 各向异性过滤
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	samplerInfo<span style=color:#1f2328>.</span>anisotropyEnable <span style=color:#0550ae>=</span> VK_TRUE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 需要查询设备获取最大各向异性采样的限制
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	VkPhysicalDeviceProperties properties<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>	vkGetPhysicalDeviceProperties<span style=color:#1f2328>(</span>physicalDevice<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>properties<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 最多使用的采样点的限制
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	samplerInfo<span style=color:#1f2328>.</span>maxAnisotropy <span style=color:#0550ae>=</span> properties<span style=color:#1f2328>.</span>limits<span style=color:#1f2328>.</span>maxSamplerAnisotropy<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 如果gpu不支持，那么我们也要关闭这个功能
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	<span style=color:#57606a>// samplerInfo.anisotropyEnable = VK_FALSE;
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	<span style=color:#57606a>// samplerInfo.maxAnisotropy = 1.0f;
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 仅在 address mode 是 clamp to border的时候有效。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	samplerInfo<span style=color:#1f2328>.</span>borderColor <span style=color:#0550ae>=</span> VK_BORDER_COLOR_INT_OPAQUE_BLACK<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 使用sampler的坐标范围
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	<span style=color:#57606a>// - True : [0,texWidth) x [0, texHeight)
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	<span style=color:#57606a>// - False : [0,1) x [0,1)
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	samplerInfo<span style=color:#1f2328>.</span>unnormalizedCoordinates <span style=color:#0550ae>=</span> VK_FALSE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 采样结果用来先做 Compare OP，随后的结果用来做filtering
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	<span style=color:#57606a>// 常用来做 percentage closer filtering (PCF)
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	<span style=color:#57606a>// https://developer.nvidia.com/gpugems/gpugems/part-ii-lighting-and-shadows/chapter-11-shadow-map-antialiasing
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	samplerInfo<span style=color:#1f2328>.</span>compareEnable <span style=color:#0550ae>=</span> VK_FALSE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	samplerInfo<span style=color:#1f2328>.</span>compareOp <span style=color:#0550ae>=</span> VK_COMPARE_OP_ALWAYS<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// mipmap滤波配置，暂时不开启
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	samplerInfo<span style=color:#1f2328>.</span>mipmapMode <span style=color:#0550ae>=</span> VK_SAMPLER_MIPMAP_MODE_LINEAR<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	samplerInfo<span style=color:#1f2328>.</span>mipLodBias <span style=color:#0550ae>=</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	samplerInfo<span style=color:#1f2328>.</span>minLod <span style=color:#0550ae>=</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	samplerInfo<span style=color:#1f2328>.</span>maxLod <span style=color:#0550ae>=</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>;</span>	
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>vkCreateSampler<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>samplerInfo<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>textureSampler<span style=color:#1f2328>)</span> <span style=color:#0550ae>!=</span> VK_SUCCESS<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to create texture sampler!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>	
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>cleanup</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    cleanupSwapChain<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    vkDestroySampler<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> textureSampler<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    vkDestroyImageView<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> textureImageView<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 创建的时候开启 anisotropy 这个能力
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>void</span> <span style=color:#6639ba>createLogicalDevice</span><span style=color:#1f2328>(){</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>	VkPhysicalDeviceFeatures deviceFeatures<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>	deviceFeatures<span style=color:#1f2328>.</span>samplerAnisotropy <span style=color:#0550ae>=</span> VK_TRUE<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 通常现代GPU都有这个能力
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>bool</span> <span style=color:#6639ba>isDeviceSuitable</span><span style=color:#1f2328>(</span>VkPhysicalDevice device<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    VkPhysicalDeviceFeatures supportedFeatures<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    vkGetPhysicalDeviceFeatures<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>supportedFeatures<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> indices<span style=color:#1f2328>.</span>isComplete<span style=color:#1f2328>()</span> <span style=color:#0550ae>&amp;&amp;</span> extensionsSupported <span style=color:#0550ae>&amp;&amp;</span> swapChainAdequate <span style=color:#0550ae>&amp;&amp;</span> supportedFeatures<span style=color:#1f2328>.</span>samplerAnisotropy<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=使用descriptor-combined-image-sampler>使用Descriptor (combined image sampler)</h1><h2 id=descriptor-set-layout修改-add-sampler-binding>Descriptor set layout修改 (add sampler binding)</h2><p>函数 <code>createDescriptorSetLayout</code> 修改</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>VkDescriptorSetLayoutBinding samplerLayoutBinding<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>samplerLayoutBinding<span style=color:#1f2328>.</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>samplerLayoutBinding<span style=color:#1f2328>.</span>descriptorCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>samplerLayoutBinding<span style=color:#1f2328>.</span>descriptorType <span style=color:#0550ae>=</span> VK_DESCRIPTOR_TYPE_COMBINED_IMAGE_SAMPLER<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>samplerLayoutBinding<span style=color:#1f2328>.</span>pImmutableSamplers <span style=color:#0550ae>=</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>samplerLayoutBinding<span style=color:#1f2328>.</span>stageFlags <span style=color:#0550ae>=</span> VK_SHADER_STAGE_FRAGMENT_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>std<span style=color:#0550ae>::</span>array<span style=color:#0550ae>&lt;</span>VkDescriptorSetLayoutBinding<span style=color:#1f2328>,</span> <span style=color:#0550ae>2</span><span style=color:#0550ae>&gt;</span> bindings <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span>uboLayoutBinding<span style=color:#1f2328>,</span> samplerLayoutBinding<span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>VkDescriptorSetLayoutCreateInfo layoutInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>layoutInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_DESCRIPTOR_SET_LAYOUT_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layoutInfo<span style=color:#1f2328>.</span>bindingCount <span style=color:#0550ae>=</span> <span style=color:#cf222e>static_cast</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>uint32_t</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>bindings<span style=color:#1f2328>.</span>size<span style=color:#1f2328>());</span>
</span></span><span style=display:flex><span>layoutInfo<span style=color:#1f2328>.</span>pBindings <span style=color:#0550ae>=</span> bindings<span style=color:#1f2328>.</span>data<span style=color:#1f2328>();</span>
</span></span></code></pre></td></tr></table></div></div><p>从上面我们可以看到，我们给现有的 DescriptorSet Layout 增加了一个binding （所以我们要复用之前的Descriptor Set）</p><h2 id=descriptor-pool修改增加这个类别的descriptorcount>Descriptor pool修改(增加这个类别的descriptorCount)</h2><p>函数 <code>createDescriptorPool</code> 修改</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>std<span style=color:#0550ae>::</span>array<span style=color:#0550ae>&lt;</span>VkDescriptorPoolSize<span style=color:#1f2328>,</span> <span style=color:#0550ae>2</span><span style=color:#0550ae>&gt;</span> poolSizes<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>poolSizes<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>type <span style=color:#0550ae>=</span> VK_DESCRIPTOR_TYPE_UNIFORM_BUFFER<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>poolSizes<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>descriptorCount <span style=color:#0550ae>=</span> <span style=color:#cf222e>static_cast</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>uint32_t</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>poolSizes<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>type <span style=color:#0550ae>=</span> VK_DESCRIPTOR_TYPE_COMBINED_IMAGE_SAMPLER<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>poolSizes<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>descriptorCount <span style=color:#0550ae>=</span> <span style=color:#cf222e>static_cast</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>uint32_t</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>VkDescriptorPoolCreateInfo poolInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>poolInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_DESCRIPTOR_POOL_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>poolInfo<span style=color:#1f2328>.</span>poolSizeCount <span style=color:#0550ae>=</span> <span style=color:#cf222e>static_cast</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>uint32_t</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>poolSizes<span style=color:#1f2328>.</span>size<span style=color:#1f2328>());</span>
</span></span><span style=display:flex><span>poolInfo<span style=color:#1f2328>.</span>pPoolSizes <span style=color:#0550ae>=</span> poolSizes<span style=color:#1f2328>.</span>data<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>poolInfo<span style=color:#1f2328>.</span>maxSets <span style=color:#0550ae>=</span> <span style=color:#cf222e>static_cast</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>uint32_t</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><p>最后的maxSets没有调整，这也说明我们要复用我们之前的 Descriptor Set （为其增加新的Descriptor）。</p><h2 id=desciptor-set修改-绑定新的descriptor>Desciptor Set修改 (绑定新的Descriptor)</h2><p>函数 <code>createDescriptorSets</code> 修改：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>for</span> <span style=color:#1f2328>(</span>size_t i <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span> i <span style=color:#0550ae>&lt;</span> MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>;</span> i<span style=color:#0550ae>++</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	std<span style=color:#0550ae>::</span>array<span style=color:#0550ae>&lt;</span>VkWriteDescriptorSet<span style=color:#1f2328>,</span> <span style=color:#0550ae>2</span><span style=color:#0550ae>&gt;</span> descriptorWrites<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    VkDescriptorBufferInfo bufferInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>    bufferInfo<span style=color:#1f2328>.</span>buffer <span style=color:#0550ae>=</span> uniformBuffers<span style=color:#1f2328>[</span>i<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>    bufferInfo<span style=color:#1f2328>.</span>offset <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    bufferInfo<span style=color:#1f2328>.</span>range <span style=color:#0550ae>=</span> <span style=color:#cf222e>sizeof</span><span style=color:#1f2328>(</span>UniformBufferObject<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_WRITE_DESCRIPTOR_SET<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>dstSet <span style=color:#0550ae>=</span> descriptorSets<span style=color:#1f2328>[</span>i<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>	descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>dstBinding <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>dstArrayElement <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>descriptorType <span style=color:#0550ae>=</span> VK_DESCRIPTOR_TYPE_UNIFORM_BUFFER<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>descriptorCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>pBufferInfo <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>bufferInfo<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    VkDescriptorImageInfo imageInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>    imageInfo<span style=color:#1f2328>.</span>imageLayout <span style=color:#0550ae>=</span> VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    imageInfo<span style=color:#1f2328>.</span>imageView <span style=color:#0550ae>=</span> textureImageView<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    imageInfo<span style=color:#1f2328>.</span>sampler <span style=color:#0550ae>=</span> textureSampler<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_WRITE_DESCRIPTOR_SET<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>dstSet <span style=color:#0550ae>=</span> descriptorSets<span style=color:#1f2328>[</span>i<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>	descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>dstBinding <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>dstArrayElement <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>descriptorType <span style=color:#0550ae>=</span> VK_DESCRIPTOR_TYPE_COMBINED_IMAGE_SAMPLER<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>descriptorCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	descriptorWrites<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>pImageInfo <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>imageInfo<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	vkUpdateDescriptorSets<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> <span style=color:#cf222e>static_cast</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>uint32_t</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>descriptorWrites<span style=color:#1f2328>.</span>size<span style=color:#1f2328>()),</span> descriptorWrites<span style=color:#1f2328>.</span>data<span style=color:#1f2328>(),</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里descriptor完成了对 imageview，sampler 的绑定。（而前面的动作，只是声明了要做这些事情做的准备）</p><h2 id=顶点数据修改增加纹理坐标>顶点数据修改(增加纹理坐标)</h2><p>顶点数据类型。好在这里也定义了 attributDescription。剩余部分都自动生效。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Vertex</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    glm<span style=color:#0550ae>::</span>vec2 pos<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    glm<span style=color:#0550ae>::</span>vec3 color<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    glm<span style=color:#0550ae>::</span>vec2 texCoord<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>static</span> VkVertexInputBindingDescription <span style=color:#6639ba>getBindingDescription</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        VkVertexInputBindingDescription bindingDescription<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>        bindingDescription<span style=color:#1f2328>.</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        bindingDescription<span style=color:#1f2328>.</span>stride <span style=color:#0550ae>=</span> <span style=color:#cf222e>sizeof</span><span style=color:#1f2328>(</span>Vertex<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>        bindingDescription<span style=color:#1f2328>.</span>inputRate <span style=color:#0550ae>=</span> VK_VERTEX_INPUT_RATE_VERTEX<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>return</span> bindingDescription<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>static</span> std<span style=color:#0550ae>::</span>array<span style=color:#0550ae>&lt;</span>VkVertexInputAttributeDescription<span style=color:#1f2328>,</span> <span style=color:#0550ae>3</span><span style=color:#0550ae>&gt;</span> getAttributeDescriptions<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        std<span style=color:#0550ae>::</span>array<span style=color:#0550ae>&lt;</span>VkVertexInputAttributeDescription<span style=color:#1f2328>,</span> <span style=color:#0550ae>3</span><span style=color:#0550ae>&gt;</span> attributeDescriptions<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>format <span style=color:#0550ae>=</span> VK_FORMAT_R32G32_SFLOAT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>].</span>offset <span style=color:#0550ae>=</span> offsetof<span style=color:#1f2328>(</span>Vertex<span style=color:#1f2328>,</span> pos<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>format <span style=color:#0550ae>=</span> VK_FORMAT_R32G32B32_SFLOAT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>offset <span style=color:#0550ae>=</span> offsetof<span style=color:#1f2328>(</span>Vertex<span style=color:#1f2328>,</span> color<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>2</span><span style=color:#1f2328>].</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>2</span><span style=color:#1f2328>].</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>2</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>2</span><span style=color:#1f2328>].</span>format <span style=color:#0550ae>=</span> VK_FORMAT_R32G32_SFLOAT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        attributeDescriptions<span style=color:#1f2328>[</span><span style=color:#0550ae>2</span><span style=color:#1f2328>].</span>offset <span style=color:#0550ae>=</span> offsetof<span style=color:#1f2328>(</span>Vertex<span style=color:#1f2328>,</span> texCoord<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>return</span> attributeDescriptions<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><p>修改具体的顶点数据</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>const</span> std<span style=color:#0550ae>::</span>vector<span style=color:#0550ae>&lt;</span>Vertex<span style=color:#0550ae>&gt;</span> vertices <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{{</span><span style=color:#0550ae>-</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>-</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>}},</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{{</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>-</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>}},</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{{</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.5f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>}},</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>{{</span><span style=color:#0550ae>-</span><span style=color:#0550ae>0.5f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.5f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>},</span> <span style=color:#1f2328>{</span><span style=color:#0550ae>1.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>}}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=shader的修改>shader的修改</h2><p>vertex shader：因为pipeline先要经过vertex shader。所以传递个fragment shader的顶点数据（这里是纹理坐标，和顶点颜色）必须在 vertex shader里指定。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>#version 450
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#57606a>// 上面的version也必须指定，否则无法编译
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> in vec2 inPosition<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>)</span> in vec3 inColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>2</span><span style=color:#1f2328>)</span> in vec2 inTexCoord<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> out vec3 fragColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>)</span> out vec2 fragTexCoord<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>main</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    gl_Position <span style=color:#0550ae>=</span> ubo<span style=color:#1f2328>.</span>proj <span style=color:#0550ae>*</span> ubo<span style=color:#1f2328>.</span>view <span style=color:#0550ae>*</span> ubo<span style=color:#1f2328>.</span>model <span style=color:#0550ae>*</span> vec4<span style=color:#1f2328>(</span>inPosition<span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    fragColor <span style=color:#0550ae>=</span> inColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    fragTexCoord <span style=color:#0550ae>=</span> inTexCoord<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>fragment shader:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span><span style=color:#57606a>#version 450</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>in</span> <span style=color:#cf222e>vec3</span> fragColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>in</span> <span style=color:#cf222e>vec2</span> fragTexCoord<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>out</span> <span style=color:#cf222e>vec4</span> outColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> main<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    outColor <span style=color:#0550ae>=</span> <span style=color:#cf222e>vec4</span><span style=color:#1f2328>(</span>fragTexCoord<span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>运行可以看到（验证纹理坐标是否正确的读取）：
<img src=/images/Vulkan%E5%85%A5%E9%97%A804-Texture%20mapping-1764828930621.png loading=lazy alt="Vulkan入门04-Texture mapping-1764828930621"></p><p>修改：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span><span style=color:#57606a>#version 450</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>in</span> <span style=color:#cf222e>vec3</span> fragColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>in</span> <span style=color:#cf222e>vec2</span> fragTexCoord<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>out</span> <span style=color:#cf222e>vec4</span> outColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>uniform</span> <span style=color:#cf222e>sampler2D</span> texSampler<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> main<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    outColor <span style=color:#0550ae>=</span> texture<span style=color:#1f2328>(</span>texSampler<span style=color:#1f2328>,</span> fragTexCoord<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>运行可以看到（验证texture成功使用）
<img src=/images/Vulkan%E5%85%A5%E9%97%A804-Texture%20mapping-1764828959861.png loading=lazy alt="Vulkan入门04-Texture mapping-1764828959861"></p><p>修改：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span><span style=color:#57606a>#version 450</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>in</span> <span style=color:#cf222e>vec3</span> fragColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>in</span> <span style=color:#cf222e>vec2</span> fragTexCoord<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>out</span> <span style=color:#cf222e>vec4</span> outColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>uniform</span> <span style=color:#cf222e>sampler2D</span> texSampler<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> main<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    outColor <span style=color:#0550ae>=</span> texture<span style=color:#1f2328>(</span>texSampler<span style=color:#1f2328>,</span> fragTexCoord<span style=color:#0550ae>*</span><span style=color:#0550ae>2.0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p>运行可以看到（验证 address mode）
<img src=/images/Vulkan%E5%85%A5%E9%97%A804-Texture%20mapping-1764828979224.png loading=lazy alt="Vulkan入门04-Texture mapping-1764828979224"></p><p>还可以进行颜色融合：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span><span style=color:#57606a>#version 450</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>in</span> <span style=color:#cf222e>vec3</span> fragColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>in</span> <span style=color:#cf222e>vec2</span> fragTexCoord<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>out</span> <span style=color:#cf222e>vec4</span> outColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>uniform</span> <span style=color:#cf222e>sampler2D</span> texSampler<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> main<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	outColor <span style=color:#0550ae>=</span> <span style=color:#cf222e>vec4</span><span style=color:#1f2328>(</span>fragColor <span style=color:#0550ae>*</span> texture<span style=color:#1f2328>(</span>texSampler<span style=color:#1f2328>,</span> fragTexCoord<span style=color:#1f2328>).</span>rgb<span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/images/Vulkan%E5%85%A5%E9%97%A804-Texture%20mapping-1764828997270.png loading=lazy alt="Vulkan入门04-Texture mapping-1764828997270"></p></section><footer class=article-footer><section class=article-tags><a href=/tags/vulkan/>Vulkan</a>
<a href=/tags/texture/>Texture</a>
<a href=/tags/sampler/>Sampler</a>
<a href=/tags/descriptor/>Descriptor</a></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=[".main-article",".widget--toc"];e.forEach(e=>{const t=document.querySelector(e);t&&renderMathInElement(t,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})})</script></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/2025/12/03/vulkan%E5%85%A5%E9%97%A803-uniformbuffers/><div class=article-details><h2 class=article-title>Vulkan入门03-UniformBuffers</h2></div></a></article><article><a href=/2025/11/27/vulkan%E5%85%A5%E9%97%A802-vertexbuffers/><div class=article-details><h2 class=article-title>Vulkan入门02-VertexBuffers</h2></div></a></article><article><a href=/2025/11/21/vulkan%E7%A8%8B%E5%BA%8F%E4%B8%ADintel%E9%A9%B1%E5%8A%A8%E6%80%BB%E6%98%AF%E8%A2%AB%E8%B0%83%E7%94%A8%E6%9C%AA%E8%A7%A3%E5%86%B3/><div class=article-details><h2 class=article-title>Vulkan程序中Intel驱动总是被调用（未解决）</h2></div></a></article><article><a href=/2025/11/19/vulkan%E7%9A%84layer%E5%8F%91%E7%8E%B0%E6%9C%BA%E5%88%B6/><div class=article-details><h2 class=article-title>Vulkan的Layer发现机制</h2></div></a></article><article><a href=/2025/11/18/vulkan%E7%9A%84icd%E6%9C%BA%E5%88%B6/><div class=article-details><h2 class=article-title>Vulkan的ICD机制</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2025 crackhopper的技术博客</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.32.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.0fcb739c1f88ce461c9640077fd21d8ce903946f1aef209dd01192827d26a90c.js defer></script><script type=text/javascript src=/ts/custom.fb6397326fc458b8ae775aee18e0a0ae80628aec9c216e7e90c79bb0486cb0e3.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>
<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="\n通过 VertexBuffer ，我们可以给每个顶点赋值数据，并传递给 vertex shader 让其可以使用（通过drawcall启动pipeline）。那么，对于全局的变量（想传递给每个shader），应该怎么做呢？举例来说：\nMVP矩阵 (model-view-project matrix) "><title>Vulkan入门03-UniformBuffers</title><link rel=canonical href=https://crackhopper.github.io/2025/12/03/vulkan%E5%85%A5%E9%97%A803-uniformbuffers/><link rel=stylesheet href=/scss/style.min.4d36f8dc1fd48129e1635deb4b8eb2870fa09474f7280c4cb606d40b2526994b.css><meta property='og:title' content="Vulkan入门03-UniformBuffers"><meta property='og:description' content="\n通过 VertexBuffer ，我们可以给每个顶点赋值数据，并传递给 vertex shader 让其可以使用（通过drawcall启动pipeline）。那么，对于全局的变量（想传递给每个shader），应该怎么做呢？举例来说：\nMVP矩阵 (model-view-project matrix) "><meta property='og:url' content='https://crackhopper.github.io/2025/12/03/vulkan%E5%85%A5%E9%97%A803-uniformbuffers/'><meta property='og:site_name' content='crackhopper的技术博客'><meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:tag' content='vulkan'><meta property='article:tag' content='uniformbuffer'><meta property='article:tag' content='ubo'><meta property='article:published_time' content='2025-12-03T21:54:56+08:00'><meta property='article:modified_time' content='2025-12-03T21:54:56+08:00'><meta name=twitter:title content="Vulkan入门03-UniformBuffers"><meta name=twitter:description content="\n通过 VertexBuffer ，我们可以给每个顶点赋值数据，并传递给 vertex shader 让其可以使用（通过drawcall启动pipeline）。那么，对于全局的变量（想传递给每个shader），应该怎么做呢？举例来说：\nMVP矩阵 (model-view-project matrix) "><link rel=stylesheet href=/css/custom.css></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_337fe2b325ec916d.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>crackhopper的技术博客</a></h1><h2 class=site-description>C++, Graphics, Game, AI/ML</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>文章</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于我</span></a></li><li><a href=/projects/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>项目</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ul><li><a href=#描述符集布局descriptor-set-layout>描述符集布局(Descriptor Set Layout)</a><ul><li><a href=#描述符-descriptor>描述符 (Descriptor)</a></li><li><a href=#我们要做什么>我们要做什么</a></li><li><a href=#描述符集布局的创建>描述符集布局的创建</a></li><li><a href=#uniform-buffer创建>Uniform buffer创建</a></li></ul></li><li><a href=#uniform-buffer>Uniform Buffer</a><ul><li><a href=#更新uniformbuffer>更新UniformBuffer</a></li></ul></li><li><a href=#描述符集descriptor-set>描述符集(Descriptor Set)</a><ul><li><a href=#描述符池-descriptor-pool-创建>描述符池 (Descriptor Pool) 创建</a></li><li><a href=#描述符集descriptor-set和描述符descriptor创建>描述符集(Descriptor Set)和描述符(Descriptor)创建</a></li><li><a href=#渲染时使用描述符集>渲染时使用描述符集</a></li><li><a href=#对齐问题>对齐问题</a></li><li><a href=#多个-descriptor-set>多个 Descriptor Set</a></li></ul></li></ul></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/2025/12/03/vulkan%E5%85%A5%E9%97%A803-uniformbuffers/>Vulkan入门03-UniformBuffers</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2025-12-03T21:54:56+08:00>Dec 03, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>7 minute read</time></div></footer></div></header><section class=article-content><p><img src=/images/Vulkan%E5%85%A5%E9%97%A803-UniformBuffers-1764830357797.png loading=lazy alt=Vulkan入门03-UniformBuffers-1764830357797></p><p>通过 <code>VertexBuffer</code> ，我们可以给每个顶点赋值数据，并传递给 vertex shader 让其可以使用（通过drawcall启动pipeline）。那么，对于全局的变量（想传递给每个shader），应该怎么做呢？举例来说：</p><ul><li>MVP矩阵 (model-view-project matrix)</li></ul><h1 id=描述符集布局descriptor-set-layout>描述符集布局(Descriptor Set Layout)</h1><h2 id=描述符-descriptor>描述符 (Descriptor)</h2><p>定义 着色器访问 GPU 资源（Buffer / Image）的方式。它是 <strong>CPU ↔ GPU资源 ↔ Shader</strong> 的桥梁。</p><p>使用描述符(Descriptor) 主要分为3个步骤：</p><ol><li>指定 Descriptor Set Layout (布局) （当pipeline创建时）。<ul><li>布局：binding = 0 是一个 uniform buffer； binding = 1 是一个 sampler</li><li>类比：RenderPass定义附件格式，但不是具体的附件</li></ul></li><li>从 Descriptor Pool 分配 Descriptor Set。真正创建一个描述符集合<ul><li>Descriptor Set，指向某个 <code>VkBuffer</code> 或者 <code>VkImageView</code></li><li>类比：FrameBuffer绑定一个具体的ImageView</li></ul></li><li>在绘制时绑定 Descriptor Set。（类似绘制绑定VB，IB，FB）<ul><li><code>vkCmdBindDescriptorSets(...)</code></li></ul></li></ol><p>有各种各样的 Descriptor。我们这里只关注 UBO (Uniform Buffer Object)</p><h2 id=我们要做什么>我们要做什么</h2><p>我们有一个C数据</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>UniformBufferObject</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    glm<span style=color:#0550ae>::</span>mat4 model<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    glm<span style=color:#0550ae>::</span>mat4 view<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    glm<span style=color:#0550ae>::</span>mat4 proj<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>注意，基于 <code>glm:mat4</code> 定义的类型，和glsl中的 <code>mat4</code> 类型在数据层面时完全匹配的。（这方便了我们直接memcpy）</li></ul><p>希望把这个数据，复制到一个 <code>VkBuffer</code> 中，并且可以再VS中以下面的方式访问：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span><span style=color:#57606a>#version 450</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>uniform</span> UniformBufferObject <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    mat4 model<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    mat4 view<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    mat4 proj<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span> ubo<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>in</span> <span style=color:#cf222e>vec2</span> inPosition<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>in</span> <span style=color:#cf222e>vec3</span> inColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>location <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>out</span> <span style=color:#cf222e>vec3</span> fragColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> main<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    gl_Position <span style=color:#0550ae>=</span> ubo<span style=color:#1f2328>.</span>proj <span style=color:#0550ae>*</span> ubo<span style=color:#1f2328>.</span>view <span style=color:#0550ae>*</span> ubo<span style=color:#1f2328>.</span>model <span style=color:#0550ae>*</span> <span style=color:#cf222e>vec4</span><span style=color:#1f2328>(</span>inPosition<span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    fragColor <span style=color:#0550ae>=</span> inColor<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>这里几个变量定义的顺序不重要。<code>binding</code> 指令和 <code>location</code> 指令类似。（回忆：<code>location</code> ，实际创建pipeline的InputVertex时，指定顶点属性配置中，指定的）（所以，可以容易才想到，UBO的binding，应该也是创建pipeline的Descriptor Set配置的时候，具体指定某一个Descriptor的 <code>binding</code> ）</li><li>注意：<code>binding</code> 并不是全局唯一。<code>layout(set = 0, binding = 0) uniform UniformBufferObject { ... } ubo;</code> 上面代码省略了默认的set。用类比解释：<ul><li><code>set</code> : 柜子</li><li><code>binding</code> ： 柜子里的抽屉</li></ul></li></ul><p>先暂时放一个整体的连线图：</p><pre tabindex=0><code>C++ struct
   ↓ memcpy
VkBuffer (size = sizeof(UBO)) 【这里还涉及到 VkDeviceMemory, vkMapMemory】
   ↓
VkDescriptorBufferInfo 【后续操作前，需要在管线中先定义好布局】
   ↓
VkWriteDescriptorSet (binding = 0)
   ↓
VkDescriptorSet 【渲染前，创建buffer后；完成Descriptor的创建】
   ↓
vkCmdBindDescriptorSets【渲染时，绑定具体的DescriptorSet】
   ↓
Shader: layout(set=0, binding=0) uniform ...【shader可以访问Descriptor资源】
</code></pre><h2 id=描述符集布局的创建>描述符集布局的创建</h2><p>在创建 pipeline之前，要先创建 <strong>描述符集布局</strong></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>initVulkan</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>    createDescriptorSetLayout<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    createGraphicsPipeline<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>VkDescriptorSetLayout descriptorSetLayout<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>createDescriptorSetLayout</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span> <span style=color:#57606a>// 整个函数仅创建了1个descriptorSetLayout (set=0)
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	<span style=color:#57606a>// 这里仅仅是定义 1 个DescriptorSetLayout下的1个binding。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    VkDescriptorSetLayoutBinding uboLayoutBinding<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 在 descriptor set 中的索引（编号）。这与 shader 中 
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#57606a>// layout(set=0, binding = 0) 对应。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    uboLayoutBinding<span style=color:#1f2328>.</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 该 binding 的类型，这里是 VK_DESCRIPTOR_TYPE_UNIFORM_BUFFER，
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#57606a>// 说明这个 binding 期待一个 Uniform Buffer（或一组 uniform buffers，
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#57606a>// 如果 descriptorCount &gt; 1）。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    uboLayoutBinding<span style=color:#1f2328>.</span>descriptorType <span style=color:#0550ae>=</span> VK_DESCRIPTOR_TYPE_UNIFORM_BUFFER<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 这个binding可以绑定相同单个描述符还是描述符数组
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	<span style=color:#57606a>// =1 时是单个 descriptor；&gt;1 时该 binding 是一个 descriptor 数组。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	<span style=color:#57606a>// shader 端需要声明成 uniform 块数组才能访问多个元素。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    <span style=color:#57606a>// 比如 N个同类型 uniform buffers。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    uboLayoutBinding<span style=color:#1f2328>.</span>descriptorCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 哪些着色器阶段可以访问这个binding。这里定义 Vertex Shader 阶段
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    uboLayoutBinding<span style=color:#1f2328>.</span>stageFlags <span style=color:#0550ae>=</span> VK_SHADER_STAGE_VERTEX_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 仅对 sampler 类型有意义 （暂时不讲）
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    uboLayoutBinding<span style=color:#1f2328>.</span>pImmutableSamplers <span style=color:#0550ae>=</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>;</span> <span style=color:#57606a>// Optional
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 1个 DescriptorSetLayout 可以做多个 Binding （下面只做了1个binding）
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	VkDescriptorSetLayoutCreateInfo layoutInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>	layoutInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_DESCRIPTOR_SET_LAYOUT_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	layoutInfo<span style=color:#1f2328>.</span>bindingCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	layoutInfo<span style=color:#1f2328>.</span>pBindings <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>uboLayoutBinding<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>vkCreateDescriptorSetLayout<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>layoutInfo<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>descriptorSetLayout<span style=color:#1f2328>)</span> <span style=color:#0550ae>!=</span> VK_SUCCESS<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	    <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to create descriptor set layout!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>createGraphicsPipeline</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>	VkPipelineLayoutCreateInfo pipelineLayoutInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>	pipelineLayoutInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_PIPELINE_LAYOUT_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 创建 pipeline layout的时候，可以创建多个 DescriptorSetLayout
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	<span style=color:#57606a>// 我们这里仅绑定了1个
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	pipelineLayoutInfo<span style=color:#1f2328>.</span>setLayoutCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	pipelineLayoutInfo<span style=color:#1f2328>.</span>pSetLayouts <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>descriptorSetLayout<span style=color:#1f2328>;</span>	
</span></span><span style=display:flex><span>	<span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>cleanup</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    cleanupSwapChain<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    vkDestroyDescriptorSetLayout<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> descriptorSetLayout<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=uniform-buffer创建>Uniform buffer创建</h2><p>上一节，做到了shader能用。但GPU上数据并没有做。</p><p><strong>UniformBuffer的数量：每一帧使用一个独立的 uniform buffer</strong></p><p>回顾StagingBuffer的作用：<strong>大数据、偶尔更新、希望数据在 DEVICE_LOCAL 中</strong> ，而UniformBuffer特点则是小数据，常更新。因此更适合 <code>HOST_VISIBLE</code> 内存。</p><p>相关代码如下</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>// 确保每帧都有1个UBO
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span><span style=color:#57606a>// Buffer对象句柄。描述 buffer 资源 （更类似于meta信息）
</span></span></span><span style=display:flex><span><span style=color:#57606a>// 用途（vertex/uniform/storage）、大小、可以被绑定到 descriptor
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>std<span style=color:#0550ae>::</span>vector<span style=color:#0550ae>&lt;</span>VkBuffer<span style=color:#0550ae>&gt;</span> uniformBuffers<span style=color:#1f2328>;</span> 
</span></span><span style=display:flex><span><span style=color:#57606a>// GPU显存句柄。代表实际的显存块。
</span></span></span><span style=display:flex><span><span style=color:#57606a>// 需要用 vkAllocateMemory 来创建。
</span></span></span><span style=display:flex><span><span style=color:#57606a>// 可用 vkBindBufferMemory 绑定到 VkBuffer (这样可以用VkBuffer对象来配合函数，操作GPU显存；被shader和descriptor访问使用；类似 vkImageView 和 vkImage 的关系)
</span></span></span><span style=display:flex><span><span style=color:#57606a>// 可用 vkMapMemory 获取到 uniformBuffersMapped 这里的指针。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>std<span style=color:#0550ae>::</span>vector<span style=color:#0550ae>&lt;</span>VkDeviceMemory<span style=color:#0550ae>&gt;</span> uniformBuffersMemory<span style=color:#1f2328>;</span> 
</span></span><span style=display:flex><span><span style=color:#57606a>// GPU显存映射后的进程空间的虚拟地址 (实际要复制的dst；复制后会被驱动自动/手动同步到显存)
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>std<span style=color:#0550ae>::</span>vector<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>void</span><span style=color:#0550ae>*&gt;</span> uniformBuffersMapped<span style=color:#1f2328>;</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>initVulkan</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>    createVertexBuffer<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    createIndexBuffer<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    createUniformBuffers<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>createUniformBuffers</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    VkDeviceSize bufferSize <span style=color:#0550ae>=</span> <span style=color:#cf222e>sizeof</span><span style=color:#1f2328>(</span>UniformBufferObject<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    uniformBuffers<span style=color:#1f2328>.</span>resize<span style=color:#1f2328>(</span>MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    uniformBuffersMemory<span style=color:#1f2328>.</span>resize<span style=color:#1f2328>(</span>MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    uniformBuffersMapped<span style=color:#1f2328>.</span>resize<span style=color:#1f2328>(</span>MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>for</span> <span style=color:#1f2328>(</span>size_t i <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span> i <span style=color:#0550ae>&lt;</span> MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>;</span> i<span style=color:#0550ae>++</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        createBuffer<span style=color:#1f2328>(</span> <span style=color:#57606a>// 之前写过的便利函数，方便创建和绑定VkBuffer、VkDeviceMemory
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>            bufferSize<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>            VK_BUFFER_USAGE_UNIFORM_BUFFER_BIT<span style=color:#1f2328>,</span>   <span style=color:#57606a>// 用途为UBO
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>            VK_MEMORY_PROPERTY_HOST_VISIBLE_BIT <span style=color:#0550ae>|</span> <span style=color:#57606a>// CPU可见
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>            VK_MEMORY_PROPERTY_HOST_COHERENT_BIT<span style=color:#1f2328>,</span> <span style=color:#57606a>// 写入后 GPU 自动可见，无需手动 flush
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>            uniformBuffers<span style=color:#1f2328>[</span>i<span style=color:#1f2328>],</span>
</span></span><span style=display:flex><span>            uniformBuffersMemory<span style=color:#1f2328>[</span>i<span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>);</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 使用持久映射（persistent mapping）技术：vkMapMemory 返回的指针在整个应用生命周期内有效
</span></span></span><span style=display:flex><span><span style=color:#57606a>// CPU 可以直接写入 UBO 数据，GPU 可以访问，无需每帧重复映射
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>        vkMapMemory<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>            device<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>            uniformBuffersMemory<span style=color:#1f2328>[</span>i<span style=color:#1f2328>],</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>            bufferSize<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>            <span style=color:#0550ae>&amp;</span>uniformBuffersMapped<span style=color:#1f2328>[</span>i<span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>cleanup</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>for</span> <span style=color:#1f2328>(</span>size_t i <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span> i <span style=color:#0550ae>&lt;</span> MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>;</span> i<span style=color:#0550ae>++</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        vkDestroyBuffer<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> uniformBuffers<span style=color:#1f2328>[</span>i<span style=color:#1f2328>],</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>        vkFreeMemory<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> uniformBuffersMemory<span style=color:#1f2328>[</span>i<span style=color:#1f2328>],</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// Descriptor 实际持有 Uniform Buffer，因此要后释放。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    vkDestroyDescriptorSetLayout<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> descriptorSetLayout<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=uniform-buffer>Uniform Buffer</h1><h2 id=更新uniformbuffer>更新UniformBuffer</h2><p>比较简单直观：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>#define GLM_FORCE_RADIANS
</span></span></span><span style=display:flex><span><span style=color:#57606a>#include</span> <span style=color:#57606a>&#34;glm/glm.hpp&#34;</span><span style=color:#57606a>
</span></span></span><span style=display:flex><span><span style=color:#57606a>#include</span> <span style=color:#57606a>&lt;glm/gtc/matrix_transform.hpp&gt;</span><span style=color:#57606a>
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> drawFrame<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    updateUniformBuffer<span style=color:#1f2328>(</span>currentFrame<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    VkSubmitInfo submitInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>    submitInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_SUBMIT_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> updateUniformBuffer<span style=color:#1f2328>(</span><span style=color:#cf222e>uint32_t</span> currentImage<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>static</span> <span style=color:#cf222e>auto</span> startTime <span style=color:#0550ae>=</span> std<span style=color:#0550ae>::</span>chrono<span style=color:#0550ae>::</span>high_resolution_clock<span style=color:#0550ae>::</span>now<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>auto</span> currentTime <span style=color:#0550ae>=</span> std<span style=color:#0550ae>::</span>chrono<span style=color:#0550ae>::</span>high_resolution_clock<span style=color:#0550ae>::</span>now<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>float</span> time <span style=color:#0550ae>=</span> std<span style=color:#0550ae>::</span>chrono<span style=color:#0550ae>::</span>duration<span style=color:#0550ae>&lt;</span><span style=color:#cf222e>float</span><span style=color:#1f2328>,</span> std<span style=color:#0550ae>::</span>chrono<span style=color:#0550ae>::</span>seconds<span style=color:#0550ae>::</span>period<span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>currentTime <span style=color:#0550ae>-</span> startTime<span style=color:#1f2328>).</span>count<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	UniformBufferObject ubo<span style=color:#1f2328>{};</span> 
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 按照经过的时间进行旋转（恒定角速度）
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	<span style=color:#57606a>// 模型变换：围绕 Z 轴旋转（恒定角速度）
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	ubo<span style=color:#1f2328>.</span>model <span style=color:#0550ae>=</span> glm<span style=color:#0550ae>::</span>rotate<span style=color:#1f2328>(</span>glm<span style=color:#0550ae>::</span>mat4<span style=color:#1f2328>(</span><span style=color:#0550ae>1.0f</span><span style=color:#1f2328>),</span> time <span style=color:#0550ae>*</span> glm<span style=color:#0550ae>::</span>radians<span style=color:#1f2328>(</span><span style=color:#0550ae>90.0f</span><span style=color:#1f2328>),</span> glm<span style=color:#0550ae>::</span>vec3<span style=color:#1f2328>(</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>));</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 视图变换：摄像机从 (2,2,2) 看向原点
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	ubo<span style=color:#1f2328>.</span>view <span style=color:#0550ae>=</span> glm<span style=color:#0550ae>::</span>lookAt<span style=color:#1f2328>(</span>glm<span style=color:#0550ae>::</span>vec3<span style=color:#1f2328>(</span><span style=color:#0550ae>2.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>2.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>2.0f</span><span style=color:#1f2328>),</span> glm<span style=color:#0550ae>::</span>vec3<span style=color:#1f2328>(</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>),</span> glm<span style=color:#0550ae>::</span>vec3<span style=color:#1f2328>(</span><span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.0f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1.0f</span><span style=color:#1f2328>));</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 投影变换：45° 视角，近平面0.1，远平面10
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	ubo<span style=color:#1f2328>.</span>proj <span style=color:#0550ae>=</span> glm<span style=color:#0550ae>::</span>perspective<span style=color:#1f2328>(</span>glm<span style=color:#0550ae>::</span>radians<span style=color:#1f2328>(</span><span style=color:#0550ae>45.0f</span><span style=color:#1f2328>),</span> swapChainExtent<span style=color:#1f2328>.</span>width <span style=color:#0550ae>/</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>float</span><span style=color:#1f2328>)</span> swapChainExtent<span style=color:#1f2328>.</span>height<span style=color:#1f2328>,</span> <span style=color:#0550ae>0.1f</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>10.0f</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 由于GLM库默认给OpenGL设计的，Vulkan里需要flip Y坐标。
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	ubo<span style=color:#1f2328>.</span>proj<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>][</span><span style=color:#0550ae>1</span><span style=color:#1f2328>]</span> <span style=color:#0550ae>*=</span> <span style=color:#0550ae>-</span><span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 对于 HOST_COHERENT 内存，写入后 GPU 可直接访问，无需 flush
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	memcpy<span style=color:#1f2328>(</span>uniformBuffersMapped<span style=color:#1f2328>[</span>currentImage<span style=color:#1f2328>],</span> <span style=color:#0550ae>&amp;</span>ubo<span style=color:#1f2328>,</span> <span style=color:#cf222e>sizeof</span><span style=color:#1f2328>(</span>ubo<span style=color:#1f2328>));</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=描述符集descriptor-set>描述符集(Descriptor Set)</h1><p>我们还没有具体创建这个对象来关联 UBO 和对应的pipeline的 Layout。</p><h2 id=描述符池-descriptor-pool-创建>描述符池 (Descriptor Pool) 创建</h2><p>描述符集(Descriptor Set) 无法直接创建。需要类似command buffer一样，从pool中创建。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>initVulkan</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>    createUniformBuffers<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    createDescriptorPool<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>VkDescriptorPool descriptorPool<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>createDescriptorPool</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	VkDescriptorPoolSize poolSize<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 描述符类型：统一缓冲区（Uniform Buffer）
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	poolSize<span style=color:#1f2328>.</span>type <span style=color:#0550ae>=</span> VK_DESCRIPTOR_TYPE_UNIFORM_BUFFER<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 描述符数量：每个帧一个，这里通常和同时渲染的帧数相同
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	poolSize<span style=color:#1f2328>.</span>descriptorCount <span style=color:#0550ae>=</span> <span style=color:#cf222e>static_cast</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>uint32_t</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	VkDescriptorPoolCreateInfo poolInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>	poolInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_DESCRIPTOR_POOL_CREATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	poolInfo<span style=color:#1f2328>.</span>poolSizeCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	poolInfo<span style=color:#1f2328>.</span>pPoolSizes <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>poolSize<span style=color:#1f2328>;</span>	
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 描述符集最大数量，决定可以从池中分配多少个 descriptor set
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	poolInfo<span style=color:#1f2328>.</span>maxSets <span style=color:#0550ae>=</span> <span style=color:#cf222e>static_cast</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>uint32_t</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>vkCreateDescriptorPool<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>poolInfo<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>descriptorPool<span style=color:#1f2328>)</span> <span style=color:#0550ae>!=</span> VK_SUCCESS<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	    <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to create descriptor pool!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>一个描述符池，可以管理多个类型的描述符的创建最大数量。（每个类型对应一个 descriptorCount) <strong>set里descriptor的个数限制</strong></li><li>一个描述符池，提供了可以创建的描述符的总最大数量（maxSets） <strong>set的个数限制</strong></li></ul><h2 id=描述符集descriptor-set和描述符descriptor创建>描述符集(Descriptor Set)和描述符(Descriptor)创建</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>initVulkan</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>    createDescriptorPool<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    createDescriptorSets<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>std<span style=color:#0550ae>::</span>vector<span style=color:#0550ae>&lt;</span>VkDescriptorSet<span style=color:#0550ae>&gt;</span> descriptorSets<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>createDescriptorSets</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	std<span style=color:#0550ae>::</span>vector<span style=color:#0550ae>&lt;</span>VkDescriptorSetLayout<span style=color:#0550ae>&gt;</span> layouts<span style=color:#1f2328>(</span>MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>,</span> descriptorSetLayout<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 分配描述符集的信息
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	VkDescriptorSetAllocateInfo allocInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>	allocInfo<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_DESCRIPTOR_SET_ALLOCATE_INFO<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 指定从哪个池分配
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	allocInfo<span style=color:#1f2328>.</span>descriptorPool <span style=color:#0550ae>=</span> descriptorPool<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 分配数量
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	allocInfo<span style=color:#1f2328>.</span>descriptorSetCount <span style=color:#0550ae>=</span> <span style=color:#cf222e>static_cast</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>uint32_t</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// // 指向每个 Descriptor Set 的布局
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	allocInfo<span style=color:#1f2328>.</span>pSetLayouts <span style=color:#0550ae>=</span> layouts<span style=color:#1f2328>.</span>data<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	descriptorSets<span style=color:#1f2328>.</span>resize<span style=color:#1f2328>(</span>MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>vkAllocateDescriptorSets<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>allocInfo<span style=color:#1f2328>,</span> descriptorSets<span style=color:#1f2328>.</span>data<span style=color:#1f2328>())</span> <span style=color:#0550ae>!=</span> VK_SUCCESS<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	    <span style=color:#cf222e>throw</span> std<span style=color:#0550ae>::</span>runtime_error<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;failed to allocate descriptor sets!&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// 到这里，descriptorSets数组已经都被分配好了
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span>    <span style=color:#57606a>// 绑定每个 descriptor set 对应的 uniform buffer	
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	<span style=color:#cf222e>for</span> <span style=color:#1f2328>(</span>size_t i <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span> i <span style=color:#0550ae>&lt;</span> MAX_FRAMES_IN_FLIGHT<span style=color:#1f2328>;</span> i<span style=color:#0550ae>++</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	    VkDescriptorBufferInfo bufferInfo<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>	    <span style=color:#57606a>// 指向对应帧的 uniform buffer
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	    bufferInfo<span style=color:#1f2328>.</span>buffer <span style=color:#0550ae>=</span> uniformBuffers<span style=color:#1f2328>[</span>i<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>	    <span style=color:#57606a>// buffer 偏移
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	    bufferInfo<span style=color:#1f2328>.</span>offset <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	    <span style=color:#57606a>// buffer 大小
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	    bufferInfo<span style=color:#1f2328>.</span>range <span style=color:#0550ae>=</span> <span style=color:#cf222e>sizeof</span><span style=color:#1f2328>(</span>UniformBufferObject<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	    
</span></span><span style=display:flex><span>	    <span style=color:#57606a>// 更新描述符集 （其实就是更新上面的 绑定uniform的信息）
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	    VkWriteDescriptorSet descriptorWrite<span style=color:#1f2328>{};</span>
</span></span><span style=display:flex><span>		descriptorWrite<span style=color:#1f2328>.</span>sType <span style=color:#0550ae>=</span> VK_STRUCTURE_TYPE_WRITE_DESCRIPTOR_SET<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>		<span style=color:#57606a>// 指定要更新的 descriptor set
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>		descriptorWrite<span style=color:#1f2328>.</span>dstSet <span style=color:#0550ae>=</span> descriptorSets<span style=color:#1f2328>[</span>i<span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>		 <span style=color:#57606a>// 对应 layout 中 binding = 0
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>		descriptorWrite<span style=color:#1f2328>.</span>dstBinding <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>		<span style=color:#57606a>// 如果是数组描述符，这里是数组起始索引
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>		descriptorWrite<span style=color:#1f2328>.</span>dstArrayElement <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>		<span style=color:#57606a>// 描述符类型
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>		descriptorWrite<span style=color:#1f2328>.</span>descriptorType <span style=color:#0550ae>=</span> VK_DESCRIPTOR_TYPE_UNIFORM_BUFFER<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>		<span style=color:#57606a>// 更新一个描述符
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>		descriptorWrite<span style=color:#1f2328>.</span>descriptorCount <span style=color:#0550ae>=</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>		<span style=color:#57606a>// 更新的内容：
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>		<span style=color:#57606a>// 指向 buffer info
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>		descriptorWrite<span style=color:#1f2328>.</span>pBufferInfo <span style=color:#0550ae>=</span> <span style=color:#0550ae>&amp;</span>bufferInfo<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>		descriptorWrite<span style=color:#1f2328>.</span>pImageInfo <span style=color:#0550ae>=</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>;</span> <span style=color:#57606a>// Optional
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>		descriptorWrite<span style=color:#1f2328>.</span>pTexelBufferView <span style=color:#0550ae>=</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>;</span> <span style=color:#57606a>// Optional
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span>		<span style=color:#57606a>// 调用 Vulkan API 更新 descriptor set，将 bufferInfo 绑定到 descriptor
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>		vkUpdateDescriptorSets<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>descriptorWrite<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>void</span> <span style=color:#6639ba>cleanup</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span>    vkDestroyDescriptorPool<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> descriptorPool<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    vkDestroyDescriptorSetLayout<span style=color:#1f2328>(</span>device<span style=color:#1f2328>,</span> descriptorSetLayout<span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=渲染时使用描述符集>渲染时使用描述符集</h2><p>在drawcall前，绑定描述符集</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>vkCmdBindDescriptorSets<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>,</span> VK_PIPELINE_BIND_POINT_GRAPHICS<span style=color:#1f2328>,</span> pipelineLayout<span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>&amp;</span>descriptorSets<span style=color:#1f2328>[</span>currentFrame<span style=color:#1f2328>],</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>nullptr</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>vkCmdDrawIndexed<span style=color:#1f2328>(</span>commandBuffer<span style=color:#1f2328>,</span> <span style=color:#cf222e>static_cast</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>uint32_t</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>(</span>indices<span style=color:#1f2328>.</span>size<span style=color:#1f2328>()),</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><p>一些bug修复。由于我们flip Y，导致三角形面的方向也相反，从而被 <code>BACK_CULL</code> 掉了。因此回到 pipeline创建的部分，修改</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>rasterizer<span style=color:#1f2328>.</span>cullMode <span style=color:#0550ae>=</span> VK_CULL_MODE_BACK_BIT<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>rasterizer<span style=color:#1f2328>.</span>frontFace <span style=color:#0550ae>=</span> VK_FRONT_FACE_COUNTER_CLOCKWISE<span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><p>到这里，可以看到渲染的画面了</p><p><img src=/images/Vulkan%E5%85%A5%E9%97%A803-UniformBuffers-1764830352161.png loading=lazy alt=Vulkan入门03-UniformBuffers-1764830352161></p><h2 id=对齐问题>对齐问题</h2><p>考虑下面两个：</p><p>内存中v.s. glsl中</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>UniformBufferObject</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    glm<span style=color:#0550ae>::</span>vec2 foo<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    glm<span style=color:#0550ae>::</span>mat4 model<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    glm<span style=color:#0550ae>::</span>mat4 view<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    glm<span style=color:#0550ae>::</span>mat4 proj<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>layout<span style=color:#1f2328>(</span>binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> uniform UniformBufferObject <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    vec2 foo<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    mat4 model<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    mat4 view<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    mat4 proj<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span> ubo<span style=color:#1f2328>;</span>
</span></span></code></pre></td></tr></table></div></div><p>其实回顾我们之前的学习，我们知道 shader中对内存布局有额外要求：</p><ul><li>Scalars have to be aligned by N (= 4 bytes given 32 bit floats).</li><li>A <code>vec2</code> must be aligned by 2N (= 8 bytes)</li><li>A <code>vec3</code> or <code>vec4</code> must be aligned by 4N (= 16 bytes)</li><li>A nested structure must be aligned by the base alignment of its members rounded up to a multiple of 16.</li><li>A <code>mat4</code> matrix must have the same alignment as a <code>vec4</code>.</li></ul><p>显然我们上面CPU布局和GPU内存布局不一致。（因为vec2，会占有8字节，而后面我们需要16字节对齐。所以我们必须手动对齐CPU的内存）</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>UniformBufferObject</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    glm<span style=color:#0550ae>::</span>vec2 foo<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>alignas</span><span style=color:#1f2328>(</span><span style=color:#0550ae>16</span><span style=color:#1f2328>)</span> glm<span style=color:#0550ae>::</span>mat4 model<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    glm<span style=color:#0550ae>::</span>mat4 view<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    glm<span style=color:#0550ae>::</span>mat4 proj<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>};</span>
</span></span></code></pre></td></tr></table></div></div><p>此外，GLM库提供了自动对齐的宏配置</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#57606a>#define GLM_FORCE_RADIANS
</span></span></span><span style=display:flex><span><span style=color:#57606a>#define GLM_FORCE_DEFAULT_ALIGNED_GENTYPES
</span></span></span><span style=display:flex><span><span style=color:#57606a>#include</span> <span style=color:#57606a>&lt;glm/glm.hpp&gt;</span><span style=color:#57606a>
</span></span></span></code></pre></td></tr></table></div></div><p>这样GLM定义的对象，会按照GPU的规范进行自动对齐。但如果你嵌套使用自定义struct，那么对齐也会失效。（GLM仅能负责自己对象内部的对齐）。教程里举了个奇怪的例子，我们这里不举例子，知道有内存对齐问题以及手动对齐为主即可。</p><h2 id=多个-descriptor-set>多个 Descriptor Set</h2><p>这个其实我们之前也提到过了。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-glsl data-lang=glsl><span style=display:flex><span>layout<span style=color:#1f2328>(</span>set <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span> binding <span style=color:#0550ae>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>uniform</span> UniformBufferObject <span style=color:#1f2328>{</span> <span style=color:#1f2328>...</span> <span style=color:#1f2328>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>1个pipiline 可以绑定 多个 Descriptor Set （每个set，可以根据UBO使用频率来规划）</li><li>1个Descriptor Set可以绑定多个Descriptor Set Binding （每个binding可以对应一种单个/数组类型的UBO/其他资源）</li><li>每个binding实际运行时，绑定1个Descriptor / 1个Descriptor数组 。</li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/vulkan/>Vulkan</a>
<a href=/tags/uniformbuffer/>Uniformbuffer</a>
<a href=/tags/ubo/>Ubo</a></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=[".main-article",".widget--toc"];e.forEach(e=>{const t=document.querySelector(e);t&&renderMathInElement(t,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})})</script></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/2025/11/27/vulkan%E5%85%A5%E9%97%A802-vertexbuffers/><div class=article-details><h2 class=article-title>Vulkan入门02-VertexBuffers</h2></div></a></article><article><a href=/2025/11/21/vulkan%E7%A8%8B%E5%BA%8F%E4%B8%ADintel%E9%A9%B1%E5%8A%A8%E6%80%BB%E6%98%AF%E8%A2%AB%E8%B0%83%E7%94%A8%E6%9C%AA%E8%A7%A3%E5%86%B3/><div class=article-details><h2 class=article-title>Vulkan程序中Intel驱动总是被调用（未解决）</h2></div></a></article><article><a href=/2025/11/19/vulkan%E7%9A%84layer%E5%8F%91%E7%8E%B0%E6%9C%BA%E5%88%B6/><div class=article-details><h2 class=article-title>Vulkan的Layer发现机制</h2></div></a></article><article><a href=/2025/11/18/vulkan%E7%9A%84icd%E6%9C%BA%E5%88%B6/><div class=article-details><h2 class=article-title>Vulkan的ICD机制</h2></div></a></article><article><a href=/2025/11/17/%E8%AE%B0%E5%BD%95%E8%B0%83%E8%AF%95vulkan%E7%A8%8B%E5%BA%8F%E6%89%93%E5%8D%B0%E5%A5%87%E6%80%AA%E6%97%A5%E5%BF%97%E7%9A%84%E9%97%AE%E9%A2%98/><div class=article-details><h2 class=article-title>记录调试Vulkan程序打印奇怪日志的问题</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2025 crackhopper的技术博客</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.32.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.0fcb739c1f88ce461c9640077fd21d8ce903946f1aef209dd01192827d26a90c.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>
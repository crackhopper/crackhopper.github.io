<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="不甘心解决不了 igvk 的频繁调用问题的我，深入研究了一下ICD机制。尝试手动指定ICD来启动Vulkan，看能否解决问题。\n"><title>Vulkan的ICD机制</title><link rel=canonical href=https://crackhopper.github.io/2025/11/18/vulkan%E7%9A%84icd%E6%9C%BA%E5%88%B6/><link rel=stylesheet href=/scss/style.min.4d36f8dc1fd48129e1635deb4b8eb2870fa09474f7280c4cb606d40b2526994b.css><meta property='og:title' content="Vulkan的ICD机制"><meta property='og:description' content="不甘心解决不了 igvk 的频繁调用问题的我，深入研究了一下ICD机制。尝试手动指定ICD来启动Vulkan，看能否解决问题。\n"><meta property='og:url' content='https://crackhopper.github.io/2025/11/18/vulkan%E7%9A%84icd%E6%9C%BA%E5%88%B6/'><meta property='og:site_name' content='crackhopper的技术博客'><meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:tag' content='vulkan'><meta property='article:tag' content='icd'><meta property='article:published_time' content='2025-11-18T12:57:45+08:00'><meta property='article:modified_time' content='2025-11-18T12:57:45+08:00'><meta name=twitter:title content="Vulkan的ICD机制"><meta name=twitter:description content="不甘心解决不了 igvk 的频繁调用问题的我，深入研究了一下ICD机制。尝试手动指定ICD来启动Vulkan，看能否解决问题。\n"><link rel=stylesheet href=/css/custom.css></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_337fe2b325ec916d.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>crackhopper的技术博客</a></h1><h2 class=site-description>C++, Graphics, Game, AI/ML</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>文章</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于我</span></a></li><li><a href=/projects/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>项目</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ul><li><a href=#什么是-vulkan-icd>什么是 Vulkan ICD？</a><ul><li><a href=#详细解释-vulkan-架构中的-icd>详细解释 Vulkan 架构中的 ICD</a><ul><li><a href=#1-vulkan-loader加载器>1. Vulkan Loader（加载器）</a></li><li><a href=#2-installable-client-driver-icd>2. Installable Client Driver (ICD)</a></li><li><a href=#3-vulkan-layers层>3. Vulkan Layers（层）</a></li></ul></li><li><a href=#总结>总结</a></li></ul></li><li><a href=#loader如何找到icd>Loader如何找到ICD？</a><ul><li><a href=#显卡设备>显卡设备</a></li><li><a href=#软件组织设备>软件组织设备</a></li></ul></li><li><a href=#使用windbg定位到loader获取icd的位置>使用WinDbg定位到Loader获取ICD的位置</a><ul><li><a href=#思路1注册表访问函数上打断点失败>思路1：注册表访问函数上打断点（失败）</a><ul><li><a href=#1f68e2fd-中断示例><code>1F68E:2FD</code> 中断示例</a></li><li><a href=#总结-1>总结</a></li></ul></li><li><a href=#思路2找到打开配置文件的代码追踪文件路径的获取过程>思路2：找到打开配置文件的代码，追踪文件路径的获取过程</a><ul><li><a href=#关于这个中断相关信息的ai解读>关于这个中断相关信息的AI解读</a><ul><li><a href=#ai节选>AI（节选）</a></li><li><a href=#ai节选-1>AI（节选）</a></li><li><a href=#我的讨论>我的讨论</a></li><li><a href=#ai节选-2>AI（节选）</a></li><li><a href=#ai节选-3>AI（节选）</a></li></ul></li></ul></li></ul></li><li><a href=#补充知识>补充知识</a><ul><li><a href=#dch>DCH</a></li></ul></li></ul></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/2025/11/18/vulkan%E7%9A%84icd%E6%9C%BA%E5%88%B6/>Vulkan的ICD机制</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2025-11-18T12:57:45+08:00>Nov 18, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><p>不甘心解决不了 igvk 的频繁调用问题的我，深入研究了一下ICD机制。尝试手动指定ICD来启动Vulkan，看能否解决问题。</p><h1 id=什么是-vulkan-icd>什么是 Vulkan ICD？</h1><p><strong>ICD</strong> 是 <strong>Installable Client Driver</strong>（可安装客户端驱动程序）的缩写。</p><p>在 Vulkan 架构中，ICD 指的是 <strong>图形硬件供应商（如 NVIDIA、AMD、Intel）提供的、针对特定硬件实现的 Vulkan 驱动程序部分</strong>。</p><p>简单来说，ICD 就是你的 <strong>显卡驱动程序中负责执行 Vulkan 命令的那部分代码</strong>。</p><p>Vulkan API 的设计采用了一种分层的（layered）架构，使其比其前身 OpenGL 或 DirectX 更加模块化和灵活。在这个架构中，ICD 扮演了核心角色。</p><h2 id=详细解释-vulkan-架构中的-icd>详细解释 Vulkan 架构中的 ICD</h2><h3 id=1-vulkan-loader加载器>1. Vulkan Loader（加载器）</h3><p>在应用程序 (App) 和 ICD 之间，有一个关键的中间件：<strong>Vulkan Loader</strong>（加载器）。</p><ul><li><p><strong>作用：</strong> 它是应用程序首先链接的库（通常是 <code>vulkan-1.dll</code> 或 <code>libvulkan.so</code>）。</p></li><li><p><strong>功能：</strong></p><ul><li><p><strong>发现与管理：</strong> Loader 负责发现系统上安装的所有 Vulkan ICDs（即所有支持 Vulkan 的显卡驱动）。ICD 通常通过特定的 <strong>JSON 清单文件</strong>（例如 <code>nvidia_icd.json</code>、<code>amd_icd.json</code> 等，位于系统特定目录如 <code>/usr/share/vulkan/icd.d/</code>）向 Loader 注册自己。</p></li><li><p><strong>调度 (Dispatch)：</strong> 当应用程序调用一个 Vulkan API 函数时（例如 <code>vkCreateInstance</code>、<code>vkCmdDraw</code>），Loader 负责将这个调用正确地导向（调度）到 <strong>正确的 ICD</strong> 或 <strong>Vulkan Layer</strong>（验证层、工具层等）。</p></li></ul></li></ul><h3 id=2-installable-client-driver-icd>2. Installable Client Driver (ICD)</h3><p>ICD 是真正的“幕后英雄”，负责与物理 GPU 硬件通信。</p><ul><li><p><strong>作用：</strong> 实现 Vulkan API 的核心功能，将抽象的 Vulkan 命令（如绘制三角形、进行计算）转换为 GPU 可以理解的实际硬件指令。</p></li><li><p><strong>注册：</strong> 每个 ICD 都会在系统上放置一个 JSON 文件，告诉 Loader 它的动态链接库（DLL 或 SO 文件）在哪里，以及它支持哪些 Vulkan 扩展和特性。</p></li><li><p><strong>多 ICDs：</strong> 由于一台计算机上可能有多个 GPU（例如一个 Intel 集成显卡和一个 NVIDIA 独立显卡），因此系统上可以同时安装和运行 <strong>多个 ICDs</strong>。Loader 会将它们全部识别出来，并在应用程序请求创建 Vulkan 实例或设备时，让应用程序选择使用哪一个 ICD。</p></li></ul><h3 id=3-vulkan-layers层>3. Vulkan Layers（层）</h3><p>虽然不是 ICD 本身，但 Layers 是理解 Vulkan 架构的另一个重要部分。</p><ul><li><p><strong>位置：</strong> Layers 位于 Loader 和 ICD 之间。</p></li><li><p><strong>作用：</strong> 它们可以拦截 API 调用，并在调用传递给 ICD 之前或之后执行额外的操作。最常见的 Layers 是 <strong>验证层 (Validation Layers)</strong>，用于在开发过程中检查应用程序是否正确使用了 Vulkan API。</p></li></ul><h2 id=总结>总结</h2><div class=table-wrapper><table><thead><tr><th><strong>角色</strong></th><th><strong>作用</strong></th><th><strong>谁提供？</strong></th></tr></thead><tbody><tr><td><strong>应用程序 (App)</strong></td><td>调用 Vulkan API 函数。</td><td>开发者</td></tr><tr><td><strong>Loader</strong></td><td>发现所有 ICDs，管理 Layers，并将 API 调用调度给正确的 ICD。</td><td>Khronos Group（或驱动程序/发行版）</td></tr><tr><td><strong>ICD</strong></td><td><strong>真正的驱动程序实现，将 Vulkan 命令翻译成 GPU 硬件指令。</strong></td><td>硬件供应商 (NVIDIA, AMD, Intel 等)</td></tr></tbody></table></div><h1 id=loader如何找到icd>Loader如何找到ICD？</h1><p>参考 vulkan 文档 : <a class=link href=https://vulkan.lunarg.com/doc/view/latest/mac/LoaderDriverInterface.html target=_blank rel=noopener>https://vulkan.lunarg.com/doc/view/latest/mac/LoaderDriverInterface.html</a> 中的 Driver Discovery on Windows 部分，可以知道，通过查询如下注册表项：</p><pre tabindex=0><code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Class\{Adapter GUID}\000X\VulkanDriverName
HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Class\{SoftwareComponent GUID}\000X\VulkanDriverName
</code></pre><h2 id=显卡设备>显卡设备</h2><p>对于显卡驱动开说，这里的 Adapter GUID是固定的，为 <code>4D36E968-E325-11CE-BFC1-08002BE10318</code> 。</p><p><img src=/images/Vulkan%e7%9a%84ICD%e6%9c%ba%e5%88%b6-1763443508236.png loading=lazy alt=Vulkan的ICD机制-1763443508236></p><p>对应设备管理器：</p><p><img src=/images/Vulkan%e7%9a%84ICD%e6%9c%ba%e5%88%b6-1763444512168.png loading=lazy alt=Vulkan的ICD机制-1763444512168></p><p>在我们的case下，这里的两个真实显卡会配置： <code>VulkanDriverName</code> 和 <code>VulkanDriverNameWow</code> 这两个key，分别指定64位和32位的 ICD的json配置文件。</p><h2 id=软件组织设备>软件组织设备</h2><p>SoftwareComponent GUID也是固定的(“软件组件设备”，用于管理软件模块或驱动包中的附加功能。 <strong>为了让操作系统可以像管理硬件设备一样管理驱动包中的软件模块</strong>)，为 <code>5C4C3332-344D-483C-8739-259E934C9CC8</code> （<strong>SoftwareComponent 可以作为非标准设备或附加模块的“容器”，让操作系统统一管理</strong>。）
<img src=/images/Vulkan%e7%9a%84ICD%e6%9c%ba%e5%88%b6-1763443585935.png loading=lazy alt=Vulkan的ICD机制-1763443585935>
对应设备管理器：
<img src=/images/Vulkan%e7%9a%84ICD%e6%9c%ba%e5%88%b6-1763444471920.png loading=lazy alt=Vulkan的ICD机制-1763444471920></p><h1 id=使用windbg定位到loader获取icd的位置>使用WinDbg定位到Loader获取ICD的位置</h1><p>上面是我阅读文档得到的信息。不过，既然咱都学会了 windbg，是不是可以从二进制中看到vulkan如何加载这个json的呢？</p><h2 id=思路1注册表访问函数上打断点失败>思路1：注册表访问函数上打断点（失败）</h2><p><img src=/images/Vulkan%e7%9a%84ICD%e6%9c%ba%e5%88%b6-1763561340860.png loading=lazy alt=Vulkan的ICD机制-1763561340860></p><h3 id=1f68e2fd-中断示例><code>1F68E:2FD</code> 中断示例</h3><p>这个中断点是最接近我们要访问的注册表项了。可惜读取的值并不是我们期待的。</p><pre tabindex=0><code>[0x0]   ADVAPI32!RegGetValueWStub   0x55168e3898   0x7ff886f69e7d   
[0x1]   ControlLib!ctlWaitForPropertyChange+0x1bcd   0x55168e38a0   0x7ff886f6c493   
[0x2]   ControlLib!ctlWaitForPropertyChange+0x41e3   0x55168e3910   0x7fff7ef9348f   
[0x3]   igvk64!ctlInit+0xff   0x55168e3a80   0x7fff7ee61a59   
[0x4]   igvk64!DumpRegistryKeyDefinitions+0x1b76a9   0x55168e3ec0   0x7fff7ee60835   
[0x5]   igvk64!DumpRegistryKeyDefinitions+0x1b6485   0x55168e41a0   0x7fff7ee476a4   
[0x6]   igvk64!DumpRegistryKeyDefinitions+0x19d2f4   0x55168e4310   0x7fff7ee31bd5   
[0x7]   igvk64!DumpRegistryKeyDefinitions+0x187825   0x55168e43c0   0x7fff7eda31e6   
[0x8]   igvk64!DumpRegistryKeyDefinitions+0xf8e36   0x55168e4410   0x7fff7ed87534   
[0x9]   igvk64!DumpRegistryKeyDefinitions+0xdd184   0x55168fb620   0x7fff7ed5ec7d   
[0xa]   igvk64!DumpRegistryKeyDefinitions+0xb48cd   0x55168fb690   0x7fff7ece0ca5   
[0xb]   igvk64!DumpRegistryKeyDefinitions+0x368f5   0x55168fb6e0   0x7fffbd89c6dc   
[0xc]   vulkan_1!vkResetEvent+0x4b14c   0x55168fb7b0   0x7fff810205e7   
[0xd]   VkLayer_khronos_validation!vulkan_layer_chassis::CreateInstance+0x217   0x55168fb910   0x7fff8bb1b27c   
[0xe]   CrossVulkanLayer64!vkCreateInstance+0x180   0x55168fbad0   0x7ff8498fcacb   
[0xf]   graphics_hook64!dummy_debug_proc+0x294b   0x55168fbbe0   0x7fff741fc952   
[0x10]   nvoglv64!DrvPresentBuffers+0x3698d2   0x55168fbca0   0x7fffbd883652   
[0x11]   vulkan_1!vkResetEvent+0x320c2   0x55168fbcd0   0x7fffbd8a751e   
[0x12]   vulkan_1!vkResetEvent+0x55f8e   0x55168fc000   0x7ff717220f44   
[0x13]   VulkanGLFWDemo!HelloTriangleApplication::createInstance+0x244   0x55168ff410   0x7ff717224b64   
</code></pre><p>RegGetValueWStub，其实它是一个 “Stub（代理/跳转）” 函数，而真正的 API 是 RegGetValueW。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>LONG WINAPI <span style=color:#6639ba>RegGetValueW</span><span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>    HKEY    hkey<span style=color:#1f2328>,</span>          <span style=color:#57606a>// [in]      已打开的注册表键句柄
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    LPCWSTR lpSubKey<span style=color:#1f2328>,</span>      <span style=color:#57606a>// [in, optional] 子键路径（相对 hkey），如果为 NULL 或 &#34;&#34; 则直接在 hkey 上查
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    LPCWSTR lpValue<span style=color:#1f2328>,</span>       <span style=color:#57606a>// [in, optional] 注册表值名称，如果为 NULL 或 &#34;&#34; 则查默认值
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    DWORD   dwFlags<span style=color:#1f2328>,</span>       <span style=color:#57606a>// [in]      检索类型的标志
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    LPDWORD pdwType<span style=color:#1f2328>,</span>       <span style=color:#57606a>// [out, optional] 返回数据类型（如 REG_SZ 等）
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    PVOID   pvData<span style=color:#1f2328>,</span>        <span style=color:#57606a>// [out, optional] 缓冲区 接收数据
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>    LPDWORD pcbData        <span style=color:#57606a>// [in,out]  指定数据缓冲区大小，返回时写入实际用字节数
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>);</span>
</span></span></code></pre></td></tr></table></div></div><p>因此可以看一下第二第三个参数：</p><pre tabindex=0><code>0:000&gt; du rdx;
000001ea`8a246d60  &#34;SYSTEM\CurrentControlSet\Control&#34;
000001ea`8a246da0  &#34;\Class\{4d36e968-e325-11ce-bfc1-&#34;
000001ea`8a246de0  &#34;08002be10318}\0001&#34;
0:000&gt; du r8;
00007ff8`86f86370  &#34;ControlApiPath&#34;
</code></pre><p>为什么注意这个注册表的读取？因为按照vulkan文档的解释，ICD的信息其实就是从这个key里得到的。</p><p>为了方便定位到类似的读取，我们改造一下断点：</p><pre tabindex=0><code>bp advapi32!RegGetValueWStub &#34;du rdx; du r8;&#34;
</code></pre><p>继续执行，把这个调用的重要参数打印出来。除了这个并没有太多有效信息。所以，应该是使用别的API读取值。（ <strong>当然也可能是内核态读取的，这样无法断点；这个是后来才知道的，参见思路2</strong> ）</p><h3 id=总结-1>总结</h3><p>打了尽可能多的读取注册表的断点，没有一处中断到 读取 值 <code>VulkanDriverName</code> 上。</p><h2 id=思路2找到打开配置文件的代码追踪文件路径的获取过程>思路2：找到打开配置文件的代码，追踪文件路径的获取过程</h2><p>既然注册表思路不行，还有一个办法，我们其实已经知道对应的ICD配置文件。同时代码一定会读取这个文件，从 <code>kernel32!CreateFileW</code> 入手，我们可以中断到ICD配置文件（字符串：一个json文件）。随后我们溯源这个字符串怎么来的。</p><p>这里细节不表。详细过程大概为：</p><ul><li>定位到文件的字符串，然后再代码中找到传参的变量/寄存器/内存。</li><li>如果是内存，打内存断点，随后追查内存写入位置的传参。
循环上面两个步骤。。。（有效的利用TTD调试，可以不断的阅读汇编代码，中断，随后 <code>g-</code> 跳转回去；当然还可以用 <code>tt br-</code> 和 <code>tt ba-</code> ，只不过我一开始不会用，就用了笨办法）</li></ul><p>最终定位到，在内存位置： <code>000001ea`87f61530</code> 这里，被填充了字符串： <code>C:\WINDOWS\System32\DriverStore\FileRepository\iigd_dch.inf_amd64_aaa3915de44b535a\igvk64.json</code></p><p>而填充这个内存的代码无法中断到。通过不断的单步，最后定位到代码：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span>    <span style=color:#6639ba>win32u</span><span style=color:#1f2328>!</span><span style=color:#0550ae>NtGdiDdDDIQueryAdapterInfo</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>CFG</span>
</span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>00007</span><span style=color:#6639ba>ff8</span><span style=color:#f6f8fa;background-color:#82071e>`</span><span style=color:#0550ae>926</span><span style=color:#0550ae>b57d0</span> <span style=color:#0550ae>4</span><span style=color:#0550ae>c8bd1</span>           <span style=color:#0550ae>mov</span>     <span style=color:#0550ae>r10</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>rcx</span>
</span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>00007</span><span style=color:#6639ba>ff8</span><span style=color:#f6f8fa;background-color:#82071e>`</span><span style=color:#0550ae>926</span><span style=color:#0550ae>b57d3</span> <span style=color:#0550ae>b82a120000</span>       <span style=color:#0550ae>mov</span>     <span style=color:#0550ae>eax</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>122</span><span style=color:#0550ae>Ah</span>
</span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>00007</span><span style=color:#6639ba>ff8</span><span style=color:#f6f8fa;background-color:#82071e>`</span><span style=color:#0550ae>926</span><span style=color:#0550ae>b57d8</span> <span style=color:#0550ae>f604250803fe7f01</span> <span style=color:#0550ae>test</span>    <span style=color:#0550ae>byte</span> <span style=color:#0550ae>ptr</span> <span style=color:#1f2328>[</span><span style=color:#0550ae>7</span><span style=color:#0550ae>FFE0308h</span><span style=color:#1f2328>],</span> <span style=color:#0550ae>1</span>
</span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>00007</span><span style=color:#6639ba>ff8</span><span style=color:#f6f8fa;background-color:#82071e>`</span><span style=color:#0550ae>926</span><span style=color:#0550ae>b57e0</span> <span style=color:#0550ae>7503</span>             <span style=color:#0550ae>jne</span>     <span style=color:#0550ae>win32u</span><span style=color:#1f2328>!</span><span style=color:#0550ae>NtGdiDdDDIQueryAdapterInfo</span><span style=color:#f6f8fa;background-color:#82071e>+</span><span style=color:#0550ae>0x15</span> <span style=color:#1f2328>(</span><span style=color:#0550ae>7</span><span style=color:#0550ae>ff8926b57e5</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>00007</span><span style=color:#6639ba>ff8</span><span style=color:#f6f8fa;background-color:#82071e>`</span><span style=color:#0550ae>926</span><span style=color:#0550ae>b57e2</span> <span style=color:#0550ae>0</span><span style=color:#0550ae>f05</span>             <span style=color:#0550ae>syscall</span> 
</span></span><span style=display:flex><span><span style=color:#0550ae>00007</span><span style=color:#0550ae>ff8</span><span style=color:#f6f8fa;background-color:#82071e>`</span><span style=color:#0550ae>926</span><span style=color:#0550ae>b57e4</span> <span style=color:#0550ae>c3</span>               <span style=color:#0550ae>ret</span>     
</span></span><span style=display:flex><span><span style=color:#0550ae>00007</span><span style=color:#0550ae>ff8</span><span style=color:#f6f8fa;background-color:#82071e>`</span><span style=color:#0550ae>926</span><span style=color:#0550ae>b57e5</span> <span style=color:#0550ae>cd2e</span>             <span style=color:#0550ae>int</span>     <span style=color:#0550ae>2</span><span style=color:#0550ae>Eh</span>
</span></span><span style=display:flex><span><span style=color:#f6f8fa;background-color:#82071e>00007</span><span style=color:#6639ba>ff8</span><span style=color:#f6f8fa;background-color:#82071e>`</span><span style=color:#0550ae>926</span><span style=color:#0550ae>b57e7</span> <span style=color:#0550ae>c3</span>               <span style=color:#0550ae>ret</span>     
</span></span><span style=display:flex><span><span style=color:#0550ae>00007</span><span style=color:#0550ae>ff8</span><span style=color:#f6f8fa;background-color:#82071e>`</span><span style=color:#0550ae>926</span><span style=color:#0550ae>b57e8</span> <span style=color:#0550ae>0</span><span style=color:#0550ae>f1f840000000000</span> <span style=color:#0550ae>nop</span>     <span style=color:#0550ae>dword</span> <span style=color:#0550ae>ptr</span> <span style=color:#1f2328>[</span><span style=color:#0550ae>rax</span><span style=color:#f6f8fa;background-color:#82071e>+</span><span style=color:#0550ae>rax</span><span style=color:#1f2328>]</span>
</span></span></code></pre></td></tr></table></div></div><p>在syscall之后，得到了数据。</p><p>通过询问AI，知道切换到了内核态。是由驱动本身来填充的。内核态的代码，用户态调试无法中断。这也是为什么，之前注册表访问函数中断不了的原因。</p><p>这个调用的堆栈：</p><pre tabindex=0><code>[0x0]   win32u!NtGdiDdDDIQueryAdapterInfo+0x14   0x55168fb7e8   0x7fffbd8b331d   
[0x1]   vulkan_1!vkResetEvent+0x61d8d   0x55168fb7f0   0x7fffbd8b2e1c   
[0x2]   vulkan_1!vkResetEvent+0x6188c   0x55168fbb20   0x7fffbd88489d   
[0x3]   vulkan_1!vkResetEvent+0x3330d   0x55168fbbc0   0x7fffbd896535   
[0x4]   vulkan_1!vkResetEvent+0x44fa5   0x55168fbc10   0x7fffbd89828a   
[0x5]   vulkan_1!vkResetEvent+0x46cfa   0x55168fbca0   0x7fffbd8a8db2   
[0x6]   vulkan_1!vkResetEvent+0x57822   0x55168fbd60   0x7ff71722f720   
[0x7]   VulkanGLFWDemo!_glfwInitVulkan+0x110(int mode = 2) [C:\Users\develop\game-dev\renderer\external\glfw-3.4\src\vulkan.c @ 100]   0x55168ff150   0x7ff71722f5cc   
[0x8]   VulkanGLFWDemo!glfwGetRequiredInstanceExtensions+0x5c(unsigned int * count = 0x55168ff214 : 0x0) [C:\Users\develop\game-dev\renderer\external\glfw-3.4\src\vulkan.c @ 236]   0x55168ff1c0   0x7ff7172249b8   
[0x9]   VulkanGLFWDemo!HelloTriangleApplication::getRequiredExtenstions+0x48() [C:\Users\develop\game-dev\renderer\src\main.cpp @ 531]   0x55168ff1f0   0x7ff71721e6b2   
</code></pre><p>可以看出来，在我的程序获取 <code>glfw</code> 所需要的extentions的时候，会触发 <code>_glfwInitVulkan</code> ，最终触发了 <code>win32u!NtGdiDdDDIQueryAdapterInfo</code> 这个函数的调用。</p><p>那么其他位置，比如 <code>vkCreateInstance</code> 的时候，应该类似。最终的调用被转发给了系统调用，从而获取到了对应的ICD配置。（如果想定位到对应的指令，必须得内核态调试）</p><p>这个就更加进阶了。暂时我不打算继续深入。相关文档在： <a class=link href=https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/getting-started-with-windbg--kernel-mode- target=_blank rel=noopener>https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/getting-started-with-windbg--kernel-mode-</a> 。未来有需要再看。</p><h3 id=关于这个中断相关信息的ai解读>关于这个中断相关信息的AI解读</h3><h4 id=ai节选>AI（节选）</h4><p>函数第一个参数：</p><p>dd @rcx L4 这个命令结果为：</p><pre tabindex=0><code>00000055168f6300 40001c00 00000030 87f61310 000001ea
</code></pre><h4 id=ai节选-1>AI（节选）</h4><p>您的内存数据如下： <code>00000055168f6300 40001c00 00000030 87f61310 000001ea</code></p><p>这是一块连续内存，WinDbg 的 <code>dd</code> (Display DWORD) 是按 4 字节显示的。我们来按结构体布局拆解它：</p><ul><li><p><strong>地址</strong>: <code>0x00000055168f6300</code></p></li><li><p><strong>Offset 0x00 (hAdapter)</strong>: <code>40001c00</code></p><ul><li>这是适配器句柄。</li></ul></li><li><p><strong>Offset 0x04 (Type)</strong>: <code>00000030</code></p><ul><li>十六进制 <code>0x30</code> = 十进制 <strong>48</strong>。</li><li>查阅 WDDM 驱动开发文档，<code>KMTQUERYADAPTERINFOTYPE</code> 枚举中，值 48 对应的是 <strong><code>KMTQAITYPE_PHYSICALADAPTERDEVICEIDS</code></strong>。</li><li><strong>含义</strong>：Vulkan Loader 正在询问内核：“<strong>请告诉我这个物理适配器的 PCI Device ID、Vendor ID 和 SubSystem ID</strong>”。这正是 Loader 用来匹配 JSON 文件中筛选器的关键步骤。</li></ul></li><li><p><strong>Offset 0x08 (pPrivateDriverData)</strong>:</p><ul><li>由于这是 x64，指针占 8 字节，由后两个 DWORD 组成。</li><li>低 4 字节: <code>87f61310</code></li><li>高 4 字节: <code>000001ea</code></li><li><strong>指针地址</strong>: <code>0x000001ea87f61310</code>。这是接收返回数据（Device IDs）的缓冲区地址。</li></ul></li></ul><p><strong>结论</strong>：Vulkan 正在遍历 GPU 并获取它们的硬件 ID。</p><h4 id=我的讨论>我的讨论</h4><p>我的调用会在 <code>000001ea87f61530</code> 这个地址，写入 C:\WINDOWS\System32\DriverStore\FileRepository\iigd_dch.inf_amd64_aaa3915de44b535a\igvk64.json 这个字符串。而不是你分析的地址。而在 <code>000001ea87f61310</code> 这个位置，信息为：（二进制）：</p><pre tabindex=0><code>000001ea87f61310 0001 0000 0001 0000 0056 0075 006c 006b
000001ea87f61320 0061 006e 0044 0072 0069 0076 0065 0072
000001ea87f61330 004e 0061 006d 0065 0000 0000 0000 0000
</code></pre><p>并没有看到内存变化。看起来更像是函数调用输入的信息。000001ea87f61310 是结构体的地址，而 000001ea87f61530 则是用来接收返回值的buffer。</p><p>或者说，整个rcx存放的是一个指针，指向某个结构体。而这个结构体前三个dword之后，又跟随一个指针，这个指针指向另一个结构体（顺便用这个结构体接收一些返回值）。</p><p>这么一推断，你上面很多说法都不成立（毕竟你的接口体定义都不对）</p><h4 id=ai节选-2>AI（节选）</h4><p><strong>修正：现场内存分析 (CSI 现场还原)</strong></p><p>你抓到的内存数据： <code>000001ea'87f61310 0056 0075 006c 006b ...</code></p><p>这确实是 <strong>Unicode 字符串</strong>。</p><ul><li><code>0056</code> = &lsquo;V&rsquo;</li><li><code>0075</code> = &lsquo;u&rsquo;</li><li><code>006c</code> = &rsquo;l'</li><li><code>006b</code> = &lsquo;k&rsquo;</li><li>拼起来正是：<strong><code>VulkanDriverName</code></strong></li></ul><p><strong>这是什么意思？</strong> 这说明 <code>Type = 0x30</code> (48) 在这个上下文（Windows 10/11 + DCH 驱动）中，实际上执行的是 <strong><code>KMTQAITYPE_ADAPTERREGISTRYINFO</code></strong> (查询适配器注册表信息) 的某种变体或特定实现。</p><p><strong>流程重构：</strong></p><ol><li><strong>Input</strong>: Vulkan Loader 将字符串 <code>VulkanDriverName</code> 放入 <code>pPrivateDriverData</code> 指向的缓冲区。</li><li><strong>Call</strong>: 调用 <code>NtGdiDdDDIQueryAdapterInfo</code>。</li><li><strong>Kernel Action</strong>: 内核拿着显卡句柄，去该显卡在 <code>HKLM\SYSTEM\CurrentControlSet\Control\Class\{GUID}\00xx</code> 下的<strong>私有驱动注册表项</strong>中查找名为 <code>VulkanDriverName</code> 的值。</li><li><strong>Output</strong>: 内核找到了路径（如 <code>...\igvk64.json</code>），并将其写回到缓冲区的某个偏移位置（你观察到的 <code>0x...530</code>）。</li></ol><p><strong>结论</strong>：Vulkan Loader 不再依赖全局的 <code>Khronos\Vulkan\Drivers</code> 列表，而是直接询问内核：“当前这个显卡，它的驱动 JSON 藏在哪里？”。这就是为什么你的注册表中没有那个全局 Drivers 键值的原因。</p><pre><code>注意：实际上和Vulkan Loader可能没有关系。因为目前堆栈定位到调用是 vkEnumerateInstanceExtensionProperties 中
</code></pre><h4 id=ai节选-3>AI（节选）</h4><pre><code>AI坚持认为调用时用 `D3DKMTQueryAdapterInfo` 这个函数。
</code></pre><p>它并没有直接调用 NtGdiDdDDIQueryAdapterInfo。</p><p>它调用的是 D3DKMTQueryAdapterInfo。这是一个由 gdi32.dll 或 d3dkmthk.dll 导出的函数。</p><p>在 WinDbg 中，你看到 NtGdi&mldr; 是因为 D3DKMT&mldr; 只是一个很薄的封装，它立即通过 syscall 进入内核，而 WinDbg 在内核入口处抓住了它。</p><p>待排查。</p><h1 id=补充知识>补充知识</h1><h2 id=dch>DCH</h2><p><strong>DCH</strong> 代表 <strong>D</strong>eclarative, <strong>C</strong>omponentized, <strong>H</strong>ardware Support Apps。这是微软在 Windows 10 1809 之后强制推行的新驱动架构。</p><ul><li><p><strong>Legacy (旧版) 驱动</strong>：</p><ul><li>一个巨大的 <code>.exe</code> 安装包。</li><li>把 DLL 扔进 <code>System32</code>。</li><li>注册表乱写。</li><li>控制面板和驱动混在一起。</li></ul></li><li><p><strong>DCH (新版) 驱动</strong>：</p><ul><li><strong>Declarative (声明式)</strong>：通过 INF 文件清晰声明所有文件去向。</li><li><strong>Componentized (组件化)</strong>：核心驱动 (Kernel)、服务 (Service)、用户软件 (Control Panel) 必须分开。</li><li><strong>Hardware Support Apps</strong>：控制面板（如 NVIDIA Control Panel）必须通过 Microsoft Store 安装，不能捆绑在驱动里。</li><li><strong>关键影响</strong>：<ul><li>驱动文件被严格隔离在 <code>C:\Windows\System32\DriverStore\FileRepository\...</code> 这种带哈希值的文件夹里，防止被篡改或覆盖。</li><li>Vulkan JSON 文件也必须放在那里。</li><li>注册表不再使用全局位置，而是绑定在 PnP 设备节点上。</li></ul></li></ul></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/vulkan/>Vulkan</a>
<a href=/tags/icd/>Icd</a></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=[".main-article",".widget--toc"];e.forEach(e=>{const t=document.querySelector(e);t&&renderMathInElement(t,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})})</script></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/2025/11/17/%E8%AE%B0%E5%BD%95%E8%B0%83%E8%AF%95vulkan%E7%A8%8B%E5%BA%8F%E6%89%93%E5%8D%B0%E5%A5%87%E6%80%AA%E6%97%A5%E5%BF%97%E7%9A%84%E9%97%AE%E9%A2%98/><div class=article-details><h2 class=article-title>记录调试Vulkan程序打印奇怪日志的问题</h2></div></a></article><article><a href=/2025/11/11/vulkan%E5%85%A5%E9%97%A801-%E7%BB%98%E5%88%B6%E4%B8%89%E8%A7%92%E5%BD%A2/><div class=article-details><h2 class=article-title>Vulkan入门01-绘制三角形</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2025 crackhopper的技术博客</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.32.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.0fcb739c1f88ce461c9640077fd21d8ce903946f1aef209dd01192827d26a90c.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>